<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Character set: Declares UTF-8 encoding to prevent garbled text -->
    <meta charset="UTF-8" />
    <!-- Page Title: Shown in browser tab -->
    <title>Advanced Gantt Chart</title>
    <!-- Bootstrap 5 CSS via CDN: for grid, modals, etc. -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
    <style>
        /*
         * Navbar layout: The top toolbar is sticky. 
         * We ensure the entire nav is pinned at top. 
         */
        .navbar .container-fluid {
            max-width: 100vw;
        }
        body {
            margin: 0;
            font-family: Arial, sans-serif;
        }
        .navbar {
            position: sticky;
            top: 0;
            z-index: 1000;
            background-color: #f8f9fa;
            padding: 0.5rem 1rem;
            width: 100%;
        }
        .navbar-collapse {
            display: flex !important;
            flex-wrap: wrap !important;
            align-items: flex-start !important;
        }
        .toolbar-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            padding: 0.5rem;
            border-left: 1px solid #dee2e6;
        }
        .toolbar-group:first-child {
            border-left: none;
            padding-left: 0;
        }

        /* Provide vertical stack for fields in timescale block */
        .stacked-field {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .timescale-block {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        .legend-container-vertical {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        /* Gantt container: position relative, holds the main table. */
        .gantt-container {
            margin: 0 1rem;
            position: relative;
        }

        /*
         * The main scroll wrapper. 
         * We keep a max-height so the header row can truly remain sticky. 
         */
        .table-wrapper {
            overflow: auto;
            position: relative;
            max-height: 75vh; 
        }

        /* 
         * Our main table: 
         * border-collapse => no extra spacing, 
         * table-layout: fixed => consistent column widths
         */
        #ganttTable {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
            position: relative;
        }

        /*
         * Add black gridlines to rows and columns:
         * 1px solid #000 on the table, header cells, etc.
         */
        #ganttTable,
        #ganttTable thead th,
        #ganttTable tbody td {
            border: 1px solid #000; /* black gridlines */
        }

        /* 
         * The header row must remain sticky at the top of the table-wrapper
         */
        #ganttTable thead {
            position: sticky;
            top: 0; 
            z-index: 50; 
            background: #f8f9fa; 
        }
        #ganttTable thead th {
            background-color: #f8f9fa;
            text-align: center;
            font-size: 0.9rem;
            padding: 4px 8px;
            box-sizing: border-box;
        }

        /* 
         * The first header cell => "Tasks" 
         */
        #nameHeader {
            width: 240px;
            text-align: center;
            font-weight: bold;
            background-color: #f8f9fa;
            z-index: 51;
        }

        /* Each timescale column => set min of 50px width */
        .timescale-header {
            background-color: #e9ecef;
            min-width: 50px;
        }

        /* Tbody for the main content. */
        #ganttTable tbody {
            position: relative;
        }

        /* 
         * Each row => dynamic height from a CSS variable 
         */
        .gantt-row {
            height: var(--row-height);
            transition: outline 0.2s;
        }
        /* highlight row if selected */
        .gantt-row.selected {
            background-color: #fff3cd;
        }
        /* highlight row in yellow if dragging */
        .gantt-row.drag-highlight {
            outline: 2px solid yellow;
        }

        /* 
         * The first cell in each row => name cell. 
         * Sticky left so tasks remain visible if horizontally scrolled.
         */
        .name-cell {
            position: sticky;
            left: 0;
            background-color: #f0f0f0;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.2);
            z-index: 9;
            width: 240px;
            display: flex;
            justify-content: center;
            align-items: center;
            height: var(--row-height);
            box-sizing: border-box;
            cursor: move; /* we drag lines from here */
        }

        /* 
         * The cell that spans columns for bars 
         */
        .bar-cell {
            position: relative;
            padding: 0;
        }

        /* 
         * Container for bars: absolutely placed elements 
         */
        .bar-row-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
        }

        /* 
         * The bar itself: absolute, with a set height. 
         */
        .bar {
            position: absolute;
            height: calc(var(--row-height) - 16px);
            top: auto;
            left: 0;
            border-radius: 4px;
            color: #fff;
            cursor: pointer;
            user-select: none;
            opacity: 0.7;
            overflow: hidden;
            z-index: 0;
            box-sizing: border-box;
        }
        .bar.selected {
            outline: 3px solid #00f;
        }
        .bar.highlighted {
            outline: 3px solid #0d6efd;
            opacity: 0.9;
        }

        /* 
         * The text inside a bar: 
         * absolutely placed, horizontally centered by JS 
         */
        .bar-text {
            position: absolute;
            top: 0;
            height: 100%;
            line-height: calc(var(--row-height) - 16px);
            white-space: nowrap;
            pointer-events: none;
            font-weight: 500;
            padding: 0 8px;
        }

        /* 
         * Resizing handles for admin mode 
         */
        .bar-handle {
            position: absolute;
            top: 0;
            width: 6px;
            height: 100%;
            cursor: col-resize;
            background-color: rgba(255,255,255,0.4);
            z-index: 2;
        }
        .bar-handle.left {
            left: 0;
            border-radius: 4px 0 0 4px;
        }
        .bar-handle.right {
            right: 0;
            border-radius: 0 4px 4px 0;
        }

        /* 
         * Overlap hatch => if bars overlap 
         */
        .overlap-hatch {
            position: absolute;
            height: calc(var(--row-height) - 16px);
            top: auto;
            background: repeating-linear-gradient(
                45deg,
                red,
                red 2px,
                transparent 2px,
                transparent 4px
            );
            opacity: 0.5;
            pointer-events: none;
            z-index: 1;
        }

        /* Editors => above everything. */
        #barEditor,
        #lineEditor {
            position: absolute;
            display: none;
            background: #fff;
            border: 1px solid #ccc;
            padding: 12px;
            border-radius: 6px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.5);
            z-index: 9999;
            min-width: 280px;
        }
        #barEditor label,
        #lineEditor label {
            display: block;
            margin-top: 8px;
            font-weight: 500;
        }
        #barEditor input,
        #barEditor select,
        #lineEditor input {
            margin-top: 4px;
            width: 100%;
        }
        #barEditorActions,
        #lineEditorActions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 12px;
        }

        /* Filter modal => in front of everything else except the editors. */
        #filterModal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            border: 1px solid #ccc;
            padding: 20px;
            border-radius: 6px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.5);
            z-index: 9999;
            min-width: 600px;
        }
        #filterModal h3 {
            margin-top: 0;
        }
        .filter-container {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            gap: 20px;
        }
        .filter-card {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .filter-card h5 {
            margin-top: 0;
            margin-bottom: 6px;
            font-size: 1rem;
            font-weight: 600;
        }
        #filterActions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 12px;
        }

        /* Settings modal => for color/theme settings. */
        #settingsModal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            border: 1px solid #ccc;
            padding: 20px;
            border-radius: 6px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.5);
            z-index: 9999;
            min-width: 300px;
        }
        #settingsModal h3 {
            margin-top: 0;
        }
        #settingsModal label {
            display: block;
            margin-top: 8px;
        }
        #settingsActions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 12px;
        }
        .color-picker {
            width: 60px;
            height: 30px;
            padding: 0;
            border: none;
            cursor: pointer;
        }

        /* Dark theme => toggled programmatically. */
        body.dark-theme {
            background-color: #212529;
            color: #f8f9fa;
        }
        body.dark-theme .navbar {
            background-color: #343a40 !important;
        }
        body.dark-theme #ganttTable thead th,
        body.dark-theme .timescale-header {
            background-color: #495057;
            color: #f8f9fa;
        }
        body.dark-theme .name-cell {
            background-color: #444;
            color: #f8f9fa;
            box-shadow: 1px 1px 3px rgba(255,255,255,0.2);
        }
        body.dark-theme .bar-text {
            color: #212529;
        }
        body.dark-theme #barEditor,
        body.dark-theme #lineEditor,
        body.dark-theme #filterModal,
        body.dark-theme #settingsModal,
        body.dark-theme #csvEditModal {
            background: #343a40;
            color: #f8f9fa;
            border: 1px solid #495057;
        }
        body.dark-theme input,
        body.dark-theme select,
        body.dark-theme textarea {
            background: #495057;
            color: #f8f9fa;
            border: 1px solid #6c757d;
        }

        /* Zoom slider styling => range input. */
        .zoom-slider {
            width: 120px;
            margin: 0 8px;
            height: 8px;
            border-radius: 4px;
            background: #ced4da;
            outline: none;
            -webkit-appearance: none;
            box-shadow: 0 2px 6px rgba(0,0,0,0.25);
        }
        .zoom-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #0d6efd;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .zoom-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #0d6efd;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        #heightZoomSlider {
            transform: rotate(-90deg);
            width: 100px;
        }

        /* CSV Edit modal => top of everything. */
        #csvEditModal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            width: 60%;
            height: 60%;
            transform: translate(-50%, -50%);
            background: #fff;
            border: 1px solid #ccc;
            padding: 10px;
            border-radius: 6px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.5);
            z-index: 99999;
            overflow: auto;
        }
        #csvTextarea {
            width: 100%;
            height: 70%;
            font-family: monospace;
            font-size: 0.9rem;
        }
        #csvEditModalActions {
            margin-top: 10px;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        /* Print => hide UI elements except table. */
        @media print {
            .navbar,
            #barEditor,
            #lineEditor,
            #filterModal,
            #settingsModal,
            #adminToggleBtn,
            #csvEditToggleBtn,
            #csvEditModal {
                display: none !important;
            }
            .table-wrapper {
                overflow: visible;
                max-height: none;
            }
            #ganttTable {
                font-size: 10pt;
            }
        }

        /* Help button => small hover effect. */
        #helpBtn {
            cursor: pointer;
            transition: transform 0.2s;
        }
        #helpBtn:hover {
            transform: scale(1.1);
        }

        /* Settings button => small hover effect. */
        #settingsBtn {
            cursor: pointer;
            transition: transform 0.2s;
        }
        #settingsBtn:hover {
            transform: scale(1.1);
        }
    </style>
</head>
<body>
<!-- Sticky navbar with stacked layout inside for space savings -->
<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
        <!-- Brand -->
        <a class="navbar-brand" href="#">Gantt Planner</a>
        <!-- Toggler -->
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
                aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <!-- Collapsible area -->
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <!-- Timescale group -->
            <div class="toolbar-group">
                <span>Timescale</span>
                <div class="timescale-block">
                    <div class="stacked-field">
                        <label for="startYearInput" class="form-label m-0">Start Year:</label>
                        <input id="startYearInput" type="number" class="form-control form-control-sm" value="2025" />
                    </div>
                    <div class="stacked-field">
                        <label for="startWeekInput" class="form-label m-0">Start Week:</label>
                        <input id="startWeekInput" type="number" class="form-control form-control-sm" value="1" />
                    </div>
                    <div class="stacked-field">
                        <label for="endYearInput" class="form-label m-0">End Year:</label>
                        <input id="endYearInput" type="number" class="form-control form-control-sm" value="2025" />
                    </div>
                    <div class="stacked-field">
                        <label for="endWeekInput" class="form-label m-0">End Week:</label>
                        <input id="endWeekInput" type="number" class="form-control form-control-sm" value="52" />
                    </div>
                    <button id="applyTimescaleBtn" class="btn btn-secondary btn-sm">Apply</button>
                </div>
            </div>

            <!-- Legend group -->
            <div class="toolbar-group">
                <span>Legend</span>
                <div id="statusLegend" class="legend-container-vertical">
                    <div class="legend-item">
                        <div class="legend-swatch" style="width:16px; height:16px; background:#28a745;"></div>
                        <span>Secured</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-swatch" style="width:16px; height:16px; background:#fd7e14;"></div>
                        <span>Proposed</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-swatch" style="width:16px; height:16px; background:#dc3545;"></div>
                        <span>Opportunity</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-swatch" style="width:16px; height:16px; background:#6f42c1;"></div>
                        <span>Future</span>
                    </div>
                </div>
            </div>

            <!-- Zoom group -->
            <div class="toolbar-group">
                <span>Zoom</span>
                <div style="display: flex; flex-direction: row; gap: 0.5rem;">
                    <div>
                        <label for="zoomSlider" class="form-label m-0 me-2">H-Zoom:</label>
                        <input type="range" class="zoom-slider" id="zoomSlider" min="50" max="300" value="150" step="10">
                    </div>
                    <div>
                        <label for="heightZoomSlider" class="form-label m-0 me-2">V-Zoom:</label>
                        <input type="range" class="zoom-slider" id="heightZoomSlider" min="30" max="100" value="40" step="5">
                    </div>
                </div>
            </div>

            <!-- Search group -->
            <div class="toolbar-group">
                <span>Search</span>
                <input type="text" id="searchInput" class="form-control form-control-sm" placeholder="Filter lines/bars..." />
            </div>

            <!-- Actions group -->
            <div class="toolbar-group">
                <span>Actions</span>
                <div style="display: flex; flex-wrap: wrap; gap:4px;">
                    <button id="addLineItemBtn" class="btn btn-primary btn-sm">Add Line</button>
                    <button id="addBarBtn" class="btn btn-secondary btn-sm">Add Bar</button>
                    <button id="filterBtn" class="btn btn-outline-primary btn-sm">Filter</button>
                    <button id="importJsonBtn" class="btn btn-outline-success btn-sm">Import</button>
                    <button id="exportJsonBtn" class="btn btn-outline-info btn-sm">Export JSON</button>
                    <button id="downloadCsvBtn" class="btn btn-outline-secondary btn-sm">Export CSV</button>
                    <button id="printBtn" class="btn btn-outline-dark btn-sm">Print/PDF</button>
                    <!-- Settings icon -->
                    <svg id="settingsBtn" width="24" height="24" viewBox="0 0 24 24" fill="none"
                         xmlns="http://www.w3.org/2000/svg">
                        <path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 0 0 .12-.61l-1.92-3.32a.488.488 0 0 0-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 0 0-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96a.488.488 0 0 0-.59.22l-1.92 3.32c-.14.24-.08.54.12.61l2.03 1.58c-.05.3-.09.63-.09.94 0 .31.04.64.07.94l-2.03 1.58a.49.49 0 0 0-.12.61l1.92 3.32c.14.24.37.34.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .43-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.45 0 .59-.22l1.92-3.32c.14-.24.08-.54-.12-.61l-2.03-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6 0-1.98 1.62-3.6 3.6-3.6 1.98 0 3.6 1.62 3.6 3.6 0 1.98-1.62 3.6-3.6 3.6z"
                              fill="#0d6efd"/>
                    </svg>
                    <!-- Help icon -->
                    <svg id="helpBtn" width="24" height="24" viewBox="0 0 24 24" fill="none"
                         xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 14.5v.5h-2v-1c0-1.11.45-2.11 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"
                              fill="#0d6efd"/>
                    </svg>
                    <button id="adminToggleBtn" class="btn btn-outline-danger btn-sm">Toggle Admin</button>
                    <button id="csvEditToggleBtn" class="btn btn-outline-dark btn-sm" style="display:none;">Edit CSV</button>
                </div>
            </div>

            <!-- Undo/Redo -->
            <div class="toolbar-group">
                <span>History</span>
                <div style="display: flex; flex-wrap: wrap; gap:4px;">
                    <button id="undoBtn" type="button" class="btn btn-sm btn-success">Undo</button>
                    <button id="redoBtn" type="button" class="btn btn-sm btn-warning">Redo</button>
                </div>
            </div>
        </div>
    </div>
</nav>

<!-- Gantt container with table wrapper -->
<div class="gantt-container">
    <div class="table-wrapper" id="tableWrapper">
        <table id="ganttTable">
            <thead>
            <tr id="headerRow">
                <th id="nameHeader">Tasks</th>
                <!-- Timescale columns appended dynamically -->
            </tr>
            </thead>
            <tbody id="tableBody">
            <!-- Rows generated dynamically -->
            </tbody>
        </table>
    </div>
</div>

<!-- Bar editor -->
<div id="barEditor">
    <!-- Single custom label for the bar, displayed inside the bar -->
    <label for="barLabelInput">Bar Label:</label>
    <input type="text" id="barLabelInput" placeholder="Bar Label..." />

    <label for="barProjectNameInput">Project Name:</label>
    <input type="text" id="barProjectNameInput" placeholder="Project Name..." />

    <label for="barClientInput">Client:</label>
    <input type="text" id="barClientInput" placeholder="Client..." />

    <label for="barDisciplineInput">Discipline:</label>
    <input type="text" id="barDisciplineInput" placeholder="Discipline..." />

    <label for="barExperienceInput">Experience:</label>
    <input type="text" id="barExperienceInput" placeholder="Experience..." />

    <label for="barLOEInput">LOE:</label>
    <input type="text" id="barLOEInput" placeholder="LOE..." />

    <label for="barLocationInput">Location:</label>
    <input type="text" id="barLocationInput" placeholder="Location..." />

    <label for="barTypeSelect">Type (affects color):</label>
    <select id="barTypeSelect">
        <option value="secured">Secured</option>
        <option value="proposed">Proposed</option>
        <option value="opportunity">Opportunity</option>
        <option value="future">Future</option>
    </select>

    <label for="barProposedSelect">Proposed:</label>
    <select id="barProposedSelect">
        <option value="yes">Yes</option>
        <option value="no">No</option>
    </select>

    <label for="startYearSelect">Start Date (Year/Week):</label>
    <select id="startYearSelect"></select>
    <select id="startWeekSelect"></select>

    <label for="endYearSelect">End Date (Year/Week):</label>
    <select id="endYearSelect"></select>
    <select id="endWeekSelect"></select>

    <div id="barEditorActions">
        <button id="barDeleteBtn" class="btn btn-sm btn-danger">Delete Bar</button>
        <button id="barEditorOkBtn" class="btn btn-sm btn-primary">OK</button>
        <button id="barEditorCancelBtn" class="btn btn-sm btn-secondary">Cancel</button>
    </div>
</div>

<!-- Line editor -->
<div id="lineEditor">
    <label for="lineNameInput">Name:</label>
    <input type="text" id="lineNameInput" placeholder="Name..." />

    <label for="lineDisciplineInput">Discipline:</label>
    <input type="text" id="lineDisciplineInput" placeholder="Discipline..." />

    <label for="lineExperienceInput">Experience:</label>
    <input type="text" id="lineExperienceInput" placeholder="Experience..." />

    <label for="lineOfficeLocationInput">Office Location:</label>
    <input type="text" id="lineOfficeLocationInput" placeholder="Office Location..." />

    <label for="lineGeoLocationInput">Geo Location:</label>
    <input type="text" id="lineGeoLocationInput" placeholder="Geo Location..." />

    <label for="lineTypeInput">Type:</label>
    <input type="text" id="lineTypeInput" placeholder="Type..." />

    <div id="lineEditorActions">
        <button id="lineDeleteBtn" class="btn btn-sm btn-danger">Delete Line Item</button>
        <button id="lineEditorOkBtn" class="btn btn-sm btn-primary">OK</button>
        <button id="lineEditorCancelBtn" class="btn btn-sm btn-secondary">Cancel</button>
    </div>
</div>

<!-- Filter modal -->
<div id="filterModal">
    <h3>Filter Lines/Bars</h3>
    <div class="filter-container">
        <!-- Left filter card: line item attributes -->
        <div class="filter-card">
            <h5>Line Item Filters</h5>
            <label for="filterLineName">Name:</label>
            <input type="text" id="filterLineName" placeholder="Name..." />

            <label for="filterLineDiscipline">Discipline:</label>
            <input type="text" id="filterLineDiscipline" placeholder="Discipline..." />

            <label for="filterLineExperience">Experience:</label>
            <input type="text" id="filterLineExperience" placeholder="Experience..." />

            <label for="filterLineOfficeLocation">Office Location:</label>
            <input type="text" id="filterLineOfficeLocation" placeholder="Office Location..." />

            <label for="filterLineGeoLocation">Geo Location:</label>
            <input type="text" id="filterLineGeoLocation" placeholder="Geo Location..." />

            <label for="filterLineType">Type:</label>
            <input type="text" id="filterLineType" placeholder="Type..." />
        </div>

        <!-- Right filter card: bar attributes -->
        <div class="filter-card">
            <h5>Bar Filters</h5>
            <label for="filterBarProjectName">Project Name:</label>
            <input type="text" id="filterBarProjectName" placeholder="Project Name..." />

            <label for="filterBarClient">Client:</label>
            <input type="text" id="filterBarClient" placeholder="Client..." />

            <label for="filterBarDiscipline">Discipline:</label>
            <input type="text" id="filterBarDiscipline" placeholder="Discipline..." />

            <label for="filterBarExperience">Experience:</label>
            <input type="text" id="filterBarExperience" placeholder="Experience..." />

            <label for="filterBarLOE">LOE:</label>
            <input type="text" id="filterBarLOE" placeholder="LOE..." />

            <label for="filterBarLocation">Location:</label>
            <input type="text" id="filterBarLocation" placeholder="Location..." />

            <label for="filterBarType">Type:</label>
            <input type="text" id="filterBarType" placeholder="Type..." />

            <label for="filterBarProposed">Proposed:</label>
            <input type="text" id="filterBarProposed" placeholder="Yes/No..." />
        </div>
    </div>
    <div id="filterActions">
        <button id="filterApplyBtn" class="btn btn-sm btn-primary">Apply</button>
        <button id="filterClearBtn" class="btn btn-sm btn-secondary">Clear</button>
        <button id="filterCancelBtn" class="btn btn-sm btn-secondary">Cancel</button>
    </div>
</div>

<!-- Settings modal -->
<div id="settingsModal">
    <h3>Theme Settings</h3>
    <label>Theme:</label>
    <select id="themeSelect">
        <option value="light">Light</option>
        <option value="dark">Dark</option>
    </select>

    <label for="securedColor">Secured Color:</label>
    <input type="color" id="securedColor" class="color-picker" value="#28a745" />

    <label for="proposedColor">Proposed Color:</label>
    <input type="color" id="proposedColor" class="color-picker" value="#fd7e14" />

    <label for="opportunityColor">Opportunity Color:</label>
    <input type="color" id="opportunityColor" class="color-picker" value="#dc3545" />

    <label for="futureColor">Future Color:</label>
    <input type="color" id="futureColor" class="color-picker" value="#6f42c1" />

    <div id="settingsActions">
        <button id="settingsOkBtn" class="btn btn-sm btn-primary">Apply</button>
        <button id="settingsCancelBtn" class="btn btn-sm btn-secondary">Cancel</button>
    </div>
</div>

<!-- CSV Edit modal -->
<div id="csvEditModal">
    <h3>Edit CSV In-Browser</h3>
    <textarea id="csvTextarea"></textarea>
    <div id="csvEditModalActions">
        <button id="csvEditApplyBtn" class="btn btn-sm btn-primary">Apply Changes</button>
        <button id="csvEditCancelBtn" class="btn btn-sm btn-secondary">Close</button>
    </div>
</div>

<!-- Hidden file input for import -->
<input type="file" id="importFileInput" accept=".json,.csv" style="display:none;" />

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
/*
    ---------------------------------------------------------------------------------------------
    GLOBAL VARIABLES/OBJECTS
    ---------------------------------------------------------------------------------------------
*/
let adminMode = false;

/* Tie bar 'type' => color */
let typeColors = {
    secured: "#28a745",
    proposed: "#fd7e14",
    opportunity: "#dc3545",
    future: "#6f42c1",
};

/* 
 * lines array with bars
 * We have only one "label" field for bars, removed the extra label.
 */
let lines = [
    {
        id: 1,
        name: "Line Item 1",
        discipline: "",
        experience: "",
        officeLocation: "",
        geoLocation: "",
        type: "",
        bars: [
            {
                id: 101,
                label: "Bar A Label",  // The main label for the bar
                projectName: "Bar A",
                client: "",
                discipline: "",
                experience: "",
                LOE: "",
                location: "",
                proposed: "no",
                type: "secured",
                startAbsWeek: toAbsoluteWeek(2025, 2),
                length: 4,
                selected: false
            },
        ],
        selected: false,
        dragging: false
    },
    {
        id: 2,
        name: "Line Item 2",
        discipline: "",
        experience: "",
        officeLocation: "",
        geoLocation: "",
        type: "",
        bars: [
            {
                id: 102,
                label: "Bar B Label",
                projectName: "Bar B",
                client: "",
                discipline: "",
                experience: "",
                LOE: "",
                location: "",
                proposed: "yes",
                type: "proposed",
                startAbsWeek: toAbsoluteWeek(2025, 10),
                length: 7,
                selected: false
            },
        ],
        selected: false,
        dragging: false
    },
];

let startYear = 2025;
let startWeek = 1;
let endYear = 2025;
let endWeek = 52;
let lineCounter = 2;
let barCounter = 102;
let cellWidth = 150;
let rowHeight = 40;
let filters = { line:{}, bar:{} };
let searchTerm = "";
let currentTheme = "light";
let undoStack = [];
let redoStack = [];

// For dragging
let dragging = false;
let dragType = null;
let dragStartX = 0;
let dragStartY = 0;
let initialStartAbs = 0;
let initialLength = 0;
let currentBar = null;
let currentLine = null;
let draggingLine = null;
let tableBodyRect = null;
let mainFilteredLines = [];

// For editors
let currentEditorBar = null;
let currentEditorLine = null;

/*
    ---------------------------------------------------------------------------------------------
    DOM References
    ---------------------------------------------------------------------------------------------
*/
const tableBody = document.getElementById("tableBody");
const headerRow = document.getElementById("headerRow");
const tableWrapper = document.getElementById("tableWrapper");

const startYearInput = document.getElementById("startYearInput");
const startWeekInput = document.getElementById("startWeekInput");
const endYearInput = document.getElementById("endYearInput");
const endWeekInput = document.getElementById("endWeekInput");
const applyTimescaleBtn = document.getElementById("applyTimescaleBtn");

const zoomSlider = document.getElementById("zoomSlider");
const heightZoomSlider = document.getElementById("heightZoomSlider");
const searchInput = document.getElementById("searchInput");
const filterBtn = document.getElementById("filterBtn");
const importJsonBtn = document.getElementById("importJsonBtn");
const exportJsonBtn = document.getElementById("exportJsonBtn");
const downloadCsvBtn = document.getElementById("downloadCsvBtn");
const printBtn = document.getElementById("printBtn");
const adminToggleBtn = document.getElementById("adminToggleBtn");
const csvEditToggleBtn = document.getElementById("csvEditToggleBtn");
const addLineItemBtn = document.getElementById("addLineItemBtn");
const addBarBtn = document.getElementById("addBarBtn");

// bar editor fields
const barLabelInput = document.getElementById("barLabelInput");
const barProjectNameInput = document.getElementById("barProjectNameInput");
const barClientInput = document.getElementById("barClientInput");
const barDisciplineInput = document.getElementById("barDisciplineInput");
const barExperienceInput = document.getElementById("barExperienceInput");
const barLOEInput = document.getElementById("barLOEInput");
const barLocationInput = document.getElementById("barLocationInput");
const barTypeSelect = document.getElementById("barTypeSelect");
const barProposedSelect = document.getElementById("barProposedSelect");
const startYearSelect = document.getElementById("startYearSelect");
const startWeekSelect = document.getElementById("startWeekSelect");
const endYearSelect = document.getElementById("endYearSelect");
const endWeekSelect = document.getElementById("endWeekSelect");
const barEditor = document.getElementById("barEditor");
const barEditorOkBtn = document.getElementById("barEditorOkBtn");
const barEditorCancelBtn = document.getElementById("barEditorCancelBtn");
const barDeleteBtn = document.getElementById("barDeleteBtn");

// line editor fields
const lineEditor = document.getElementById("lineEditor");
const lineNameInput = document.getElementById("lineNameInput");
const lineDisciplineInput = document.getElementById("lineDisciplineInput");
const lineExperienceInput = document.getElementById("lineExperienceInput");
const lineOfficeLocationInput = document.getElementById("lineOfficeLocationInput");
const lineGeoLocationInput = document.getElementById("lineGeoLocationInput");
const lineTypeInput = document.getElementById("lineTypeInput");
const lineEditorOkBtn = document.getElementById("lineEditorOkBtn");
const lineEditorCancelBtn = document.getElementById("lineEditorCancelBtn");
const lineDeleteBtn = document.getElementById("lineDeleteBtn");

// filter modal
const filterModal = document.getElementById("filterModal");
const filterLineName = document.getElementById("filterLineName");
const filterLineDiscipline = document.getElementById("filterLineDiscipline");
const filterLineExperience = document.getElementById("filterLineExperience");
const filterLineOfficeLocation = document.getElementById("filterLineOfficeLocation");
const filterLineGeoLocation = document.getElementById("filterLineGeoLocation");
const filterLineType = document.getElementById("filterLineType");
const filterBarProjectName = document.getElementById("filterBarProjectName");
const filterBarClient = document.getElementById("filterBarClient");
const filterBarDiscipline = document.getElementById("filterBarDiscipline");
const filterBarExperience = document.getElementById("filterBarExperience");
const filterBarLOE = document.getElementById("filterBarLOE");
const filterBarLocation = document.getElementById("filterBarLocation");
const filterBarType = document.getElementById("filterBarType");
const filterBarProposed = document.getElementById("filterBarProposed");
const filterApplyBtn = document.getElementById("filterApplyBtn");
const filterClearBtn = document.getElementById("filterClearBtn");
const filterCancelBtn = document.getElementById("filterCancelBtn");

// settings
const settingsModal = document.getElementById("settingsModal");
const themeSelect = document.getElementById("themeSelect");
const securedColor = document.getElementById("securedColor");
const proposedColor = document.getElementById("proposedColor");
const opportunityColor = document.getElementById("opportunityColor");
const futureColor = document.getElementById("futureColor");
const settingsOkBtn = document.getElementById("settingsOkBtn");
const settingsCancelBtn = document.getElementById("settingsCancelBtn");

// CSV
const csvEditModal = document.getElementById("csvEditModal");
const csvTextarea = document.getElementById("csvTextarea");
const csvEditApplyBtn = document.getElementById("csvEditApplyBtn");
const csvEditCancelBtn = document.getElementById("csvEditCancelBtn");
const importFileInput = document.getElementById("importFileInput");

/*
    ---------------------------------------------------------------------------------------------
    TIME HELPERS
    ---------------------------------------------------------------------------------------------
*/
function toAbsoluteWeek(year, week) {
    return year * 52 + (week - 1);
}
function fromAbsoluteWeek(abs) {
    const y = Math.floor(abs / 52);
    const w = (abs % 52) + 1;
    return { year: y, week: w };
}
function getMonthFromYearWeek(year, week) {
    let january4 = new Date(year, 0, 4);
    let dayMs = 24 * 3600 * 1000;
    let offsetDays = (week - 1)*7 - ((january4.getDay() + 6) % 7);
    let date = new Date(january4.getTime() + offsetDays * dayMs);
    return date.getMonth();
}
function getMonthName(m) {
    const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    return months[m] || "";
}
function getColorFromType(t) {
    return typeColors[t] || "#fd7e14";
}

/*
    ---------------------------------------------------------------------------------------------
    LOCAL STORAGE
    ---------------------------------------------------------------------------------------------
*/
function saveToLocalStorage() {
    const chartData = {
        lines,
        startYear,
        startWeek,
        endYear,
        endWeek,
        lineCounter,
        barCounter,
        cellWidth,
        rowHeight,
        typeColors,
        currentTheme
    };
    localStorage.setItem("ganttChartData", JSON.stringify(chartData));
}
function loadFromLocalStorage() {
    const stored = localStorage.getItem("ganttChartData");
    if (!stored) return;
    try {
        let parsed = JSON.parse(stored);
        lines = parsed.lines || [];
        lines.forEach(line => {
            line.selected = false;
            line.dragging = false;
            line.bars.forEach(bar => {
                bar.selected = false;
                if (bar.type === undefined) bar.type = "proposed";
                if (bar.label === undefined) bar.label = "";
            });
        });
        startYear = parsed.startYear || 2025;
        startWeek = parsed.startWeek || 1;
        endYear = parsed.endYear || 2025;
        endWeek = parsed.endWeek || 52;
        lineCounter = parsed.lineCounter || 0;
        barCounter = parsed.barCounter || 0;
        cellWidth = parsed.cellWidth || 150;
        rowHeight = parsed.rowHeight || 40;
        typeColors = parsed.typeColors || typeColors;
        currentTheme = parsed.currentTheme || "light";
    } catch (err) {
        console.warn("Invalid localStorage data");
    }
}

/*
    ---------------------------------------------------------------------------------------------
    THEME & CSS
    ---------------------------------------------------------------------------------------------
*/
function applyTheme() {
    if (currentTheme === "dark") {
        document.body.classList.add("dark-theme");
    } else {
        document.body.classList.remove("dark-theme");
    }
    renderTable();
    saveToLocalStorage();
}
function updateCSSVariables() {
    document.documentElement.style.setProperty("--cell-width", cellWidth + "px");
    document.documentElement.style.setProperty("--row-height", rowHeight + "px");
}

/*
    ---------------------------------------------------------------------------------------------
    getDisplayRange => from user input in timescale
    ---------------------------------------------------------------------------------------------
*/
function getDisplayRange() {
    let ds = toAbsoluteWeek(startYear, startWeek);
    let de = toAbsoluteWeek(endYear, endWeek);
    if (ds > de) [ds, de] = [de, ds];
    return { displayStart: ds, displayEnd: de };
}

/*
    ---------------------------------------------------------------------------------------------
    UNSELECT/HIGHLIGHT UTILS
    ---------------------------------------------------------------------------------------------
*/
function unselectAllBars() {
    lines.forEach(line => line.bars.forEach(bar => bar.selected = false));
}
function clearHighlights() {
    document.querySelectorAll('.bar.highlighted').forEach(el => el.classList.remove('highlighted'));
}

/*
    ---------------------------------------------------------------------------------------------
    updateBarTextPositions => keep bar text horizontally centered if visible
    ---------------------------------------------------------------------------------------------
*/
function updateBarTextPositions() {
    let scrollLeft = tableWrapper.scrollLeft;
    let viewportWidth = tableWrapper.clientWidth;
    document.querySelectorAll(".bar-text").forEach(textEl => {
        let barEl = textEl.parentElement;
        let barLeft = parseFloat(barEl.style.left);
        let barWidth = parseFloat(barEl.style.width);
        let barRight = barLeft + barWidth;
        let visibleLeft = Math.max(barLeft, scrollLeft);
        let visibleRight = Math.min(barRight, scrollLeft + viewportWidth);
        let visibleWidth = visibleRight - visibleLeft;
        if (visibleWidth <= 0) {
            textEl.style.opacity = "0";
            return;
        }
        textEl.style.opacity = "1";
        let textWidth = textEl.offsetWidth;
        let textLeft = (visibleLeft - barLeft) + (visibleWidth - textWidth)/2;
        if (textLeft < 5) textLeft = 5;
        if (textLeft + textWidth > barWidth - 5) textLeft = barWidth - textWidth - 5;
        textEl.style.left = textLeft + "px";
    });
}

/*
    ---------------------------------------------------------------------------------------------
    renderHeader => builds timescale columns
    ---------------------------------------------------------------------------------------------
*/
function renderHeader() {
    // remove old timescale columns
    while (headerRow.children.length > 1) {
        headerRow.removeChild(headerRow.lastChild);
    }
    let { displayStart, displayEnd } = getDisplayRange();
    let totalWeeks = displayEnd - displayStart + 1;
    if (totalWeeks < 1) return;

    // We'll simply create columns for each week
    for (let i=0; i< totalWeeks; i++){
        let abs= displayStart + i;
        let {year, week}= fromAbsoluteWeek(abs);
        let th= document.createElement("th");
        th.className="timescale-header";
        // Show something like "2025-W10 (Mar)" 
        let mIdx= getMonthFromYearWeek(year, week);
        th.textContent= `${year}-W${week} (${getMonthName(mIdx)})`;
        th.style.width= cellWidth+"px";
        headerRow.appendChild(th);
    }
}

/*
    ---------------------------------------------------------------------------------------------
    handleBarClickSelect => shift/ctrl multi
    ---------------------------------------------------------------------------------------------
*/
function handleBarClickSelect(bar, evt) {
    let multi = evt.shiftKey || evt.ctrlKey || evt.metaKey;
    if(!multi){
        unselectAllBars();
        bar.selected= true;
    } else {
        bar.selected= !bar.selected;
    }
}

/*
    ---------------------------------------------------------------------------------------------
    renderTable => main UI drawing
    ---------------------------------------------------------------------------------------------
*/
function renderTable() {
    renderHeader();
    tableBody.innerHTML= "";
    clearHighlights();

    let { displayStart, displayEnd }= getDisplayRange();
    let totalWeeks= displayEnd- displayStart + 1;
    if(totalWeeks<1) return;

    let lowerSearch= searchTerm.toLowerCase();

    // filter lines
    let filteredLines= lines.filter(line=>{
        // line-level filters
        const linePass= (
            (!filters.line.name || (line.name && line.name.toLowerCase().includes(filters.line.name.toLowerCase()))) &&
            (!filters.line.discipline || (line.discipline && line.discipline.toLowerCase().includes(filters.line.discipline.toLowerCase()))) &&
            (!filters.line.experience || (line.experience && line.experience.toLowerCase().includes(filters.line.experience.toLowerCase()))) &&
            (!filters.line.officeLocation || (line.officeLocation && line.officeLocation.toLowerCase().includes(filters.line.officeLocation.toLowerCase()))) &&
            (!filters.line.geoLocation || (line.geoLocation && line.geoLocation.toLowerCase().includes(filters.line.geoLocation.toLowerCase()))) &&
            (!filters.line.type || (line.type && line.type.toLowerCase().includes(filters.line.type.toLowerCase())))
        );
        // bar-level => at least 1 bar must pass
        const barPass= line.bars.some(b=>{
            const condProj= (!filters.bar.projectName || (b.projectName && b.projectName.toLowerCase().includes(filters.bar.projectName.toLowerCase())));
            const condClient=(!filters.bar.client || (b.client && b.client.toLowerCase().includes(filters.bar.client.toLowerCase())));
            const condDis=(!filters.bar.discipline || (b.discipline && b.discipline.toLowerCase().includes(filters.bar.discipline.toLowerCase())));
            const condExp=(!filters.bar.experience|| (b.experience && b.experience.toLowerCase().includes(filters.bar.experience.toLowerCase())));
            const condLOE=(!filters.bar.LOE|| (b.LOE && b.LOE.toLowerCase().includes(filters.bar.LOE.toLowerCase())));
            const condLoc=(!filters.bar.location|| (b.location && b.location.toLowerCase().includes(filters.bar.location.toLowerCase())));
            const condType=(!filters.bar.type|| (b.type && b.type.toLowerCase().includes(filters.bar.type.toLowerCase())));
            const condProp=(!filters.bar.proposed|| (b.proposed && b.proposed.toLowerCase().includes(filters.bar.proposed.toLowerCase())));
            return(condProj && condClient && condDis && condExp && condLOE && condLoc && condType && condProp);
        });
        if(!linePass) return false;
        if(!barPass && line.bars.length>0) return false;

        // search
        if(lowerSearch){
            let lineMatch= (
                (line.name && line.name.toLowerCase().includes(lowerSearch))||
                (line.discipline && line.discipline.toLowerCase().includes(lowerSearch))||
                (line.experience && line.experience.toLowerCase().includes(lowerSearch))||
                (line.officeLocation && line.officeLocation.toLowerCase().includes(lowerSearch))||
                (line.geoLocation && line.geoLocation.toLowerCase().includes(lowerSearch))||
                (line.type && line.type.toLowerCase().includes(lowerSearch))
            );
            let barMatch= line.bars.some(b=>{
                const bFields=[
                    (b.label||"").toLowerCase(),
                    (b.projectName||"").toLowerCase(),
                    (b.client||"").toLowerCase(),
                    (b.discipline||"").toLowerCase(),
                    (b.experience||"").toLowerCase(),
                    (b.LOE||"").toLowerCase(),
                    (b.location||"").toLowerCase(),
                    (b.type||"").toLowerCase(),
                    (b.proposed||"").toLowerCase()
                ];
                return bFields.some(f=> f.includes(lowerSearch));
            });
            if(!lineMatch && !barMatch) return false;
        }
        return true;
    });

    mainFilteredLines= filteredLines;

    // For each line => build a table row
    filteredLines.forEach((line, lineIndex)=>{
        const tr= document.createElement("tr");
        tr.className="gantt-row";
        if(line.selected) tr.classList.add("selected");
        if(line.dragging) tr.classList.add("drag-highlight");

        // name cell
        const nameTd= document.createElement("td");
        nameTd.className="name-cell";
        nameTd.addEventListener("mousedown", e=> onLineMouseDown(e, line, lineIndex));
        // right-click => line editor
        nameTd.addEventListener("contextmenu", e=>{
            e.preventDefault();
            showLineEditor(line, e.clientX, e.clientY);
        });
        const labelSpan= document.createElement("span");
        labelSpan.textContent= line.name;
        nameTd.appendChild(labelSpan);
        tr.appendChild(nameTd);

        // bar cell => colSpan all weeks
        const barTd= document.createElement("td");
        barTd.colSpan= totalWeeks;
        barTd.className="bar-cell";
        const barContainer= document.createElement("div");
        barContainer.className="bar-row-container";

        // right-click blank => add bar
        barContainer.addEventListener("contextmenu", ev=>{
            if(adminMode){
                if(!ev.target.classList.contains("bar") &&
                   !ev.target.classList.contains("bar-text") &&
                   !ev.target.classList.contains("bar-handle"))
                {
                   ev.preventDefault();
                   barCounter++;
                   let offsetX= ev.offsetX;
                   let weeksFromStart= Math.floor(offsetX / cellWidth);
                   let { displayStart }= getDisplayRange();
                   let nb={
                       id: barCounter,
                       label:"",
                       projectName:"New Project",
                       client:"",
                       discipline:"",
                       experience:"",
                       LOE:"",
                       location:"",
                       proposed:"no",
                       type:"proposed",
                       startAbsWeek: displayStart + weeksFromStart,
                       length:4,
                       selected:false
                   };
                   line.bars.push(nb);
                   pushState();
                   renderTable();
                   saveToLocalStorage();
                }
            }
        });

        // Render each bar
        line.bars.forEach(bar=>{
            let barStart= bar.startAbsWeek;
            let barEnd= barStart+ bar.length;
            let overlapStart= Math.max(displayStart, barStart);
            let overlapEnd= Math.min(displayEnd+1, barEnd);
            let overlapLen= overlapEnd- overlapStart;
            if(overlapLen<=0) return;

            let barLeftPx= (overlapStart- displayStart)* cellWidth;
            let barWidthPx= overlapLen* cellWidth;
            const barDiv= document.createElement("div");
            barDiv.classList.add("bar");
            if(bar.selected) barDiv.classList.add("selected");
            // highlight if search matched bar name
            if(lowerSearch && bar.projectName.toLowerCase().includes(lowerSearch)) {
                barDiv.classList.add("highlighted");
            }
            barDiv.style.left= barLeftPx + "px";
            barDiv.style.width= barWidthPx + "px";
            barDiv.style.backgroundColor= getColorFromType(bar.type);

            // bar text => bar.label
            const textSpan= document.createElement("span");
            textSpan.className="bar-text";
            textSpan.textContent= bar.label || bar.projectName;
            barDiv.appendChild(textSpan);

            // if admin => show resize handles
            if(adminMode){
                const leftHandle= document.createElement("div");
                leftHandle.classList.add("bar-handle","left");
                const rightHandle= document.createElement("div");
                rightHandle.classList.add("bar-handle","right");
                barDiv.appendChild(leftHandle);
                barDiv.appendChild(rightHandle);
            }

            // right-click => bar editor
            barDiv.addEventListener("contextmenu", e=>{
                e.preventDefault();
                showBarEditor(bar,line,e.clientX,e.clientY);
            });
            // click => select
            barDiv.addEventListener("click", e=>{
                e.stopPropagation();
                handleBarClickSelect(bar,e);
                renderTable();
                saveToLocalStorage();
            });
            // mousedown => bar drag
            barDiv.addEventListener("mousedown", e=> onBarMouseDown(e,line,bar,lineIndex));

            // add to barContainer
            barContainer.appendChild(barDiv);
        });

        // Overlap hatch => detect overlapping bars
        let sorted=[...line.bars].sort((a,b)=> a.startAbsWeek - b.startAbsWeek);
        for(let i=0; i< sorted.length; i++){
            for(let j=i+1; j< sorted.length; j++){
                let b1= sorted[i];
                let b2= sorted[j];
                let s1= Math.max(displayStart, b1.startAbsWeek);
                let e1= Math.min(displayEnd+1, b1.startAbsWeek+b1.length);
                let s2= Math.max(displayStart, b2.startAbsWeek);
                let e2= Math.min(displayEnd+1, b2.startAbsWeek+b2.length);
                let overlapS= Math.max(s1,s2);
                let overlapE= Math.min(e1,e2);
                if(overlapE> overlapS){
                    let leftPx= (overlapS- displayStart)* cellWidth;
                    let wPx= (overlapE- overlapS)* cellWidth;
                    let hatch= document.createElement("div");
                    hatch.className="overlap-hatch";
                    hatch.style.left= leftPx+ "px";
                    hatch.style.width= wPx+ "px";
                    barContainer.appendChild(hatch);
                }
            }
        }

        barTd.appendChild(barContainer);
        tr.appendChild(barTd);
        tableBody.appendChild(tr);
    });

    updateBarTextPositions();
}

/*
    ---------------------------------------------------------------------------------------------
    onLineMouseDown => reorder lines 
    ---------------------------------------------------------------------------------------------
*/
function onLineMouseDown(e, line, lineIndex){
    dragging= true;
    dragType="line-reorder";
    draggingLine=line;
    line.dragging=true;
    tableBodyRect= tableBody.getBoundingClientRect();
    renderTable();
    e.preventDefault();
}

/*
    ---------------------------------------------------------------------------------------------
    onBarMouseDown => bar drag or resize
    ---------------------------------------------------------------------------------------------
*/
function onBarMouseDown(e, line, bar, lineIndex){
    dragging= true;
    currentBar= bar;
    currentLine= line;
    dragStartX= e.clientX;
    dragStartY= e.clientY;
    initialStartAbs= bar.startAbsWeek;
    initialLength= bar.length;
    tableBodyRect= tableBody.getBoundingClientRect();

    if(adminMode){
        if(e.target.classList.contains("bar-handle")){
            if(e.target.classList.contains("left")) dragType="resize-left";
            else dragType="resize-right";
        } else {
            dragType="bar-move-admin";
        }
    } else {
        dragType="bar-move-user";
    }
    e.preventDefault();
}

/*
    ---------------------------------------------------------------------------------------------
    MOUSEMOVE => handle dragging (line or bar)
    ---------------------------------------------------------------------------------------------
*/
document.addEventListener("mousemove", e=>{
    if(!dragging) return;

    if(dragType==="line-reorder" && draggingLine){
        let posY= e.clientY - tableBodyRect.top;
        let newIndex= Math.floor(posY / rowHeight);
        if(newIndex<0) newIndex=0;
        if(newIndex>= mainFilteredLines.length) newIndex= mainFilteredLines.length-1;
        let oldIndex= mainFilteredLines.indexOf(draggingLine);
        if(oldIndex<0)return;
        if(newIndex!== oldIndex){
            lines.splice(lines.indexOf(draggingLine), 1);
            let targetLine= mainFilteredLines[newIndex];
            let targetGlobalIdx= lines.indexOf(targetLine);
            if(targetGlobalIdx<0) targetGlobalIdx= lines.length;
            lines.splice(targetGlobalIdx, 0, draggingLine);
            renderTable();
        }
    }
    else if(dragType==="bar-move-admin" && currentBar){
        let dx= e.clientX- dragStartX;
        let dWeeks= Math.round(dx/cellWidth);
        currentBar.startAbsWeek= Math.max(0, initialStartAbs + dWeeks);

        let posY= e.clientY- tableBodyRect.top;
        let idxCur= mainFilteredLines.indexOf(currentLine);
        if(idxCur<0) idxCur= 0;
        let newIdx= Math.floor(posY / rowHeight);
        if(newIdx<0) newIdx=0;
        if(newIdx>= mainFilteredLines.length) newIdx= mainFilteredLines.length-1;
        if(newIdx!== idxCur){
            // remove bar from old line
            currentLine.bars= currentLine.bars.filter(b=> b.id!== currentBar.id);
            // push bar to new line
            mainFilteredLines[newIdx].bars.push(currentBar);
            currentLine= mainFilteredLines[newIdx];
        }
        renderTable();
    }
    else if(dragType==="resize-left" && currentBar){
        let dx= e.clientX- dragStartX;
        let dWeeks= Math.round(dx / cellWidth);
        let newStart= initialStartAbs + dWeeks;
        let newLen= initialStartAbs + initialLength - newStart;
        if(newLen<1){
            newLen=1;
            newStart= initialStartAbs + initialLength-1;
        }
        currentBar.startAbsWeek= Math.max(0, newStart);
        currentBar.length= newLen;
        renderTable();
    }
    else if(dragType==="resize-right" && currentBar){
        let dx= e.clientX- dragStartX;
        let dWeeks= Math.round(dx / cellWidth);
        let newLen= initialLength + dWeeks;
        if(newLen<1)newLen=1;
        currentBar.length= newLen;
        renderTable();
    }
    else if(dragType==="bar-move-user" && currentBar){
        // user can only move bar vertically among visible lines
        let posY= e.clientY- tableBodyRect.top;
        let newIndex= Math.floor(posY/ rowHeight);
        if(newIndex<0) newIndex=0;
        if(newIndex>= mainFilteredLines.length) newIndex= mainFilteredLines.length-1;
        // find old line
        let oldLineIdx= mainFilteredLines.indexOf(currentLine);
        if(oldLineIdx<0) oldLineIdx=0;
        if(newIndex!== oldLineIdx){
            mainFilteredLines[oldLineIdx].bars= mainFilteredLines[oldLineIdx].bars.filter(b=> b.id!== currentBar.id);
            mainFilteredLines[newIndex].bars.push(currentBar);
            currentLine= mainFilteredLines[newIndex];
            renderTable();
        }
    }
});

/*
    ---------------------------------------------------------------------------------------------
    MOUSEUP => finalize drag
    ---------------------------------------------------------------------------------------------
*/
document.addEventListener("mouseup", e=>{
    if(!dragging) return;
    dragging=false;
    if(dragType==="line-reorder"){
        draggingLine.dragging=false;
        draggingLine=null;
        pushState();
        saveToLocalStorage();
        renderTable();
    }
    else if(["bar-move-admin","resize-left","resize-right","bar-move-user"].includes(dragType)){
        currentBar=null;
        currentLine=null;
        pushState();
        saveToLocalStorage();
    }
    dragType=null;
});

/*
    ---------------------------------------------------------------------------------------------
    Document click => unselect lines/bars if user clicks blank area 
    ---------------------------------------------------------------------------------------------
*/
document.addEventListener("click", evt=>{
    if(!dragging){
        let nm= evt.target.closest(".name-cell");
        let br= evt.target.closest(".bar");
        if(!nm && !br){
            lines.forEach(l=> l.selected=false);
            unselectAllBars();
            renderTable();
            saveToLocalStorage();
        }
    }
});

/*
    ---------------------------------------------------------------------------------------------
    showBarEditor => open bar editor form
    ---------------------------------------------------------------------------------------------
*/
function showBarEditor(bar, line, x, y){
    currentEditorBar= bar;
    currentEditorLine= line;

    barLabelInput.value= bar.label||"";
    barProjectNameInput.value= bar.projectName||"";
    barClientInput.value= bar.client||"";
    barDisciplineInput.value= bar.discipline||"";
    barExperienceInput.value= bar.experience||"";
    barLOEInput.value= bar.LOE||"";
    barLocationInput.value= bar.location||"";
    barTypeSelect.value= bar.type||"proposed";
    barProposedSelect.value= bar.proposed||"no";

    let {year:sy, week:sw} = fromAbsoluteWeek(bar.startAbsWeek);
    let {year:ey, week:ew} = fromAbsoluteWeek(bar.startAbsWeek + bar.length -1);
    startYearSelect.value= sy;
    startWeekSelect.value= sw;
    endYearSelect.value= ey;
    endWeekSelect.value= ew;

    let ro= !adminMode;
    barLabelInput.disabled= ro;
    barProjectNameInput.disabled= ro;
    barClientInput.disabled= ro;
    barDisciplineInput.disabled= ro;
    barExperienceInput.disabled= ro;
    barLOEInput.disabled= ro;
    barLocationInput.disabled= ro;
    barTypeSelect.disabled= ro;
    barProposedSelect.disabled= ro;
    startYearSelect.disabled= ro;
    startWeekSelect.disabled= ro;
    endYearSelect.disabled= ro;
    endWeekSelect.disabled= ro;
    barDeleteBtn.disabled= ro;

    barEditor.style.display= "block";
    barEditor.style.left= (x + window.scrollX + 10)+ "px";
    barEditor.style.top= (y + window.scrollY + 10)+ "px";

    const autosave= ()=>{
        if(!adminMode)return;
        currentEditorBar.label= barLabelInput.value;
        currentEditorBar.projectName= barProjectNameInput.value;
        currentEditorBar.client= barClientInput.value;
        currentEditorBar.discipline= barDisciplineInput.value;
        currentEditorBar.experience= barExperienceInput.value;
        currentEditorBar.LOE= barLOEInput.value;
        currentEditorBar.location= barLocationInput.value;
        currentEditorBar.type= barTypeSelect.value;
        currentEditorBar.proposed= barProposedSelect.value;

        let sY= parseInt(startYearSelect.value);
        let sW= parseInt(startWeekSelect.value);
        let eY= parseInt(endYearSelect.value);
        let eW= parseInt(endWeekSelect.value);
        currentEditorBar.startAbsWeek= toAbsoluteWeek(sY, sW);
        currentEditorBar.length= toAbsoluteWeek(eY, eW) - currentEditorBar.startAbsWeek + 1;
        if(currentEditorBar.length<1) currentEditorBar.length=1;

        renderTable();
        saveToLocalStorage();
    };

    barLabelInput.oninput= autosave;
    barProjectNameInput.oninput= autosave;
    barClientInput.oninput= autosave;
    barDisciplineInput.oninput= autosave;
    barExperienceInput.oninput= autosave;
    barLOEInput.oninput= autosave;
    barLocationInput.oninput= autosave;
    barTypeSelect.onchange= autosave;
    barProposedSelect.onchange= autosave;
    startYearSelect.onchange= autosave;
    startWeekSelect.onchange= autosave;
    endYearSelect.onchange= autosave;
    endWeekSelect.onchange= autosave;
}

barEditorOkBtn.addEventListener("click", ()=>{
    barEditor.style.display="none";
    currentEditorBar=null;
    currentEditorLine=null;
    pushState();
});
barEditorCancelBtn.addEventListener("click", ()=>{
    barEditor.style.display="none";
    currentEditorBar=null;
    currentEditorLine=null;
    pushState();
});
barDeleteBtn.addEventListener("click", ()=>{
    if(!adminMode)return;
    if(!currentEditorBar||!currentEditorLine)return;
    currentEditorLine.bars= currentEditorLine.bars.filter(b=> b.id!== currentEditorBar.id);
    barEditor.style.display="none";
    currentEditorBar=null;
    currentEditorLine=null;
    pushState();
    renderTable();
    saveToLocalStorage();
});
document.addEventListener("mousedown", e=>{
    if(barEditor.style.display==="block"){
        let rect= barEditor.getBoundingClientRect();
        let inside= (
            e.clientX>= rect.left && e.clientX<= rect.right &&
            e.clientY>= rect.top && e.clientY<= rect.bottom
        );
        if(!inside){
            barEditor.style.display="none";
            currentEditorBar=null;
            currentEditorLine=null;
            pushState();
        }
    }
});

/*
    ---------------------------------------------------------------------------------------------
    showLineEditor => line editor form
    ---------------------------------------------------------------------------------------------
*/
function showLineEditor(line,x,y){
    currentEditorLine= line;
    lineNameInput.value= line.name||"";
    lineDisciplineInput.value= line.discipline||"";
    lineExperienceInput.value= line.experience||"";
    lineOfficeLocationInput.value= line.officeLocation||"";
    lineGeoLocationInput.value= line.geoLocation||"";
    lineTypeInput.value= line.type||"";

    let ro= !adminMode;
    lineNameInput.disabled= ro;
    lineDisciplineInput.disabled= ro;
    lineExperienceInput.disabled= ro;
    lineOfficeLocationInput.disabled= ro;
    lineGeoLocationInput.disabled= ro;
    lineTypeInput.disabled= ro;
    lineDeleteBtn.disabled= ro;

    lineEditor.style.display="block";
    lineEditor.style.left= (x+ window.scrollX+10)+ "px";
    lineEditor.style.top= (y+ window.scrollY+10)+ "px";

    const autosaveLine= ()=>{
        if(!adminMode)return;
        currentEditorLine.name= lineNameInput.value;
        currentEditorLine.discipline= lineDisciplineInput.value;
        currentEditorLine.experience= lineExperienceInput.value;
        currentEditorLine.officeLocation= lineOfficeLocationInput.value;
        currentEditorLine.geoLocation= lineGeoLocationInput.value;
        currentEditorLine.type= lineTypeInput.value;
        renderTable();
        saveToLocalStorage();
    };
    lineNameInput.oninput= autosaveLine;
    lineDisciplineInput.oninput= autosaveLine;
    lineExperienceInput.oninput= autosaveLine;
    lineOfficeLocationInput.oninput= autosaveLine;
    lineGeoLocationInput.oninput= autosaveLine;
    lineTypeInput.oninput= autosaveLine;
}

lineEditorOkBtn.addEventListener("click", ()=>{
    lineEditor.style.display="none";
    currentEditorLine=null;
    pushState();
});
lineEditorCancelBtn.addEventListener("click", ()=>{
    lineEditor.style.display="none";
    currentEditorLine=null;
    pushState();
});
lineDeleteBtn.addEventListener("click", ()=>{
    if(!adminMode)return;
    if(!currentEditorLine)return;
    lines= lines.filter(l=> l.id!== currentEditorLine.id);
    lineEditor.style.display="none";
    currentEditorLine=null;
    pushState();
    renderTable();
    saveToLocalStorage();
});
document.addEventListener("mousedown", e=>{
    if(lineEditor.style.display==="block"){
        let rect= lineEditor.getBoundingClientRect();
        let inside=(
            e.clientX>= rect.left && e.clientX<= rect.right &&
            e.clientY>= rect.top && e.clientY<= rect.bottom
        );
        if(!inside){
            lineEditor.style.display="none";
            currentEditorLine=null;
            pushState();
        }
    }
});

/*
    ---------------------------------------------------------------------------------------------
    FILTERS
    ---------------------------------------------------------------------------------------------
*/
filterBtn.addEventListener("click", ()=>{
    filterLineName.value= filters.line.name||"";
    filterLineDiscipline.value= filters.line.discipline||"";
    filterLineExperience.value= filters.line.experience||"";
    filterLineOfficeLocation.value= filters.line.officeLocation||"";
    filterLineGeoLocation.value= filters.line.geoLocation||"";
    filterLineType.value= filters.line.type||"";

    filterBarProjectName.value= filters.bar.projectName||"";
    filterBarClient.value= filters.bar.client||"";
    filterBarDiscipline.value= filters.bar.discipline||"";
    filterBarExperience.value= filters.bar.experience||"";
    filterBarLOE.value= filters.bar.LOE||"";
    filterBarLocation.value= filters.bar.location||"";
    filterBarType.value= filters.bar.type||"";
    filterBarProposed.value= filters.bar.proposed||"";
    filterModal.style.display="block";
});
filterApplyBtn.addEventListener("click", ()=>{
    filters.line.name= filterLineName.value.trim()||null;
    filters.line.discipline= filterLineDiscipline.value.trim()||null;
    filters.line.experience= filterLineExperience.value.trim()||null;
    filters.line.officeLocation= filterLineOfficeLocation.value.trim()||null;
    filters.line.geoLocation= filterLineGeoLocation.value.trim()||null;
    filters.line.type= filterLineType.value.trim()||null;

    filters.bar.projectName= filterBarProjectName.value.trim()||null;
    filters.bar.client= filterBarClient.value.trim()||null;
    filters.bar.discipline= filterBarDiscipline.value.trim()||null;
    filters.bar.experience= filterBarExperience.value.trim()||null;
    filters.bar.LOE= filterBarLOE.value.trim()||null;
    filters.bar.location= filterBarLocation.value.trim()||null;
    filters.bar.type= filterBarType.value.trim()||null;
    filters.bar.proposed= filterBarProposed.value.trim()||null;
    // remove empty keys
    for(let k in filters.line){
        if(!filters.line[k]) delete filters.line[k];
    }
    for(let k in filters.bar){
        if(!filters.bar[k]) delete filters.bar[k];
    }
    filterModal.style.display="none";
    renderTable();
});
filterClearBtn.addEventListener("click", ()=>{
    filters.line={};
    filters.bar={};
    filterModal.style.display="none";
    renderTable();
});
filterCancelBtn.addEventListener("click", ()=>{
    filterModal.style.display="none";
});
document.addEventListener("mousedown", e=>{
    if(filterModal.style.display==="block"){
        let rect= filterModal.getBoundingClientRect();
        let inside=(
            e.clientX>= rect.left && e.clientX<= rect.right &&
            e.clientY>= rect.top && e.clientY<= rect.bottom
        );
        if(!inside){
            filterModal.style.display="none";
        }
    }
});

/*
    ---------------------------------------------------------------------------------------------
    SETTINGS
    ---------------------------------------------------------------------------------------------
*/
settingsBtn.addEventListener("click", ()=>{
    themeSelect.value= currentTheme;
    securedColor.value= typeColors.secured;
    proposedColor.value= typeColors.proposed;
    opportunityColor.value= typeColors.opportunity;
    futureColor.value= typeColors.future;
    settingsModal.style.display="block";
});
settingsOkBtn.addEventListener("click", ()=>{
    currentTheme= themeSelect.value;
    typeColors.secured= securedColor.value;
    typeColors.proposed= proposedColor.value;
    typeColors.opportunity= opportunityColor.value;
    typeColors.future= futureColor.value;
    settingsModal.style.display="none";
    applyTheme();
});
settingsCancelBtn.addEventListener("click", ()=>{
    settingsModal.style.display="none";
});
document.addEventListener("mousedown", e=>{
    if(settingsModal.style.display==="block"){
        let rect= settingsModal.getBoundingClientRect();
        let inside=(
            e.clientX>= rect.left && e.clientX<= rect.right &&
            e.clientY>= rect.top && e.clientY<= rect.bottom
        );
        if(!inside){
            settingsModal.style.display="none";
        }
    }
});

/*
    ---------------------------------------------------------------------------------------------
    SEARCH => instant filter
    ---------------------------------------------------------------------------------------------
*/
searchInput.addEventListener("input", ()=>{
    searchTerm= searchInput.value.trim();
    renderTable();
});

/*
    ---------------------------------------------------------------------------------------------
    Add line => admin
    ---------------------------------------------------------------------------------------------
*/
addLineItemBtn.addEventListener("click", ()=>{
    if(!adminMode)return;
    lineCounter++;
    lines.push({
        id: lineCounter,
        name: "Line Item "+ lineCounter,
        discipline:"",
        experience:"",
        officeLocation:"",
        geoLocation:"",
        type:"",
        bars:[],
        selected:false,
        dragging:false
    });
    pushState();
    renderTable();
    saveToLocalStorage();
});

/*
    ---------------------------------------------------------------------------------------------
    Add bar => admin
    ---------------------------------------------------------------------------------------------
*/
addBarBtn.addEventListener("click", e=>{
    if(!adminMode)return;
    e.stopPropagation();
    if(!lines.length){
        lineCounter=1;
        lines.push({
            id:1,
            name:"Line Item 1",
            discipline:"",
            experience:"",
            officeLocation:"",
            geoLocation:"",
            type:"",
            bars:[],
            selected:false,
            dragging:false
        });
    }
    barCounter++;
    let {displayStart}= getDisplayRange();
    let newBar= {
        id: barCounter,
        label:"",
        projectName:"New Project",
        client:"",
        discipline:"",
        experience:"",
        LOE:"",
        location:"",
        proposed:"no",
        type:"proposed",
        startAbsWeek: displayStart,
        length:4,
        selected:false
    };
    lines[lines.length-1].bars.push(newBar);
    pushState();
    renderTable();
    saveToLocalStorage();
});

/*
    ---------------------------------------------------------------------------------------------
    EXPORT JSON
    ---------------------------------------------------------------------------------------------
*/
exportJsonBtn.addEventListener("click", ()=>{
    const dataStr= JSON.stringify({
        lines,
        startYear,
        startWeek,
        endYear,
        endWeek,
        lineCounter,
        barCounter,
        cellWidth,
        rowHeight,
        typeColors,
        currentTheme
    },null,2);
    const blob= new Blob([dataStr], {type:"application/json"});
    const url= URL.createObjectURL(blob);
    const now= new Date();
    let dateStr= now.toISOString().replace(/[:.]/g,"-");
    const a= document.createElement("a");
    a.download= "Gantt_"+ dateStr +".json";
    a.href= url;
    a.click();
    URL.revokeObjectURL(url);
});

/*
    ---------------------------------------------------------------------------------------------
    CSV
    ---------------------------------------------------------------------------------------------
*/
downloadCsvBtn.addEventListener("click", ()=>{
    /* Only a single label field now, so we remove references to extra. */
    let csv= "Line ID,Line Name,Line Discipline,Line Experience,Line OfficeLocation,Line GeoLocation,Line Type,"+
             "Bar ID,Bar Label,Project Name,Client,Discipline,Experience,LOE,Location,Proposed,Type,"+
             "Start Year,Start Week,End Year,End Week,Duration (weeks)\n";
    lines.forEach(line=>{
       if(!line.bars.length){
           csv+= `${line.id||""},"${line.name||""}","${line.discipline||""}","${line.experience||""}","${line.officeLocation||""}","${line.geoLocation||""}","${line.type||""}",,,,,,,,,,,,\n`;
       } else {
           line.bars.forEach(bar=>{
               let {year:sy, week:sw}= fromAbsoluteWeek(bar.startAbsWeek);
               let {year:ey, week:ew}= fromAbsoluteWeek(bar.startAbsWeek+ bar.length-1);
               csv+= `${line.id||""},"${line.name||""}","${line.discipline||""}","${line.experience||""}","${line.officeLocation||""}","${line.geoLocation||""}","${line.type||""}",`;
               csv+= `${bar.id||""},"${bar.label||""}","${bar.projectName||""}","${bar.client||""}","${bar.discipline||""}","${bar.experience||""}","${bar.LOE||""}","${bar.location||""}","${bar.proposed||""}","${bar.type||""}",`;
               csv+= `${sy},${sw},${ey},${ew},${bar.length}\n`;
           });
       }
    });
    let blob= new Blob([csv], {type:"text/csv;charset=utf-8;"});
    let url= URL.createObjectURL(blob);
    let a= document.createElement("a");
    a.download="gantt-data.csv";
    a.href= url;
    a.click();
    URL.revokeObjectURL(url);
});

/*
    ---------------------------------------------------------------------------------------------
    IMPORT => JSON/CSV
    ---------------------------------------------------------------------------------------------
*/
importJsonBtn.addEventListener("click", ()=>{
    importFileInput.value="";
    importFileInput.click();
});
importFileInput.addEventListener("change", e=>{
    let file= e.target.files[0];
    if(!file)return;
    let reader= new FileReader();
    reader.onload= ev=>{
        try{
            let imported;
            if(file.name.endsWith(".json")){
                imported= JSON.parse(ev.target.result);
                lines= imported.lines||[];
                startYear= imported.startYear|| startYear;
                startWeek= imported.startWeek|| startWeek;
                endYear= imported.endYear|| endYear;
                endWeek= imported.endWeek|| endWeek;
                lineCounter= imported.lineCounter|| lineCounter;
                barCounter= imported.barCounter|| barCounter;
                cellWidth= imported.cellWidth|| cellWidth;
                rowHeight= imported.rowHeight|| rowHeight;
                typeColors= imported.typeColors|| typeColors;
                currentTheme= imported.currentTheme|| currentTheme;
                lines.forEach(l=>{
                    l.selected=false;
                    l.dragging=false;
                    l.bars.forEach(b=>{
                        b.selected=false;
                        if(b.type===undefined) b.type="proposed";
                        if(b.label===undefined) b.label="";
                    });
                });
            } else if(file.name.endsWith(".csv")){
                let parsed= parseCsv(ev.target.result);
                lines= parsed.lines;
                lineCounter= parsed.lineCounter;
                barCounter= parsed.barCounter;
            } else {
                throw new Error("Unsupported file type");
            }
            startYearInput.value= startYear;
            startWeekInput.value= startWeek;
            endYearInput.value= endYear;
            endWeekInput.value= endWeek;
            zoomSlider.value= cellWidth;
            heightZoomSlider.value= rowHeight;
            themeSelect.value= currentTheme;
            securedColor.value= typeColors.secured;
            proposedColor.value= typeColors.proposed;
            opportunityColor.value= typeColors.opportunity;
            futureColor.value= typeColors.future;
            updateCSSVariables();
            applyTheme();
            renderTable();
            saveToLocalStorage();
            alert("Import successful!");
        } catch(err){
            console.error(err);
            alert("Import failed: "+ err.message);
        }
    };
    reader.readAsText(file);
});
function parseCsv(csv){
    let rows= csv.trim().split("\n");
    let header= rows[0].toLowerCase();
    if(!header.includes("bar id")) throw new Error("Invalid CSV (no 'Bar ID').");
    let newLines=[];
    let lineMap={};
    let maxLineId=0;
    let maxBarId=0;

    for(let i=1; i< rows.length; i++){
        let row= rows[i].trim();
        if(!row) continue;
        let parsed=[];
        let field="";
        let inQuote=false;
        for(let c of row+","){
            if(c==='"') inQuote=!inQuote;
            else if(c==="," && !inQuote){
                parsed.push(field);
                field="";
            } else field+= c;
        }
        if(parsed.length<7) continue;
        let lineId= parseInt(parsed[0])||0;
        if(!lineMap[lineId]){
            lineMap[lineId]={
                id: lineId,
                name:(parsed[1]||""),
                discipline:(parsed[2]||""),
                experience:(parsed[3]||""),
                officeLocation:(parsed[4]||""),
                geoLocation:(parsed[5]||""),
                type:(parsed[6]||""),
                bars:[],
                selected:false,
                dragging:false
            };
            newLines.push(lineMap[lineId]);
            maxLineId= Math.max(maxLineId, lineId);
        }
        let barIdStr= parsed[7]||"";
        if(!barIdStr) continue;
        let barId= parseInt(barIdStr)||0;
        let barLabel= parsed[8]||""; // single label
        let barProj= parsed[9]||"";
        let barClient= parsed[10]||"";
        let barDis= parsed[11]||"";
        let barExp= parsed[12]||"";
        let barLOE= parsed[13]||"";
        let barLoc= parsed[14]||"";
        let barProp= parsed[15]||"no";
        let barType= parsed[16]||"proposed";
        let sY= parseInt(parsed[17])||2025;
        let sW= parseInt(parsed[18])||1;
        let eY= parseInt(parsed[19])||2025;
        let eW= parseInt(parsed[20])||1;
        let dur= parseInt(parsed[21])||1;

        let startAbs= toAbsoluteWeek(sY,sW);
        let endAbs= toAbsoluteWeek(eY,eW);
        let length= endAbs- startAbs+1;
        if(length<1) length= dur||1;

        let newBar={
            id: barId,
            label: barLabel,
            projectName: barProj,
            client: barClient,
            discipline: barDis,
            experience: barExp,
            LOE: barLOE,
            location: barLoc,
            proposed: barProp,
            type: barType,
            startAbsWeek: startAbs,
            length,
            selected:false
        };
        lineMap[lineId].bars.push(newBar);
        maxBarId= Math.max(maxBarId, barId);
    }
    return { lines: newLines, lineCounter: maxLineId, barCounter: maxBarId };
}

/*
    ---------------------------------------------------------------------------------------------
    PRINT
    ---------------------------------------------------------------------------------------------
*/
printBtn.addEventListener("click", ()=> window.print());

/*
    ---------------------------------------------------------------------------------------------
    ZOOM
    ---------------------------------------------------------------------------------------------
*/
zoomSlider.addEventListener("input", e=>{
    cellWidth= parseInt(e.target.value);
    pushState();
    updateCSSVariables();
    renderTable();
    saveToLocalStorage();
});
heightZoomSlider.addEventListener("input", e=>{
    rowHeight= parseInt(e.target.value);
    pushState();
    updateCSSVariables();
    renderTable();
    saveToLocalStorage();
});

/*
    ---------------------------------------------------------------------------------------------
    UNDO/REDO
    ---------------------------------------------------------------------------------------------
*/
function pushState(){
    let st= JSON.parse(JSON.stringify({
        lines,
        startYear,
        startWeek,
        endYear,
        endWeek,
        lineCounter,
        barCounter,
        cellWidth,
        rowHeight,
        typeColors,
        currentTheme
    }));
    undoStack.push(st);
    redoStack=[];
}
function restoreState(st){
    lines= st.lines;
    startYear= st.startYear;
    startWeek= st.startWeek;
    endYear= st.endYear;
    endWeek= st.endWeek;
    lineCounter= st.lineCounter;
    barCounter= st.barCounter;
    cellWidth= st.cellWidth;
    rowHeight= st.rowHeight;
    typeColors= st.typeColors;
    currentTheme= st.currentTheme;
    updateCSSVariables();
    applyTheme();
    renderTable();
    saveToLocalStorage();
}
function undo(){
    if(!adminMode)return;
    if(undoStack.length<2)return;
    let cur=undoStack.pop();
    redoStack.push(cur);
    let prev=undoStack[undoStack.length-1];
    restoreState(prev);
}
function redo(){
    if(!adminMode)return;
    if(!redoStack.length)return;
    let nxt= redoStack.pop();
    let cur= JSON.parse(JSON.stringify({
        lines,
        startYear,
        startWeek,
        endYear,
        endWeek,
        lineCounter,
        barCounter,
        cellWidth,
        rowHeight,
        typeColors,
        currentTheme
    }));
    undoStack.push(cur);
    restoreState(nxt);
}
document.getElementById("undoBtn").addEventListener("click", ()=> undo());
document.getElementById("redoBtn").addEventListener("click", ()=> redo());

/*
    ---------------------------------------------------------------------------------------------
    HELP
    ---------------------------------------------------------------------------------------------
*/
document.getElementById("helpBtn").addEventListener("click", ()=>{
    alert(`Gantt Planner Quick Help:
 Extra label removed, only one "label" remains for bars.
 Background shading removed from the visualizer.
 Bar label is editable in the bar editor, displayed inside the bar.
 Black gridlines help align the headers and bar snaps to edges.
Enjoy managing your Gantt!`);
});

/*
    ---------------------------------------------------------------------------------------------
    ADMIN TOGGLE
    ---------------------------------------------------------------------------------------------
*/
adminToggleBtn.addEventListener("click", ()=>{
    if(!adminMode){
        let pwd= prompt("Enter admin password:");
        if(pwd==="Password"){
            adminMode= true;
            alert("Admin mode enabled.");
        } else {
            alert("Incorrect password. Remaining in user mode.");
            return;
        }
    } else {
        adminMode= false;
        alert("Admin mode disabled.");
    }
    csvEditToggleBtn.style.display= adminMode? "inline-block":"none";
    renderTable();
});

/*
    ---------------------------------------------------------------------------------------------
    CSV EDIT
    ---------------------------------------------------------------------------------------------
*/
csvEditToggleBtn.addEventListener("click", ()=>{
    if(!adminMode)return;
    let csvStr= "Line ID,Line Name,Line Discipline,Line Experience,Line OfficeLocation,Line GeoLocation,Line Type,"+
                "Bar ID,Bar Label,Project Name,Client,Discipline,Experience,LOE,Location,Proposed,Type,"+
                "Start Year,Start Week,End Year,End Week,Duration (weeks)\n";
    lines.forEach(line=>{
        if(!line.bars.length){
            csvStr+= `${line.id||""},"${line.name||""}","${line.discipline||""}","${line.experience||""}","${line.officeLocation||""}","${line.geoLocation||""}","${line.type||""}",,,,,,,,,,,,\n`;
        } else {
            line.bars.forEach(bar=>{
                let {year:sy, week:sw}= fromAbsoluteWeek(bar.startAbsWeek);
                let {year:ey, week:ew}= fromAbsoluteWeek(bar.startAbsWeek+ bar.length -1);
                csvStr+= `${line.id||""},"${line.name||""}","${line.discipline||""}","${line.experience||""}","${line.officeLocation||""}","${line.geoLocation||""}","${line.type||""}",`;
                csvStr+= `${bar.id||""},"${bar.label||""}","${bar.projectName||""}","${bar.client||""}","${bar.discipline||""}","${bar.experience||""}","${bar.LOE||""}","${bar.location||""}","${bar.proposed||""}","${bar.type||""}",`;
                csvStr+= `${sy},${sw},${ey},${ew},${bar.length}\n`;
            });
        }
    });
    csvTextarea.value= csvStr;
    csvEditModal.style.display= "block";
});
csvEditApplyBtn.addEventListener("click", ()=>{
    if(!adminMode)return;
    let csvData= csvTextarea.value;
    try{
        let parsed= parseCsv(csvData);
        lines= parsed.lines;
        lineCounter= parsed.lineCounter;
        barCounter= parsed.barCounter;
        pushState();
        renderTable();
        saveToLocalStorage();
        alert("CSV updated successfully.");
        csvEditModal.style.display= "none";
    } catch(err){
        alert("Error parsing CSV: "+ err.message);
    }
});
csvEditCancelBtn.addEventListener("click", ()=>{
    csvEditModal.style.display= "none";
});
document.addEventListener("mousedown", e=>{
    if(csvEditModal.style.display==="block"){
        let rect= csvEditModal.getBoundingClientRect();
        let inside= (
            e.clientX>= rect.left && e.clientX<= rect.right &&
            e.clientY>= rect.top && e.clientY<= rect.bottom
        );
        if(!inside){
            csvEditModal.style.display="none";
        }
    }
});

/*
    ---------------------------------------------------------------------------------------------
    APPLY TIMESCALE => read inputs, re-render
    ---------------------------------------------------------------------------------------------
*/
applyTimescaleBtn.addEventListener("click", ()=>{
    startYear= parseInt(startYearInput.value)||2025;
    startWeek= parseInt(startWeekInput.value)||1;
    endYear= parseInt(endYearInput.value)||2025;
    endWeek= parseInt(endWeekInput.value)||52;
    pushState();
    renderTable();
    saveToLocalStorage();
});

/*
    ---------------------------------------------------------------------------------------------
    INIT => on window load
    ---------------------------------------------------------------------------------------------
*/
function init() {
    loadFromLocalStorage();
    populateDateSelects();
    updateCSSVariables();
    startYearInput.value= startYear;
    startWeekInput.value= startWeek;
    endYearInput.value= endYear;
    endWeekInput.value= endWeek;
    zoomSlider.value= cellWidth;
    heightZoomSlider.value= rowHeight;
    themeSelect.value= currentTheme;
    securedColor.value= typeColors.secured;
    proposedColor.value= typeColors.proposed;
    opportunityColor.value= typeColors.opportunity;
    futureColor.value= typeColors.future;
    applyTheme();
    renderTable();
    pushState();
    csvEditToggleBtn.style.display="none";

    tableWrapper.addEventListener("scroll", ()=> updateBarTextPositions());
    window.addEventListener("resize", ()=> updateBarTextPositions());
}
window.addEventListener("load", init);

/*
    populateDateSelects => fill the year/week selects with sample range
*/
function populateDateSelects(){
    let years=[];
    for(let y=2023; y<=2030; y++){
        years.push(y);
    }
    let weeks=[];
    for(let w=1; w<=52; w++){
        weeks.push(w);
    }
    [startYearSelect,endYearSelect].forEach(sel=>{
        sel.innerHTML="";
        years.forEach(Y=>{
            let opt=document.createElement("option");
            opt.value= Y;
            opt.textContent= Y;
            sel.appendChild(opt);
        });
    });
    [startWeekSelect,endWeekSelect].forEach(sel=>{
        sel.innerHTML="";
        weeks.forEach(W=>{
            let opt=document.createElement("option");
            opt.value= W;
            opt.textContent= W;
            sel.appendChild(opt);
        });
    });
}
</script>
</body>
</html>
