<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Character set: Ensures correct text encoding -->
    <meta charset="UTF-8" />
    <!-- Updated Page Title for a more professional look -->
    <title><b>Gantt Planner</b></title>
    <!-- Bootstrap 5 CSS for layout & components -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
    <style>
        /*
         * We rely on native sizing to prevent clipping at bottom.
         * The last row is a 'filler row' that remains always at bottom.
         */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; 
            font-family: Arial, sans-serif;
        }

        /*
         * Sticky navbar at the top with scrolling if content grows too large.
         */
        .navbar {
            position: sticky;
            top: 0;
            z-index: 1000;
            background-color: #f8f9fa;
            padding: 0.5rem 0.75rem;
            width: 100%;
            max-height: 500px;
            overflow-y: auto; /* vertical scroll if the toolbar gets too tall */
        }
        .navbar .container-fluid {
            max-width: 100vw;
            padding: 0;
            margin: 0;
        }
        /* Collapsible area with gap */
        .navbar-collapse {
            display: flex !important;
            flex-wrap: wrap !important;
            gap: 0.75rem;
        }

        /*
         * We'll create .toolbar-column for vertical stacking inside nav.
         */
        .toolbar-column {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            border-right: 1px solid #dee2e6;
            padding-right: 0.5rem;
        }
        .toolbar-column:last-child {
            border-right: none;
            padding-right: 0;
        }

        /*
         * .toolbar-group => items stacked vertically
         */
        .toolbar-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        .toolbar-group label {
            margin-bottom: 0;
        }

        /* 
         * Timescale block => two side-by-side columns 
         */
        .timescale-row {
            display: flex;
            flex-direction: row;
            gap: 0.75rem;
        }
        .timescale-col {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        .timescale-col label {
            font-size: 0.85rem;
        }

        /*
         * .gantt-container below the navbar,
         * We'll rely on an extra "filler row" to ensure no clipping at bottom.
         */
        .gantt-container {
            position: relative;
            height: calc(100% - 1px);
            margin-bottom: 0;
        }

        /* 
         * Added padding-bottom to help the last row be fully visible 
         * regardless of filtering or not.
         */
        .table-wrapper {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow: auto;
            box-sizing: border-box;
            padding-bottom: 100px; /* Extra space at bottom to ensure last row is visible */
        }

        /*
         * Main table => black grid lines
         */
        #ganttTable {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
            position: relative;
        }
        #ganttTable,
        #ganttTable thead th,
        #ganttTable tbody td {
            border: 1px solid #000;
        }

        /* Sticky header */
        #ganttTable thead {
            position: sticky;
            top: 0;
            z-index: 50;
            background: #f8f9fa;
        }
        #ganttTable thead th {
            background-color: #f8f9fa;
            text-align: center;
            font-size: 0.9rem;
            padding: 4px 8px;
            box-sizing: border-box;
        }
        /* "Tasks" => 300px wide */
        #nameHeader {
            width: 300px;
            text-align: center;
            font-weight: bold;
            background-color: #f8f9fa;
            z-index: 51;
        }
        .timescale-header {
            background-color: #e9ecef;
            min-width: 50px;
        }

        /*
         * Tbody => row height from a CSS variable
         */
        #ganttTable tbody {
            position: relative;
        }
        .gantt-row {
            height: var(--row-height);
            transition: outline 0.2s;
        }
        .gantt-row.selected {
            background-color: #fff3cd;
        }
        /* More prominent red outline for drag highlight */
        .gantt-row.drag-highlight {
            outline: 3px solid red;
        }

        /*
         * We'll add a 'filler' row that remains at bottom, never re-ordered.
         * This row helps visually, but real padding is handled by .table-wrapper now.
         */
        .filler-row {
            height: 40px; 
        }

        /*
         * Name cell => sticky left
         */
        .name-cell {
            position: sticky;
            left: 0;
            background-color: #f0f0f0;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.2);
            z-index: 9;
            width: 300px;
            display: flex;
            justify-content: center;
            align-items: center;
            height: var(--row-height);
            box-sizing: border-box;
            cursor: move;
        }

        /*
         * bar-cell => colSpan timescale columns
         */
        .bar-cell {
            position: relative;
            padding: 0;
        }
        .bar-row-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
        }

        /* 
         * Bar => absolute
         */
        .bar {
            position: absolute;
            height: calc(var(--row-height) - 16px);
            left: 0;
            border-radius: 4px;
            color: #fff;
            cursor: pointer;
            user-select: none;
            opacity: 0.7;
            overflow: hidden;
            z-index: 0;
            box-sizing: border-box;
        }
        .bar.selected {
            outline: 3px solid #00f;
        }
        .bar.highlighted {
            outline: 3px solid #0d6efd;
            opacity: 0.9;
        }
        .bar-text {
            position: absolute;
            top: 0;
            height: 100%;
            line-height: calc(var(--row-height) - 16px);
            white-space: nowrap;
            pointer-events: none;
            font-weight: 500;
            padding: 0 8px;
        }

        /* Admin bar-handle => resizing */
        .bar-handle {
            position: absolute;
            top: 0;
            width: 6px;
            height: 100%;
            cursor: col-resize;
            background-color: rgba(255,255,255,0.4);
            z-index: 2;
        }
        .bar-handle.left {
            left: 0;
            border-radius: 4px 0 0 4px;
        }
        .bar-handle.right {
            right: 0;
            border-radius: 0 4px 4px 0;
        }

        /* Overlap hatch => diagonal stripes if bars overlap */
        .overlap-hatch {
            position: absolute;
            height: calc(var(--row-height) - 16px);
            background: repeating-linear-gradient(
                45deg,
                red,
                red 2px,
                transparent 2px,
                transparent 4px
            );
            opacity: 0.5;
            pointer-events: none;
            z-index: 1;
        }

        /*
         * We want each label + input on same line => .attribute-row 
         * + smaller editors to avoid overflow
         */
        #barEditor {
            position: absolute;
            display: none;
            background: #fff;
            border: 1px solid #ccc;
            padding: 8px;
            border-radius: 6px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.5);
            z-index: 9999;
            min-width: 200px;
            max-height: 70vh;
            overflow: auto;
            max-width: 90vw;
            font-size: 0.9rem;
        }
        #lineEditor {
            position: absolute;
            display: none;
            background: #fff;
            border: 1px solid #ccc;
            padding: 12px;
            border-radius: 6px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.5);
            z-index: 9999;
            min-width: 280px;
            max-height: 80vh;
            overflow: auto;
            max-width: 90vw;
        }

        /* Place label + input side-by-side in .attribute-row */
        .attribute-row {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
        }
        .attribute-row label {
            flex: 0 0 auto;
            margin-right: 6px;
            font-weight: 500;
        }
        .attribute-row input,
        .attribute-row select {
            flex: 1 1 auto;
        }

        #barEditorActions,
        #lineEditorActions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 12px;
        }

        /* Filter modal => center, scroll if big */
        #filterModal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            border: 1px solid #ccc;
            padding: 20px;
            border-radius: 6px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.5);
            z-index: 9999;
            min-width: 600px;
            max-height: 80vh;
            overflow: auto;
        }
        #filterModal h3 {
            margin-top: 0;
        }
        .filter-container {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            gap: 20px;
        }
        .filter-card {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .filter-card h5 {
            margin-top: 0;
            margin-bottom: 6px;
            font-size: 1rem;
            font-weight: 600;
        }
        #filterActions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 12px;
        }

        /* Settings modal => color/theme, scroll if large */
        #settingsModal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            border: 1px solid #ccc;
            padding: 20px;
            border-radius: 6px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.5);
            z-index: 9999;
            min-width: 300px;
            max-height: 80vh;
            max-width: 90vw;
            overflow: auto;
        }
        #settingsModal h3 {
            margin-top: 0;
        }
        #settingsModal label {
            display: block;
            margin-top: 8px;
        }
        #settingsActions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 12px;
        }
        .color-picker {
            width: 60px;
            height: 30px;
            padding: 0;
            border: none;
            cursor: pointer;
        }

        /* CSV Edit modal => topmost, scroll if large */
        #csvEditModal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            width: 60%;
            height: 60%;
            transform: translate(-50%, -50%);
            background: #fff;
            border: 1px solid #ccc;
            padding: 10px;
            border-radius: 6px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.5);
            z-index: 99999;
            overflow: auto;
        }
        #csvTextarea {
            width: 100%;
            height: 70%;
            font-family: monospace;
            font-size: 0.9rem;
        }
        #csvEditModalActions {
            margin-top: 10px;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        /*
         * Dark theme => .dark-theme
         */
        body.dark-theme {
            background-color: #212529;
            color: #f8f9fa;
        }
        body.dark-theme .navbar {
            background-color: #343a40 !important;
        }
        body.dark-theme #ganttTable thead th,
        body.dark-theme .timescale-header {
            background-color: #495057;
            color: #f8f9fa;
        }
        body.dark-theme .name-cell {
            background-color: #444;
            color: #f8f9fa;
            box-shadow: 1px 1px 3px rgba(255,255,255,0.2);
        }
        body.dark-theme .bar-text {
            color: #212529;
        }
        body.dark-theme #barEditor,
        body.dark-theme #lineEditor,
        body.dark-theme #filterModal,
        body.dark-theme #settingsModal,
        body.dark-theme #csvEditModal {
            background: #343a40;
            color: #f8f9fa;
            border: 1px solid #495057;
        }
        body.dark-theme input,
        body.dark-theme select,
        body.dark-theme textarea {
            background: #495057;
            color: #f8f9fa;
            border: 1px solid #6c757d;
        }

        /* Zoom sliders => horizontal and vertical range inputs */
        .zoom-slider {
            width: 120px;
            margin: 0 8px;
            height: 8px;
            border-radius: 4px;
            background: #ced4da;
            outline: none;
            -webkit-appearance: none;
            box-shadow: 0 2px 6px rgba(0,0,0,0.25);
        }
        .zoom-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #0d6efd;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .zoom-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #0d6efd;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        #heightZoomSlider {
            transform: rotate(-90deg);
            width: 100px;
        }

        /*
         * Print => only the visible scrolled portion of .table-wrapper
         */
        @media print {
            .navbar,
            #barEditor,
            #lineEditor,
            #filterModal,
            #settingsModal,
            #csvEditModal {
                display: none !important;
            }
        }
    </style>
</head>
<body>
<!-- Sticky navbar with newly arranged columns -->
<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
        <!-- Brand => more professional title -->
        <a class="navbar-brand" href="#">Gantt Planner</a>
        <!-- Toggler for small screens -->
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
                aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <!-- Collapsible area with columns -->
        <div class="collapse navbar-collapse" id="navbarSupportedContent" style="display:flex; flex-direction: row; gap:1rem;">
            
            <!-- Column 1 => Timescale in 2 columns + dynamic updates -->
            <div class="toolbar-column">
                <div class="toolbar-group">
                    <span>Timescale</span>
                    <div class="timescale-row">
                        <!-- Start side -->
                        <div class="timescale-col">
                            <label for="startYearInput" class="form-label">Start Year:</label>
                            <input id="startYearInput" type="number" class="form-control form-control-sm" value="2025" />
                            <label for="startWeekInput" class="form-label">Start Week:</label>
                            <input id="startWeekInput" type="number" class="form-control form-control-sm" value="1" />
                        </div>
                        <!-- End side -->
                        <div class="timescale-col">
                            <label for="endYearInput" class="form-label">End Year:</label>
                            <input id="endYearInput" type="number" class="form-control form-control-sm" value="2025" />
                            <label for="endWeekInput" class="form-label">End Week:</label>
                            <input id="endWeekInput" type="number" class="form-control form-control-sm" value="52" />
                        </div>
                    </div>
                </div>
            </div>

            <!-- Column 2 => Zoom and search stacked, filter button under search -->
            <div class="toolbar-column">
                <div class="toolbar-group">
                    <span>Zoom</span>
                    <div style="display: flex; flex-direction: row; gap: 0.5rem;">
                        <div>
                            <label for="zoomSlider" class="form-label m-0 me-2">H-Zoom:</label>
                            <input type="range" class="zoom-slider" id="zoomSlider" min="50" max="300" value="150" step="10">
                        </div>
                        <div>
                            <label for="heightZoomSlider" class="form-label m-0 me-2">V-Zoom:</label>
                            <input type="range" class="zoom-slider" id="heightZoomSlider" min="30" max="100" value="40" step="5">
                        </div>
                    </div>
                </div>
                <div class="toolbar-group">
                    <span>Search</span>
                    <input type="text" id="searchInput" class="form-control form-control-sm" placeholder="Filter lines/bars..." />
                    <button id="filterBtn" class="btn btn-outline-primary btn-sm mt-1">Filter</button>
                </div>
            </div>

            <!-- Column 3 => Add line/bar stacked, History stacked -->
            <div class="toolbar-column">
                <div class="toolbar-group">
                    <span>Add Items</span>
                    <button id="addLineItemBtn" class="btn btn-primary btn-sm">Add Line</button>
                    <button id="addBarBtn" class="btn btn-secondary btn-sm">Add Bar</button>
                </div>
                <div class="toolbar-group">
                    <span>History</span>
                    <button id="undoBtn" type="button" class="btn btn-sm btn-success">Undo</button>
                    <button id="redoBtn" type="button" class="btn btn-sm btn-warning">Redo</button>
                </div>
            </div>

            <!-- Column 4 => Legend -->
            <div class="toolbar-column">
                <div class="toolbar-group">
                    <span>Legend</span>
                    <div id="statusLegend" class="legend-container-vertical">
                        <div class="legend-item">
                            <div class="legend-swatch" style="width:16px; height:16px; background:#28a745;"></div>
                            <span>Secured</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-swatch" style="width:16px; height:16px; background:#fd7e14;"></div>
                            <span>Proposed</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-swatch" style="width:16px; height:16px; background:#dc3545;"></div>
                            <span>Opportunity</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-swatch" style="width:16px; height:16px; background:#6f42c1;"></div>
                            <span>Future</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Column 5 => Import/Export/Print stacked -->
            <div class="toolbar-column">
                <div class="toolbar-group">
                    <span>Import/Export</span>
                    <button id="importJsonBtn" class="btn btn-outline-success btn-sm">Import</button>
                    <button id="exportJsonBtn" class="btn btn-outline-info btn-sm">Export JSON</button>
                    <button id="downloadCsvBtn" class="btn btn-outline-secondary btn-sm">Export CSV</button>
                    <button id="printBtn" class="btn btn-outline-dark btn-sm">Print/PDF</button>
                </div>
            </div>

            <!-- Column 6 => Misc => Admin & Theme/About toggles -->
            <div class="toolbar-column">
                <div class="toolbar-group">
                    <span>Misc</span>
                    <!-- Admin toggle button under help section as requested -->
                    <button id="adminToggleBtn" class="btn btn-sm btn-outline-danger">Admin</button>
                    <!-- "Theme" normal toggle button => same as settingsBtn event -->
                    <button id="themeToggleBtn" class="btn btn-sm btn-outline-info">Theme</button>
                    <!-- "About" normal toggle button => same as helpBtn event -->
                    <button id="aboutToggleBtn" class="btn btn-sm btn-outline-secondary">About</button>
                    <!-- CSV Edit remains hidden unless admin mode -->
                    <button id="csvEditToggleBtn" class="btn btn-outline-dark btn-sm" style="display:none;">Edit CSV</button>
                </div>
            </div>
        </div>
    </div>
</nav>

<!-- Gantt container => table wrapper -->
<div class="gantt-container">
    <div class="table-wrapper" id="tableWrapper">
        <table id="ganttTable">
            <thead>
            <tr id="headerRow">
                <th id="nameHeader">Tasks</th>
                <!-- Timescale columns appended dynamically -->
            </tr>
            </thead>
            <tbody id="tableBody">
            <!-- Rows generated dynamically -->
            </tbody>
        </table>
    </div>
</div>

<!-- Bar editor => single label plus various attributes 
     Each label + input or select is on the same line using .attribute-row -->
<div id="barEditor">
    <div class="attribute-row">
        <label for="barLabelInput">Bar Label:</label>
        <input type="text" id="barLabelInput" placeholder="Bar Label..." />
    </div>
    <div class="attribute-row">
        <label for="barProjectNameInput">Project Name:</label>
        <input type="text" id="barProjectNameInput" placeholder="Project Name..." />
    </div>
    <div class="attribute-row">
        <label for="barClientInput">Client:</label>
        <input type="text" id="barClientInput" placeholder="Client..." />
    </div>
    <div class="attribute-row">
        <label for="barDisciplineInput">Discipline:</label>
        <input type="text" id="barDisciplineInput" placeholder="Discipline..." />
    </div>
    <div class="attribute-row">
        <label for="barExperienceInput">Experience:</label>
        <input type="text" id="barExperienceInput" placeholder="Experience..." />
    </div>
    <div class="attribute-row">
        <label for="barLOEInput">LOE:</label>
        <input type="text" id="barLOEInput" placeholder="LOE..." />
    </div>
    <div class="attribute-row">
        <label for="barLocationInput">Location:</label>
        <input type="text" id="barLocationInput" placeholder="Location..." />
    </div>

    <!-- Custom field between Location and Type -->
    <div class="attribute-row">
        <label for="barCustomInput">Assigned To:</label>
        <input type="text" id="barCustomInput" placeholder="Assigned To..." />
    </div>

    <div class="attribute-row">
        <label for="barTypeSelect">Type (affects color):</label>
        <select id="barTypeSelect">
            <option value="secured">Secured</option>
            <option value="proposed">Proposed</option>
            <option value="opportunity">Opportunity</option>
            <option value="future">Future</option>
        </select>
    </div>
    <div class="attribute-row">
        <label for="barProposedSelect">Proposed:</label>
        <select id="barProposedSelect">
            <option value="yes">Yes</option>
            <option value="no">No</option>
        </select>
    </div>
    <div class="attribute-row">
        <label for="startYearSelect">Start (Y/W):</label>
        <select id="startYearSelect"></select>
        <select id="startWeekSelect"></select>
    </div>
    <div class="attribute-row">
        <label for="endYearSelect">End (Y/W):</label>
        <select id="endYearSelect"></select>
        <select id="endWeekSelect"></select>
    </div>

    <div id="barEditorActions">
        <button id="barDeleteBtn" class="btn btn-sm btn-danger">Delete Bar</button>
        <button id="barEditorOkBtn" class="btn btn-sm btn-primary">OK</button>
        <button id="barEditorCancelBtn" class="btn btn-sm btn-secondary">Cancel</button>
    </div>
</div>

<!-- Line editor 
     Each label + input on the same line using .attribute-row -->
<div id="lineEditor">
    <div class="attribute-row">
        <label for="lineNameInput">Name:</label>
        <input type="text" id="lineNameInput" placeholder="Name..." />
    </div>
    <div class="attribute-row">
        <label for="lineDisciplineInput">Discipline:</label>
        <input type="text" id="lineDisciplineInput" placeholder="Discipline..." />
    </div>
    <div class="attribute-row">
        <label for="lineExperienceInput">Experience:</label>
        <input type="text" id="lineExperienceInput" placeholder="Experience..." />
    </div>
    <div class="attribute-row">
        <label for="lineOfficeLocationInput">Office Location:</label>
        <input type="text" id="lineOfficeLocationInput" placeholder="Office Location..." />
    </div>
    <div class="attribute-row">
        <label for="lineGeoLocationInput">Geo Location:</label>
        <input type="text" id="lineGeoLocationInput" placeholder="Geo Location..." />
    </div>
    <div class="attribute-row">
        <label for="lineTypeInput">Type:</label>
        <input type="text" id="lineTypeInput" placeholder="Type..." />
    </div>

    <div id="lineEditorActions">
        <button id="lineDeleteBtn" class="btn btn-sm btn-danger">Delete Line Item</button>
        <button id="lineEditorOkBtn" class="btn btn-sm btn-primary">OK</button>
        <button id="lineEditorCancelBtn" class="btn btn-sm btn-secondary">Cancel</button>
    </div>
</div>

<!-- Filter modal -->
<div id="filterModal">
    <h3>Filter Lines/Bars</h3>
    <div class="filter-container">
        <!-- Left filter card => line item fields -->
        <div class="filter-card">
            <h5>Line Item Filters</h5>
            <label for="filterLineName">Name:</label>
            <input type="text" id="filterLineName" placeholder="Name..." />

            <label for="filterLineDiscipline">Discipline:</label>
            <input type="text" id="filterLineDiscipline" placeholder="Discipline..." />

            <label for="filterLineExperience">Experience:</label>
            <input type="text" id="filterLineExperience" placeholder="Experience..." />

            <label for="filterLineOfficeLocation">Office Location:</label>
            <input type="text" id="filterLineOfficeLocation" placeholder="Office Location..." />

            <label for="filterLineGeoLocation">Geo Location:</label>
            <input type="text" id="filterLineGeoLocation" placeholder="Geo Location..." />

            <label for="filterLineType">Type:</label>
            <input type="text" id="filterLineType" placeholder="Type..." />
        </div>

        <!-- Right filter card => bar attributes -->
        <div class="filter-card">
            <h5>Bar Filters</h5>
            <label for="filterBarProjectName">Project Name:</label>
            <input type="text" id="filterBarProjectName" placeholder="Project Name..." />

            <label for="filterBarClient">Client:</label>
            <input type="text" id="filterBarClient" placeholder="Client..." />

            <label for="filterBarDiscipline">Discipline:</label>
            <input type="text" id="filterBarDiscipline" placeholder="Discipline..." />

            <label for="filterBarExperience">Experience:</label>
            <input type="text" id="filterBarExperience" placeholder="Experience..." />

            <label for="filterBarLOE">LOE:</label>
            <input type="text" id="filterBarLOE" placeholder="LOE..." />

            <label for="filterBarLocation">Location:</label>
            <input type="text" id="filterBarLocation" placeholder="Location..." />

            <!-- BEGIN: Added new custom field filter input -->
            <label for="filterBarCustom">Assigned To:</label>
            <input type="text" id="filterBarCustom" placeholder="Custom..." />
            <!-- END: new custom field filter -->

            <label for="filterBarType">Type:</label>
            <input type="text" id="filterBarType" placeholder="Type..." />

            <label for="filterBarProposed">Proposed:</label>
            <input type="text" id="filterBarProposed" placeholder="Yes/No..." />
        </div>
    </div>
    <div id="filterActions">
        <button id="filterApplyBtn" class="btn btn-sm btn-primary">Apply</button>
        <button id="filterClearBtn" class="btn btn-sm btn-secondary">Clear</button>
        <button id="filterCancelBtn" class="btn btn-sm btn-secondary">Cancel</button>
    </div>
</div>

<!-- Settings modal -->
<div id="settingsModal">
    <h3>Theme Settings</h3>
    <label>Theme:</label>
    <select id="themeSelect">
        <option value="light">Light</option>
        <option value="dark">Dark</option>
    </select>

    <label for="securedColor">Secured Color:</label>
    <input type="color" id="securedColor" class="color-picker" value="#28a745" />

    <label for="proposedColor">Proposed Color:</label>
    <input type="color" id="proposedColor" class="color-picker" value="#fd7e14" />

    <label for="opportunityColor">Opportunity Color:</label>
    <input type="color" id="opportunityColor" class="color-picker" value="#dc3545" />

    <label for="futureColor">Future Color:</label>
    <input type="color" id="futureColor" class="color-picker" value="#6f42c1" />

    <div id="settingsActions">
        <button id="settingsOkBtn" class="btn btn-sm btn-primary">Apply</button>
        <button id="settingsCancelBtn" class="btn btn-sm btn-secondary">Cancel</button>
    </div>
</div>

<!-- CSV Edit modal -->
<div id="csvEditModal">
    <h3>Edit CSV In-Browser</h3>
    <textarea id="csvTextarea"></textarea>
    <div id="csvEditModalActions">
        <button id="csvEditApplyBtn" class="btn btn-sm btn-primary">Apply Changes</button>
        <button id="csvEditCancelBtn" class="btn btn-sm btn-secondary">Close</button>
    </div>
</div>

<!-- Hidden file input for import -->
<input type="file" id="importFileInput" accept=".json,.csv" style="display:none;" />

<!-- Bootstrap 5 JS bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
/*
    ---------------------------------------------------------------------------------------------
    GLOBALS
    ---------------------------------------------------------------------------------------------
    The following variables store the overall state of the Gantt chart and user configurations.
*/
let adminMode = false; 
let typeColors = {
    secured: "#28a745",
    proposed: "#fd7e14",
    opportunity: "#dc3545",
    future: "#6f42c1",
};
/*
    lines: Array that holds our line items, each with an array of bars.
    Example structure:
    lines = [ { id, name, discipline, experience, officeLocation, geoLocation, type, bars: [...], selected, dragging }, ... ]
*/
let lines = [
    {
        id: 1,
        name: "Line One",
        discipline: "",
        experience: "",
        officeLocation: "",
        geoLocation: "",
        type: "",
        bars: [
            {
                id: 101,
                label: "Bar Sample A",
                projectName: "Proj A",
                client: "",
                discipline: "",
                experience: "",
                LOE: "",
                location: "",
                /* custom => new user input field */
                Assigned To: "",
                proposed: "no",
                type: "secured",
                startAbsWeek: toAbsoluteWeek(2025, 2),
                length: 4,
                selected: false
            },
        ],
        selected: false,
        dragging: false
    },
    {
        id: 2,
        name: "Line Two",
        discipline: "",
        experience: "",
        officeLocation: "",
        geoLocation: "",
        type: "",
        bars: [
            {
                id: 102,
                label: "Bar Sample B",
                projectName: "Proj B",
                client: "",
                discipline: "",
                experience: "",
                LOE: "",
                location: "",
                /* custom => new user input field */
                Assigned To: "",
                proposed: "yes",
                type: "proposed",
                startAbsWeek: toAbsoluteWeek(2025, 10),
                length: 7,
                selected: false
            },
        ],
        selected: false,
        dragging: false
    },
];
let startYear = 2025;
let startWeek = 1;
let endYear = 2025;
let endWeek = 52;
let lineCounter = 2;
let barCounter = 102;
let cellWidth = 150;
let rowHeight = 40;
let filters = { line:{}, bar:{} };
let searchTerm = "";
let currentTheme = "light";
let undoStack = [];
let redoStack = [];
let dragging = false;
let dragType = null;
let dragStartX = 0;
let dragStartY = 0;
let initialStartAbs = 0;
let initialLength = 0;
let currentBar = null;
let currentLine = null;
let draggingLine = null;
let tableBodyRect = null;
let mainFilteredLines = [];
let currentEditorBar = null;
let currentEditorLine = null;

/*
    ---------------------------------------------------------------------------------------------
    TIME & HELPER
    ---------------------------------------------------------------------------------------------
    Functions for converting year/week to absolute weeks, determining month names, etc.
*/

/**
 * Convert (year, week) to a single absolute integer for easier bar positioning
 * @param {number} year 
 * @param {number} week 
 * @returns {number} abs
 */
function toAbsoluteWeek(year, week){
    return year * 52 + (week - 1);
}

/**
 * Convert absolute week back to (year, week)
 * @param {number} abs 
 * @returns {object} { year, week }
 */
function fromAbsoluteWeek(abs){
    const y = Math.floor(abs / 52);
    const w = (abs % 52) + 1;
    return { year: y, week: w };
}

/**
 * Get the month index for a given year/week
 * @param {number} year 
 * @param {number} week 
 * @returns {number} monthIndex
 */
function getMonthFromYearWeek(year, week){
    let january4 = new Date(year, 0, 4);
    let dayMs = 24*3600*1000;
    let offsetDays = (week - 1)*7 - ((january4.getDay() + 6) % 7);
    let date = new Date(january4.getTime() + offsetDays* dayMs);
    return date.getMonth();
}

/**
 * Return short month name from index
 * @param {number} m 
 * @returns {string} "Jan"..."Dec"
 */
function getMonthName(m){
    const months= ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    return months[m]||"";
}

/**
 * Return color from bar type
 * @param {string} t 
 * @returns {string} color hex
 */
function getColorFromType(t){
    return typeColors[t]|| "#fd7e14";
}

/*
    ---------------------------------------------------------------------------------------------
    LOCAL STORAGE
    ---------------------------------------------------------------------------------------------
    Saving and loading entire chart state to/from localStorage
*/
function saveToLocalStorage(){
    const chartData= {
        lines,
        startYear,
        startWeek,
        endYear,
        endWeek,
        lineCounter,
        barCounter,
        cellWidth,
        rowHeight,
        typeColors,
        currentTheme
    };
    localStorage.setItem("ganttChartData", JSON.stringify(chartData));
}
function loadFromLocalStorage(){
    const stored= localStorage.getItem("ganttChartData");
    if(!stored)return;
    try {
        let parsed= JSON.parse(stored);
        lines= parsed.lines|| [];
        lines.forEach(line=>{
            line.selected= false;
            line.dragging= false;
            line.bars.forEach(bar=>{
                bar.selected= false;
                if(bar.type===undefined) bar.type="proposed";
                if(bar.label===undefined) bar.label="";
                // Ensure new custom field is present even if older data lacks it
                if(bar.custom===undefined) bar.custom="";
            });
        });
        startYear= parsed.startYear||2025;
        startWeek= parsed.startWeek||1;
        endYear= parsed.endYear||2025;
        endWeek= parsed.endWeek||52;
        lineCounter= parsed.lineCounter|| lineCounter;
        barCounter= parsed.barCounter|| barCounter;
        cellWidth= parsed.cellWidth||150;
        rowHeight= parsed.rowHeight||40;
        typeColors= parsed.typeColors|| typeColors;
        currentTheme= parsed.currentTheme|| "light";
    } catch(err){
        console.warn("Invalid localStorage data");
    }
}

/*
    ---------------------------------------------------------------------------------------------
    THEME & CSS
    ---------------------------------------------------------------------------------------------
    Handling theme toggling and dynamic CSS updates
*/
function applyTheme(){
    if(currentTheme==="dark"){
        document.body.classList.add("dark-theme");
    } else {
        document.body.classList.remove("dark-theme");
    }
    renderTable();
    saveToLocalStorage();
}
function updateCSSVariables(){
    document.documentElement.style.setProperty("--cell-width", cellWidth+"px");
    document.documentElement.style.setProperty("--row-height", rowHeight+"px");
}

/*
    ---------------------------------------------------------------------------------------------
    getDisplayRange => from timescale
    ---------------------------------------------------------------------------------------------
    Return absolute start/end weeks
*/
function getDisplayRange(){
    let ds= toAbsoluteWeek(startYear, startWeek);
    let de= toAbsoluteWeek(endYear, endWeek);
    return { displayStart: ds, displayEnd: de };
}

/*
    ---------------------------------------------------------------------------------------------
    UTILS => unselect/hide highlights
    ---------------------------------------------------------------------------------------------
*/

/**
 * Unselect all bars
 */
function unselectAllBars(){
    lines.forEach(line=> line.bars.forEach(bar=> bar.selected=false));
}

/**
 * Clear all highlighted bar classes
 */
function clearHighlights(){
    document.querySelectorAll(".bar.highlighted").forEach(el=> el.classList.remove("highlighted"));
}

/*
    ---------------------------------------------------------------------------------------------
    updateBarTextPositions => center bar label if visible
    ---------------------------------------------------------------------------------------------
    Called on table scroll or window resize
*/
function updateBarTextPositions(){
    let scrollLeft= tableWrapper.scrollLeft;
    let viewportWidth= tableWrapper.clientWidth;
    document.querySelectorAll(".bar-text").forEach(textEl=>{
        let barEl= textEl.parentElement;
        let barLeft= parseFloat(barEl.style.left);
        let barWidth= parseFloat(barEl.style.width);
        let barRight= barLeft+ barWidth;
        let visibleLeft= Math.max(barLeft, scrollLeft);
        let visibleRight= Math.min(barRight, scrollLeft+ viewportWidth);
        let visibleWidth= visibleRight- visibleLeft;
        if(visibleWidth<=0){
            textEl.style.opacity="0";
            return;
        }
        textEl.style.opacity="1";
        let textWidth= textEl.offsetWidth;
        let textLeft= (visibleLeft- barLeft)+ (visibleWidth- textWidth)/2;
        if(textLeft<5) textLeft=5;
        if(textLeft+ textWidth> barWidth-5) textLeft= barWidth- textWidth-5;
        textEl.style.left= textLeft+"px";
    });
}

/*
    ---------------------------------------------------------------------------------------------
    renderHeader => timescale columns
    ---------------------------------------------------------------------------------------------
    Build the <th> columns based on startWeek/endWeek
*/
function renderHeader(){
    while(headerRow.children.length>1){
        headerRow.removeChild(headerRow.lastChild);
    }
    let {displayStart,displayEnd}= getDisplayRange();
    let totalWeeks= displayEnd- displayStart+1;
    if(totalWeeks<1)return;

    for(let i=0; i< totalWeeks; i++){
        let abs= displayStart+ i;
        let {year, week}= fromAbsoluteWeek(abs);
        let th= document.createElement("th");
        th.className= "timescale-header";
        let mIdx= getMonthFromYearWeek(year, week);
        th.textContent= `${year}-W${week} (${getMonthName(mIdx)})`;
        th.style.width= cellWidth+"px";
        headerRow.appendChild(th);
    }
}

/*
    ---------------------------------------------------------------------------------------------
    handleBarClickSelect => shift/ctrl multi selection
    ---------------------------------------------------------------------------------------------
*/
function handleBarClickSelect(bar, evt){
    let multi= evt.shiftKey|| evt.ctrlKey|| evt.metaKey;
    if(!multi){
        unselectAllBars();
        bar.selected= true;
    } else {
        bar.selected= !bar.selected;
    }
}

/*
    ---------------------------------------------------------------------------------------------
    renderTable => main UI, plus filler row
    ---------------------------------------------------------------------------------------------
    Renders the lines, bars, highlighting, etc.
*/
function renderTable(){
    renderHeader();
    tableBody.innerHTML= "";
    clearHighlights();

    let {displayStart, displayEnd}= getDisplayRange();
    let totalWeeks= displayEnd- displayStart +1;
    if(totalWeeks<1)return;

    let lowerSearch= searchTerm.toLowerCase();

    // Filter lines
    let filteredLines= lines.filter(line=>{
        const linePass= (
            (!filters.line.name || (line.name && line.name.toLowerCase().includes(filters.line.name.toLowerCase()))) &&
            (!filters.line.discipline || (line.discipline && line.discipline.toLowerCase().includes(filters.line.discipline.toLowerCase()))) &&
            (!filters.line.experience || (line.experience && line.experience.toLowerCase().includes(filters.line.experience.toLowerCase()))) &&
            (!filters.line.officeLocation || (line.officeLocation && line.officeLocation.toLowerCase().includes(filters.line.officeLocation.toLowerCase()))) &&
            (!filters.line.geoLocation || (line.geoLocation && line.geoLocation.toLowerCase().includes(filters.line.geoLocation.toLowerCase()))) &&
            (!filters.line.type || (line.type && line.type.toLowerCase().includes(filters.line.type.toLowerCase())))
        );

        const barPass= line.bars.some(b=>{
            const condProj= (!filters.bar.projectName|| (b.projectName && b.projectName.toLowerCase().includes(filters.bar.projectName.toLowerCase())));
            const condClient= (!filters.bar.client|| (b.client && b.client.toLowerCase().includes(filters.bar.client.toLowerCase())));
            const condDis= (!filters.bar.discipline|| (b.discipline && b.discipline.toLowerCase().includes(filters.bar.discipline.toLowerCase())));
            const condExp= (!filters.bar.experience|| (b.experience && b.experience.toLowerCase().includes(filters.bar.experience.toLowerCase())));
            const condLOE= (!filters.bar.LOE|| (b.LOE && b.LOE.toLowerCase().includes(filters.bar.LOE.toLowerCase())));
            const condLoc= (!filters.bar.location|| (b.location && b.location.toLowerCase().includes(filters.bar.location.toLowerCase())));
            const condType= (!filters.bar.type|| (b.type && b.type.toLowerCase().includes(filters.bar.type.toLowerCase())));
            const condProp= (!filters.bar.proposed|| (b.proposed && b.proposed.toLowerCase().includes(filters.bar.proposed.toLowerCase())));
            /* BEGIN: new condition for custom field */
            const condCustom= (!filters.bar.custom || (b.custom && b.custom.toLowerCase().includes(filters.bar.custom.toLowerCase())));
            /* END: new condition for custom field */

            return(condProj && condClient && condDis && condExp && condLOE && condLoc && condType && condProp && condCustom);
        });
        if(!linePass)return false;
        if(!barPass && line.bars.length>0)return false;

        // search
        if(lowerSearch){
            let lineMatch= (
                (line.name && line.name.toLowerCase().includes(lowerSearch))||
                (line.discipline && line.discipline.toLowerCase().includes(lowerSearch))||
                (line.experience && line.experience.toLowerCase().includes(lowerSearch))||
                (line.officeLocation && line.officeLocation.toLowerCase().includes(lowerSearch))||
                (line.geoLocation && line.geoLocation.toLowerCase().includes(lowerSearch))||
                (line.type && line.type.toLowerCase().includes(lowerSearch))
            );
            let barMatch= line.bars.some(b=>{
                let bFields= [
                    (b.label||"").toLowerCase(),
                    (b.projectName||"").toLowerCase(),
                    (b.client||"").toLowerCase(),
                    (b.discipline||"").toLowerCase(),
                    (b.experience||"").toLowerCase(),
                    (b.LOE||"").toLowerCase(),
                    (b.location||"").toLowerCase(),
                    (b.type||"").toLowerCase(),
                    (b.proposed||"").toLowerCase(),
                    (b.custom||"").toLowerCase() // also search in bar.custom
                ];
                return bFields.some(f=> f.includes(lowerSearch));
            });
            if(!lineMatch && !barMatch)return false;
        }
        return true;
    });

    mainFilteredLines= filteredLines;

    // Build normal lines in the table
    filteredLines.forEach((line, lineIndex)=>{
        const tr= document.createElement("tr");
        tr.className= "gantt-row";
        if(line.selected) tr.classList.add("selected");
        if(line.dragging) tr.classList.add("drag-highlight");

        // name cell
        const nameTd= document.createElement("td");
        nameTd.className= "name-cell";
        nameTd.addEventListener("mousedown", e=> onLineMouseDown(e,line,lineIndex));
        nameTd.addEventListener("contextmenu", e=>{
            e.preventDefault();
            showLineEditor(line, e.clientX, e.clientY);
        });
        const labelSpan= document.createElement("span");
        labelSpan.textContent= line.name;
        nameTd.appendChild(labelSpan);
        tr.appendChild(nameTd);

        // bar cell => colSpan timescale
        const barTd= document.createElement("td");
        barTd.colSpan= totalWeeks;
        barTd.className= "bar-cell";
        const barContainer= document.createElement("div");
        barContainer.className= "bar-row-container";

        // r-click => add bar
        barContainer.addEventListener("contextmenu", ev=>{
            if(adminMode){
                if(!ev.target.classList.contains("bar") &&
                   !ev.target.classList.contains("bar-text") &&
                   !ev.target.classList.contains("bar-handle")){
                    ev.preventDefault();
                    barCounter++;
                    let offsetX= ev.offsetX;
                    let weeksFromStart= Math.floor(offsetX/ cellWidth);
                    let {displayStart}= getDisplayRange();
                    let nb= {
                        id: barCounter,
                        label:"",
                        projectName:"New Project",
                        client:"",
                        discipline:"",
                        experience:"",
                        LOE:"",
                        location:"",
                        custom:"",
                        proposed:"no",
                        type:"proposed",
                        startAbsWeek: displayStart+ weeksFromStart,
                        length:4,
                        selected:false
                    };
                    line.bars.push(nb);
                    pushState();
                    renderTable();
                    saveToLocalStorage();
                }
            }
        });

        // render bars
        line.bars.forEach(bar=>{
            let barStart= bar.startAbsWeek;
            let barEnd= barStart+ bar.length;
            let overlapStart= Math.max(displayStart, barStart);
            let overlapEnd= Math.min(displayEnd+1, barEnd);
            let overlapLen= overlapEnd- overlapStart;
            if(overlapLen<=0)return;

            let barLeftPx= (overlapStart- displayStart)* cellWidth;
            let barWidthPx= overlapLen* cellWidth;
            const barDiv= document.createElement("div");
            barDiv.classList.add("bar");
            if(bar.selected) barDiv.classList.add("selected");

            // highlight if search matches projectName, custom field, etc.
            if(lowerSearch && (
                (bar.projectName||"").toLowerCase().includes(lowerSearch) || 
                (bar.custom||"").toLowerCase().includes(lowerSearch)
            )){
                barDiv.classList.add("highlighted");
            }
            barDiv.style.left= barLeftPx+"px";
            barDiv.style.width= barWidthPx+"px";
            barDiv.style.backgroundColor= getColorFromType(bar.type);

            // bar text
            const textSpan= document.createElement("span");
            textSpan.className= "bar-text";
            textSpan.textContent= bar.label|| bar.projectName;
            barDiv.appendChild(textSpan);

            // admin => add resize handles
            if(adminMode){
                const leftHandle= document.createElement("div");
                leftHandle.classList.add("bar-handle","left");
                const rightHandle= document.createElement("div");
                rightHandle.classList.add("bar-handle","right");
                barDiv.appendChild(leftHandle);
                barDiv.appendChild(rightHandle);
            }

            // cxt => bar editor
            barDiv.addEventListener("contextmenu", e=>{
                e.preventDefault();
                showBarEditor(bar,line,e.clientX,e.clientY);
            });
            // click => select
            barDiv.addEventListener("click", e=>{
                e.stopPropagation();
                handleBarClickSelect(bar,e);
                renderTable();
                saveToLocalStorage();
            });
            // mousedown => drag
            barDiv.addEventListener("mousedown", e=> onBarMouseDown(e,line,bar,lineIndex));

            barContainer.appendChild(barDiv);
        });

        // overlap hatch
        let sorted= [...line.bars].sort((a,b)=> a.startAbsWeek- b.startAbsWeek);
        for(let i=0; i< sorted.length; i++){
            for(let j=i+1; j< sorted.length; j++){
                let b1= sorted[i];
                let b2= sorted[j];
                let s1= Math.max(displayStart, b1.startAbsWeek);
                let e1= Math.min(displayEnd+1, b1.startAbsWeek+ b1.length);
                let s2= Math.max(displayStart, b2.startAbsWeek);
                let e2= Math.min(displayEnd+1, b2.startAbsWeek+ b2.length);
                let overlapS= Math.max(s1,s2);
                let overlapE= Math.min(e1,e2);
                if(overlapE> overlapS){
                    let leftPx= (overlapS- displayStart)* cellWidth;
                    let wPx= (overlapE- overlapS)* cellWidth;
                    let hatch= document.createElement("div");
                    hatch.className= "overlap-hatch";
                    hatch.style.left= leftPx+"px";
                    hatch.style.width= wPx+"px";
                    barContainer.appendChild(hatch);
                }
            }
        }

        barTd.appendChild(barContainer);
        tr.appendChild(barTd);
        tableBody.appendChild(tr);
    });

    // final filler row => never re-ordered or removed
    const fillerTr= document.createElement("tr");
    fillerTr.className= "filler-row";
    // filler name cell => not interactive
    const fillerNameTd= document.createElement("td");
    fillerNameTd.className= "name-cell";
    fillerNameTd.style.cursor= "default"; 
    fillerNameTd.textContent= " "; // blank
    fillerTr.appendChild(fillerNameTd);

    // filler timescale => colSpan
    const fillerBarTd= document.createElement("td");
    fillerBarTd.colSpan= totalWeeks;
    fillerBarTd.className= "bar-cell";
    fillerTr.appendChild(fillerBarTd);

    tableBody.appendChild(fillerTr);

    updateBarTextPositions();
}

/*
    ---------------------------------------------------------------------------------------------
    onLineMouseDown => reorder lines
    ---------------------------------------------------------------------------------------------
*/
function onLineMouseDown(e,line,lineIndex){
    dragging= true;
    dragType= "line-reorder";
    draggingLine= line;
    line.dragging= true;
    tableBodyRect= tableBody.getBoundingClientRect();
    renderTable();
    e.preventDefault();
}

/*
    ---------------------------------------------------------------------------------------------
    onBarMouseDown => bar drag or resize
    ---------------------------------------------------------------------------------------------
*/
function onBarMouseDown(e,line,bar,lineIndex){
    dragging= true;
    currentBar= bar;
    currentLine= line;
    dragStartX= e.clientX;
    dragStartY= e.clientY;
    initialStartAbs= bar.startAbsWeek;
    initialLength= bar.length;
    tableBodyRect= tableBody.getBoundingClientRect();

    if(adminMode){
        if(e.target.classList.contains("bar-handle")){
            if(e.target.classList.contains("left")) dragType="resize-left";
            else dragType="resize-right";
        } else {
            dragType="bar-move-admin";
        }
    } else {
        dragType="bar-move-user";
    }
    e.preventDefault();
}

/*
    ---------------------------------------------------------------------------------------------
    Document MOUSEMOVE => handle dragging
    ---------------------------------------------------------------------------------------------
*/
document.addEventListener("mousemove", e=>{
    if(!dragging)return;
    if(dragType==="line-reorder" && draggingLine){
        let posY= e.clientY- tableBodyRect.top;
        let newIndex= Math.floor(posY/ rowHeight);
        if(newIndex<0) newIndex=0;
        if(newIndex>= mainFilteredLines.length) newIndex= mainFilteredLines.length -1;
        let oldIndex= mainFilteredLines.indexOf(draggingLine);
        if(oldIndex<0)return;
        if(newIndex!== oldIndex){
            lines.splice(lines.indexOf(draggingLine),1);
            let targetLine= mainFilteredLines[newIndex];
            let targetGlobalIdx= lines.indexOf(targetLine);
            if(targetGlobalIdx<0) targetGlobalIdx= lines.length;
            lines.splice(targetGlobalIdx,0,draggingLine);
            renderTable();
        }
    }
    else if(dragType==="bar-move-admin" && currentBar){
        let dx= e.clientX- dragStartX;
        let dWeeks= Math.round(dx/ cellWidth);
        currentBar.startAbsWeek= Math.max(0, initialStartAbs+ dWeeks);

        let posY= e.clientY- tableBodyRect.top;
        let idxCur= mainFilteredLines.indexOf(currentLine);
        if(idxCur<0) idxCur=0;
        let newIdx= Math.floor(posY/ rowHeight);
        if(newIdx<0) newIdx=0;
        if(newIdx>= mainFilteredLines.length) newIdx= mainFilteredLines.length-1;
        if(newIdx!== idxCur){
            currentLine.bars= currentLine.bars.filter(b=> b.id!== currentBar.id);
            mainFilteredLines[newIdx].bars.push(currentBar);
            currentLine= mainFilteredLines[newIdx];
        }
        renderTable();
    }
    else if(dragType==="resize-left" && currentBar){
        let dx= e.clientX- dragStartX;
        let dWeeks= Math.round(dx/ cellWidth);
        let newStart= initialStartAbs+ dWeeks;
        let newLen= initialStartAbs+ initialLength - newStart;
        if(newLen<1){
            newLen=1;
            newStart= initialStartAbs+ initialLength-1;
        }
        currentBar.startAbsWeek= Math.max(0,newStart);
        currentBar.length= newLen;
        renderTable();
    }
    else if(dragType==="resize-right" && currentBar){
        let dx= e.clientX- dragStartX;
        let dWeeks= Math.round(dx/ cellWidth);
        let newLen= initialLength+ dWeeks;
        if(newLen<1)newLen=1;
        currentBar.length= newLen;
        renderTable();
    }
    else if(dragType==="bar-move-user" && currentBar){
        let posY= e.clientY- tableBodyRect.top;
        let newIndex= Math.floor(posY/ rowHeight);
        if(newIndex<0) newIndex=0;
        if(newIndex>= mainFilteredLines.length) newIndex= mainFilteredLines.length-1;
        let oldLineIdx= mainFilteredLines.indexOf(currentLine);
        if(oldLineIdx<0) oldLineIdx=0;
        if(newIndex!== oldLineIdx){
            mainFilteredLines[oldLineIdx].bars= mainFilteredLines[oldLineIdx].bars.filter(b=> b.id!== currentBar.id);
            mainFilteredLines[newIndex].bars.push(currentBar);
            currentLine= mainFilteredLines[newIndex];
            renderTable();
        }
    }
});

/*
    ---------------------------------------------------------------------------------------------
    MOUSEUP => finalize drag
    ---------------------------------------------------------------------------------------------
*/
document.addEventListener("mouseup", e=>{
    if(!dragging)return;
    dragging= false;
    if(dragType==="line-reorder"){
        draggingLine.dragging= false;
        draggingLine=null;
        pushState();
        saveToLocalStorage();
        renderTable();
    }
    else if(["bar-move-admin","resize-left","resize-right","bar-move-user"].includes(dragType)){
        currentBar= null;
        currentLine= null;
        pushState();
        saveToLocalStorage();
    }
    dragType= null;
});

/*
    ---------------------------------------------------------------------------------------------
    Document click => unselect lines/bars if blank area
    ---------------------------------------------------------------------------------------------
*/
document.addEventListener("click", evt=>{
    if(!dragging){
        let nm= evt.target.closest(".name-cell");
        let br= evt.target.closest(".bar");
        if(!nm && !br){
            lines.forEach(l=> l.selected=false);
            unselectAllBars();
            renderTable();
            saveToLocalStorage();
        }
    }
});

/*
    ---------------------------------------------------------------------------------------------
    showBarEditor => bar editor, uses bar + line references
    ---------------------------------------------------------------------------------------------
*/
function showBarEditor(bar, line, x, y){
    currentEditorBar= bar;
    currentEditorLine= line;

    // Populate fields
    barLabelInput.value= bar.label||"";
    barProjectNameInput.value= bar.projectName||"";
    barClientInput.value= bar.client||"";
    barDisciplineInput.value= bar.discipline||"";
    barExperienceInput.value= bar.experience||"";
    barLOEInput.value= bar.LOE||"";
    barLocationInput.value= bar.location||"";
    barCustomInput.value= bar.custom||"";
    barTypeSelect.value= bar.type||"proposed";
    barProposedSelect.value= bar.proposed||"no";

    let {year:sy,week:sw}= fromAbsoluteWeek(bar.startAbsWeek);
    let {year:ey,week:ew}= fromAbsoluteWeek(bar.startAbsWeek+ bar.length-1);
    startYearSelect.value= sy;
    startWeekSelect.value= sw;
    endYearSelect.value= ey;
    endWeekSelect.value= ew;

    // Restrict editing if not admin
    let ro= !adminMode;
    barLabelInput.disabled= ro;
    barProjectNameInput.disabled= ro;
    barClientInput.disabled= ro;
    barDisciplineInput.disabled= ro;
    barExperienceInput.disabled= ro;
    barLOEInput.disabled= ro;
    barLocationInput.disabled= ro;
    barCustomInput.disabled= ro;
    barTypeSelect.disabled= ro;
    barProposedSelect.disabled= ro;
    startYearSelect.disabled= ro;
    startWeekSelect.disabled= ro;
    endYearSelect.disabled= ro;
    endWeekSelect.disabled= ro;
    barDeleteBtn.disabled= ro;

    barEditor.style.display="block";
    barEditor.style.left= (x+ window.scrollX+ 10)+ "px";
    barEditor.style.top= (y+ window.scrollY+ 10)+ "px";

    // Autosave changes as user types if admin
    const autosave= ()=>{
        if(!adminMode)return;
        currentEditorBar.label= barLabelInput.value;
        currentEditorBar.projectName= barProjectNameInput.value;
        currentEditorBar.client= barClientInput.value;
        currentEditorBar.discipline= barDisciplineInput.value;
        currentEditorBar.experience= barExperienceInput.value;
        currentEditorBar.LOE= barLOEInput.value;
        currentEditorBar.location= barLocationInput.value;
        currentEditorBar.custom= barCustomInput.value;
        currentEditorBar.type= barTypeSelect.value;
        currentEditorBar.proposed= barProposedSelect.value;

        let sY= parseInt(startYearSelect.value);
        let sW= parseInt(startWeekSelect.value);
        let eY= parseInt(endYearSelect.value);
        let eW= parseInt(endWeekSelect.value);
        currentEditorBar.startAbsWeek= toAbsoluteWeek(sY, sW);
        currentEditorBar.length= toAbsoluteWeek(eY,eW)- currentEditorBar.startAbsWeek+1;
        if(currentEditorBar.length<1) currentEditorBar.length=1;

        renderTable();
        saveToLocalStorage();
    };

    barLabelInput.oninput= autosave;
    barProjectNameInput.oninput= autosave;
    barClientInput.oninput= autosave;
    barDisciplineInput.oninput= autosave;
    barExperienceInput.oninput= autosave;
    barLOEInput.oninput= autosave;
    barLocationInput.oninput= autosave;
    barCustomInput.oninput= autosave;
    barTypeSelect.onchange= autosave;
    barProposedSelect.onchange= autosave;
    startYearSelect.onchange= autosave;
    startWeekSelect.onchange= autosave;
    endYearSelect.onchange= autosave;
    endWeekSelect.onchange= autosave;
}

barEditorOkBtn.addEventListener("click", ()=>{
    barEditor.style.display="none";
    currentEditorBar= null;
    currentEditorLine= null;
    pushState();
});
barEditorCancelBtn.addEventListener("click", ()=>{
    barEditor.style.display="none";
    currentEditorBar= null;
    currentEditorLine= null;
    pushState();
});
barDeleteBtn.addEventListener("click", ()=>{
    if(!adminMode)return;
    if(!currentEditorBar|| !currentEditorLine)return;
    currentEditorLine.bars= currentEditorLine.bars.filter(b=> b.id!== currentEditorBar.id);
    barEditor.style.display="none";
    currentEditorBar= null;
    currentEditorLine= null;
    pushState();
    renderTable();
    saveToLocalStorage();
});
document.addEventListener("mousedown", e=>{
    if(barEditor.style.display==="block"){
        let rect= barEditor.getBoundingClientRect();
        let inside= (
            e.clientX>= rect.left && e.clientX<= rect.right &&
            e.clientY>= rect.top && e.clientY<= rect.bottom
        );
        if(!inside){
            barEditor.style.display="none";
            currentEditorBar= null;
            currentEditorLine= null;
            pushState();
        }
    }
});

/*
    ---------------------------------------------------------------------------------------------
    showLineEditor => line editor
    ---------------------------------------------------------------------------------------------
*/
function showLineEditor(line, x, y){
    currentEditorLine= line;
    lineNameInput.value= line.name||"";
    lineDisciplineInput.value= line.discipline||"";
    lineExperienceInput.value= line.experience||"";
    lineOfficeLocationInput.value= line.officeLocation||"";
    lineGeoLocationInput.value= line.geoLocation||"";
    lineTypeInput.value= line.type||"";

    // Restrict editing if not admin
    let ro= !adminMode;
    lineNameInput.disabled= ro;
    lineDisciplineInput.disabled= ro;
    lineExperienceInput.disabled= ro;
    lineOfficeLocationInput.disabled= ro;
    lineGeoLocationInput.disabled= ro;
    lineTypeInput.disabled= ro;
    lineDeleteBtn.disabled= ro;

    lineEditor.style.display="block";
    lineEditor.style.left= (x+ window.scrollX+10)+ "px";
    lineEditor.style.top= (y+ window.scrollY+10)+ "px";

    // Autosave line if user is admin
    const autosaveLine= ()=>{
        if(!adminMode)return;
        currentEditorLine.name= lineNameInput.value;
        currentEditorLine.discipline= lineDisciplineInput.value;
        currentEditorLine.experience= lineExperienceInput.value;
        currentEditorLine.officeLocation= lineOfficeLocationInput.value;
        currentEditorLine.geoLocation= lineGeoLocationInput.value;
        currentEditorLine.type= lineTypeInput.value;
        renderTable();
        saveToLocalStorage();
    };
    lineNameInput.oninput= autosaveLine;
    lineDisciplineInput.oninput= autosaveLine;
    lineExperienceInput.oninput= autosaveLine;
    lineOfficeLocationInput.oninput= autosaveLine;
    lineGeoLocationInput.oninput= autosaveLine;
    lineTypeInput.oninput= autosaveLine;
}

lineEditorOkBtn.addEventListener("click", ()=>{
    lineEditor.style.display="none";
    currentEditorLine= null;
    pushState();
});
lineEditorCancelBtn.addEventListener("click", ()=>{
    lineEditor.style.display="none";
    currentEditorLine= null;
    pushState();
});
lineDeleteBtn.addEventListener("click", ()=>{
    if(!adminMode)return;
    if(!currentEditorLine)return;
    lines= lines.filter(l=> l.id!== currentEditorLine.id);
    lineEditor.style.display="none";
    currentEditorLine= null;
    pushState();
    renderTable();
    saveToLocalStorage();
});
document.addEventListener("mousedown", e=>{
    if(lineEditor.style.display==="block"){
        let rect= lineEditor.getBoundingClientRect();
        let inside= (
            e.clientX>= rect.left && e.clientX<= rect.right &&
            e.clientY>= rect.top && e.clientY<= rect.bottom
        );
        if(!inside){
            lineEditor.style.display="none";
            currentEditorLine= null;
            pushState();
        }
    }
});

/*
    ---------------------------------------------------------------------------------------------
    DYNAMIC FILTER POPUP: references + auto-updates
    ---------------------------------------------------------------------------------------------
*/
const filterLineName = document.getElementById("filterLineName");
const filterLineDiscipline = document.getElementById("filterLineDiscipline");
const filterLineExperience = document.getElementById("filterLineExperience");
const filterLineOfficeLocation = document.getElementById("filterLineOfficeLocation");
const filterLineGeoLocation = document.getElementById("filterLineGeoLocation");
const filterLineType = document.getElementById("filterLineType");

const filterBarProjectName = document.getElementById("filterBarProjectName");
const filterBarClient = document.getElementById("filterBarClient");
const filterBarDiscipline = document.getElementById("filterBarDiscipline");
const filterBarExperience = document.getElementById("filterBarExperience");
const filterBarLOE = document.getElementById("filterBarLOE");
const filterBarLocation = document.getElementById("filterBarLocation");
const filterBarType = document.getElementById("filterBarType");
const filterBarProposed = document.getElementById("filterBarProposed");
/* BEGIN: new reference for custom bar filter */
const filterBarCustom = document.getElementById("filterBarCustom");
/* END: new reference */

function autoRefreshFilters(){
    filters.line.name= filterLineName.value.trim()|| null;
    filters.line.discipline= filterLineDiscipline.value.trim()|| null;
    filters.line.experience= filterLineExperience.value.trim()|| null;
    filters.line.officeLocation= filterLineOfficeLocation.value.trim()|| null;
    filters.line.geoLocation= filterLineGeoLocation.value.trim()|| null;
    filters.line.type= filterLineType.value.trim()|| null;

    filters.bar.projectName= filterBarProjectName.value.trim()|| null;
    filters.bar.client= filterBarClient.value.trim()|| null;
    filters.bar.discipline= filterBarDiscipline.value.trim()|| null;
    filters.bar.experience= filterBarExperience.value.trim()|| null;
    filters.bar.LOE= filterBarLOE.value.trim()|| null;
    filters.bar.location= filterBarLocation.value.trim()|| null;
    filters.bar.type= filterBarType.value.trim()|| null;
    filters.bar.proposed= filterBarProposed.value.trim()|| null;
    /* BEGIN: set filters.bar.custom from new field */
    filters.bar.custom= filterBarCustom.value.trim()|| null;
    /* END: set custom filter */

    // Remove empty keys
    for(let k in filters.line){
        if(!filters.line[k]) delete filters.line[k];
    }
    for(let k in filters.bar){
        if(!filters.bar[k]) delete filters.bar[k];
    }
    renderTable();
}
// Attach autoRefreshFilters to each filter input
[
  filterLineName,
  filterLineDiscipline,
  filterLineExperience,
  filterLineOfficeLocation,
  filterLineGeoLocation,
  filterLineType,
  filterBarProjectName,
  filterBarClient,
  filterBarDiscipline,
  filterBarExperience,
  filterBarLOE,
  filterBarLocation,
  filterBarType,
  filterBarProposed,
  /* add the new custom field */
  filterBarCustom
].forEach(el => {
  el.addEventListener("input", autoRefreshFilters);
});

/*
    ---------------------------------------------------------------------------------------------
    FILTERS => filter modal
    ---------------------------------------------------------------------------------------------
*/
filterBtn.addEventListener("click", ()=>{
    filterLineName.value= filters.line.name||"";
    filterLineDiscipline.value= filters.line.discipline||"";
    filterLineExperience.value= filters.line.experience||"";
    filterLineOfficeLocation.value= filters.line.officeLocation||"";
    filterLineGeoLocation.value= filters.line.geoLocation||"";
    filterLineType.value= filters.line.type||"";

    filterBarProjectName.value= filters.bar.projectName||"";
    filterBarClient.value= filters.bar.client||"";
    filterBarDiscipline.value= filters.bar.discipline||"";
    filterBarExperience.value= filters.bar.experience||"";
    filterBarLOE.value= filters.bar.LOE||"";
    filterBarLocation.value= filters.bar.location||"";
    filterBarType.value= filters.bar.type||"";
    filterBarProposed.value= filters.bar.proposed||"";
    /* populate the new filter input if used */
    filterBarCustom.value= filters.bar.custom||"";

    filterModal.style.display="block";
});
filterApplyBtn.addEventListener("click", ()=>{
    // We already auto-refresh, just hide modal here
    filterModal.style.display="none";
});
filterClearBtn.addEventListener("click", ()=>{
    filters.line={};
    filters.bar={};
    filterModal.style.display="none";
    renderTable();
});
filterCancelBtn.addEventListener("click", ()=>{
    filterModal.style.display="none";
});
document.addEventListener("mousedown", e=>{
    if(filterModal.style.display==="block"){
        let rect= filterModal.getBoundingClientRect();
        let inside= (
            e.clientX>= rect.left && e.clientX<= rect.right &&
            e.clientY>= rect.top && e.clientY<= rect.bottom
        );
        if(!inside){
            filterModal.style.display="none";
        }
    }
});

/*
    ---------------------------------------------------------------------------------------------
    THEME => replaced gear icon with "themeToggleBtn"
    ---------------------------------------------------------------------------------------------
*/
const settingsModal= document.getElementById("settingsModal");
const settingsOkBtn= document.getElementById("settingsOkBtn");
const settingsCancelBtn= document.getElementById("settingsCancelBtn");
const themeSelect= document.getElementById("themeSelect");
const securedColor= document.getElementById("securedColor");
const proposedColor= document.getElementById("proposedColor");
const opportunityColor= document.getElementById("opportunityColor");
const futureColor= document.getElementById("futureColor");

document.getElementById("themeToggleBtn").addEventListener("click", ()=>{
    // show settings modal
    themeSelect.value= currentTheme;
    securedColor.value= typeColors.secured;
    proposedColor.value= typeColors.proposed;
    opportunityColor.value= typeColors.opportunity;
    futureColor.value= typeColors.future;
    settingsModal.style.display= "block";
});
settingsOkBtn.addEventListener("click", ()=>{
    currentTheme= themeSelect.value;
    typeColors.secured= securedColor.value;
    typeColors.proposed= proposedColor.value;
    typeColors.opportunity= opportunityColor.value;
    typeColors.future= futureColor.value;
    settingsModal.style.display="none";
    applyTheme();
});
settingsCancelBtn.addEventListener("click", ()=>{
    settingsModal.style.display="none";
});
document.addEventListener("mousedown", e=>{
    if(settingsModal.style.display==="block"){
        let rect= settingsModal.getBoundingClientRect();
        let inside= (
            e.clientX>= rect.left && e.clientX<= rect.right &&
            e.clientY>= rect.top && e.clientY<= rect.bottom
        );
        if(!inside){
            settingsModal.style.display="none";
        }
    }
});

/*
    ---------------------------------------------------------------------------------------------
    ABOUT => replaced help icon with aboutToggleBtn
    ---------------------------------------------------------------------------------------------
*/
document.getElementById("aboutToggleBtn").addEventListener("click", ()=>{
    alert(`
Sleek Professional Gantt Planner - Quick Tips:
1) Admin Mode can be toggled with the "Admin" button (password "Password").
2) Timescale updates dynamically; if Start > End, it alerts an error.
3) The last row is a permanent filler row so nothing gets cut off at the bottom.
4) "Theme" toggles color picks for dark/light or custom bar colors.
5) "Import/Export" supports JSON and CSV.
6) "Print/PDF" only prints the currently visible portion in the scrolled table area.
Enjoy planning!
    `);
});

/*
    ---------------------------------------------------------------------------------------------
    SEARCH => instant filter
    ---------------------------------------------------------------------------------------------
*/
const searchInput= document.getElementById("searchInput");
searchInput.addEventListener("input", ()=>{
    searchTerm= searchInput.value.trim();
    renderTable();
});

/*
    ---------------------------------------------------------------------------------------------
    ADMIN TOGGLE => adminToggleBtn
    ---------------------------------------------------------------------------------------------
*/
const adminToggleBtn= document.getElementById("adminToggleBtn");
adminToggleBtn.addEventListener("click", ()=>{
    if(!adminMode){
        let pwd= prompt("Enter admin password:");
        if(pwd==="Password"){
            adminMode= true;
            alert("Admin mode enabled.");
        } else {
            alert("Incorrect password. Remaining in user mode.");
            return;
        }
    } else {
        adminMode= false;
        alert("Admin mode disabled.");
    }
    csvEditToggleBtn.style.display= adminMode? "inline-block":"none";
    renderTable();
});

/*
    ---------------------------------------------------------------------------------------------
    CSV EDIT => remains hidden unless admin
    ---------------------------------------------------------------------------------------------
*/
const csvEditToggleBtn= document.getElementById("csvEditToggleBtn");
const csvEditModal= document.getElementById("csvEditModal");
const csvTextarea= document.getElementById("csvTextarea");
const csvEditApplyBtn= document.getElementById("csvEditApplyBtn");
const csvEditCancelBtn= document.getElementById("csvEditCancelBtn");

/**
 * Show CSV in text area so admin can edit quickly
 */
csvEditToggleBtn.addEventListener("click", ()=>{
    if(!adminMode)return;
    // Updated CSV header to include new "Custom" column
    let csvStr= "Line ID,Line Name,Line Discipline,Line Experience,Line OfficeLocation,Line GeoLocation,Line Type,"+
                "Bar ID,Bar Label,Project Name,Client,Discipline,Experience,LOE,Location,Custom,Proposed,Type,"+
                "Start Year,Start Week,End Year,End Week,Duration (weeks)\n";
    lines.forEach(line=>{
        if(!line.bars.length){
            csvStr+= `${line.id||""},"${line.name||""}","${line.discipline||""}","${line.experience||""}","${line.officeLocation||""}","${line.geoLocation||""}","${line.type||""}",,,,,,,,,,,,\n`;
        } else {
            line.bars.forEach(bar=>{
                let {year:sy,week:sw}= fromAbsoluteWeek(bar.startAbsWeek);
                let {year:ey,week:ew}= fromAbsoluteWeek(bar.startAbsWeek+ bar.length-1);
                csvStr+= `${line.id||""},"${line.name||""}","${line.discipline||""}","${line.experience||""}","${line.officeLocation||""}","${line.geoLocation||""}","${line.type||""}",`;
                csvStr+= `${bar.id||""},"${bar.label||""}","${bar.projectName||""}","${bar.client||""}","${bar.discipline||""}","${bar.experience||""}","${bar.LOE||""}","${bar.location||""}","${bar.custom||""}","${bar.proposed||""}","${bar.type||""}",`;
                csvStr+= `${sy},${sw},${ey},${ew},${bar.length}\n`;
            });
        }
    });
    csvTextarea.value= csvStr;
    csvEditModal.style.display= "block";
});
csvEditApplyBtn.addEventListener("click", ()=>{
    if(!adminMode)return;
    let csvData= csvTextarea.value;
    try {
        let parsed= parseCsv(csvData);
        lines= parsed.lines;
        lineCounter= parsed.lineCounter;
        barCounter= parsed.barCounter;
        pushState();
        renderTable();
        saveToLocalStorage();
        alert("CSV updated successfully.");
        csvEditModal.style.display= "none";
    } catch(err){
        alert("Error parsing CSV: "+ err.message);
    }
});
csvEditCancelBtn.addEventListener("click", ()=>{
    csvEditModal.style.display= "none";
});
document.addEventListener("mousedown", e=>{
    if(csvEditModal.style.display==="block"){
        let rect= csvEditModal.getBoundingClientRect();
        let inside= (
            e.clientX>= rect.left && e.clientX<= rect.right &&
            e.clientY>= rect.top && e.clientY<= rect.bottom
        );
        if(!inside){
            csvEditModal.style.display="none";
        }
    }
});

/*
    ---------------------------------------------------------------------------------------------
    IMPORT => JSON/CSV
    ---------------------------------------------------------------------------------------------
*/
const importJsonBtn= document.getElementById("importJsonBtn");
const importFileInput= document.getElementById("importFileInput");
importJsonBtn.addEventListener("click", ()=>{
    importFileInput.value="";
    importFileInput.click();
});
importFileInput.addEventListener("change", e=>{
    let file= e.target.files[0];
    if(!file)return;
    let reader= new FileReader();
    reader.onload= ev=>{
        try{
            let imported;
            if(file.name.endsWith(".json")){
                imported= JSON.parse(ev.target.result);
                lines= imported.lines|| [];
                startYear= imported.startYear|| startYear;
                startWeek= imported.startWeek|| startWeek;
                endYear= imported.endYear|| endYear;
                endWeek= imported.endWeek|| endWeek;
                lineCounter= imported.lineCounter|| lineCounter;
                barCounter= imported.barCounter|| barCounter;
                cellWidth= imported.cellWidth|| cellWidth;
                rowHeight= imported.rowHeight|| rowHeight;
                typeColors= imported.typeColors|| typeColors;
                currentTheme= imported.currentTheme|| currentTheme;
                lines.forEach(l=>{
                    l.selected=false;
                    l.dragging=false;
                    l.bars.forEach(b=>{
                        b.selected=false;
                        if(b.type===undefined) b.type="proposed";
                        if(b.label===undefined) b.label="";
                        if(b.custom===undefined) b.custom="";
                    });
                });
            } else if(file.name.endsWith(".csv")){
                let parsed= parseCsv(ev.target.result);
                lines= parsed.lines;
                lineCounter= parsed.lineCounter;
                barCounter= parsed.barCounter;
            } else {
                throw new Error("Unsupported file type");
            }
            startYearInput.value= startYear;
            startWeekInput.value= startWeek;
            endYearInput.value= endYear;
            endWeekInput.value= endWeek;
            zoomSlider.value= cellWidth;
            heightZoomSlider.value= rowHeight;
            themeSelect.value= currentTheme;
            securedColor.value= typeColors.secured;
            proposedColor.value= typeColors.proposed;
            opportunityColor.value= typeColors.opportunity;
            futureColor.value= typeColors.future;
            updateCSSVariables();
            applyTheme();
            renderTable();
            saveToLocalStorage();
            alert("Import successful!");
        } catch(err){
            console.error(err);
            alert("Import failed: "+ err.message);
        }
    };
    reader.readAsText(file);
});

/*
    ---------------------------------------------------------------------------------------------
    CSV => minimal columns
    ---------------------------------------------------------------------------------------------
*/
const downloadCsvBtn= document.getElementById("downloadCsvBtn");
downloadCsvBtn.addEventListener("click", ()=>{
    // Updated CSV header to include new "Custom" column
    let csv= "Line ID,Line Name,Line Discipline,Line Experience,Line OfficeLocation,Line GeoLocation,Line Type,"+
             "Bar ID,Bar Label,Project Name,Client,Discipline,Experience,LOE,Location,Custom,Proposed,Type,"+
             "Start Year,Start Week,End Year,End Week,Duration (weeks)\n";
    lines.forEach(line=>{
       if(!line.bars.length){
           csv+= `${line.id||""},"${line.name||""}","${line.discipline||""}","${line.experience||""}","${line.officeLocation||""}","${line.geoLocation||""}","${line.type||""}",,,,,,,,,,,,\n`;
       } else {
           line.bars.forEach(bar=>{
               let {year:sy,week:sw}= fromAbsoluteWeek(bar.startAbsWeek);
               let {year:ey,week:ew}= fromAbsoluteWeek(bar.startAbsWeek+ bar.length-1);
               csv+= `${line.id||""},"${line.name||""}","${line.discipline||""}","${line.experience||""}","${line.officeLocation||""}","${line.geoLocation||""}","${line.type||""}",`;
               csv+= `${bar.id||""},"${bar.label||""}","${bar.projectName||""}","${bar.client||""}","${bar.discipline||""}","${bar.experience||""}","${bar.LOE||""}","${bar.location||""}","${bar.custom||""}","${bar.proposed||""}","${bar.type||""}",`;
               csv+= `${sy},${sw},${ey},${ew},${bar.length}\n`;
           });
       }
    });
    let blob= new Blob([csv], {type:"text/csv;charset=utf-8;"});
    let url= URL.createObjectURL(blob);
    let a= document.createElement("a");
    a.download= "gantt-data.csv";
    a.href= url;
    a.click();
    URL.revokeObjectURL(url);
});

/*
    ---------------------------------------------------------------------------------------------
    PRINT => only prints current portion
    ---------------------------------------------------------------------------------------------
*/
const printBtn= document.getElementById("printBtn");
printBtn.addEventListener("click", ()=>{
    window.print();
});

/*
    ---------------------------------------------------------------------------------------------
    ZOOM => cellWidth & rowHeight
    ---------------------------------------------------------------------------------------------
*/
const zoomSlider= document.getElementById("zoomSlider");
const heightZoomSlider= document.getElementById("heightZoomSlider");
zoomSlider.addEventListener("input", e=>{
    cellWidth= parseInt(e.target.value);
    pushState();
    updateCSSVariables();
    renderTable();
    saveToLocalStorage();
});
heightZoomSlider.addEventListener("input", e=>{
    rowHeight= parseInt(e.target.value);
    pushState();
    updateCSSVariables();
    renderTable();
    saveToLocalStorage();
});

/*
    ---------------------------------------------------------------------------------------------
    UNDO/REDO
    ---------------------------------------------------------------------------------------------
*/
function pushState(){
    let st= JSON.parse(JSON.stringify({
        lines,
        startYear,
        startWeek,
        endYear,
        endWeek,
        lineCounter,
        barCounter,
        cellWidth,
        rowHeight,
        typeColors,
        currentTheme
    }));
    undoStack.push(st);
    redoStack= [];
}

function restoreState(st){
    lines= st.lines;
    startYear= st.startYear;
    startWeek= st.startWeek;
    endYear= st.endYear;
    endWeek= st.endWeek;
    lineCounter= st.lineCounter;
    barCounter= st.barCounter;
    cellWidth= st.cellWidth;
    rowHeight= st.rowHeight;
    typeColors= st.typeColors;
    currentTheme= st.currentTheme;
    updateCSSVariables();
    applyTheme();
    renderTable();
    saveToLocalStorage();
}

function undo(){
    if(!adminMode)return;
    if(undoStack.length<2)return;
    let cur= undoStack.pop();
    redoStack.push(cur);
    let prev= undoStack[undoStack.length-1];
    restoreState(prev);
}

function redo(){
    if(!adminMode)return;
    if(!redoStack.length)return;
    let nxt= redoStack.pop();
    let cur= JSON.parse(JSON.stringify({
        lines,
        startYear,
        startWeek,
        endYear,
        endWeek,
        lineCounter,
        barCounter,
        cellWidth,
        rowHeight,
        typeColors,
        currentTheme
    }));
    undoStack.push(cur);
    restoreState(nxt);
}

/*
    ---------------------------------------------------------------------------------------------
    Timescale => dynamic updates + error check if Start > End
    ---------------------------------------------------------------------------------------------
*/
function checkTimescale(){
    let ds= toAbsoluteWeek(startYear, startWeek);
    let de= toAbsoluteWeek(endYear, endWeek);
    if(ds> de){
        alert("Error: The Start date is later than the End date. Please fix.");
        return false;
    }
    return true;
}

function timescaleChange(){
    startYear= parseInt(startYearInput.value)|| 2025;
    startWeek= parseInt(startWeekInput.value)|| 1;
    endYear= parseInt(endYearInput.value)||2025;
    endWeek= parseInt(endWeekInput.value)||52;
    if(checkTimescale()){
        pushState();
        renderTable();
        saveToLocalStorage();
    }
}
const startYearInput= document.getElementById("startYearInput");
const startWeekInput= document.getElementById("startWeekInput");
const endYearInput= document.getElementById("endYearInput");
const endWeekInput= document.getElementById("endWeekInput");
startYearInput.addEventListener("change", timescaleChange);
startWeekInput.addEventListener("change", timescaleChange);
endYearInput.addEventListener("change", timescaleChange);
endWeekInput.addEventListener("change", timescaleChange);

/*
    ---------------------------------------------------------------------------------------------
    INIT => onload
    ---------------------------------------------------------------------------------------------
*/
const tableWrapper= document.getElementById("tableWrapper");
const headerRow= document.getElementById("headerRow");
const tableBody= document.getElementById("tableBody");

/**
 * Called once on page load
 */
function init(){
    loadFromLocalStorage();
    populateDateSelects();
    updateCSSVariables();
    startYearInput.value= startYear;
    startWeekInput.value= startWeek;
    endYearInput.value= endYear;
    endWeekInput.value= endWeek;
    zoomSlider.value= cellWidth;
    heightZoomSlider.value= rowHeight;
    themeSelect.value= currentTheme;
    securedColor.value= typeColors.secured;
    proposedColor.value= typeColors.proposed;
    opportunityColor.value= typeColors.opportunity;
    futureColor.value= typeColors.future;
    applyTheme();
    renderTable();
    pushState();
    tableWrapper.addEventListener("scroll", ()=> updateBarTextPositions());
    window.addEventListener("resize", ()=> updateBarTextPositions());
}
window.addEventListener("load", init);

/*
    populate the year/week <select> for bar date picking
*/
function populateDateSelects(){
    let years=[];
    for(let y=2023; y<=2030; y++){
        years.push(y);
    }
    let weeks=[];
    for(let w=1; w<=52; w++){
        weeks.push(w);
    }
    [startYearSelect, endYearSelect].forEach(sel=>{
        sel.innerHTML="";
        years.forEach(Y=>{
            let opt= document.createElement("option");
            opt.value= Y;
            opt.textContent= Y;
            sel.appendChild(opt);
        });
    });
    [startWeekSelect, endWeekSelect].forEach(sel=>{
        sel.innerHTML="";
        weeks.forEach(W=>{
            let opt= document.createElement("option");
            opt.value= W;
            opt.textContent= W;
            sel.appendChild(opt);
        });
    });
}

/*
    parseCsv helper => minimal CSV parser
*/
function parseCsv(csvString){
    let linesArr= csvString.split(/\r?\n/);
    if(!linesArr.length) return { lines:[], lineCounter:0, barCounter:0 };
    let header= linesArr[0].split(",");
    linesArr.shift();
    let data=[];
    linesArr.forEach(row=>{
        if(!row.trim()) return;
        let cols= splitCsvRow(row);
        let entry={};
        for(let i=0; i< header.length; i++){
            entry[header[i].trim()]= (cols[i]||"").trim();
        }
        data.push(entry);
    });

    // Rebuild lines/bars from CSV data
    let rebuilt= {};
    let lineCount=0, barCount=0;

    data.forEach(r=>{
        let lineId= r["Line ID"]||"";
        if(!rebuilt[lineId]){
            rebuilt[lineId]= {
                id: parseInt(lineId)|| (1000+Object.keys(rebuilt).length),
                name: stripQuotes(r["Line Name"]||""),
                discipline: stripQuotes(r["Line Discipline"]||""),
                experience: stripQuotes(r["Line Experience"]||""),
                officeLocation: stripQuotes(r["Line OfficeLocation"]||""),
                geoLocation: stripQuotes(r["Line GeoLocation"]||""),
                type: stripQuotes(r["Line Type"]||""),
                bars: [],
                selected:false,
                dragging:false
            };
            lineCount++;
        }
        let barId= r["Bar ID"]||"";
        if(barId.trim()){
            let sy= parseInt(r["Start Year"]||"2025");
            let sw= parseInt(r["Start Week"]||"1");
            let ey= parseInt(r["End Year"]||"2025");
            let ew= parseInt(r["End Week"]||"1");
            let startAbs= toAbsoluteWeek(sy,sw);
            let endAbs= toAbsoluteWeek(ey,ew);
            let length= endAbs- startAbs+1;
            if(length<1) length=1;
            rebuilt[lineId].bars.push({
                id: parseInt(barId)|| (9999+barCount),
                label: stripQuotes(r["Bar Label"]||""),
                projectName: stripQuotes(r["Project Name"]||""),
                client: stripQuotes(r["Client"]||""),
                discipline: stripQuotes(r["Discipline"]||""),
                experience: stripQuotes(r["Experience"]||""),
                LOE: stripQuotes(r["LOE"]||""),
                location: stripQuotes(r["Location"]||""),
                // parse new custom column
                custom: stripQuotes(r["Custom"]||""),
                proposed: stripQuotes(r["Proposed"]||"no").toLowerCase(),
                type: stripQuotes(r["Type"]||"proposed").toLowerCase(),
                startAbsWeek: startAbs,
                length,
                selected:false
            });
            barCount++;
        }
    });

    let finalLines= Object.values(rebuilt);
    return {
        lines: finalLines,
        lineCounter: lineCount,
        barCounter: barCount
    };
}

/**
 * A basic CSV row splitter that accounts for quotes
 */
function splitCsvRow(row){
    let result=[];
    let cur="";
    let inQuotes=false;
    for(let i=0; i< row.length; i++){
        let c= row[i];
        if(c==='"'){
            inQuotes=!inQuotes;
            cur+= c;
        } else if(c===',' && !inQuotes){
            result.push(cur);
            cur="";
        } else {
            cur+= c;
        }
    }
    result.push(cur);
    return result;
}

/**
 * Remove surrounding quotes from string
 * @param {string} str 
 * @returns {string}
 */
function stripQuotes(str){
    return str.replace(/^"(.*)"$/, "$1");
}
</script>
</body>
</html>
