<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Character set: Declares UTF-8 encoding to prevent garbled text -->
    <meta charset="UTF-8" />
    <!-- Page Title: Shown in browser tab -->
    <title>Advanced Gantt Chart</title>
    <!-- Bootstrap 5 CSS via CDN: for grid, modals, etc. -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
    <style>
        /* Make navbar/toolbar span the full screen width */
        .navbar .container-fluid {
            max-width: 100vw;
        }

        /* Remove default body margin, set font: resets margin, sets default font */
        body {
            margin: 0;
            font-family: Arial, sans-serif;
        }

        /* Navbar: Sticky at top, always visible, full width */
        .navbar {
            position: sticky;
            top: 0;
            z-index: 1000;
            background-color: #f8f9fa;
            padding: 0.5rem 1rem;
            width: 100%;
        }

        /* Force the navbar collapse area to flex-wrap so we can stack items vertically */
        .navbar-collapse {
            display: flex !important;
            flex-wrap: wrap !important;
            align-items: flex-start !important;
        }

        /* Each toolbar group can be stacked */
        .toolbar-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            padding: 0.5rem;
            border-left: 1px solid #dee2e6;
        }

        .toolbar-group:first-child {
            border-left: none;
            padding-left: 0;
        }

        /* For stacking label/inputs in a vertical manner (timescale, etc.) */
        .stacked-field {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        /* Timescale block to group timescale items */
        .timescale-block {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        /* color legend stacked vertically */
        .legend-container-vertical {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        /* Gantt container: Full width with padding */
        .gantt-container {
            margin: 0 1rem;
            position: relative;
        }

        /* Cohesive table: Native HTML table for perfect alignment */
        #ganttTable {
            width: 100%;
            border-collapse: collapse; /* needed for aligned borders */
            table-layout: fixed; /* Ensures column widths remain consistent */
        }

        /*
         * Add black gridlines to rows and columns.
         * Each cell, including the header cells, gets a 1px solid black border.
         */
        #ganttTable,
        #ganttTable thead th,
        #ganttTable tbody td {
            border: 1px solid #000;
        }

        /* Header row: Sticky top */
        #ganttTable thead th {
            position: sticky;
            top: 0px;
            background-color: #f8f9fa;
            z-index: 10;
            border-bottom: 1px solid #dee2e6;
            text-align: center;
            font-size: 0.9rem;
            padding: 4px 8px;
            box-sizing: border-box;
        }

        /* Name header: width, background */
        #nameHeader {
            width: 240px;
            text-align: center;
            font-weight: bold;
            background-color: #f8f9fa;
            border-right: 1px solid #dee2e6;
            z-index: 11;
        }

        /* Timescale headers: dynamically sized columns for each week */
        .timescale-header {
            background-color: #e9ecef;
            border-right: 1px solid #dee2e6;
            min-width: 50px;
        }

        /* Table body with dynamic background based on rowHeight/cellWidth. We'll override to color columns by month. */
        #ganttTable tbody {
            position: relative;
        }

        /* Row: dynamic height via CSS variable */
        .gantt-row {
            height: var(--row-height);
            transition: outline 0.2s;
        }

        /* Selected row highlight */
        .gantt-row.selected {
            background-color: #fff3cd;
        }

        /* Highlight row in yellow when dragging (feedback) */
        .gantt-row.drag-highlight {
            outline: 2px solid yellow;
        }

        /* Name cell: Sticky left, background, etc. */
        .name-cell {
            position: sticky;
            left: 0;
            background-color: #f0f0f0;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.2);
            z-index: 9;
            width: 240px;
            border-right: 1px solid #dee2e6;
            display: flex;
            justify-content: center;
            align-items: center;
            height: var(--row-height);
            box-sizing: border-box;
            cursor: move;
        }

        /* Bar container cell: for absolute bar placement */
        .bar-cell {
            position: relative;
            border-right: 1px solid #dee2e6;
            padding: 0;
        }

        /* Full row bar container: flex center */
        .bar-row-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
        }

        /* Bar: absolute, with fluid dragging in admin, vertical-only in user */
        .bar {
            position: absolute;
            height: calc(var(--row-height) - 16px);
            top: auto;
            left: 0;
            border-radius: 4px;
            color: #fff;
            cursor: pointer; /* We'll use right-click for the editor now */
            user-select: none;
            opacity: 0.7;
            overflow: hidden;
            z-index: 0;
            box-sizing: border-box;
        }

        .bar.selected {
            outline: 3px solid #00f;
        }

        /* Highlighted for search matches */
        .bar.highlighted {
            outline: 3px solid #0d6efd;
            opacity: 0.9;
        }

        /* Bar text: center horizontally */
        .bar-text {
            position: absolute;
            top: 0;
            height: 100%;
            line-height: calc(var(--row-height) - 16px);
            white-space: nowrap;
            pointer-events: none;
            font-weight: 500;
            padding: 0 8px;
        }

        /* Resize handles in admin mode only */
        .bar-handle {
            position: absolute;
            top: 0;
            width: 6px;
            height: 100%;
            cursor: col-resize;
            background-color: rgba(255,255,255,0.4);
            z-index: 2;
        }

        .bar-handle.left {
            left: 0;
            border-radius: 4px 0 0 4px;
        }

        .bar-handle.right {
            right: 0;
            border-radius: 0 4px 4px 0;
        }

        /* Overlap hatch: indicates overlapping bars */
        .overlap-hatch {
            position: absolute;
            height: calc(var(--row-height) - 16px);
            top: auto;
            background: repeating-linear-gradient(
                45deg,
                red,
                red 2px,
                transparent 2px,
                transparent 4px
            );
            opacity: 0.5;
            pointer-events: none;
            z-index: 1;
            margin-top: 0;
            margin-bottom: 0;
        }

        /* The main wrapper for scrolling */
        .table-wrapper {
            overflow: auto;
            max-height: calc(100vh - 96px);
            position: relative;
        }

        /* Editor overlays have high z-index to appear above everything */
        #barEditor,
        #lineEditor {
            position: absolute;
            display: none;
            background: #fff;
            border: 1px solid #ccc;
            padding: 12px;
            border-radius: 6px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.5);
            z-index: 9999;
            min-width: 280px;
        }

        #barEditor label,
        #lineEditor label {
            display: block;
            margin-top: 8px;
            font-weight: 500;
        }

        #barEditor input,
        #barEditor select,
        #lineEditor input {
            margin-top: 4px;
            width: 100%;
        }

        #barEditorActions,
        #lineEditorActions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 12px;
        }

        /* Filter modal with two cards side-by-side */
        #filterModal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            border: 1px solid #ccc;
            padding: 20px;
            border-radius: 6px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.5);
            z-index: 9999;
            min-width: 600px;
        }

        #filterModal h3 {
            margin-top: 0;
        }

        .filter-container {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            gap: 20px;
        }

        .filter-card {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .filter-card h5 {
            margin-top: 0;
            margin-bottom: 6px;
            font-size: 1rem;
            font-weight: 600;
        }

        #filterActions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 12px;
        }

        /* Settings modal */
        #settingsModal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            border: 1px solid #ccc;
            padding: 20px;
            border-radius: 6px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.5);
            z-index: 9999;
            min-width: 300px;
        }

        #settingsModal h3 {
            margin-top: 0;
        }

        #settingsModal label {
            display: block;
            margin-top: 8px;
        }

        #settingsActions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 12px;
        }

        .color-picker {
            width: 60px;
            height: 30px;
            padding: 0;
            border: none;
            cursor: pointer;
        }

        /* Dark theme */
        body.dark-theme {
            background-color: #212529;
            color: #f8f9fa;
        }

        body.dark-theme .navbar {
            background-color: #343a40 !important;
        }

        body.dark-theme #ganttTable thead th,
        body.dark-theme .timescale-header {
            background-color: #495057;
            color: #f8f9fa;
        }

        body.dark-theme .name-cell {
            background-color: #444;
            color: #f8f9fa;
            box-shadow: 1px 1px 3px rgba(255,255,255,0.2);
        }

        body.dark-theme .bar-text {
            color: #212529;
        }

        body.dark-theme #barEditor,
        body.dark-theme #lineEditor,
        body.dark-theme #filterModal,
        body.dark-theme #settingsModal,
        body.dark-theme #csvEditModal {
            background: #343a40;
            color: #f8f9fa;
            border: 1px solid #495057;
        }

        body.dark-theme input,
        body.dark-theme select,
        body.dark-theme textarea {
            background: #495057;
            color: #f8f9fa;
            border: 1px solid #6c757d;
        }

        /* Zoom sliders styling */
        .zoom-slider {
            width: 120px;
            margin: 0 8px;
            height: 8px;
            border-radius: 4px;
            background: #ced4da;
            outline: none;
            -webkit-appearance: none;
            box-shadow: 0 2px 6px rgba(0,0,0,0.25);
        }

        .zoom-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #0d6efd;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .zoom-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #0d6efd;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        #heightZoomSlider {
            transform: rotate(-90deg);
            width: 100px;
        }

        /* CSV Edit modal must appear on top of everything as well */
        #csvEditModal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            width: 60%;
            height: 60%;
            transform: translate(-50%, -50%);
            background: #fff;
            border: 1px solid #ccc;
            padding: 10px;
            border-radius: 6px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.5);
            z-index: 99999;
            overflow: auto;
        }

        #csvTextarea {
            width: 100%;
            height: 70%;
            font-family: monospace;
            font-size: 0.9rem;
        }

        #csvEditModalActions {
            margin-top: 10px;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        /* Print styling, hide UI elements */
        @media print {
            .navbar,
            #barEditor,
            #lineEditor,
            #filterModal,
            #settingsModal,
            #adminToggleBtn,
            #csvEditToggleBtn,
            #csvEditModal {
                display: none !important;
            }

            .table-wrapper {
                overflow: visible;
                max-height: none;
            }

            #ganttTable {
                font-size: 10pt;
            }
        }

        /* Help button */
        #helpBtn {
            cursor: pointer;
            transition: transform 0.2s;
        }
        #helpBtn:hover {
            transform: scale(1.1);
        }

        /* Settings button */
        #settingsBtn {
            cursor: pointer;
            transition: transform 0.2s;
        }
        #settingsBtn:hover {
            transform: scale(1.1);
        }
    </style>
</head>
<body>
<!-- Sticky navbar with stacked layout inside for space savings -->
<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
        <!-- Brand -->
        <a class="navbar-brand" href="#">Gantt Planner</a>
        <!-- Toggler -->
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
                aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <!-- Collapsible content with wrap -->
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <!-- Timescale group -->
            <div class="toolbar-group">
                <span>Timescale</span>
                <div class="timescale-block">
                    <div class="stacked-field">
                        <label for="startYearInput" class="form-label m-0">Start Year:</label>
                        <input id="startYearInput" type="number" class="form-control form-control-sm" value="2025" />
                    </div>
                    <div class="stacked-field">
                        <label for="startWeekInput" class="form-label m-0">Start Week:</label>
                        <input id="startWeekInput" type="number" class="form-control form-control-sm" value="1" />
                    </div>
                    <div class="stacked-field">
                        <label for="endYearInput" class="form-label m-0">End Year:</label>
                        <input id="endYearInput" type="number" class="form-control form-control-sm" value="2025" />
                    </div>
                    <div class="stacked-field">
                        <label for="endWeekInput" class="form-label m-0">End Week:</label>
                        <input id="endWeekInput" type="number" class="form-control form-control-sm" value="52" />
                    </div>
                    <button id="applyTimescaleBtn" type="button" class="btn btn-secondary btn-sm">Apply</button>
                </div>
            </div>

            <!-- Legend group -->
            <div class="toolbar-group">
                <span>Legend</span>
                <div id="statusLegend" class="legend-container-vertical">
                    <div class="legend-item">
                        <div class="legend-swatch" style="width:16px; height:16px; background:#28a745;"></div>
                        <span>Secured</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-swatch" style="width:16px; height:16px; background:#fd7e14;"></div>
                        <span>Proposed</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-swatch" style="width:16px; height:16px; background:#dc3545;"></div>
                        <span>Opportunity</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-swatch" style="width:16px; height:16px; background:#6f42c1;"></div>
                        <span>Future</span>
                    </div>
                </div>
            </div>

            <!-- Zoom group -->
            <div class="toolbar-group">
                <span>Zoom</span>
                <div style="display: flex; flex-direction: row; gap: 0.5rem;">
                    <div>
                        <label for="zoomSlider" class="form-label m-0 me-2">H-Zoom:</label>
                        <input type="range" class="zoom-slider" id="zoomSlider" min="50" max="300" value="150" step="10">
                    </div>
                    <div>
                        <label for="heightZoomSlider" class="form-label m-0 me-2">V-Zoom:</label>
                        <input type="range" class="zoom-slider" id="heightZoomSlider" min="30" max="100" value="40" step="5">
                    </div>
                </div>
            </div>

            <!-- Search group -->
            <div class="toolbar-group">
                <span>Search</span>
                <input type="text" id="searchInput" class="form-control form-control-sm" placeholder="Filter lines/bars..." />
            </div>

            <!-- Actions group -->
            <div class="toolbar-group">
                <span>Actions</span>
                <div style="display: flex; flex-wrap: wrap; gap:4px;">
                    <button id="addLineItemBtn" class="btn btn-primary btn-sm">Add Line</button>
                    <button id="addBarBtn" class="btn btn-secondary btn-sm">Add Bar</button>
                    <button id="filterBtn" class="btn btn-outline-primary btn-sm">Filter</button>
                    <button id="importJsonBtn" class="btn btn-outline-success btn-sm">Import</button>
                    <button id="exportJsonBtn" class="btn btn-outline-info btn-sm">Export JSON</button>
                    <button id="downloadCsvBtn" class="btn btn-outline-secondary btn-sm">Export CSV</button>
                    <button id="printBtn" class="btn btn-outline-dark btn-sm">Print/PDF</button>
                    <svg id="settingsBtn" width="24" height="24" viewBox="0 0 24 24" fill="none"
                         xmlns="http://www.w3.org/2000/svg">
                        <path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 0 0 .12-.61l-1.92-3.32a.488.488 0 0 0-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 0 0-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96a.488.488 0 0 0-.59.22l-1.92 3.32c-.14.24-.08.54.12.61l2.03 1.58c-.05.3-.09.63-.09.94 0 .31.04.64.07.94l-2.03 1.58a.49.49 0 0 0-.12.61l1.92 3.32c.14.24.37.34.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .43-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.45 0 .59-.22l1.92-3.32c.14-.24.08-.54-.12-.61l-2.03-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6 0-1.98 1.62-3.6 3.6-3.6 1.98 0 3.6 1.62 3.6 3.6 0 1.98-1.62 3.6-3.6 3.6z"
                              fill="#0d6efd"/>
                    </svg>
                    <svg id="helpBtn" width="24" height="24" viewBox="0 0 24 24" fill="none"
                         xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 14.5v.5h-2v-1c0-1.11.45-2.11 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"
                              fill="#0d6efd"/>
                    </svg>
                    <button id="adminToggleBtn" class="btn btn-outline-danger btn-sm">Toggle Admin</button>
                    <!-- Now we ensure CSV Editing toggles in admin mode -->
                    <button id="csvEditToggleBtn" class="btn btn-outline-dark btn-sm" style="display:none;">Edit CSV</button>
                </div>
            </div>

            <!-- Undo/Redo group -->
            <div class="toolbar-group">
                <span>History</span>
                <div style="display: flex; flex-wrap: wrap; gap:4px;">
                    <button id="undoBtn" type="button" class="btn btn-sm btn-success">Undo</button>
                    <button id="redoBtn" type="button" class="btn btn-sm btn-warning">Redo</button>
                </div>
            </div>
        </div>
    </div>
</nav>

<!-- Main cohesive table -->
<div class="gantt-container">
    <div class="table-wrapper" id="tableWrapper">
        <table id="ganttTable">
            <thead>
            <tr id="headerRow">
                <th id="nameHeader">Tasks</th>
                <!-- Timescale headers go here -->
            </tr>
            </thead>
            <tbody id="tableBody">
            <!-- Rows go here -->
            </tbody>
        </table>
    </div>
</div>

<!-- Bar editor -->
<div id="barEditor">
    <label for="barProjectNameInput">Project Name:</label>
    <input type="text" id="barProjectNameInput" placeholder="Project Name..." />

    <label for="barClientInput">Client:</label>
    <input type="text" id="barClientInput" placeholder="Client..." />

    <label for="barDisciplineInput">Discipline:</label>
    <input type="text" id="barDisciplineInput" placeholder="Discipline..." />

    <label for="barExperienceInput">Experience:</label>
    <input type="text" id="barExperienceInput" placeholder="Experience..." />

    <label for="barLOEInput">LOE:</label>
    <input type="text" id="barLOEInput" placeholder="LOE..." />

    <label for="barLocationInput">Location:</label>
    <input type="text" id="barLocationInput" placeholder="Location..." />

    <label for="barTypeInput">Type:</label>
    <input type="text" id="barTypeInput" placeholder="Type..." />

    <label for="barProposedSelect">Proposed:</label>
    <select id="barProposedSelect">
        <option value="yes">Yes</option>
        <option value="no">No</option>
    </select>

    <!-- New Bar Label attribute -->
    <label for="barLabelInput">Label:</label>
    <input type="text" id="barLabelInput" placeholder="Bar Label..." />

    <label for="startYearSelect">Start Date (Year/Week):</label>
    <select id="startYearSelect"></select>
    <select id="startWeekSelect"></select>

    <label for="endYearSelect">End Date (Year/Week):</label>
    <select id="endYearSelect"></select>
    <select id="endWeekSelect"></select>

    <div id="barEditorActions">
        <button id="barDeleteBtn" class="btn btn-sm btn-danger">Delete Bar</button>
        <button id="barEditorOkBtn" class="btn btn-sm btn-primary">OK</button>
        <button id="barEditorCancelBtn" class="btn btn-sm btn-secondary">Cancel</button>
    </div>
</div>

<!-- Line editor -->
<div id="lineEditor">
    <label for="lineNameInput">Name:</label>
    <input type="text" id="lineNameInput" placeholder="Name..." />

    <label for="lineDisciplineInput">Discipline:</label>
    <input type="text" id="lineDisciplineInput" placeholder="Discipline..." />

    <label for="lineExperienceInput">Experience:</label>
    <input type="text" id="lineExperienceInput" placeholder="Experience..." />

    <label for="lineOfficeLocationInput">Office Location:</label>
    <input type="text" id="lineOfficeLocationInput" placeholder="Office Location..." />

    <label for="lineGeoLocationInput">Geo Location:</label>
    <input type="text" id="lineGeoLocationInput" placeholder="Geo Location..." />

    <label for="lineTypeInput">Type:</label>
    <input type="text" id="lineTypeInput" placeholder="Type..." />

    <div id="lineEditorActions">
        <button id="lineDeleteBtn" class="btn btn-sm btn-danger">Delete Line Item</button>
        <button id="lineEditorOkBtn" class="btn btn-sm btn-primary">OK</button>
        <button id="lineEditorCancelBtn" class="btn btn-sm btn-secondary">Cancel</button>
    </div>
</div>

<!-- Filter modal with 2 cards side by side -->
<div id="filterModal">
    <h3>Filter Lines/Bars</h3>
    <div class="filter-container">
        <!-- Left filter card: line item attributes -->
        <div class="filter-card">
            <h5>Line Item Filters</h5>
            <label for="filterLineName">Name:</label>
            <input type="text" id="filterLineName" placeholder="Name..." />

            <label for="filterLineDiscipline">Discipline:</label>
            <input type="text" id="filterLineDiscipline" placeholder="Discipline..." />

            <label for="filterLineExperience">Experience:</label>
            <input type="text" id="filterLineExperience" placeholder="Experience..." />

            <label for="filterLineOfficeLocation">Office Location:</label>
            <input type="text" id="filterLineOfficeLocation" placeholder="Office Location..." />

            <label for="filterLineGeoLocation">Geo Location:</label>
            <input type="text" id="filterLineGeoLocation" placeholder="Geo Location..." />

            <label for="filterLineType">Type:</label>
            <input type="text" id="filterLineType" placeholder="Type..." />
        </div>

        <!-- Right filter card: bar attributes -->
        <div class="filter-card">
            <h5>Bar Filters</h5>
            <label for="filterBarProjectName">Project Name:</label>
            <input type="text" id="filterBarProjectName" placeholder="Project Name..." />

            <label for="filterBarClient">Client:</label>
            <input type="text" id="filterBarClient" placeholder="Client..." />

            <label for="filterBarDiscipline">Discipline:</label>
            <input type="text" id="filterBarDiscipline" placeholder="Discipline..." />

            <label for="filterBarExperience">Experience:</label>
            <input type="text" id="filterBarExperience" placeholder="Experience..." />

            <label for="filterBarLOE">LOE:</label>
            <input type="text" id="filterBarLOE" placeholder="LOE..." />

            <label for="filterBarLocation">Location:</label>
            <input type="text" id="filterBarLocation" placeholder="Location..." />

            <label for="filterBarType">Type:</label>
            <input type="text" id="filterBarType" placeholder="Type..." />

            <label for="filterBarProposed">Proposed:</label>
            <input type="text" id="filterBarProposed" placeholder="Yes/No..." />
        </div>
    </div>
    <div id="filterActions">
        <button id="filterApplyBtn" class="btn btn-sm btn-primary">Apply</button>
        <button id="filterClearBtn" class="btn btn-sm btn-secondary">Clear</button>
        <button id="filterCancelBtn" class="btn btn-sm btn-secondary">Cancel</button>
    </div>
</div>

<!-- Settings modal -->
<div id="settingsModal">
    <h3>Theme Settings</h3>
    <label>Theme:</label>
    <select id="themeSelect">
        <option value="light">Light</option>
        <option value="dark">Dark</option>
    </select>

    <label for="securedColor">Secured Color:</label>
    <input type="color" id="securedColor" class="color-picker" value="#28a745" />

    <label for="proposedColor">Proposed Color:</label>
    <input type="color" id="proposedColor" class="color-picker" value="#fd7e14" />

    <label for="opportunityColor">Opportunity Color:</label>
    <input type="color" id="opportunityColor" class="color-picker" value="#dc3545" />

    <label for="futureColor">Future Color:</label>
    <input type="color" id="futureColor" class="color-picker" value="#6f42c1" />

    <div id="settingsActions">
        <button id="settingsOkBtn" class="btn btn-sm btn-primary">Apply</button>
        <button id="settingsCancelBtn" class="btn btn-sm btn-secondary">Cancel</button>
    </div>
</div>

<!-- CSV Edit modal -->
<div id="csvEditModal">
    <h3>Edit CSV In-Browser</h3>
    <textarea id="csvTextarea"></textarea>
    <div id="csvEditModalActions">
        <button id="csvEditApplyBtn" class="btn btn-sm btn-primary">Apply Changes</button>
        <button id="csvEditCancelBtn" class="btn btn-sm btn-secondary">Close</button>
    </div>
</div>

<!-- Hidden import for JSON/CSV -->
<input type="file" id="importFileInput" accept=".json,.csv" style="display:none;" />

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
/*
    ---------------------------------------------------------------------------------------------
    Global variables/objects
    ---------------------------------------------------------------------------------------------
*/
let adminMode = false;
let statusColors = { secured: "#28a745", proposed: "#fd7e14", opportunity: "#dc3545", future: "#6f42c1" };

// Lines array, now with "label" property in each bar
let lines = [
    {
        id: 1,
        name: "Line Item 1",
        discipline: "",
        experience: "",
        officeLocation: "",
        geoLocation: "",
        type: "",
        bars: [
            {
                id: 101,
                projectName: "Bar A",
                client: "",
                discipline: "",
                experience: "",
                LOE: "",
                location: "",
                proposed: "no",
                type: "",
                label: "",          // <-- New label attribute
                startAbsWeek: toAbsoluteWeek(2025, 2),
                length: 4,
                status: "secured",
                selected: false,
            },
        ],
        selected: false,
        dragging: false
    },
    {
        id: 2,
        name: "Line Item 2",
        discipline: "",
        experience: "",
        officeLocation: "",
        geoLocation: "",
        type: "",
        bars: [
            {
                id: 102,
                projectName: "Bar B",
                client: "",
                discipline: "",
                experience: "",
                LOE: "",
                location: "",
                proposed: "yes",
                type: "",
                label: "",          // <-- New label attribute
                startAbsWeek: toAbsoluteWeek(2025, 10),
                length: 7,
                status: "proposed",
                selected: false,
            },
        ],
        selected: false,
        dragging: false
    },
];

let startYear = 2025;
let startWeek = 1;
let endYear = 2025;
let endWeek = 52;
let lineCounter = 2;
let barCounter = 102;
let cellWidth = 150;
let rowHeight = 40;
let filters = { line: {}, bar: {} };
let searchTerm = "";
let currentTheme = "light";
let undoStack = [];
let redoStack = [];

// For drag
let dragging = false;
let dragType = null;
let dragStartX = 0;
let dragStartY = 0;
let initialStartAbs = 0;
let initialLength = 0;
let currentBar = null;
let currentLine = null;
let draggingLine = null;
let previousLineIndex = null;
let previousUserLineIndex = null;
let barOriginalLineIndex = null;
let tableBodyRect = null;
let mainFilteredLines = [];

// For editors
let currentEditorBar = null;
let currentEditorLine = null;

// DOM references
const tableBody = document.getElementById("tableBody");
const headerRow = document.getElementById("headerRow");
const tableWrapper = document.getElementById("tableWrapper");
const startYearInput = document.getElementById("startYearInput");
const startWeekInput = document.getElementById("startWeekInput");
const endYearInput = document.getElementById("endYearInput");
const endWeekInput = document.getElementById("endWeekInput");
const applyTimescaleBtn = document.getElementById("applyTimescaleBtn");
const zoomSlider = document.getElementById("zoomSlider");
const heightZoomSlider = document.getElementById("heightZoomSlider");
const searchInput = document.getElementById("searchInput");
const filterBtn = document.getElementById("filterBtn");
const importJsonBtn = document.getElementById("importJsonBtn");
const exportJsonBtn = document.getElementById("exportJsonBtn");
const downloadCsvBtn = document.getElementById("downloadCsvBtn");
const printBtn = document.getElementById("printBtn");
const adminToggleBtn = document.getElementById("adminToggleBtn");
const csvEditToggleBtn = document.getElementById("csvEditToggleBtn");
const addLineItemBtn = document.getElementById("addLineItemBtn");
const addBarBtn = document.getElementById("addBarBtn");

// bar editor fields
const barProjectNameInput = document.getElementById("barProjectNameInput");
const barClientInput = document.getElementById("barClientInput");
const barDisciplineInput = document.getElementById("barDisciplineInput");
const barExperienceInput = document.getElementById("barExperienceInput");
const barLOEInput = document.getElementById("barLOEInput");
const barLocationInput = document.getElementById("barLocationInput");
const barTypeInput = document.getElementById("barTypeInput");
const barProposedSelect = document.getElementById("barProposedSelect");
const barLabelInput = document.getElementById("barLabelInput"); // <-- reference to new label input
const startYearSelect = document.getElementById("startYearSelect");
const startWeekSelect = document.getElementById("startWeekSelect");
const endYearSelect = document.getElementById("endYearSelect");
const endWeekSelect = document.getElementById("endWeekSelect");
const barEditor = document.getElementById("barEditor");
const barEditorOkBtn = document.getElementById("barEditorOkBtn");
const barEditorCancelBtn = document.getElementById("barEditorCancelBtn");
const barDeleteBtn = document.getElementById("barDeleteBtn");

// line editor fields
const lineEditor = document.getElementById("lineEditor");
const lineNameInput = document.getElementById("lineNameInput");
const lineDisciplineInput = document.getElementById("lineDisciplineInput");
const lineExperienceInput = document.getElementById("lineExperienceInput");
const lineOfficeLocationInput = document.getElementById("lineOfficeLocationInput");
const lineGeoLocationInput = document.getElementById("lineGeoLocationInput");
const lineTypeInput = document.getElementById("lineTypeInput");
const lineEditorOkBtn = document.getElementById("lineEditorOkBtn");
const lineEditorCancelBtn = document.getElementById("lineEditorCancelBtn");
const lineDeleteBtn = document.getElementById("lineDeleteBtn");

// filter modal fields
const filterModal = document.getElementById("filterModal");
const filterLineName = document.getElementById("filterLineName");
const filterLineDiscipline = document.getElementById("filterLineDiscipline");
const filterLineExperience = document.getElementById("filterLineExperience");
const filterLineOfficeLocation = document.getElementById("filterLineOfficeLocation");
const filterLineGeoLocation = document.getElementById("filterLineGeoLocation");
const filterLineType = document.getElementById("filterLineType");
const filterBarProjectName = document.getElementById("filterBarProjectName");
const filterBarClient = document.getElementById("filterBarClient");
const filterBarDiscipline = document.getElementById("filterBarDiscipline");
const filterBarExperience = document.getElementById("filterBarExperience");
const filterBarLOE = document.getElementById("filterBarLOE");
const filterBarLocation = document.getElementById("filterBarLocation");
const filterBarType = document.getElementById("filterBarType");
const filterBarProposed = document.getElementById("filterBarProposed");
const filterApplyBtn = document.getElementById("filterApplyBtn");
const filterClearBtn = document.getElementById("filterClearBtn");
const filterCancelBtn = document.getElementById("filterCancelBtn");

// settings
const settingsModal = document.getElementById("settingsModal");
const themeSelect = document.getElementById("themeSelect");
const securedColor = document.getElementById("securedColor");
const proposedColor = document.getElementById("proposedColor");
const opportunityColor = document.getElementById("opportunityColor");
const futureColor = document.getElementById("futureColor");
const settingsOkBtn = document.getElementById("settingsOkBtn");
const settingsCancelBtn = document.getElementById("settingsCancelBtn");

// CSV
const csvEditModal = document.getElementById("csvEditModal");
const csvTextarea = document.getElementById("csvTextarea");
const csvEditApplyBtn = document.getElementById("csvEditApplyBtn");
const csvEditCancelBtn = document.getElementById("csvEditCancelBtn");
const importFileInput = document.getElementById("importFileInput");

/*
    ---------------------------------------------------------------------------------------------
    Time/Date helpers
    ---------------------------------------------------------------------------------------------
*/
function toAbsoluteWeek(year, week) {
    return year * 52 + (week - 1);
}
function fromAbsoluteWeek(absWeek) {
    const y = Math.floor(absWeek / 52);
    const w = (absWeek % 52) + 1;
    return { year: y, week: w };
}
// We'll approximate a month from a year-week by converting "year plus (week-1) *7 days" => date => month
function getMonthFromYearWeek(year, week) {
    let january4 = new Date(year, 0, 4);
    let dayMs = 24 * 3600 * 1000;
    let offsetDays = (week - 1) * 7 - (january4.getDay() + 6) % 7;
    let date = new Date(january4.getTime() + offsetDays * dayMs);
    let monthIdx = date.getMonth();
    return monthIdx;
}
// We'll label headers as "YYYY-W## (MonName)"
function getMonthName(monthIndex) {
    const monthNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    return monthNames[monthIndex] || "";
}

/*
    ---------------------------------------------------------------------------------------------
    getColorFromStatus => color for bar
    ---------------------------------------------------------------------------------------------
*/
function getColorFromStatus(status) {
    return statusColors[status] || "#fd7e14";
}

/*
    ---------------------------------------------------------------------------------------------
    localStorage
    ---------------------------------------------------------------------------------------------
*/
function saveToLocalStorage() {
    const chartData = {
        lines,
        startYear,
        startWeek,
        endYear,
        endWeek,
        lineCounter,
        barCounter,
        cellWidth,
        rowHeight,
        statusColors,
        currentTheme
    };
    localStorage.setItem("ganttChartData", JSON.stringify(chartData));
}
function loadFromLocalStorage() {
    const stored = localStorage.getItem("ganttChartData");
    if (!stored) return;
    try {
        const parsed = JSON.parse(stored);
        lines = parsed.lines || [];
        lines.forEach(line => {
            line.selected = false;
            line.dragging = false;
            line.bars.forEach(bar => {
                bar.selected = false;
                if (!bar.status) bar.status = "proposed";
                // Ensure "label" is defined
                if (bar.label === undefined) bar.label = "";
            });
        });
        startYear = parsed.startYear || 2025;
        startWeek = parsed.startWeek || 1;
        endYear = parsed.endYear || 2025;
        endWeek = parsed.endWeek || 52;
        lineCounter = parsed.lineCounter || 0;
        barCounter = parsed.barCounter || 0;
        cellWidth = parsed.cellWidth || 150;
        rowHeight = parsed.rowHeight || 40;
        statusColors = parsed.statusColors || statusColors;
        currentTheme = parsed.currentTheme || "light";
    } catch (err) {
        console.warn("Invalid localStorage data");
    }
}

/*
    ---------------------------------------------------------------------------------------------
    applyTheme & updateCSSVariables
    ---------------------------------------------------------------------------------------------
*/
function applyTheme() {
    if (currentTheme === "dark") {
        document.body.classList.add("dark-theme");
    } else {
        document.body.classList.remove("dark-theme");
    }
    renderTable();
    saveToLocalStorage();
}
function updateCSSVariables() {
    document.documentElement.style.setProperty('--cell-width', cellWidth + 'px');
    document.documentElement.style.setProperty('--row-height', rowHeight + 'px');
}

/*
    ---------------------------------------------------------------------------------------------
    getDisplayRange
    ---------------------------------------------------------------------------------------------
*/
function getDisplayRange() {
    let ds = toAbsoluteWeek(startYear, startWeek);
    let de = toAbsoluteWeek(endYear, endWeek);
    if (ds > de) [ds, de] = [de, ds];
    return { displayStart: ds, displayEnd: de };
}

/*
    ---------------------------------------------------------------------------------------------
    unselectAllBars
    ---------------------------------------------------------------------------------------------
*/
function unselectAllBars() {
    lines.forEach(line => line.bars.forEach(bar => {
        bar.selected = false;
    }));
}

/*
    ---------------------------------------------------------------------------------------------
    clearHighlights
    ---------------------------------------------------------------------------------------------
*/
function clearHighlights() {
    document.querySelectorAll('.bar.highlighted').forEach(el => el.classList.remove('highlighted'));
}

/*
    ---------------------------------------------------------------------------------------------
    updateBarTextPositions => keeps bar label centered horizontally
    ---------------------------------------------------------------------------------------------
*/
function updateBarTextPositions() {
    const scrollLeft = tableWrapper.scrollLeft;
    const viewportWidth = tableWrapper.clientWidth;
    document.querySelectorAll(".bar-text").forEach(textEl => {
        const barEl = textEl.parentElement;
        const barLeft = parseFloat(barEl.style.left);
        const barWidth = parseFloat(barEl.style.width);
        const barRight = barLeft + barWidth;
        const visibleLeft = Math.max(barLeft, scrollLeft);
        const visibleRight = Math.min(barRight, scrollLeft + viewportWidth);
        const visibleWidth = visibleRight - visibleLeft;
        if (visibleWidth <= 0) {
            textEl.style.opacity = "0";
            return;
        }
        textEl.style.opacity = "1";
        const textWidth = textEl.offsetWidth;
        let textLeft = visibleLeft - barLeft + (visibleWidth - textWidth) / 2;
        if (textLeft < 5) textLeft = 5;
        if (textLeft + textWidth > barWidth - 5) textLeft = barWidth - textWidth - 5;
        textEl.style.left = textLeft + "px";
    });
}

/*
    ---------------------------------------------------------------------------------------------
    renderHeader => Now we show "year-week (MonthName)" and color columns for every-other-month
    ---------------------------------------------------------------------------------------------
*/
function renderHeader() {
    while (headerRow.children.length > 1) {
        headerRow.removeChild(headerRow.lastChild);
    }
    const { displayStart, displayEnd } = getDisplayRange();
    const totalWeeks = displayEnd - displayStart + 1;
    if (totalWeeks < 1) return;

    // We'll build up an array of the months for each week, so we can do an alternating color background
    let monthIndices = [];
    for (let i = 0; i < totalWeeks; i++) {
        const abs = displayStart + i;
        const { year, week } = fromAbsoluteWeek(abs);
        let mIdx = getMonthFromYearWeek(year, week);
        monthIndices.push(mIdx);
    }

    for (let i = 0; i < totalWeeks; i++) {
        const abs = displayStart + i;
        const { year, week } = fromAbsoluteWeek(abs);
        const th = document.createElement("th");
        th.className = "timescale-header";
        let mIdx = monthIndices[i];
        let label = `${year}-W${week} (${getMonthName(mIdx)})`;
        th.textContent = label;
        th.style.width = cellWidth + "px";
        headerRow.appendChild(th);
    }

    // Now apply a background gradient to tableBody to color columns for each month
    let colorStops = [];
    let xLast = 0;
    let currentColor = "#ffffff";
    let altColor = "#f0f0f0";
    let prevMonth = monthIndices[0] || 0;
    for (let i = 0; i <= totalWeeks; i++) {
        if (i === totalWeeks) {
            let pct = (i / totalWeeks) * 100;
            colorStops.push(`${currentColor} ${xLast}%`);
            colorStops.push(`${currentColor} ${pct}%`);
        } else {
            let mCur = monthIndices[i];
            let pct = (i / totalWeeks) * 100;
            if (mCur !== prevMonth) {
                colorStops.push(`${currentColor} ${xLast}%`);
                colorStops.push(`${currentColor} ${pct}%`);
                currentColor = (currentColor === "#ffffff") ? altColor : "#ffffff";
                xLast = pct;
                prevMonth = mCur;
            }
        }
    }
    let gradientString = `linear-gradient(to right, ${colorStops.join(",")})`;
    tableBody.style.background = gradientString;
}

/*
    ---------------------------------------------------------------------------------------------
    handleBarClickSelect
    ---------------------------------------------------------------------------------------------
*/
function handleBarClickSelect(bar, evt) {
    const multi = evt.shiftKey || evt.ctrlKey || evt.metaKey;
    if (!multi) {
        unselectAllBars();
        bar.selected = true;
    } else {
        bar.selected = !bar.selected;
    }
}

/*
    ---------------------------------------------------------------------------------------------
    renderTable => main UI drawing
    ---------------------------------------------------------------------------------------------
*/
function renderTable() {
    renderHeader();
    tableBody.innerHTML = "";
    clearHighlights();
    const { displayStart, displayEnd } = getDisplayRange();
    const totalWeeks = displayEnd - displayStart + 1;
    if (totalWeeks < 1) return;

    const lowerSearch = searchTerm.toLowerCase();

    // Filter lines
    const filteredLines = lines.filter(line => {
        // line-level filters
        const linePass = (
            (!filters.line.name || (line.name && line.name.toLowerCase().includes(filters.line.name.toLowerCase()))) &&
            (!filters.line.discipline || (line.discipline && line.discipline.toLowerCase().includes(filters.line.discipline.toLowerCase()))) &&
            (!filters.line.experience || (line.experience && line.experience.toLowerCase().includes(filters.line.experience.toLowerCase()))) &&
            (!filters.line.officeLocation || (line.officeLocation && line.officeLocation.toLowerCase().includes(filters.line.officeLocation.toLowerCase()))) &&
            (!filters.line.geoLocation || (line.geoLocation && line.geoLocation.toLowerCase().includes(filters.line.geoLocation.toLowerCase()))) &&
            (!filters.line.type || (line.type && line.type.toLowerCase().includes(filters.line.type.toLowerCase())))
        );

        // bar-level filter => at least one bar passes
        const barPass = line.bars.some(b => {
            const condProj = (!filters.bar.projectName || (b.projectName && b.projectName.toLowerCase().includes(filters.bar.projectName.toLowerCase())));
            const condClient = (!filters.bar.client || (b.client && b.client.toLowerCase().includes(filters.bar.client.toLowerCase())));
            const condDis = (!filters.bar.discipline || (b.discipline && b.discipline.toLowerCase().includes(filters.bar.discipline.toLowerCase())));
            const condExp = (!filters.bar.experience || (b.experience && b.experience.toLowerCase().includes(filters.bar.experience.toLowerCase())));
            const condLOE = (!filters.bar.LOE || (b.LOE && b.LOE.toLowerCase().includes(filters.bar.LOE.toLowerCase())));
            const condLoc = (!filters.bar.location || (b.location && b.location.toLowerCase().includes(filters.bar.location.toLowerCase())));
            const condT = (!filters.bar.type || (b.type && b.type.toLowerCase().includes(filters.bar.type.toLowerCase())));
            const condProp = (!filters.bar.proposed || (b.proposed && b.proposed.toLowerCase().includes(filters.bar.proposed.toLowerCase())));
            return (condProj && condClient && condDis && condExp && condLOE && condLoc && condT && condProp);
        });

        if (!linePass) return false;
        if (!barPass && line.bars.length > 0) return false;

        // search
        if (lowerSearch) {
            const lineMatch = (
                (line.name && line.name.toLowerCase().includes(lowerSearch)) ||
                (line.discipline && line.discipline.toLowerCase().includes(lowerSearch)) ||
                (line.experience && line.experience.toLowerCase().includes(lowerSearch)) ||
                (line.officeLocation && line.officeLocation.toLowerCase().includes(lowerSearch)) ||
                (line.geoLocation && line.geoLocation.toLowerCase().includes(lowerSearch)) ||
                (line.type && line.type.toLowerCase().includes(lowerSearch))
            );
            const barMatch = line.bars.some(b => {
                const bProj = (b.projectName || "").toLowerCase();
                const bClient= (b.client || "").toLowerCase();
                const bDisci= (b.discipline || "").toLowerCase();
                const bExp = (b.experience || "").toLowerCase();
                const bLOE = (b.LOE || "").toLowerCase();
                const bLoc = (b.location || "").toLowerCase();
                const bType = (b.type || "").toLowerCase();
                const bProp = (b.proposed || "").toLowerCase();
                const bStat = (b.status || "").toLowerCase();
                const bLabel = (b.label || "").toLowerCase();
                return (
                    bProj.includes(lowerSearch) ||
                    bClient.includes(lowerSearch) ||
                    bDisci.includes(lowerSearch) ||
                    bExp.includes(lowerSearch) ||
                    bLOE.includes(lowerSearch) ||
                    bLoc.includes(lowerSearch) ||
                    bType.includes(lowerSearch) ||
                    bProp.includes(lowerSearch) ||
                    bStat.includes(lowerSearch) ||
                    bLabel.includes(lowerSearch)
                );
            });
            if (!lineMatch && !barMatch) return false;
        }
        return true;
    });

    mainFilteredLines = filteredLines;

    // For each line in filtered result
    filteredLines.forEach((line, lineIndex) => {
        const tr = document.createElement("tr");
        tr.className = "gantt-row";
        if (line.selected) tr.classList.add("selected");
        if (line.dragging) tr.classList.add("drag-highlight");

        // Name cell
        const nameTd = document.createElement("td");
        nameTd.className = "name-cell";
        nameTd.addEventListener("mousedown", e => onLineMouseDown(e, line, lineIndex));
        // Right-click => show line info
        nameTd.addEventListener("contextmenu", e => {
            e.preventDefault();
            showLineEditor(line, e.clientX, e.clientY);
        });
        // Show line name
        const nameLabel = document.createElement("span");
        nameLabel.textContent = line.name;
        nameTd.appendChild(nameLabel);
        tr.appendChild(nameTd);

        // Single cell for bars
        const barTd = document.createElement("td");
        barTd.colSpan = totalWeeks;
        barTd.className = "bar-cell";
        const barContainer = document.createElement("div");
        barContainer.className = "bar-row-container";

        // Right-click blank => add bar in admin
        barContainer.addEventListener("contextmenu", e => {
            if (adminMode) {
                if (!e.target.classList.contains("bar") &&
                    !e.target.classList.contains("bar-text") &&
                    !e.target.classList.contains("bar-handle")) {
                    e.preventDefault();
                    barCounter++;
                    let offsetX = e.offsetX;
                    let weeksFromStart = Math.floor(offsetX / cellWidth);
                    const { displayStart } = getDisplayRange();
                    const newBar = {
                        id: barCounter,
                        projectName: "New Project",
                        client: "",
                        discipline: "",
                        experience: "",
                        LOE: "",
                        location: "",
                        proposed: "no",
                        type: "",
                        label: "", // initialize label
                        startAbsWeek: displayStart + weeksFromStart,
                        length: 4,
                        status: "proposed",
                        selected: false,
                    };
                    line.bars.push(newBar);
                    pushState();
                    renderTable();
                    saveToLocalStorage();
                }
            }
        });

        // Render bars
        line.bars.forEach(bar => {
            const barStart = bar.startAbsWeek;
            const barEnd = barStart + bar.length;
            const overlapStart = Math.max(displayStart, barStart);
            const overlapEnd = Math.min(displayEnd + 1, barEnd);
            const overlapLen = overlapEnd - overlapStart;
            if (overlapLen <= 0) return;

            const barLeft = (overlapStart - displayStart) * cellWidth;
            const barWidth = overlapLen * cellWidth;

            const barDiv = document.createElement("div");
            barDiv.classList.add("bar");
            if (bar.selected) barDiv.classList.add("selected");
            if (lowerSearch && bar.projectName.toLowerCase().includes(lowerSearch)) {
                barDiv.classList.add("highlighted");
            }
            barDiv.style.left = barLeft + "px";
            barDiv.style.width = barWidth + "px";
            barDiv.style.backgroundColor = getColorFromStatus(bar.status);

            // Bar text => show label if present, else projectName
            const textSpan = document.createElement("span");
            textSpan.className = "bar-text";
            textSpan.textContent = bar.label || bar.projectName;
            barDiv.appendChild(textSpan);

            // Admin mode => handles
            if (adminMode) {
                const leftHandle = document.createElement("div");
                leftHandle.classList.add("bar-handle","left");
                const rightHandle = document.createElement("div");
                rightHandle.classList.add("bar-handle","right");
                barDiv.appendChild(leftHandle);
                barDiv.appendChild(rightHandle);
            }

            // On right-click => show bar editor
            barDiv.addEventListener("contextmenu", e => {
                e.preventDefault();
                showBarEditor(bar, line, e.clientX, e.clientY);
            });
            // On click => select bar
            barDiv.addEventListener("click", e => {
                e.stopPropagation();
                handleBarClickSelect(bar, e);
                renderTable();
                saveToLocalStorage();
            });
            // On mousedown => begin bar drag
            barDiv.addEventListener("mousedown", e => onBarMouseDown(e, line, bar, lineIndex));

            barContainer.appendChild(barDiv);
        });

        // Overlap hatch
        const sortedBars = [...line.bars].sort((a, b) => a.startAbsWeek - b.startAbsWeek);
        for (let i = 0; i < sortedBars.length; i++) {
            for (let j = i + 1; j < sortedBars.length; j++) {
                const bar1 = sortedBars[i];
                const bar2 = sortedBars[j];
                const start1 = Math.max(displayStart, bar1.startAbsWeek);
                const end1 = Math.min(displayEnd+1, bar1.startAbsWeek + bar1.length);
                const start2 = Math.max(displayStart, bar2.startAbsWeek);
                const end2 = Math.min(displayEnd+1, bar2.startAbsWeek + bar2.length);
                const overlapS = Math.max(start1, start2);
                const overlapE = Math.min(end1, end2);
                if (overlapE > overlapS) {
                    const left = (overlapS - displayStart) * cellWidth;
                    const w = (overlapE - overlapS) * cellWidth;
                    const hatchDiv = document.createElement("div");
                    hatchDiv.className = "overlap-hatch";
                    hatchDiv.style.left = left + "px";
                    hatchDiv.style.width = w + "px";
                    barContainer.appendChild(hatchDiv);
                }
            }
        }

        barTd.appendChild(barContainer);
        tr.appendChild(barTd);
        tableBody.appendChild(tr);
    });

    updateBarTextPositions();
}

/*
    ---------------------------------------------------------------------------------------------
    onLineMouseDown => reorder lines
    ---------------------------------------------------------------------------------------------
*/
function onLineMouseDown(e, line, lineIndex) {
    dragging = true;
    dragType = "line-reorder";
    draggingLine = line;
    draggingLine.dragging = true;
    previousLineIndex = lineIndex;
    tableBodyRect = tableBody.getBoundingClientRect();
    renderTable();
    e.preventDefault();
}

/*
    ---------------------------------------------------------------------------------------------
    onBarMouseDown => reorder bar
    ---------------------------------------------------------------------------------------------
*/
function onBarMouseDown(e, line, bar, lineIndex) {
    dragging = true;
    currentBar = bar;
    currentLine = line;
    dragStartX = e.clientX;
    dragStartY = e.clientY;
    barOriginalLineIndex = lineIndex;
    initialStartAbs = bar.startAbsWeek;
    initialLength = bar.length;
    tableBodyRect = tableBody.getBoundingClientRect();

    if (adminMode) {
        if (e.target.classList.contains("bar-handle")) {
            dragType = e.target.classList.contains("left") ? "resize-left" : "resize-right";
        } else {
            dragType = "bar-move-admin";
        }
    } else {
        dragType = "bar-move-user";
        previousUserLineIndex = lineIndex;
    }
    e.preventDefault();
}

/*
    ---------------------------------------------------------------------------------------------
    Document mousemove => handle dragging
    ---------------------------------------------------------------------------------------------
*/
document.addEventListener("mousemove", e => {
    if (!dragging) return;

    if (dragType === "line-reorder" && draggingLine) {
        let posY = e.clientY - tableBodyRect.top;
        let newIndex = Math.floor(posY / rowHeight);
        if (newIndex < 0) newIndex = 0;
        if (newIndex >= mainFilteredLines.length) newIndex = mainFilteredLines.length - 1;
        if (newIndex !== previousLineIndex) {
            const oldIndexInLines = lines.indexOf(draggingLine);
            if (oldIndexInLines >= 0) {
                lines.splice(oldIndexInLines, 1);
            }
            let targetLine = mainFilteredLines[newIndex];
            let targetIdx = lines.indexOf(targetLine);
            if (targetIdx < 0) targetIdx = lines.length;
            lines.splice(targetIdx, 0, draggingLine);
            previousLineIndex = newIndex;
            renderTable();
        }
    }
    else if (dragType === "bar-move-admin" && currentBar) {
        const dx = e.clientX - dragStartX;
        const dWeeks = Math.round(dx / cellWidth);
        currentBar.startAbsWeek = Math.max(0, initialStartAbs + dWeeks);

        let posY = e.clientY - tableBodyRect.top;
        let idxCur = mainFilteredLines.indexOf(currentLine);
        if (idxCur < 0) idxCur = 0;
        let newIdx = Math.floor(posY / rowHeight);
        if (newIdx < 0) newIdx = 0;
        if (newIdx >= mainFilteredLines.length) newIdx = mainFilteredLines.length - 1;
        if (newIdx !== idxCur) {
            currentLine.bars = currentLine.bars.filter(b => b.id !== currentBar.id);
            mainFilteredLines[newIdx].bars.push(currentBar);
            currentLine = mainFilteredLines[newIdx];
        }
        renderTable();
    }
    else if (dragType === "resize-left" && currentBar) {
        const dx = e.clientX - dragStartX;
        const dWeeks = Math.round(dx / cellWidth);
        let newStart = initialStartAbs + dWeeks;
        let newLength = initialStartAbs + initialLength - newStart;
        if (newLength < 1) {
            newLength = 1;
            newStart = initialStartAbs + initialLength - 1;
        }
        currentBar.startAbsWeek = Math.max(0, newStart);
        currentBar.length = newLength;
        renderTable();
    }
    else if (dragType === "resize-right" && currentBar) {
        const dx = e.clientX - dragStartX;
        const dWeeks = Math.round(dx / cellWidth);
        let newLen = initialLength + dWeeks;
        if (newLen < 1) newLen = 1;
        currentBar.length = newLen;
        renderTable();
    }
    else if (dragType === "bar-move-user" && currentBar) {
        let posY = e.clientY - tableBodyRect.top;
        let newIndex = Math.floor(posY / rowHeight);
        if (newIndex < 0) newIndex = 0;
        if (newIndex >= mainFilteredLines.length) newIndex = mainFilteredLines.length - 1;
        if (newIndex !== previousUserLineIndex) {
            mainFilteredLines[previousUserLineIndex].bars =
                mainFilteredLines[previousUserLineIndex].bars.filter(b => b.id !== currentBar.id);
            mainFilteredLines[newIndex].bars.push(currentBar);
            previousUserLineIndex = newIndex;
            renderTable();
        }
    }
});

/*
    ---------------------------------------------------------------------------------------------
    Document mouseup => finalize drag
    ---------------------------------------------------------------------------------------------
*/
document.addEventListener("mouseup", e => {
    if (!dragging) return;
    dragging = false;
    if (dragType === "line-reorder") {
        draggingLine.dragging = false;
        draggingLine = null;
        pushState();
        saveToLocalStorage();
        renderTable();
    }
    else if (dragType === "bar-move-admin" || dragType === "resize-left" || dragType === "resize-right") {
        currentBar = null;
        currentLine = null;
        pushState();
        saveToLocalStorage();
    }
    else if (dragType === "bar-move-user") {
        currentBar = null;
        currentLine = null;
        pushState();
        saveToLocalStorage();
    }
    dragType = null;
});

/*
    ---------------------------------------------------------------------------------------------
    Document click => unselect if blank
    ---------------------------------------------------------------------------------------------
*/
document.addEventListener("click", evt => {
    if (!dragging) {
        let tgt = evt.target;
        const isNameCell = tgt.closest('.name-cell');
        const isBar = tgt.closest('.bar');
        if (!isNameCell && !isBar) {
            lines.forEach(l => l.selected = false);
            unselectAllBars();
            renderTable();
            saveToLocalStorage();
        }
    }
});

/*
    ---------------------------------------------------------------------------------------------
    showBarEditor => via right-click
    ---------------------------------------------------------------------------------------------
*/
function showBarEditor(bar, line, x, y) {
    currentEditorBar = bar;
    currentEditorLine = line;

    barProjectNameInput.value = bar.projectName || "";
    barClientInput.value = bar.client || "";
    barDisciplineInput.value = bar.discipline || "";
    barExperienceInput.value = bar.experience || "";
    barLOEInput.value = bar.LOE || "";
    barLocationInput.value = bar.location || "";
    barTypeInput.value = bar.type || "";
    barProposedSelect.value = bar.proposed || "no";
    barLabelInput.value = bar.label || ""; // set label to editor

    const { year: sy, week: sw } = fromAbsoluteWeek(bar.startAbsWeek);
    const { year: ey, week: ew } = fromAbsoluteWeek(bar.startAbsWeek + bar.length - 1);
    startYearSelect.value = sy;
    startWeekSelect.value = sw;
    endYearSelect.value = ey;
    endWeekSelect.value = ew;

    // if not admin => read-only
    const ro = !adminMode;
    barProjectNameInput.disabled = ro;
    barClientInput.disabled = ro;
    barDisciplineInput.disabled = ro;
    barExperienceInput.disabled = ro;
    barLOEInput.disabled = ro;
    barLocationInput.disabled = ro;
    barTypeInput.disabled = ro;
    barProposedSelect.disabled = ro;
    barLabelInput.disabled = ro; // disable if not admin
    startYearSelect.disabled = ro;
    startWeekSelect.disabled = ro;
    endYearSelect.disabled = ro;
    endWeekSelect.disabled = ro;
    barDeleteBtn.disabled = ro;

    barEditor.style.display = "block";
    barEditor.style.left = (x + window.scrollX + 10) + "px";
    barEditor.style.top = (y + window.scrollY + 10) + "px";

    // autosave if admin
    const autosave = () => {
        if (!adminMode) return;
        currentEditorBar.projectName = barProjectNameInput.value;
        currentEditorBar.client = barClientInput.value;
        currentEditorBar.discipline = barDisciplineInput.value;
        currentEditorBar.experience = barExperienceInput.value;
        currentEditorBar.LOE = barLOEInput.value;
        currentEditorBar.location = barLocationInput.value;
        currentEditorBar.type = barTypeInput.value;
        currentEditorBar.proposed = barProposedSelect.value;
        currentEditorBar.label = barLabelInput.value; // update label

        let sY = parseInt(startYearSelect.value);
        let sW = parseInt(startWeekSelect.value);
        let eY = parseInt(endYearSelect.value);
        let eW = parseInt(endWeekSelect.value);

        currentEditorBar.startAbsWeek = toAbsoluteWeek(sY, sW);
        currentEditorBar.length = toAbsoluteWeek(eY, eW) - currentEditorBar.startAbsWeek + 1;
        if (currentEditorBar.length < 1) currentEditorBar.length = 1;

        renderTable();
        saveToLocalStorage();
    };

    barProjectNameInput.oninput = autosave;
    barClientInput.oninput = autosave;
    barDisciplineInput.oninput = autosave;
    barExperienceInput.oninput = autosave;
    barLOEInput.oninput = autosave;
    barLocationInput.oninput = autosave;
    barTypeInput.oninput = autosave;
    barProposedSelect.onchange = autosave;
    barLabelInput.oninput = autosave; // listen for label changes
    startYearSelect.onchange = autosave;
    startWeekSelect.onchange = autosave;
    endYearSelect.onchange = autosave;
    endWeekSelect.onchange = autosave;
}

barEditorOkBtn.addEventListener("click", () => {
    barEditor.style.display = "none";
    currentEditorBar = null;
    currentEditorLine = null;
    pushState();
});
barEditorCancelBtn.addEventListener("click", () => {
    barEditor.style.display = "none";
    currentEditorBar = null;
    currentEditorLine = null;
    pushState();
});
barDeleteBtn.addEventListener("click", () => {
    if (!adminMode) return;
    if (!currentEditorBar || !currentEditorLine) return;
    currentEditorLine.bars = currentEditorLine.bars.filter(b => b.id !== currentEditorBar.id);
    barEditor.style.display = "none";
    currentEditorBar = null;
    currentEditorLine = null;
    pushState();
    renderTable();
    saveToLocalStorage();
});
document.addEventListener("mousedown", e => {
    if (barEditor.style.display === "block") {
        const rect = barEditor.getBoundingClientRect();
        const inside = e.clientX >= rect.left && e.clientX <= rect.right && e.clientY >= rect.top && e.clientY <= rect.bottom;
        if (!inside) {
            barEditor.style.display = "none";
            currentEditorBar = null;
            currentEditorLine = null;
            pushState();
        }
    }
});

/*
    ---------------------------------------------------------------------------------------------
    showLineEditor => via right-click
    ---------------------------------------------------------------------------------------------
*/
function showLineEditor(line, x, y) {
    currentEditorLine = line;
    lineNameInput.value = line.name || "";
    lineDisciplineInput.value = line.discipline || "";
    lineExperienceInput.value = line.experience || "";
    lineOfficeLocationInput.value = line.officeLocation || "";
    lineGeoLocationInput.value = line.geoLocation || "";
    lineTypeInput.value = line.type || "";

    const ro = !adminMode;
    lineNameInput.disabled = ro;
    lineDisciplineInput.disabled = ro;
    lineExperienceInput.disabled = ro;
    lineOfficeLocationInput.disabled = ro;
    lineGeoLocationInput.disabled = ro;
    lineTypeInput.disabled = ro;
    lineDeleteBtn.disabled = ro;

    lineEditor.style.display = "block";
    lineEditor.style.left = (x + window.scrollX + 10) + "px";
    lineEditor.style.top = (y + window.scrollY + 10) + "px";

    const autosaveLine = () => {
        if (!adminMode) return;
        currentEditorLine.name = lineNameInput.value;
        currentEditorLine.discipline = lineDisciplineInput.value;
        currentEditorLine.experience = lineExperienceInput.value;
        currentEditorLine.officeLocation = lineOfficeLocationInput.value;
        currentEditorLine.geoLocation = lineGeoLocationInput.value;
        currentEditorLine.type = lineTypeInput.value;
        renderTable();
        saveToLocalStorage();
    };

    lineNameInput.oninput = autosaveLine;
    lineDisciplineInput.oninput = autosaveLine;
    lineExperienceInput.oninput = autosaveLine;
    lineOfficeLocationInput.oninput = autosaveLine;
    lineGeoLocationInput.oninput = autosaveLine;
    lineTypeInput.oninput = autosaveLine;
}

lineEditorOkBtn.addEventListener("click", () => {
    lineEditor.style.display = "none";
    currentEditorLine = null;
    pushState();
});
lineEditorCancelBtn.addEventListener("click", () => {
    lineEditor.style.display = "none";
    currentEditorLine = null;
    pushState();
});
lineDeleteBtn.addEventListener("click", () => {
    if (!adminMode) return;
    if (!currentEditorLine) return;
    lines = lines.filter(l => l.id !== currentEditorLine.id);
    lineEditor.style.display = "none";
    currentEditorLine = null;
    pushState();
    renderTable();
    saveToLocalStorage();
});
document.addEventListener("mousedown", e => {
    if (lineEditor.style.display === "block") {
        const rect = lineEditor.getBoundingClientRect();
        const inside = e.clientX >= rect.left && e.clientX <= rect.right && e.clientY >= rect.top && e.clientY <= rect.bottom;
        if (!inside) {
            lineEditor.style.display = "none";
            currentEditorLine = null;
            pushState();
        }
    }
});

/*
    ---------------------------------------------------------------------------------------------
    Filters
    ---------------------------------------------------------------------------------------------
*/
filterBtn.addEventListener("click", () => {
    filterLineName.value = filters.line.name || "";
    filterLineDiscipline.value = filters.line.discipline || "";
    filterLineExperience.value = filters.line.experience || "";
    filterLineOfficeLocation.value = filters.line.officeLocation || "";
    filterLineGeoLocation.value = filters.line.geoLocation || "";
    filterLineType.value = filters.line.type || "";

    filterBarProjectName.value = filters.bar.projectName || "";
    filterBarClient.value = filters.bar.client || "";
    filterBarDiscipline.value = filters.bar.discipline || "";
    filterBarExperience.value = filters.bar.experience || "";
    filterBarLOE.value = filters.bar.LOE || "";
    filterBarLocation.value = filters.bar.location || "";
    filterBarType.value = filters.bar.type || "";
    filterBarProposed.value = filters.bar.proposed || "";

    filterModal.style.display = "block";
});
filterApplyBtn.addEventListener("click", () => {
    filters.line.name = filterLineName.value.trim() || null;
    filters.line.discipline = filterLineDiscipline.value.trim() || null;
    filters.line.experience = filterLineExperience.value.trim() || null;
    filters.line.officeLocation = filterLineOfficeLocation.value.trim() || null;
    filters.line.geoLocation = filterLineGeoLocation.value.trim() || null;
    filters.line.type = filterLineType.value.trim() || null;

    filters.bar.projectName = filterBarProjectName.value.trim() || null;
    filters.bar.client = filterBarClient.value.trim() || null;
    filters.bar.discipline = filterBarDiscipline.value.trim() || null;
    filters.bar.experience = filterBarExperience.value.trim() || null;
    filters.bar.LOE = filterBarLOE.value.trim() || null;
    filters.bar.location = filterBarLocation.value.trim() || null;
    filters.bar.type = filterBarType.value.trim() || null;
    filters.bar.proposed = filterBarProposed.value.trim() || null;

    for (let k in filters.line) {
        if (!filters.line[k]) delete filters.line[k];
    }
    for (let k in filters.bar) {
        if (!filters.bar[k]) delete filters.bar[k];
    }
    filterModal.style.display = "none";
    renderTable();
});
filterClearBtn.addEventListener("click", () => {
    filters.line = {};
    filters.bar = {};
    filterModal.style.display = "none";
    renderTable();
});
filterCancelBtn.addEventListener("click", () => {
    filterModal.style.display = "none";
});
document.addEventListener("mousedown", e => {
    if (filterModal.style.display === "block") {
        const rect = filterModal.getBoundingClientRect();
        const inside = e.clientX >= rect.left && e.clientX <= rect.right && e.clientY >= rect.top && e.clientY <= rect.bottom;
        if (!inside) {
            filterModal.style.display = "none";
        }
    }
});

/*
    ---------------------------------------------------------------------------------------------
    Settings
    ---------------------------------------------------------------------------------------------
*/
settingsBtn.addEventListener("click", () => {
    themeSelect.value = currentTheme;
    securedColor.value = statusColors.secured;
    proposedColor.value = statusColors.proposed;
    opportunityColor.value = statusColors.opportunity;
    futureColor.value = statusColors.future;
    settingsModal.style.display = "block";
});
settingsOkBtn.addEventListener("click", () => {
    currentTheme = themeSelect.value;
    statusColors.secured = securedColor.value;
    statusColors.proposed = proposedColor.value;
    statusColors.opportunity = opportunityColor.value;
    statusColors.future = futureColor.value;
    settingsModal.style.display = "none";
    applyTheme();
});
settingsCancelBtn.addEventListener("click", () => {
    settingsModal.style.display = "none";
});
document.addEventListener("mousedown", e => {
    if (settingsModal.style.display === "block") {
        const rect = settingsModal.getBoundingClientRect();
        const inside = e.clientX >= rect.left && e.clientX <= rect.right && e.clientY >= rect.top && e.clientY <= rect.bottom;
        if (!inside) {
            settingsModal.style.display = "none";
        }
    }
});

/*
    ---------------------------------------------------------------------------------------------
    Search
    ---------------------------------------------------------------------------------------------
*/
searchInput.addEventListener("input", () => {
    searchTerm = searchInput.value.trim();
    renderTable();
});

/*
    ---------------------------------------------------------------------------------------------
    Add line => only in admin mode
    ---------------------------------------------------------------------------------------------
*/
addLineItemBtn.addEventListener("click", e => {
    if (!adminMode) return;
    lineCounter++;
    lines.push({
        id: lineCounter,
        name: "Line Item " + lineCounter,
        discipline: "",
        experience: "",
        officeLocation: "",
        geoLocation: "",
        type: "",
        bars: [],
        selected: false,
        dragging: false
    });
    pushState();
    renderTable();
    saveToLocalStorage();
});

/*
    ---------------------------------------------------------------------------------------------
    Add bar => only in admin mode
    ---------------------------------------------------------------------------------------------
*/
addBarBtn.addEventListener("click", e => {
    if (!adminMode) return;
    e.stopPropagation();
    if (!lines.length) {
        lineCounter = 1;
        lines.push({
            id: 1,
            name: "Line Item 1",
            discipline: "",
            experience: "",
            officeLocation: "",
            geoLocation: "",
            type: "",
            bars: [],
            selected: false,
            dragging: false
        });
    }
    barCounter++;
    const { displayStart } = getDisplayRange();
    const newBar = {
        id: barCounter,
        projectName: "New Project",
        client: "",
        discipline: "",
        experience: "",
        LOE: "",
        location: "",
        proposed: "no",
        type: "",
        label: "", // new label
        startAbsWeek: displayStart,
        length: 4,
        status: "proposed",
        selected: false
    };
    lines[lines.length - 1].bars.push(newBar);
    pushState();
    renderTable();
    saveToLocalStorage();
});

/*
    ---------------------------------------------------------------------------------------------
    Import / Export
    ---------------------------------------------------------------------------------------------
*/
exportJsonBtn.addEventListener("click", () => {
    const dataStr = JSON.stringify({
        lines,
        startYear,
        startWeek,
        endYear,
        endWeek,
        lineCounter,
        barCounter,
        cellWidth,
        rowHeight,
        statusColors,
        currentTheme
    }, null, 2);
    const blob = new Blob([dataStr], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const now = new Date();
    let dateStr = now.toISOString().replace(/[:.]/g, "-");
    const a = document.createElement("a");
    a.download = "Gantt_" + dateStr + ".json";
    a.href = url;
    a.click();
    URL.revokeObjectURL(url);
});
downloadCsvBtn.addEventListener("click", () => {
    let csv = "Line ID,Line Name,Line Discipline,Line Experience,Line OfficeLocation,Line GeoLocation,Line Type," +
              "Bar ID,Project Name,Client,Discipline,Experience,LOE,Location,Proposed,Type,Label," +
              "Start Year,Start Week,End Year,End Week,Duration (weeks)\n";
    lines.forEach(line => {
        if (line.bars.length === 0) {
            csv += `${line.id||""},"${line.name||""}","${line.discipline||""}","${line.experience||""}","${line.officeLocation||""}","${line.geoLocation||""}","${line.type||""}",,,,,,,,,,,,\n`;
        } else {
            line.bars.forEach(bar => {
                const { year: sy, week: sw } = fromAbsoluteWeek(bar.startAbsWeek);
                const { year: ey, week: ew } = fromAbsoluteWeek(bar.startAbsWeek + bar.length - 1);
                csv += `${line.id||""},"${line.name||""}","${line.discipline||""}","${line.experience||""}","${line.officeLocation||""}","${line.geoLocation||""}","${line.type||""}",`;
                csv += `${bar.id||""},"${bar.projectName||""}","${bar.client||""}","${bar.discipline||""}","${bar.experience||""}","${bar.LOE||""}","${bar.location||""}","${bar.proposed||""}","${bar.type||""}","${bar.label||""}",`;
                csv += `${sy},${sw},${ey},${ew},${bar.length}\n`;
            });
        }
    });
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.download = "gantt-data.csv";
    a.href = url;
    a.click();
    URL.revokeObjectURL(url);
});

// Import
importJsonBtn.addEventListener("click", () => {
    importFileInput.value = "";
    importFileInput.click();
});
importFileInput.addEventListener("change", e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
        try {
            let imported;
            if (file.name.endsWith(".json")) {
                imported = JSON.parse(ev.target.result);
                lines = imported.lines || [];
                startYear = imported.startYear || startYear;
                startWeek = imported.startWeek || startWeek;
                endYear = imported.endYear || endYear;
                endWeek = imported.endWeek || endWeek;
                lineCounter = imported.lineCounter || lineCounter;
                barCounter = imported.barCounter || barCounter;
                cellWidth = imported.cellWidth || cellWidth;
                rowHeight = imported.rowHeight || rowHeight;
                statusColors = imported.statusColors || statusColors;
                currentTheme = imported.currentTheme || currentTheme;
                lines.forEach(l => {
                    l.selected = false;
                    l.dragging = false;
                    l.bars.forEach(b => {
                        b.selected = false;
                        if (!b.status) b.status = "proposed";
                        if (b.label === undefined) b.label = "";
                    });
                });
            }
            else if (file.name.endsWith(".csv")) {
                const parsed = parseCsv(ev.target.result);
                lines = parsed.lines;
                lineCounter = parsed.lineCounter;
                barCounter = parsed.barCounter;
            }
            else {
                throw new Error("Unsupported file type");
            }

            startYearInput.value = startYear;
            startWeekInput.value = startWeek;
            endYearInput.value = endYear;
            endWeekInput.value = endWeek;
            zoomSlider.value = cellWidth;
            heightZoomSlider.value = rowHeight;
            themeSelect.value = currentTheme;
            securedColor.value = statusColors.secured;
            proposedColor.value = statusColors.proposed;
            opportunityColor.value = statusColors.opportunity;
            futureColor.value = statusColors.future;
            updateCSSVariables();
            applyTheme();
            renderTable();
            saveToLocalStorage();
            alert("Import successful!");
        } catch (err) {
            console.error(err);
            alert("Import failed:" + err.message);
        }
    };
    reader.readAsText(file);
});

function parseCsv(csv) {
    const rows = csv.trim().split('\n');
    const header = rows[0].toLowerCase();
    if (!header.includes('line id') || !header.includes('bar id'))
        throw new Error("Invalid CSV header");

    const newLines = [];
    let maxLineId = 0;
    let maxBarId = 0;
    const lineMap = {};

    for (let i = 1; i < rows.length; i++) {
        const row = rows[i].trim();
        if (!row) continue;
        const parsed = [];
        let field = "";
        let inQuote = false;
        for (let c of row + ',') {
            if (c === '"') inQuote = !inQuote;
            else if (c === ',' && !inQuote) {
                parsed.push(field);
                field = "";
            } else field += c;
        }
        if (parsed.length < 7) continue;

        // Map columns
        const lineId = parseInt(parsed[0]) || 0;
        const lineName = parsed[1] || "";
        const lineDis = parsed[2] || "";
        const lineExp = parsed[3] || "";
        const lineOff = parsed[4] || "";
        const lineGeo = parsed[5] || "";
        const lineTypeVal = parsed[6] || "";

        if (!lineMap[lineId]) {
            lineMap[lineId] = {
                id: lineId,
                name: lineName,
                discipline: lineDis,
                experience: lineExp,
                officeLocation: lineOff,
                geoLocation: lineGeo,
                type: lineTypeVal,
                bars: [],
                selected: false,
                dragging: false
            };
            newLines.push(lineMap[lineId]);
            maxLineId = Math.max(maxLineId, lineId);
        }

        const barIdStr = parsed[7];
        if (!barIdStr) continue;
        const barId = parseInt(barIdStr) || 0;
        const barProj = parsed[8] || "";
        const barClient = parsed[9] || "";
        const barDisci = parsed[10] || "";
        const barExp = parsed[11] || "";
        const barLOE = parsed[12] || "";
        const barLoc = parsed[13] || "";
        const barProp = parsed[14] || "no";
        const barType = parsed[15] || "";
        const barLabel = parsed[16] || ""; // extended to fit new "Label" column
        const sY = parseInt(parsed[17]) || 2025;
        const sW = parseInt(parsed[18]) || 1;
        const eY = parseInt(parsed[19]) || 2025;
        const eW = parseInt(parsed[20]) || 1;
        let duration = parseInt(parsed[21]) || 1;

        const startAbs = toAbsoluteWeek(sY, sW);
        const endAbs = toAbsoluteWeek(eY, eW);
        let length = endAbs - startAbs + 1;
        if (length < 1) length = duration || 1;

        const newBar = {
            id: barId,
            projectName: barProj,
            client: barClient,
            discipline: barDisci,
            experience: barExp,
            LOE: barLOE,
            location: barLoc,
            proposed: barProp,
            type: barType,
            label: barLabel,
            startAbsWeek: startAbs,
            length,
            status: "proposed",
            selected: false
        };
        lineMap[lineId].bars.push(newBar);

        maxBarId = Math.max(maxBarId, barId);
    }
    return { lines: newLines, lineCounter: maxLineId, barCounter: maxBarId };
}

/*
    ---------------------------------------------------------------------------------------------
    print
    ---------------------------------------------------------------------------------------------
*/
printBtn.addEventListener("click", () => {
    window.print();
});

/*
    ---------------------------------------------------------------------------------------------
    Zoom
    ---------------------------------------------------------------------------------------------
*/
zoomSlider.addEventListener("input", e => {
    cellWidth = parseInt(e.target.value);
    pushState();
    updateCSSVariables();
    renderTable();
    saveToLocalStorage();
});
heightZoomSlider.addEventListener("input", e => {
    rowHeight = parseInt(e.target.value);
    pushState();
    updateCSSVariables();
    renderTable();
    saveToLocalStorage();
});

/*
    ---------------------------------------------------------------------------------------------
    pushState
    ---------------------------------------------------------------------------------------------
*/
function pushState() {
    const stateCopy = JSON.parse(JSON.stringify({
        lines,
        startYear,
        startWeek,
        endYear,
        endWeek,
        lineCounter,
        barCounter,
        cellWidth,
        rowHeight,
        statusColors,
        currentTheme
    }));
    undoStack.push(stateCopy);
    redoStack = [];
}
function restoreState(st) {
    lines = st.lines;
    startYear = st.startYear;
    startWeek = st.startWeek;
    endYear = st.endYear;
    endWeek = st.endWeek;
    lineCounter = st.lineCounter;
    barCounter = st.barCounter;
    cellWidth = st.cellWidth;
    rowHeight = st.rowHeight;
    statusColors = st.statusColors;
    currentTheme = st.currentTheme;
    updateCSSVariables();
    applyTheme();
    renderTable();
    saveToLocalStorage();
}
function undo() {
    if (!adminMode) return;
    if (undoStack.length < 2) return;
    const current = undoStack.pop();
    redoStack.push(current);
    const prev = undoStack[undoStack.length - 1];
    restoreState(prev);
}
function redo() {
    if (!adminMode) return;
    if (!redoStack.length) return;
    const nextSt = redoStack.pop();
    const current = JSON.parse(JSON.stringify({
        lines,
        startYear,
        startWeek,
        endYear,
        endWeek,
        lineCounter,
        barCounter,
        cellWidth,
        rowHeight,
        statusColors,
        currentTheme
    }));
    undoStack.push(current);
    restoreState(nextSt);
}
document.getElementById("undoBtn").addEventListener("click", () => undo());
document.getElementById("redoBtn").addEventListener("click", () => redo());

/*
    ---------------------------------------------------------------------------------------------
    helpBtn
    ---------------------------------------------------------------------------------------------
*/
document.getElementById("helpBtn").addEventListener("click", () => {
    alert(` Gantt Planner Detailed Help & Tips:
 Admin vs User:
  - Toggle Admin with the 'Toggle Admin' button, password "Password".
  - In user mode, bars can only move vertically. In admin mode, bars can be resized or moved freely.

 Right-Click to:
  - Open line item attribute editor (user sees read-only, admin can edit).
  - Open bar attribute editor (same read-only or admin edit).
  - Or, if right-clicking empty space in admin, quickly add a new bar.

 CSV Editor:
  - In admin mode, you can click 'Edit CSV' to open a live CSV viewer which, on Apply, updates the chart.

 Timescale:
  - Now includes month name in the header. Every other month is shaded differently in the background.

 Zoom & Timescale:
  - Use the sliders for horizontal/vertical cell sizes, or adjust Start/End year/week and click Apply.

 Undo/Redo:
  - Only available in admin mode.

 Print/PDF:
  - Use your browser's print dialog.

Enjoy the Gantt Planner!
`);
});

/*
    ---------------------------------------------------------------------------------------------
    adminToggleBtn => password check
    ---------------------------------------------------------------------------------------------
*/
adminToggleBtn.addEventListener("click", () => {
    if (!adminMode) {
        let pwd = prompt("Enter admin password:");
        if (pwd === "Password") {
            adminMode = true;
            alert("Admin mode enabled.");
        } else {
            alert("Incorrect password. Remaining in user mode.");
            return;
        }
    } else {
        adminMode = false;
        alert("Admin mode disabled.");
    }
    csvEditToggleBtn.style.display = adminMode ? "inline-block" : "none";
    renderTable();
});

/*
    ---------------------------------------------------------------------------------------------
    CSV Edit
    ---------------------------------------------------------------------------------------------
*/
csvEditToggleBtn.addEventListener("click", () => {
    if (!adminMode) return;
    let csvStr = "Line ID,Line Name,Line Discipline,Line Experience,Line OfficeLocation,Line GeoLocation,Line Type," +
                 "Bar ID,Project Name,Client,Discipline,Experience,LOE,Location,Proposed,Type,Label," +
                 "Start Year,Start Week,End Year,End Week,Duration (weeks)\n";
    lines.forEach(line => {
        if (line.bars.length === 0) {
            csvStr += `${line.id||""},"${line.name||""}","${line.discipline||""}","${line.experience||""}","${line.officeLocation||""}","${line.geoLocation||""}","${line.type||""}",,,,,,,,,,,,\n`;
        } else {
            line.bars.forEach(bar => {
                let { year: sy, week: sw } = fromAbsoluteWeek(bar.startAbsWeek);
                let { year: ey, week: ew } = fromAbsoluteWeek(bar.startAbsWeek + bar.length - 1);
                csvStr += `${line.id||""},"${line.name||""}","${line.discipline||""}","${line.experience||""}","${line.officeLocation||""}","${line.geoLocation||""}","${line.type||""}",`;
                csvStr += `${bar.id||""},"${bar.projectName||""}","${bar.client||""}","${bar.discipline||""}","${bar.experience||""}","${bar.LOE||""}","${bar.location||""}","${bar.proposed||""}","${bar.type||""}","${bar.label||""}",`;
                csvStr += `${sy},${sw},${ey},${ew},${bar.length}\n`;
            });
        }
    });
    csvTextarea.value = csvStr;
    csvEditModal.style.display = "block";
});
csvEditApplyBtn.addEventListener("click", () => {
    if (!adminMode) return;
    const csvData = csvTextarea.value;
    try {
        const parsed = parseCsv(csvData);
        lines = parsed.lines;
        lineCounter = parsed.lineCounter;
        barCounter = parsed.barCounter;
        pushState();
        renderTable();
        saveToLocalStorage();
        alert("CSV updated successfully.");
        csvEditModal.style.display = "none";
    } catch (err) {
        alert("Error parsing CSV: " + err.message);
    }
});
csvEditCancelBtn.addEventListener("click", () => {
    csvEditModal.style.display = "none";
});
document.addEventListener("mousedown", e => {
    if (csvEditModal.style.display === "block") {
        const rect = csvEditModal.getBoundingClientRect();
        const inside = e.clientX >= rect.left && e.clientX <= rect.right && e.clientY >= rect.top && e.clientY <= rect.bottom;
        if (!inside) {
            csvEditModal.style.display = "none";
        }
    }
});

/*
    ---------------------------------------------------------------------------------------------
    applyTimescaleBtn
    ---------------------------------------------------------------------------------------------
*/
applyTimescaleBtn.addEventListener("click", () => {
    startYear = parseInt(startYearInput.value) || 2025;
    startWeek = parseInt(startWeekInput.value) || 1;
    endYear = parseInt(endYearInput.value) || 2025;
    endWeek = parseInt(endWeekInput.value) || 52;
    pushState();
    renderTable();
    saveToLocalStorage();
});

/*
    ---------------------------------------------------------------------------------------------
    init => load & set up
    ---------------------------------------------------------------------------------------------
*/
function init() {
    loadFromLocalStorage();
    populateDateSelects();
    updateCSSVariables();
    startYearInput.value = startYear;
    startWeekInput.value = startWeek;
    endYearInput.value = endYear;
    endWeekInput.value = endWeek;
    zoomSlider.value = cellWidth;
    heightZoomSlider.value = rowHeight;
    themeSelect.value = currentTheme;
    securedColor.value = statusColors.secured;
    proposedColor.value = statusColors.proposed;
    opportunityColor.value = statusColors.opportunity;
    futureColor.value = statusColors.future;
    applyTheme();
    renderTable();
    pushState();
    csvEditToggleBtn.style.display = "none"; // hidden until admin mode

    tableWrapper.addEventListener("scroll", () => updateBarTextPositions());
    window.addEventListener("resize", () => updateBarTextPositions());
}
window.addEventListener("load", init);

// helper to populate year/week selects for the bar editor
function populateDateSelects() {
    // Just briefly fill with some typical years for demonstration
    const years = [];
    for (let y = 2023; y <= 2030; y++) {
        years.push(y);
    }
    const weeks = [];
    for (let w = 1; w <= 52; w++) {
        weeks.push(w);
    }
    [startYearSelect, endYearSelect].forEach(sel => {
        sel.innerHTML = "";
        years.forEach(y => {
            let opt = document.createElement("option");
            opt.value = y;
            opt.textContent = y;
            sel.appendChild(opt);
        });
    });
    [startWeekSelect, endWeekSelect].forEach(sel => {
        sel.innerHTML = "";
        weeks.forEach(w => {
            let opt = document.createElement("option");
            opt.value = w;
            opt.textContent = w;
            sel.appendChild(opt);
        });
    });
}
</script>
</body>
</html>
