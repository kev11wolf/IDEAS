<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Character set: Declares UTF-8 encoding to prevent garbled text -->
    <meta charset="UTF-8" />
    <!-- Page Title: Shown in browser tab -->
    <title>Advanced Gantt Chart</title>
    <!-- Bootstrap 5 CSS via CDN: for grid, modals, etc. -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
    <style>
        /* Make navbar/toolbar span the full screen width */
        .navbar .container-fluid {
            max-width: 100vw;
        }

        /* Remove default body margin, set font: resets margin, sets default font */
        body {
            margin: 0;
            font-family: Arial, sans-serif;
        }

        /* Navbar: Sticky at top, always visible, full width */
        .navbar {
            position: sticky;
            top: 0;
            z-index: 1000; /* ensures the navbar is on top */
            background-color: #f8f9fa;
            padding: 0.5rem 1rem;
            width: 100%;
        }

        /* Force the navbar collapse area to flex-wrap so we can stack items vertically */
        .navbar-collapse {
            display: flex !important;
            flex-wrap: wrap !important;
            align-items: flex-start !important;
        }

        /* Each toolbar group can be stacked */
        .toolbar-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            padding: 0.5rem;
            border-left: 1px solid #dee2e6;
        }

        .toolbar-group:first-child {
            border-left: none;
            padding-left: 0;
        }

        /* For stacking label/inputs in a vertical manner (timescale, etc.) */
        .stacked-field {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        /* Timescale block to group timescale items */
        .timescale-block {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        /* color legend stacked vertically */
        .legend-container-vertical {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        /* Gantt container: Full width with padding */
        .gantt-container {
            margin: 0 1rem;
            position: relative;
        }

        /* The main wrapper for both horizontal and vertical scrolls */
        .table-wrapper {
            overflow: auto;
            position: relative;
        }

        /* Cohesive table: Native HTML table for perfect alignment */
        #ganttTable {
            width: 100%;
            border-collapse: collapse; /* needed for aligned borders */
            table-layout: fixed; /* Ensures column widths remain consistent */
        }

        /*
         * Add black gridlines to rows and columns.
         * Each cell, including the header cells, gets a 1px solid black border.
         */
        #ganttTable,
        #ganttTable thead th,
        #ganttTable tbody td {
            border: 1px solid #000; /* black gridlines */
        }

        /* Header row: sticky top so that we always see it, z-index higher than lines */
        #ganttTable thead th {
            position: sticky;
            top: 0; 
            background-color: #f8f9fa;
            z-index: 10; 
            text-align: center;
            font-size: 0.9rem;
            padding: 4px 8px;
            box-sizing: border-box;
        }

        /* Name header: width, background */
        #nameHeader {
            width: 240px;
            text-align: center;
            font-weight: bold;
            background-color: #f8f9fa;
            z-index: 11; 
        }

        /* Timescale headers: for each week, also keep them sticky for columns if we like, but we only keep them top sticky here */
        .timescale-header {
            background-color: #e9ecef;
            min-width: 50px;
        }

        /* Table body with dynamic background coloration for months/weeks */
        #ganttTable tbody {
            position: relative;
        }

        /* Row: dynamic height via CSS variable */
        .gantt-row {
            height: var(--row-height);
            transition: outline 0.2s;
        }

        /* Selected row highlight */
        .gantt-row.selected {
            background-color: #fff3cd;
        }

        /* Highlight row in yellow when dragging (feedback) */
        .gantt-row.drag-highlight {
            outline: 2px solid yellow;
        }

        /* Name cell: Sticky left, background, etc. */
        .name-cell {
            position: sticky;
            left: 0;
            background-color: #f0f0f0;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.2);
            z-index: 9;
            width: 240px;
            display: flex;
            justify-content: center;
            align-items: center;
            height: var(--row-height);
            box-sizing: border-box;
            cursor: move; /* we drag lines by the cell */
        }

        /* Container for bars in each row (covering the entire colspan) */
        .bar-cell {
            position: relative;
            padding: 0;
        }

        /* Full row bar container: flex center */
        .bar-row-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
        }

        /* Bar: absolute, can drag in admin, vertical-only in user */
        .bar {
            position: absolute;
            height: calc(var(--row-height) - 16px);
            top: auto;
            left: 0;
            border-radius: 4px;
            color: #fff;
            cursor: pointer;
            user-select: none;
            opacity: 0.7;
            overflow: hidden;
            z-index: 0;
            box-sizing: border-box;
        }

        .bar.selected {
            outline: 3px solid #00f;
        }

        /* Highlighted for search matches */
        .bar.highlighted {
            outline: 3px solid #0d6efd;
            opacity: 0.9;
        }

        /* Bar text: center horizontally */
        .bar-text {
            position: absolute;
            top: 0;
            height: 100%;
            line-height: calc(var(--row-height) - 16px);
            white-space: nowrap;
            pointer-events: none;
            font-weight: 500;
            padding: 0 8px;
        }

        /* Resize handles in admin mode only */
        .bar-handle {
            position: absolute;
            top: 0;
            width: 6px;
            height: 100%;
            cursor: col-resize;
            background-color: rgba(255,255,255,0.4);
            z-index: 2;
        }
        .bar-handle.left {
            left: 0;
            border-radius: 4px 0 0 4px;
        }
        .bar-handle.right {
            right: 0;
            border-radius: 0 4px 4px 0;
        }

        /* Overlap hatch: indicates overlapping bars */
        .overlap-hatch {
            position: absolute;
            height: calc(var(--row-height) - 16px);
            top: auto;
            background: repeating-linear-gradient(
                45deg,
                red,
                red 2px,
                transparent 2px,
                transparent 4px
            );
            opacity: 0.5;
            pointer-events: none;
            z-index: 1;
            margin-top: 0;
            margin-bottom: 0;
        }

        /* Editor overlays have high z-index to appear above everything */
        #barEditor,
        #lineEditor {
            position: absolute;
            display: none;
            background: #fff;
            border: 1px solid #ccc;
            padding: 12px;
            border-radius: 6px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.5);
            z-index: 9999;
            min-width: 280px;
        }

        #barEditor label,
        #lineEditor label {
            display: block;
            margin-top: 8px;
            font-weight: 500;
        }

        #barEditor input,
        #barEditor select,
        #lineEditor input {
            margin-top: 4px;
            width: 100%;
        }

        #barEditorActions,
        #lineEditorActions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 12px;
        }

        /* Filter modal with two cards side-by-side */
        #filterModal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            border: 1px solid #ccc;
            padding: 20px;
            border-radius: 6px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.5);
            z-index: 9999;
            min-width: 600px;
        }

        #filterModal h3 {
            margin-top: 0;
        }

        .filter-container {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            gap: 20px;
        }

        .filter-card {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .filter-card h5 {
            margin-top: 0;
            margin-bottom: 6px;
            font-size: 1rem;
            font-weight: 600;
        }

        #filterActions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 12px;
        }

        /* Settings modal */
        #settingsModal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            border: 1px solid #ccc;
            padding: 20px;
            border-radius: 6px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.5);
            z-index: 9999;
            min-width: 300px;
        }

        #settingsModal h3 {
            margin-top: 0;
        }

        #settingsModal label {
            display: block;
            margin-top: 8px;
        }

        #settingsActions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 12px;
        }

        .color-picker {
            width: 60px;
            height: 30px;
            padding: 0;
            border: none;
            cursor: pointer;
        }

        /* Dark theme */
        body.dark-theme {
            background-color: #212529;
            color: #f8f9fa;
        }

        body.dark-theme .navbar {
            background-color: #343a40 !important;
        }

        body.dark-theme #ganttTable thead th,
        body.dark-theme .timescale-header {
            background-color: #495057;
            color: #f8f9fa;
        }

        body.dark-theme .name-cell {
            background-color: #444;
            color: #f8f9fa;
            box-shadow: 1px 1px 3px rgba(255,255,255,0.2);
        }

        body.dark-theme .bar-text {
            color: #212529;
        }

        body.dark-theme #barEditor,
        body.dark-theme #lineEditor,
        body.dark-theme #filterModal,
        body.dark-theme #settingsModal,
        body.dark-theme #csvEditModal {
            background: #343a40;
            color: #f8f9fa;
            border: 1px solid #495057;
        }

        body.dark-theme input,
        body.dark-theme select,
        body.dark-theme textarea {
            background: #495057;
            color: #f8f9fa;
            border: 1px solid #6c757d;
        }

        /* Zoom sliders styling */
        .zoom-slider {
            width: 120px;
            margin: 0 8px;
            height: 8px;
            border-radius: 4px;
            background: #ced4da;
            outline: none;
            -webkit-appearance: none;
            box-shadow: 0 2px 6px rgba(0,0,0,0.25);
        }

        .zoom-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #0d6efd;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .zoom-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #0d6efd;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        #heightZoomSlider {
            transform: rotate(-90deg);
            width: 100px;
        }

        /* CSV Edit modal must appear on top of everything */
        #csvEditModal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            width: 60%;
            height: 60%;
            transform: translate(-50%, -50%);
            background: #fff;
            border: 1px solid #ccc;
            padding: 10px;
            border-radius: 6px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.5);
            z-index: 99999;
            overflow: auto;
        }

        #csvTextarea {
            width: 100%;
            height: 70%;
            font-family: monospace;
            font-size: 0.9rem;
        }

        #csvEditModalActions {
            margin-top: 10px;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        /* Print styling, hide UI elements */
        @media print {
            .navbar,
            #barEditor,
            #lineEditor,
            #filterModal,
            #settingsModal,
            #adminToggleBtn,
            #csvEditToggleBtn,
            #csvEditModal {
                display: none !important;
            }

            .table-wrapper {
                overflow: visible;
            }

            #ganttTable {
                font-size: 10pt;
            }
        }

        /* Help button */
        #helpBtn {
            cursor: pointer;
            transition: transform 0.2s;
        }
        #helpBtn:hover {
            transform: scale(1.1);
        }

        /* Settings button */
        #settingsBtn {
            cursor: pointer;
            transition: transform 0.2s;
        }
        #settingsBtn:hover {
            transform: scale(1.1);
        }
    </style>
</head>
<body>
<!-- Sticky navbar with stacked layout inside for space savings -->
<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
        <!-- Brand -->
        <a class="navbar-brand" href="#">Gantt Planner</a>
        <!-- Toggler -->
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
                aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <!-- Collapsible content with wrap -->
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <!-- Timescale group -->
            <div class="toolbar-group">
                <span>Timescale</span>
                <div class="timescale-block">
                    <div class="stacked-field">
                        <label for="startYearInput" class="form-label m-0">Start Year:</label>
                        <input id="startYearInput" type="number" class="form-control form-control-sm" value="2025" />
                    </div>
                    <div class="stacked-field">
                        <label for="startWeekInput" class="form-label m-0">Start Week:</label>
                        <input id="startWeekInput" type="number" class="form-control form-control-sm" value="1" />
                    </div>
                    <div class="stacked-field">
                        <label for="endYearInput" class="form-label m-0">End Year:</label>
                        <input id="endYearInput" type="number" class="form-control form-control-sm" value="2025" />
                    </div>
                    <div class="stacked-field">
                        <label for="endWeekInput" class="form-label m-0">End Week:</label>
                        <input id="endWeekInput" type="number" class="form-control form-control-sm" value="52" />
                    </div>
                    <button id="applyTimescaleBtn" type="button" class="btn btn-secondary btn-sm">Apply</button>
                </div>
            </div>

            <!-- Legend group -->
            <div class="toolbar-group">
                <span>Legend</span>
                <div id="statusLegend" class="legend-container-vertical">
                    <div class="legend-item">
                        <div class="legend-swatch" style="width:16px; height:16px; background:#28a745;"></div>
                        <span>Secured</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-swatch" style="width:16px; height:16px; background:#fd7e14;"></div>
                        <span>Proposed</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-swatch" style="width:16px; height:16px; background:#dc3545;"></div>
                        <span>Opportunity</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-swatch" style="width:16px; height:16px; background:#6f42c1;"></div>
                        <span>Future</span>
                    </div>
                </div>
            </div>

            <!-- Zoom group -->
            <div class="toolbar-group">
                <span>Zoom</span>
                <div style="display: flex; flex-direction: row; gap: 0.5rem;">
                    <div>
                        <label for="zoomSlider" class="form-label m-0 me-2">H-Zoom:</label>
                        <input type="range" class="zoom-slider" id="zoomSlider" min="50" max="300" value="150" step="10">
                    </div>
                    <div>
                        <label for="heightZoomSlider" class="form-label m-0 me-2">V-Zoom:</label>
                        <input type="range" class="zoom-slider" id="heightZoomSlider" min="30" max="100" value="40" step="5">
                    </div>
                </div>
            </div>

            <!-- Search group -->
            <div class="toolbar-group">
                <span>Search</span>
                <input type="text" id="searchInput" class="form-control form-control-sm" placeholder="Filter lines/bars..." />
            </div>

            <!-- Actions group -->
            <div class="toolbar-group">
                <span>Actions</span>
                <div style="display: flex; flex-wrap: wrap; gap:4px;">
                    <button id="addLineItemBtn" class="btn btn-primary btn-sm">Add Line</button>
                    <button id="addBarBtn" class="btn btn-secondary btn-sm">Add Bar</button>
                    <button id="filterBtn" class="btn btn-outline-primary btn-sm">Filter</button>
                    <button id="importJsonBtn" class="btn btn-outline-success btn-sm">Import</button>
                    <button id="exportJsonBtn" class="btn btn-outline-info btn-sm">Export JSON</button>
                    <button id="downloadCsvBtn" class="btn btn-outline-secondary btn-sm">Export CSV</button>
                    <button id="printBtn" class="btn btn-outline-dark btn-sm">Print/PDF</button>
                    <svg id="settingsBtn" width="24" height="24" viewBox="0 0 24 24" fill="none"
                         xmlns="http://www.w3.org/2000/svg">
                        <path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 0 0 .12-.61l-1.92-3.32a.488.488 0 0 0-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 0 0-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96a.488.488 0 0 0-.59.22l-1.92 3.32c-.14.24-.08.54.12.61l2.03 1.58c-.05.3-.09.63-.09.94 0 .31.04.64.07.94l-2.03 1.58a.49.49 0 0 0-.12.61l1.92 3.32c.14.24.37.34.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .43-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.45 0 .59-.22l1.92-3.32c.14-.24.08-.54-.12-.61l-2.03-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6 0-1.98 1.62-3.6 3.6-3.6 1.98 0 3.6 1.62 3.6 3.6 0 1.98-1.62 3.6-3.6 3.6z"
                              fill="#0d6efd"/>
                    </svg>
                    <svg id="helpBtn" width="24" height="24" viewBox="0 0 24 24" fill="none"
                         xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 14.5v.5h-2v-1c0-1.11.45-2.11 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"
                              fill="#0d6efd"/>
                    </svg>
                    <button id="adminToggleBtn" class="btn btn-outline-danger btn-sm">Toggle Admin</button>
                    <!-- CSV Editing toggles in admin mode -->
                    <button id="csvEditToggleBtn" class="btn btn-outline-dark btn-sm" style="display:none;">Edit CSV</button>
                </div>
            </div>

            <!-- Undo/Redo group -->
            <div class="toolbar-group">
                <span>History</span>
                <div style="display: flex; flex-wrap: wrap; gap:4px;">
                    <button id="undoBtn" type="button" class="btn btn-sm btn-success">Undo</button>
                    <button id="redoBtn" type="button" class="btn btn-sm btn-warning">Redo</button>
                </div>
            </div>
        </div>
    </div>
</nav>

<!-- Main cohesive table -->
<div class="gantt-container">
    <div class="table-wrapper" id="tableWrapper">
        <table id="ganttTable">
            <thead>
            <tr id="headerRow">
                <th id="nameHeader">Tasks</th>
                <!-- Timescale headers go here -->
            </tr>
            </thead>
            <tbody id="tableBody">
            <!-- Rows go here -->
            </tbody>
        </table>
    </div>
</div>

<!-- Bar editor -->
<div id="barEditor">
    <!-- Re-organizing to place Label first, then others. -->
    <label for="barLabelInput">Bar Label:</label>
    <input type="text" id="barLabelInput" placeholder="Bar Label..." />

    <label for="barProjectNameInput">Project Name:</label>
    <input type="text" id="barProjectNameInput" placeholder="Project Name..." />

    <label for="barClientInput">Client:</label>
    <input type="text" id="barClientInput" placeholder="Client..." />

    <label for="barDisciplineInput">Discipline:</label>
    <input type="text" id="barDisciplineInput" placeholder="Discipline..." />

    <label for="barExperienceInput">Experience:</label>
    <input type="text" id="barExperienceInput" placeholder="Experience..." />

    <label for="barLOEInput">LOE:</label>
    <input type="text" id="barLOEInput" placeholder="LOE..." />

    <label for="barLocationInput">Location:</label>
    <input type="text" id="barLocationInput" placeholder="Location..." />

    <!-- Type => color from the legend -->
    <label for="barTypeSelect">Type (affects color):</label>
    <select id="barTypeSelect">
        <option value="secured">Secured</option>
        <option value="proposed">Proposed</option>
        <option value="opportunity">Opportunity</option>
        <option value="future">Future</option>
    </select>

    <label for="barProposedSelect">Proposed:</label>
    <select id="barProposedSelect">
        <option value="yes">Yes</option>
        <option value="no">No</option>
    </select>

    <label for="startYearSelect">Start Date (Year/Week):</label>
    <select id="startYearSelect"></select>
    <select id="startWeekSelect"></select>

    <label for="endYearSelect">End Date (Year/Week):</label>
    <select id="endYearSelect"></select>
    <select id="endWeekSelect"></select>

    <div id="barEditorActions">
        <button id="barDeleteBtn" class="btn btn-sm btn-danger">Delete Bar</button>
        <button id="barEditorOkBtn" class="btn btn-sm btn-primary">OK</button>
        <button id="barEditorCancelBtn" class="btn btn-sm btn-secondary">Cancel</button>
    </div>
</div>

<!-- Line editor -->
<div id="lineEditor">
    <label for="lineNameInput">Name:</label>
    <input type="text" id="lineNameInput" placeholder="Name..." />

    <label for="lineDisciplineInput">Discipline:</label>
    <input type="text" id="lineDisciplineInput" placeholder="Discipline..." />

    <label for="lineExperienceInput">Experience:</label>
    <input type="text" id="lineExperienceInput" placeholder="Experience..." />

    <label for="lineOfficeLocationInput">Office Location:</label>
    <input type="text" id="lineOfficeLocationInput" placeholder="Office Location..." />

    <label for="lineGeoLocationInput">Geo Location:</label>
    <input type="text" id="lineGeoLocationInput" placeholder="Geo Location..." />

    <label for="lineTypeInput">Type:</label>
    <input type="text" id="lineTypeInput" placeholder="Type..." />

    <div id="lineEditorActions">
        <button id="lineDeleteBtn" class="btn btn-sm btn-danger">Delete Line Item</button>
        <button id="lineEditorOkBtn" class="btn btn-sm btn-primary">OK</button>
        <button id="lineEditorCancelBtn" class="btn btn-sm btn-secondary">Cancel</button>
    </div>
</div>

<!-- Filter modal with 2 cards side by side -->
<div id="filterModal">
    <h3>Filter Lines/Bars</h3>
    <div class="filter-container">
        <!-- Left filter card: line item attributes -->
        <div class="filter-card">
            <h5>Line Item Filters</h5>
            <label for="filterLineName">Name:</label>
            <input type="text" id="filterLineName" placeholder="Name..." />

            <label for="filterLineDiscipline">Discipline:</label>
            <input type="text" id="filterLineDiscipline" placeholder="Discipline..." />

            <label for="filterLineExperience">Experience:</label>
            <input type="text" id="filterLineExperience" placeholder="Experience..." />

            <label for="filterLineOfficeLocation">Office Location:</label>
            <input type="text" id="filterLineOfficeLocation" placeholder="Office Location..." />

            <label for="filterLineGeoLocation">Geo Location:</label>
            <input type="text" id="filterLineGeoLocation" placeholder="Geo Location..." />

            <label for="filterLineType">Type:</label>
            <input type="text" id="filterLineType" placeholder="Type..." />
        </div>

        <!-- Right filter card: bar attributes -->
        <div class="filter-card">
            <h5>Bar Filters</h5>
            <label for="filterBarProjectName">Project Name:</label>
            <input type="text" id="filterBarProjectName" placeholder="Project Name..." />

            <label for="filterBarClient">Client:</label>
            <input type="text" id="filterBarClient" placeholder="Client..." />

            <label for="filterBarDiscipline">Discipline:</label>
            <input type="text" id="filterBarDiscipline" placeholder="Discipline..." />

            <label for="filterBarExperience">Experience:</label>
            <input type="text" id="filterBarExperience" placeholder="Experience..." />

            <label for="filterBarLOE">LOE:</label>
            <input type="text" id="filterBarLOE" placeholder="LOE..." />

            <label for="filterBarLocation">Location:</label>
            <input type="text" id="filterBarLocation" placeholder="Location..." />

            <label for="filterBarType">Type:</label>
            <input type="text" id="filterBarType" placeholder="Type..." />

            <label for="filterBarProposed">Proposed:</label>
            <input type="text" id="filterBarProposed" placeholder="Yes/No..." />
        </div>
    </div>
    <div id="filterActions">
        <button id="filterApplyBtn" class="btn btn-sm btn-primary">Apply</button>
        <button id="filterClearBtn" class="btn btn-sm btn-secondary">Clear</button>
        <button id="filterCancelBtn" class="btn btn-sm btn-secondary">Cancel</button>
    </div>
</div>

<!-- Settings modal -->
<div id="settingsModal">
    <h3>Theme Settings</h3>
    <label>Theme:</label>
    <select id="themeSelect">
        <option value="light">Light</option>
        <option value="dark">Dark</option>
    </select>

    <label for="securedColor">Secured Color:</label>
    <input type="color" id="securedColor" class="color-picker" value="#28a745" />

    <label for="proposedColor">Proposed Color:</label>
    <input type="color" id="proposedColor" class="color-picker" value="#fd7e14" />

    <label for="opportunityColor">Opportunity Color:</label>
    <input type="color" id="opportunityColor" class="color-picker" value="#dc3545" />

    <label for="futureColor">Future Color:</label>
    <input type="color" id="futureColor" class="color-picker" value="#6f42c1" />

    <div id="settingsActions">
        <button id="settingsOkBtn" class="btn btn-sm btn-primary">Apply</button>
        <button id="settingsCancelBtn" class="btn btn-sm btn-secondary">Cancel</button>
    </div>
</div>

<!-- CSV Edit modal -->
<div id="csvEditModal">
    <h3>Edit CSV In-Browser</h3>
    <textarea id="csvTextarea"></textarea>
    <div id="csvEditModalActions">
        <button id="csvEditApplyBtn" class="btn btn-sm btn-primary">Apply Changes</button>
        <button id="csvEditCancelBtn" class="btn btn-sm btn-secondary">Close</button>
    </div>
</div>

<!-- Hidden import for JSON/CSV -->
<input type="file" id="importFileInput" accept=".json,.csv" style="display:none;" />

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
/*
    ---------------------------------------------------------------------------------------------
    GLOBAL VARIABLES
    ---------------------------------------------------------------------------------------------
*/
let adminMode = false;

/* Ties type field => color */
let typeColors = {
    secured: "#28a745",
    proposed: "#fd7e14",
    opportunity: "#dc3545",
    future: "#6f42c1"
};

/* Our lines array with bars, plus a "label" attribute on each bar.  */
let lines = [
    {
        id: 1,
        name: "Line Item 1",
        discipline: "",
        experience: "",
        officeLocation: "",
        geoLocation: "",
        type: "",
        bars: [
            {
                id: 101,
                label: "Bar A Label",
                projectName: "Bar A",
                client: "",
                discipline: "",
                experience: "",
                LOE: "",
                location: "",
                proposed: "no",
                type: "secured",
                startAbsWeek: toAbsoluteWeek(2025, 2),
                length: 4,
                selected: false
            },
        ],
        selected: false,
        dragging: false
    },
    {
        id: 2,
        name: "Line Item 2",
        discipline: "",
        experience: "",
        officeLocation: "",
        geoLocation: "",
        type: "",
        bars: [
            {
                id: 102,
                label: "Bar B Label",
                projectName: "Bar B",
                client: "",
                discipline: "",
                experience: "",
                LOE: "",
                location: "",
                proposed: "yes",
                type: "proposed",
                startAbsWeek: toAbsoluteWeek(2025, 10),
                length: 7,
                selected: false
            },
        ],
        selected: false,
        dragging: false
    },
];

let startYear = 2025;
let startWeek = 1;
let endYear = 2025;
let endWeek = 52;
let lineCounter = 2;
let barCounter = 102;
let cellWidth = 150;
let rowHeight = 40;
let filters = { line: {}, bar: {} };
let searchTerm = "";
let currentTheme = "light";
let undoStack = [];
let redoStack = [];

let dragging = false;
let dragType = null;
let dragStartX = 0;
let dragStartY = 0;
let initialStartAbs = 0;
let initialLength = 0;
let currentBar = null;
let currentLine = null;
let draggingLine = null;
let lineOriginalIndex = null;
let previousUserLineIndex = null;
let barOriginalLineIndex = null;
let tableBodyRect = null;
let mainFilteredLines = [];

// Editor references
let currentEditorBar = null;
let currentEditorLine = null;

/*
    ---------------------------------------------------------------------------------------------
    DOM REFERENCES
    ---------------------------------------------------------------------------------------------
*/
const tableBody = document.getElementById("tableBody");
const headerRow = document.getElementById("headerRow");
const tableWrapper = document.getElementById("tableWrapper");
const startYearInput = document.getElementById("startYearInput");
const startWeekInput = document.getElementById("startWeekInput");
const endYearInput = document.getElementById("endYearInput");
const endWeekInput = document.getElementById("endWeekInput");
const applyTimescaleBtn = document.getElementById("applyTimescaleBtn");
const zoomSlider = document.getElementById("zoomSlider");
const heightZoomSlider = document.getElementById("heightZoomSlider");
const searchInput = document.getElementById("searchInput");
const filterBtn = document.getElementById("filterBtn");
const importJsonBtn = document.getElementById("importJsonBtn");
const exportJsonBtn = document.getElementById("exportJsonBtn");
const downloadCsvBtn = document.getElementById("downloadCsvBtn");
const printBtn = document.getElementById("printBtn");
const adminToggleBtn = document.getElementById("adminToggleBtn");
const csvEditToggleBtn = document.getElementById("csvEditToggleBtn");
const addLineItemBtn = document.getElementById("addLineItemBtn");
const addBarBtn = document.getElementById("addBarBtn");

// bar editor fields
const barLabelInput = document.getElementById("barLabelInput");
const barProjectNameInput = document.getElementById("barProjectNameInput");
const barClientInput = document.getElementById("barClientInput");
const barDisciplineInput = document.getElementById("barDisciplineInput");
const barExperienceInput = document.getElementById("barExperienceInput");
const barLOEInput = document.getElementById("barLOEInput");
const barLocationInput = document.getElementById("barLocationInput");
const barTypeSelect = document.getElementById("barTypeSelect");
const barProposedSelect = document.getElementById("barProposedSelect");
const startYearSelect = document.getElementById("startYearSelect");
const startWeekSelect = document.getElementById("startWeekSelect");
const endYearSelect = document.getElementById("endYearSelect");
const endWeekSelect = document.getElementById("endWeekSelect");
const barEditor = document.getElementById("barEditor");
const barEditorOkBtn = document.getElementById("barEditorOkBtn");
const barEditorCancelBtn = document.getElementById("barEditorCancelBtn");
const barDeleteBtn = document.getElementById("barDeleteBtn");

// line editor fields
const lineEditor = document.getElementById("lineEditor");
const lineNameInput = document.getElementById("lineNameInput");
const lineDisciplineInput = document.getElementById("lineDisciplineInput");
const lineExperienceInput = document.getElementById("lineExperienceInput");
const lineOfficeLocationInput = document.getElementById("lineOfficeLocationInput");
const lineGeoLocationInput = document.getElementById("lineGeoLocationInput");
const lineTypeInput = document.getElementById("lineTypeInput");
const lineEditorOkBtn = document.getElementById("lineEditorOkBtn");
const lineEditorCancelBtn = document.getElementById("lineEditorCancelBtn");
const lineDeleteBtn = document.getElementById("lineDeleteBtn");

// filter modal
const filterModal = document.getElementById("filterModal");
const filterLineName = document.getElementById("filterLineName");
const filterLineDiscipline = document.getElementById("filterLineDiscipline");
const filterLineExperience = document.getElementById("filterLineExperience");
const filterLineOfficeLocation = document.getElementById("filterLineOfficeLocation");
const filterLineGeoLocation = document.getElementById("filterLineGeoLocation");
const filterLineType = document.getElementById("filterLineType");
const filterBarProjectName = document.getElementById("filterBarProjectName");
const filterBarClient = document.getElementById("filterBarClient");
const filterBarDiscipline = document.getElementById("filterBarDiscipline");
const filterBarExperience = document.getElementById("filterBarExperience");
const filterBarLOE = document.getElementById("filterBarLOE");
const filterBarLocation = document.getElementById("filterBarLocation");
const filterBarType = document.getElementById("filterBarType");
const filterBarProposed = document.getElementById("filterBarProposed");
const filterApplyBtn = document.getElementById("filterApplyBtn");
const filterClearBtn = document.getElementById("filterClearBtn");
const filterCancelBtn = document.getElementById("filterCancelBtn");

// settings
const settingsModal = document.getElementById("settingsModal");
const themeSelect = document.getElementById("themeSelect");
const securedColor = document.getElementById("securedColor");
const proposedColor = document.getElementById("proposedColor");
const opportunityColor = document.getElementById("opportunityColor");
const futureColor = document.getElementById("futureColor");
const settingsOkBtn = document.getElementById("settingsOkBtn");
const settingsCancelBtn = document.getElementById("settingsCancelBtn");

// CSV
const csvEditModal = document.getElementById("csvEditModal");
const csvTextarea = document.getElementById("csvTextarea");
const csvEditApplyBtn = document.getElementById("csvEditApplyBtn");
const csvEditCancelBtn = document.getElementById("csvEditCancelBtn");
const importFileInput = document.getElementById("importFileInput");

/*
    ---------------------------------------------------------------------------------------------
    TIME HELPERS
    ---------------------------------------------------------------------------------------------
*/
function toAbsoluteWeek(year, week) {
    return year * 52 + (week - 1);
}
function fromAbsoluteWeek(absWeek) {
    let y = Math.floor(absWeek / 52);
    let w = (absWeek % 52) + 1;
    return { year: y, week: w };
}
function getMonthFromYearWeek(year, week) {
    let january4 = new Date(year, 0, 4);
    let dayMs = 24*3600*1000;
    let offsetDays = (week - 1)*7 - ( (january4.getDay()+6)%7 );
    let date = new Date(january4.getTime() + offsetDays*dayMs);
    return date.getMonth(); 
}
function getMonthName(m) {
    const months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    return months[m]||"";
}
function getColorFromType(t) {
    return typeColors[t]||"#fd7e14";
}

/*
    ---------------------------------------------------------------------------------------------
    LOCAL STORAGE
    ---------------------------------------------------------------------------------------------
*/
function saveToLocalStorage(){
    let chartData = {
        lines,
        startYear,
        startWeek,
        endYear,
        endWeek,
        lineCounter,
        barCounter,
        cellWidth,
        rowHeight,
        typeColors,
        currentTheme
    };
    localStorage.setItem("ganttChartData", JSON.stringify(chartData));
}
function loadFromLocalStorage(){
    let stored=localStorage.getItem("ganttChartData");
    if(!stored)return;
    try {
        let parsed=JSON.parse(stored);
        lines=parsed.lines||[];
        lines.forEach(l=>{
            l.selected=false;
            l.dragging=false;
            l.bars.forEach(b=>{
                b.selected=false;
                if(b.type===undefined)b.type="proposed";
                if(b.label===undefined)b.label="";
            });
        });
        startYear = parsed.startYear||2025;
        startWeek = parsed.startWeek||1;
        endYear = parsed.endYear||2025;
        endWeek = parsed.endWeek||52;
        lineCounter = parsed.lineCounter||0;
        barCounter = parsed.barCounter||0;
        cellWidth = parsed.cellWidth||150;
        rowHeight = parsed.rowHeight||40;
        typeColors = parsed.typeColors||typeColors;
        currentTheme = parsed.currentTheme||"light";
    }catch(err){
        console.warn("Invalid localStorage data");
    }
}

/*
    ---------------------------------------------------------------------------------------------
    THEME & CSS
    ---------------------------------------------------------------------------------------------
*/
function applyTheme(){
    if(currentTheme==="dark"){
        document.body.classList.add("dark-theme");
    } else {
        document.body.classList.remove("dark-theme");
    }
    renderTable();
    saveToLocalStorage();
}
function updateCSSVariables(){
    document.documentElement.style.setProperty("--cell-width", cellWidth+"px");
    document.documentElement.style.setProperty("--row-height", rowHeight+"px");
}

/*
    ---------------------------------------------------------------------------------------------
    DISPLAY RANGE
    ---------------------------------------------------------------------------------------------
*/
function getDisplayRange(){
    let ds = toAbsoluteWeek(startYear, startWeek);
    let de = toAbsoluteWeek(endYear, endWeek);
    if(ds>de){let temp=ds; ds=de; de=temp;}
    return {displayStart: ds, displayEnd: de};
}

/*
    ---------------------------------------------------------------------------------------------
    SELECTION HELPER
    ---------------------------------------------------------------------------------------------
*/
function unselectAllBars(){
    lines.forEach(l=>l.bars.forEach(b=>b.selected=false));
}
function clearHighlights(){
    document.querySelectorAll(".bar.highlighted").forEach(el=>el.classList.remove("highlighted"));
}

/*
    ---------------------------------------------------------------------------------------------
    BAR TEXT POS
    ---------------------------------------------------------------------------------------------
*/
function updateBarTextPositions(){
    const scrollLeft = tableWrapper.scrollLeft;
    const viewportWidth = tableWrapper.clientWidth;
    document.querySelectorAll(".bar-text").forEach(textEl=>{
        let barEl = textEl.parentElement;
        let barLeft = parseFloat(barEl.style.left);
        let barWidth = parseFloat(barEl.style.width);
        let barRight = barLeft+barWidth;
        let visibleLeft = Math.max(barLeft, scrollLeft);
        let visibleRight= Math.min(barRight, scrollLeft+viewportWidth);
        let visibleWidth = visibleRight - visibleLeft;
        if(visibleWidth<=0){
            textEl.style.opacity="0";
            return;
        }
        textEl.style.opacity="1";
        let textWidth = textEl.offsetWidth;
        let textLeft = visibleLeft - barLeft + (visibleWidth-textWidth)/2;
        if(textLeft<5) textLeft=5;
        if(textLeft+textWidth>barWidth-5) textLeft=barWidth-textWidth-5;
        textEl.style.left= textLeft+"px";
    });
}

/*
    ---------------------------------------------------------------------------------------------
    RENDER HEADER => sticky
    ---------------------------------------------------------------------------------------------
*/
function renderHeader(){
    while(headerRow.children.length>1){
        headerRow.removeChild(headerRow.lastChild);
    }
    let {displayStart, displayEnd} = getDisplayRange();
    let totalWeeks = displayEnd-displayStart+1;
    if(totalWeeks<1)return;

    let monArr=[];
    for(let i=0; i<totalWeeks; i++){
        let abs = displayStart+i;
        let {year, week} = fromAbsoluteWeek(abs);
        let mIdx = getMonthFromYearWeek(year, week);
        monArr.push(mIdx);
    }

    for(let i=0; i<totalWeeks;i++){
        let abs=displayStart+i;
        let {year,week}=fromAbsoluteWeek(abs);
        let th = document.createElement("th");
        th.className="timescale-header";
        let m=monArr[i];
        th.textContent= `${year}-W${week} (${getMonthName(m)})`;
        th.style.width=cellWidth+"px";
        headerRow.appendChild(th);
    }

    // background gradient
    let colorStops=[];
    let pm = monArr[0]||0;
    let c1="#ffffff";
    let c2="#f0f0f0";
    let curColor=c1;
    let xLast=0;
    for(let i=0;i<=totalWeeks;i++){
        if(i===totalWeeks){
            let p=(i/totalWeeks)*100;
            colorStops.push(`${curColor} ${xLast}%`);
            colorStops.push(`${curColor} ${p}%`);
        } else {
            let mc=monArr[i];
            let p=(i/totalWeeks)*100;
            if(mc!==pm){
                colorStops.push(`${curColor} ${xLast}%`);
                colorStops.push(`${curColor} ${p}%`);
                curColor= (curColor===c1? c2:c1);
                xLast=p;
                pm=mc;
            }
        }
    }
    tableBody.style.background=`linear-gradient(to right, ${colorStops.join(",")})`;
}

/*
    ---------------------------------------------------------------------------------------------
    handleBarClickSelect
    ---------------------------------------------------------------------------------------------
*/
function handleBarClickSelect(bar,e){
    let multi=e.shiftKey||e.ctrlKey||e.metaKey;
    if(!multi){
        unselectAllBars();
        bar.selected=true;
    } else {
        bar.selected=!bar.selected;
    }
}

/*
    ---------------------------------------------------------------------------------------------
    RENDER TABLE
    ---------------------------------------------------------------------------------------------
*/
function renderTable(){
    renderHeader();
    tableBody.innerHTML="";
    clearHighlights();
    let {displayStart, displayEnd} = getDisplayRange();
    let totalWeeks= displayEnd-displayStart+1;
    if(totalWeeks<1)return;
    let lowerSearch = searchTerm.toLowerCase();

    // filtering lines
    let filteredLines = lines.filter(line=>{
        let linePass = (
            (!filters.line.name || (line.name && line.name.toLowerCase().includes(filters.line.name.toLowerCase()))) &&
            (!filters.line.discipline || (line.discipline && line.discipline.toLowerCase().includes(filters.line.discipline.toLowerCase()))) &&
            (!filters.line.experience || (line.experience && line.experience.toLowerCase().includes(filters.line.experience.toLowerCase()))) &&
            (!filters.line.officeLocation || (line.officeLocation && line.officeLocation.toLowerCase().includes(filters.line.officeLocation.toLowerCase()))) &&
            (!filters.line.geoLocation || (line.geoLocation && line.geoLocation.toLowerCase().includes(filters.line.geoLocation.toLowerCase()))) &&
            (!filters.line.type || (line.type && line.type.toLowerCase().includes(filters.line.type.toLowerCase())))
        );
        let barPass = line.bars.some(b=>{
            let pProj= (!filters.bar.projectName || (b.projectName && b.projectName.toLowerCase().includes(filters.bar.projectName.toLowerCase())));
            let pCl= (!filters.bar.client ||(b.client && b.client.toLowerCase().includes(filters.bar.client.toLowerCase())));
            let pDis=(!filters.bar.discipline ||(b.discipline && b.discipline.toLowerCase().includes(filters.bar.discipline.toLowerCase())));
            let pExp=(!filters.bar.experience ||(b.experience && b.experience.toLowerCase().includes(filters.bar.experience.toLowerCase())));
            let pLOE=(!filters.bar.LOE ||(b.LOE && b.LOE.toLowerCase().includes(filters.bar.LOE.toLowerCase())));
            let pLoc=(!filters.bar.location ||(b.location && b.location.toLowerCase().includes(filters.bar.location.toLowerCase())));
            let pType=(!filters.bar.type ||(b.type && b.type.toLowerCase().includes(filters.bar.type.toLowerCase())));
            let pProp=(!filters.bar.proposed ||(b.proposed && b.proposed.toLowerCase().includes(filters.bar.proposed.toLowerCase())));
            return (pProj && pCl && pDis && pExp && pLOE && pLoc && pType && pProp);
        });
        if(!linePass)return false;
        if(!barPass && line.bars.length>0)return false;

        // search
        if(lowerSearch){
            let lineMatch= (
                (line.name && line.name.toLowerCase().includes(lowerSearch))||
                (line.discipline && line.discipline.toLowerCase().includes(lowerSearch))||
                (line.experience && line.experience.toLowerCase().includes(lowerSearch))||
                (line.officeLocation && line.officeLocation.toLowerCase().includes(lowerSearch))||
                (line.geoLocation && line.geoLocation.toLowerCase().includes(lowerSearch))||
                (line.type && line.type.toLowerCase().includes(lowerSearch))
            );
            let barMatch= line.bars.some(b=>{
                let bFields=[
                    (b.label||"").toLowerCase(),
                    (b.projectName||"").toLowerCase(),
                    (b.client||"").toLowerCase(),
                    (b.discipline||"").toLowerCase(),
                    (b.experience||"").toLowerCase(),
                    (b.LOE||"").toLowerCase(),
                    (b.location||"").toLowerCase(),
                    (b.type||"").toLowerCase(),
                    (b.proposed||"").toLowerCase()
                ];
                return bFields.some(ff=>ff.includes(lowerSearch));
            });
            if(!lineMatch && !barMatch) return false;
        }
        return true;
    });

    mainFilteredLines=filteredLines;

    filteredLines.forEach((line,lineIndex)=>{
        let tr=document.createElement("tr");
        tr.className="gantt-row";
        if(line.selected)tr.classList.add("selected");
        if(line.dragging)tr.classList.add("drag-highlight");

        let nameTd= document.createElement("td");
        nameTd.className="name-cell";
        nameTd.addEventListener("mousedown", e=>onLineMouseDown(e,line,lineIndex));
        nameTd.addEventListener("contextmenu", e=>{
            e.preventDefault();
            showLineEditor(line,e.clientX,e.clientY);
        });
        let span=document.createElement("span");
        span.textContent=line.name;
        nameTd.appendChild(span);
        tr.appendChild(nameTd);

        let barTd=document.createElement("td");
        barTd.colSpan=totalWeeks;
        barTd.className="bar-cell";
        let barContainer=document.createElement("div");
        barContainer.className="bar-row-container";

        barContainer.addEventListener("contextmenu", e=>{
            // right-click blank => add bar if admin
            if(adminMode){
                if(!e.target.classList.contains("bar") &&
                   !e.target.classList.contains("bar-text") &&
                   !e.target.classList.contains("bar-handle"))
                {
                   e.preventDefault();
                   barCounter++;
                   let offsetX=e.offsetX;
                   let weeksFromStart=Math.floor(offsetX/cellWidth);
                   let {displayStart}=getDisplayRange();
                   let nb={
                       id:barCounter,
                       label:"",
                       projectName:"New Project",
                       client:"",
                       discipline:"",
                       experience:"",
                       LOE:"",
                       location:"",
                       proposed:"no",
                       type:"proposed",
                       startAbsWeek:displayStart+weeksFromStart,
                       length:4,
                       selected:false
                   };
                   line.bars.push(nb);
                   pushState();
                   renderTable();
                   saveToLocalStorage();
                }
            }
        });

        line.bars.forEach(bar=>{
            let barStart=bar.startAbsWeek;
            let barEnd=barStart+bar.length;
            let overlapStart=Math.max(displayStart, barStart);
            let overlapEnd=Math.min(displayEnd+1, barEnd);
            let overlapLen=overlapEnd-overlapStart;
            if(overlapLen<=0)return;

            let leftPx=(overlapStart-displayStart)*cellWidth;
            let widthPx=overlapLen*cellWidth;
            let barDiv=document.createElement("div");
            barDiv.classList.add("bar");
            if(bar.selected)barDiv.classList.add("selected");
            if(lowerSearch && bar.projectName.toLowerCase().includes(lowerSearch)){
                barDiv.classList.add("highlighted");
            }
            barDiv.style.left=leftPx+"px";
            barDiv.style.width=widthPx+"px";
            barDiv.style.backgroundColor=getColorFromType(bar.type);

            let textSpan=document.createElement("span");
            textSpan.className="bar-text";
            textSpan.textContent= bar.label || bar.projectName;
            barDiv.appendChild(textSpan);

            if(adminMode){
                let lh=document.createElement("div");
                lh.classList.add("bar-handle","left");
                let rh=document.createElement("div");
                rh.classList.add("bar-handle","right");
                barDiv.appendChild(lh);
                barDiv.appendChild(rh);
            }

            barDiv.addEventListener("contextmenu", e=>{
                e.preventDefault();
                showBarEditor(bar,line,e.clientX,e.clientY);
            });
            barDiv.addEventListener("click", e=>{
                e.stopPropagation();
                handleBarClickSelect(bar,e);
                renderTable();
                saveToLocalStorage();
            });
            barDiv.addEventListener("mousedown", e=> onBarMouseDown(e,line,bar,lineIndex));

            barContainer.appendChild(barDiv);
        });

        // overlap hatch
        let sortedBars=[...line.bars].sort((a,b)=>a.startAbsWeek-b.startAbsWeek);
        for(let i=0;i<sortedBars.length;i++){
            for(let j=i+1;j<sortedBars.length;j++){
                let b1=sortedBars[i];
                let b2=sortedBars[j];
                let s1=Math.max(displayStart, b1.startAbsWeek);
                let e1=Math.min(displayEnd+1, b1.startAbsWeek+b1.length);
                let s2=Math.max(displayStart, b2.startAbsWeek);
                let e2=Math.min(displayEnd+1, b2.startAbsWeek+b2.length);
                let overS=Math.max(s1,s2);
                let overE=Math.min(e1,e2);
                if(overE>overS){
                    let l=(overS-displayStart)*cellWidth;
                    let w=(overE-overS)*cellWidth;
                    let hatch=document.createElement("div");
                    hatch.className="overlap-hatch";
                    hatch.style.left=l+"px";
                    hatch.style.width=w+"px";
                    barContainer.appendChild(hatch);
                }
            }
        }

        barTd.appendChild(barContainer);
        tr.appendChild(barTd);
        tableBody.appendChild(tr);
    });

    updateBarTextPositions();
}

/*
    ---------------------------------------------------------------------------------------------
    onLineMouseDown => line reorder
    ---------------------------------------------------------------------------------------------
*/
function onLineMouseDown(e, line, lineIndex){
    dragging=true;
    dragType="line-reorder";
    draggingLine=line;
    line.dragging=true;
    lineOriginalIndex=lineIndex;
    tableBodyRect=tableBody.getBoundingClientRect();
    renderTable();
    e.preventDefault();
}

/*
    ---------------------------------------------------------------------------------------------
    onBarMouseDown => bar drag
    ---------------------------------------------------------------------------------------------
*/
function onBarMouseDown(e, line, bar, lineIndex){
    dragging=true;
    currentBar=bar;
    currentLine=line;
    dragStartX=e.clientX;
    dragStartY=e.clientY;
    barOriginalLineIndex=lineIndex;
    initialStartAbs=bar.startAbsWeek;
    initialLength=bar.length;
    tableBodyRect=tableBody.getBoundingClientRect();

    if(adminMode){
        if(e.target.classList.contains("bar-handle")){
            if(e.target.classList.contains("left")) dragType="resize-left";
            else dragType="resize-right";
        } else {
            dragType="bar-move-admin";
        }
    } else {
        dragType="bar-move-user";
        previousUserLineIndex=lineIndex;
    }
    e.preventDefault();
}

/*
    ---------------------------------------------------------------------------------------------
    DOCUMENT MOUSEMOVE => handle dragging
    ---------------------------------------------------------------------------------------------
*/
document.addEventListener("mousemove", e=>{
    if(!dragging)return;

    if(dragType==="line-reorder" && draggingLine){
        /* We want a fluid up/down re-org among visible lines. */
        let posY=e.clientY-tableBodyRect.top;
        let newIndex=Math.floor(posY/rowHeight);
        if(newIndex<0)newIndex=0;
        if(newIndex>=mainFilteredLines.length)newIndex=mainFilteredLines.length-1;

        let oldIndex= mainFilteredLines.indexOf(draggingLine);
        if(oldIndex<0)return;
        if(newIndex!==oldIndex){
            // remove from global lines, find target line in mainFilteredLines
            lines.splice(lines.indexOf(draggingLine),1);
            let targetLine= mainFilteredLines[newIndex];
            let targetGIdx = lines.indexOf(targetLine);
            if(targetGIdx<0) targetGIdx= lines.length;
            lines.splice(targetGIdx,0,draggingLine);
            renderTable();
        }
    }
    else if(dragType==="bar-move-admin" && currentBar){
        let dx=e.clientX-dragStartX;
        let dWeeks=Math.round(dx/cellWidth);
        currentBar.startAbsWeek=Math.max(0, initialStartAbs+dWeeks);

        let posY=e.clientY-tableBodyRect.top;
        let idxCur= mainFilteredLines.indexOf(currentLine);
        if(idxCur<0)idxCur=0;
        let newIdx=Math.floor(posY/rowHeight);
        if(newIdx<0)newIdx=0;
        if(newIdx>=mainFilteredLines.length)newIdx= mainFilteredLines.length-1;
        if(newIdx!==idxCur){
            currentLine.bars= currentLine.bars.filter(b=>b.id!==currentBar.id);
            mainFilteredLines[newIdx].bars.push(currentBar);
            currentLine= mainFilteredLines[newIdx];
        }
        renderTable();
    }
    else if(dragType==="resize-left" && currentBar){
        let dx=e.clientX-dragStartX;
        let dWeeks=Math.round(dx/cellWidth);
        let newStart=initialStartAbs+dWeeks;
        let newLen= initialStartAbs+initialLength - newStart;
        if(newLen<1){
            newLen=1;
            newStart= initialStartAbs+initialLength-1;
        }
        currentBar.startAbsWeek=Math.max(0,newStart);
        currentBar.length=newLen;
        renderTable();
    }
    else if(dragType==="resize-right" && currentBar){
        let dx=e.clientX-dragStartX;
        let dWeeks=Math.round(dx/cellWidth);
        let newLen= initialLength+dWeeks;
        if(newLen<1)newLen=1;
        currentBar.length=newLen;
        renderTable();
    }
    else if(dragType==="bar-move-user" && currentBar){
        let posY= e.clientY-tableBodyRect.top;
        let newIndex= Math.floor(posY/rowHeight);
        if(newIndex<0)newIndex=0;
        if(newIndex>= mainFilteredLines.length)newIndex= mainFilteredLines.length-1;
        if(newIndex!== previousUserLineIndex){
            mainFilteredLines[previousUserLineIndex].bars=
                mainFilteredLines[previousUserLineIndex].bars.filter(b=> b.id!== currentBar.id);
            mainFilteredLines[newIndex].bars.push(currentBar);
            previousUserLineIndex=newIndex;
            renderTable();
        }
    }
});

/*
    ---------------------------------------------------------------------------------------------
    DOCUMENT MOUSEUP => finalize drag
    ---------------------------------------------------------------------------------------------
*/
document.addEventListener("mouseup", e=>{
    if(!dragging)return;
    dragging=false;
    if(dragType==="line-reorder"){
        draggingLine.dragging=false;
        draggingLine=null;
        pushState();
        saveToLocalStorage();
        renderTable();
    } else if(["bar-move-admin","resize-left","resize-right"].includes(dragType)){
        currentBar=null;
        currentLine=null;
        pushState();
        saveToLocalStorage();
    } else if(dragType==="bar-move-user"){
        currentBar=null;
        currentLine=null;
        pushState();
        saveToLocalStorage();
    }
    dragType=null;
});

/*
    ---------------------------------------------------------------------------------------------
    DOCUMENT CLICK => unselect if blank
    ---------------------------------------------------------------------------------------------
*/
document.addEventListener("click", evt=>{
    if(!dragging){
        let nm= evt.target.closest(".name-cell");
        let br= evt.target.closest(".bar");
        if(!nm && !br){
            lines.forEach(l=> l.selected=false);
            unselectAllBars();
            renderTable();
            saveToLocalStorage();
        }
    }
});

/*
    ---------------------------------------------------------------------------------------------
    BAR EDITOR
    ---------------------------------------------------------------------------------------------
*/
function showBarEditor(bar,line,x,y){
    currentEditorBar=bar;
    currentEditorLine=line;

    barLabelInput.value = bar.label || "";
    barProjectNameInput.value = bar.projectName||"";
    barClientInput.value= bar.client||"";
    barDisciplineInput.value=bar.discipline||"";
    barExperienceInput.value= bar.experience||"";
    barLOEInput.value= bar.LOE||"";
    barLocationInput.value= bar.location||"";
    barTypeSelect.value= bar.type||"proposed";
    barProposedSelect.value= bar.proposed||"no";

    let {year:sy,week:sw} = fromAbsoluteWeek(bar.startAbsWeek);
    let {year:ey,week:ew} = fromAbsoluteWeek(bar.startAbsWeek+bar.length-1);
    startYearSelect.value=sy;
    startWeekSelect.value=sw;
    endYearSelect.value=ey;
    endWeekSelect.value=ew;

    let ro=!adminMode;
    barLabelInput.disabled=ro;
    barProjectNameInput.disabled=ro;
    barClientInput.disabled=ro;
    barDisciplineInput.disabled=ro;
    barExperienceInput.disabled=ro;
    barLOEInput.disabled=ro;
    barLocationInput.disabled=ro;
    barTypeSelect.disabled=ro;
    barProposedSelect.disabled=ro;
    startYearSelect.disabled=ro;
    startWeekSelect.disabled=ro;
    endYearSelect.disabled=ro;
    endWeekSelect.disabled=ro;
    barDeleteBtn.disabled=ro;

    barEditor.style.display="block";
    barEditor.style.left= (x+window.scrollX+10)+"px";
    barEditor.style.top= (y+window.scrollY+10)+"px";

    const autosave=()=>{
        if(!adminMode)return;
        bar.label= barLabelInput.value;
        bar.projectName= barProjectNameInput.value;
        bar.client= barClientInput.value;
        bar.discipline= barDisciplineInput.value;
        bar.experience= barExperienceInput.value;
        bar.LOE= barLOEInput.value;
        bar.location= barLocationInput.value;
        bar.type= barTypeSelect.value;
        bar.proposed= barProposedSelect.value;
        let sy=parseInt(startYearSelect.value);
        let sw=parseInt(startWeekSelect.value);
        let ey=parseInt(endYearSelect.value);
        let ew=parseInt(endWeekSelect.value);
        bar.startAbsWeek= toAbsoluteWeek(sy,sw);
        bar.length= toAbsoluteWeek(ey,ew)- bar.startAbsWeek+1;
        if(bar.length<1) bar.length=1;
        renderTable();
        saveToLocalStorage();
    };

    barLabelInput.oninput=autosave;
    barProjectNameInput.oninput=autosave;
    barClientInput.oninput=autosave;
    barDisciplineInput.oninput=autosave;
    barExperienceInput.oninput=autosave;
    barLOEInput.oninput=autosave;
    barLocationInput.oninput=autosave;
    barTypeSelect.onchange=autosave;
    barProposedSelect.onchange=autosave;
    startYearSelect.onchange=autosave;
    startWeekSelect.onchange=autosave;
    endYearSelect.onchange=autosave;
    endWeekSelect.onchange=autosave;
}

barEditorOkBtn.addEventListener("click", ()=>{
    barEditor.style.display="none";
    currentEditorBar=null;
    currentEditorLine=null;
    pushState();
});
barEditorCancelBtn.addEventListener("click", ()=>{
    barEditor.style.display="none";
    currentEditorBar=null;
    currentEditorLine=null;
    pushState();
});
barDeleteBtn.addEventListener("click", ()=>{
    if(!adminMode)return;
    if(!currentEditorBar||!currentEditorLine)return;
    currentEditorLine.bars= currentEditorLine.bars.filter(b=> b.id!== currentEditorBar.id);
    barEditor.style.display="none";
    currentEditorBar=null;
    currentEditorLine=null;
    pushState();
    renderTable();
    saveToLocalStorage();
});
document.addEventListener("mousedown", e=>{
    if(barEditor.style.display==="block"){
        let rect= barEditor.getBoundingClientRect();
        let inside= (
            e.clientX>=rect.left && e.clientX<=rect.right &&
            e.clientY>=rect.top && e.clientY<=rect.bottom
        );
        if(!inside){
            barEditor.style.display="none";
            currentEditorBar=null;
            currentEditorLine=null;
            pushState();
        }
    }
});

/*
    ---------------------------------------------------------------------------------------------
    LINE EDITOR
    ---------------------------------------------------------------------------------------------
*/
function showLineEditor(line,x,y){
    currentEditorLine=line;
    lineNameInput.value=line.name||"";
    lineDisciplineInput.value=line.discipline||"";
    lineExperienceInput.value=line.experience||"";
    lineOfficeLocationInput.value=line.officeLocation||"";
    lineGeoLocationInput.value=line.geoLocation||"";
    lineTypeInput.value=line.type||"";

    let ro=!adminMode;
    lineNameInput.disabled=ro;
    lineDisciplineInput.disabled=ro;
    lineExperienceInput.disabled=ro;
    lineOfficeLocationInput.disabled=ro;
    lineGeoLocationInput.disabled=ro;
    lineTypeInput.disabled=ro;
    lineDeleteBtn.disabled=ro;

    lineEditor.style.display="block";
    lineEditor.style.left= (x+window.scrollX+10)+"px";
    lineEditor.style.top= (y+window.scrollY+10)+"px";

    const autosaveLine=()=>{
        if(!adminMode)return;
        line.name=lineNameInput.value;
        line.discipline=lineDisciplineInput.value;
        line.experience=lineExperienceInput.value;
        line.officeLocation=lineOfficeLocationInput.value;
        line.geoLocation=lineGeoLocationInput.value;
        line.type=lineTypeInput.value;
        renderTable();
        saveToLocalStorage();
    };

    lineNameInput.oninput= autosaveLine;
    lineDisciplineInput.oninput= autosaveLine;
    lineExperienceInput.oninput= autosaveLine;
    lineOfficeLocationInput.oninput= autosaveLine;
    lineGeoLocationInput.oninput= autosaveLine;
    lineTypeInput.oninput= autosaveLine;
}

lineEditorOkBtn.addEventListener("click", ()=>{
    lineEditor.style.display="none";
    currentEditorLine=null;
    pushState();
});
lineEditorCancelBtn.addEventListener("click", ()=>{
    lineEditor.style.display="none";
    currentEditorLine=null;
    pushState();
});
lineDeleteBtn.addEventListener("click", ()=>{
    if(!adminMode)return;
    if(!currentEditorLine)return;
    lines= lines.filter(l=> l.id!== currentEditorLine.id);
    lineEditor.style.display="none";
    currentEditorLine=null;
    pushState();
    renderTable();
    saveToLocalStorage();
});
document.addEventListener("mousedown", e=>{
    if(lineEditor.style.display==="block"){
        let rect= lineEditor.getBoundingClientRect();
        let inside= (
            e.clientX>=rect.left && e.clientX<=rect.right &&
            e.clientY>=rect.top && e.clientY<=rect.bottom
        );
        if(!inside){
            lineEditor.style.display="none";
            currentEditorLine=null;
            pushState();
        }
    }
});

/*
    ---------------------------------------------------------------------------------------------
    FILTERS
    ---------------------------------------------------------------------------------------------
*/
filterBtn.addEventListener("click", ()=>{
    filterLineName.value= filters.line.name||"";
    filterLineDiscipline.value= filters.line.discipline||"";
    filterLineExperience.value= filters.line.experience||"";
    filterLineOfficeLocation.value= filters.line.officeLocation||"";
    filterLineGeoLocation.value= filters.line.geoLocation||"";
    filterLineType.value= filters.line.type||"";

    filterBarProjectName.value= filters.bar.projectName||"";
    filterBarClient.value= filters.bar.client||"";
    filterBarDiscipline.value= filters.bar.discipline||"";
    filterBarExperience.value= filters.bar.experience||"";
    filterBarLOE.value= filters.bar.LOE||"";
    filterBarLocation.value= filters.bar.location||"";
    filterBarType.value= filters.bar.type||"";
    filterBarProposed.value= filters.bar.proposed||"";

    filterModal.style.display="block";
});
filterApplyBtn.addEventListener("click", ()=>{
    filters.line.name= filterLineName.value.trim()||null;
    filters.line.discipline= filterLineDiscipline.value.trim()||null;
    filters.line.experience= filterLineExperience.value.trim()||null;
    filters.line.officeLocation= filterLineOfficeLocation.value.trim()||null;
    filters.line.geoLocation= filterLineGeoLocation.value.trim()||null;
    filters.line.type= filterLineType.value.trim()||null;

    filters.bar.projectName= filterBarProjectName.value.trim()||null;
    filters.bar.client= filterBarClient.value.trim()||null;
    filters.bar.discipline= filterBarDiscipline.value.trim()||null;
    filters.bar.experience= filterBarExperience.value.trim()||null;
    filters.bar.LOE= filterBarLOE.value.trim()||null;
    filters.bar.location= filterBarLocation.value.trim()||null;
    filters.bar.type= filterBarType.value.trim()||null;
    filters.bar.proposed= filterBarProposed.value.trim()||null;

    for(let k in filters.line){
        if(!filters.line[k]) delete filters.line[k];
    }
    for(let k in filters.bar){
        if(!filters.bar[k]) delete filters.bar[k];
    }
    filterModal.style.display="none";
    renderTable();
});
filterClearBtn.addEventListener("click", ()=>{
    filters.line={};
    filters.bar={};
    filterModal.style.display="none";
    renderTable();
});
filterCancelBtn.addEventListener("click", ()=>{
    filterModal.style.display="none";
});
document.addEventListener("mousedown", e=>{
    if(filterModal.style.display==="block"){
        let rect= filterModal.getBoundingClientRect();
        let inside= (
            e.clientX>=rect.left && e.clientX<=rect.right &&
            e.clientY>=rect.top && e.clientY<=rect.bottom
        );
        if(!inside){
            filterModal.style.display="none";
        }
    }
});

/*
    ---------------------------------------------------------------------------------------------
    SETTINGS
    ---------------------------------------------------------------------------------------------
*/
settingsBtn.addEventListener("click", ()=>{
    themeSelect.value= currentTheme;
    securedColor.value= typeColors.secured||"#28a745";
    proposedColor.value= typeColors.proposed||"#fd7e14";
    opportunityColor.value= typeColors.opportunity||"#dc3545";
    futureColor.value= typeColors.future||"#6f42c1";
    settingsModal.style.display="block";
});
settingsOkBtn.addEventListener("click", ()=>{
    currentTheme= themeSelect.value;
    typeColors.secured= securedColor.value;
    typeColors.proposed= proposedColor.value;
    typeColors.opportunity= opportunityColor.value;
    typeColors.future= futureColor.value;
    settingsModal.style.display="none";
    applyTheme();
});
settingsCancelBtn.addEventListener("click", ()=>{
    settingsModal.style.display="none";
});
document.addEventListener("mousedown", e=>{
    if(settingsModal.style.display==="block"){
        let rect= settingsModal.getBoundingClientRect();
        let inside=( e.clientX>=rect.left && e.clientX<=rect.right && e.clientY>=rect.top && e.clientY<=rect.bottom );
        if(!inside) settingsModal.style.display="none";
    }
});

/*
    ---------------------------------------------------------------------------------------------
    SEARCH
    ---------------------------------------------------------------------------------------------
*/
searchInput.addEventListener("input", ()=>{
    searchTerm= searchInput.value.trim();
    renderTable();
});

/*
    ---------------------------------------------------------------------------------------------
    ADD LINE => admin
    ---------------------------------------------------------------------------------------------
*/
addLineItemBtn.addEventListener("click", ()=>{
    if(!adminMode)return;
    lineCounter++;
    lines.push({
        id: lineCounter,
        name: "Line Item "+lineCounter,
        discipline: "",
        experience: "",
        officeLocation: "",
        geoLocation: "",
        type: "",
        bars: [],
        selected: false,
        dragging: false
    });
    pushState();
    renderTable();
    saveToLocalStorage();
});

/*
    ---------------------------------------------------------------------------------------------
    ADD BAR => admin
    ---------------------------------------------------------------------------------------------
*/
addBarBtn.addEventListener("click", e=>{
    if(!adminMode)return;
    e.stopPropagation();
    if(!lines.length){
        lineCounter=1;
        lines.push({
            id:1,
            name:"Line Item 1",
            discipline:"",
            experience:"",
            officeLocation:"",
            geoLocation:"",
            type:"",
            bars:[],
            selected:false,
            dragging:false
        });
    }
    barCounter++;
    let {displayStart}= getDisplayRange();
    let nb={
        id:barCounter,
        label:"",
        projectName:"New Project",
        client:"",
        discipline:"",
        experience:"",
        LOE:"",
        location:"",
        proposed:"no",
        type:"proposed",
        startAbsWeek:displayStart,
        length:4,
        selected:false
    };
    lines[lines.length-1].bars.push(nb);
    pushState();
    renderTable();
    saveToLocalStorage();
});

/*
    ---------------------------------------------------------------------------------------------
    EXPORT / IMPORT
    ---------------------------------------------------------------------------------------------
*/
exportJsonBtn.addEventListener("click", ()=>{
    let dataStr= JSON.stringify({
        lines,
        startYear,
        startWeek,
        endYear,
        endWeek,
        lineCounter,
        barCounter,
        cellWidth,
        rowHeight,
        typeColors,
        currentTheme
    },null,2);
    let blob= new Blob([dataStr], {type:"application/json"});
    let url=URL.createObjectURL(blob);
    let now=new Date();
    let dateStr= now.toISOString().replace(/[:.]/g,"-");
    let a=document.createElement("a");
    a.download="Gantt_"+dateStr+".json";
    a.href=url;
    a.click();
    URL.revokeObjectURL(url);
});
downloadCsvBtn.addEventListener("click", ()=>{
    let csv="Line ID,Line Name,Line Discipline,Line Experience,Line OfficeLocation,Line GeoLocation,Line Type,"+
            "Bar ID,Bar Label,Project Name,Client,Discipline,Experience,LOE,Location,Proposed,Type,"+
            "Start Year,Start Week,End Year,End Week,Duration (weeks)\n";
    lines.forEach(line=>{
        if(!line.bars.length){
            csv+= `${line.id||""},"${line.name||""}","${line.discipline||""}","${line.experience||""}","${line.officeLocation||""}","${line.geoLocation||""}","${line.type||""}",,,,,,,,,,,,\n`;
        } else {
            line.bars.forEach(bar=>{
                let {year:sy,week:sw} = fromAbsoluteWeek(bar.startAbsWeek);
                let {year:ey,week:ew} = fromAbsoluteWeek(bar.startAbsWeek + bar.length-1);
                csv+= `${line.id||""},"${line.name||""}","${line.discipline||""}","${line.experience||""}","${line.officeLocation||""}","${line.geoLocation||""}","${line.type||""}",`;
                csv+= `${bar.id||""},"${bar.label||""}","${bar.projectName||""}","${bar.client||""}","${bar.discipline||""}","${bar.experience||""}","${bar.LOE||""}","${bar.location||""}","${bar.proposed||""}","${bar.type||""}",`;
                csv+= `${sy},${sw},${ey},${ew},${bar.length}\n`;
            });
        }
    });
    let blob= new Blob([csv],{type:"text/csv;charset=utf-8;"});
    let url= URL.createObjectURL(blob);
    let a=document.createElement("a");
    a.download="gantt-data.csv";
    a.href=url;
    a.click();
    URL.revokeObjectURL(url);
});

importJsonBtn.addEventListener("click", ()=>{
    importFileInput.value="";
    importFileInput.click();
});
importFileInput.addEventListener("change", e=>{
    let file=e.target.files[0];
    if(!file)return;
    let reader=new FileReader();
    reader.onload= ev=>{
        try{
            let imported;
            if(file.name.endsWith(".json")){
                imported= JSON.parse(ev.target.result);
                lines= imported.lines||[];
                startYear= imported.startYear||startYear;
                startWeek= imported.startWeek||startWeek;
                endYear= imported.endYear||endYear;
                endWeek= imported.endWeek||endWeek;
                lineCounter= imported.lineCounter|| lineCounter;
                barCounter= imported.barCounter|| barCounter;
                cellWidth= imported.cellWidth|| cellWidth;
                rowHeight= imported.rowHeight|| rowHeight;
                typeColors= imported.typeColors|| typeColors;
                currentTheme= imported.currentTheme|| currentTheme;
                lines.forEach(l=>{
                    l.selected=false;
                    l.dragging=false;
                    l.bars.forEach(b=>{
                        b.selected=false;
                        if(b.type===undefined)b.type="proposed";
                        if(b.label===undefined)b.label="";
                    });
                });
            } else if(file.name.endsWith(".csv")){
                let parsed = parseCsv(ev.target.result);
                lines=parsed.lines;
                lineCounter=parsed.lineCounter;
                barCounter=parsed.barCounter;
            } else {
                throw new Error("Unsupported file type");
            }
            startYearInput.value= startYear;
            startWeekInput.value= startWeek;
            endYearInput.value= endYear;
            endWeekInput.value= endWeek;
            zoomSlider.value= cellWidth;
            heightZoomSlider.value= rowHeight;
            themeSelect.value= currentTheme;
            securedColor.value= typeColors.secured;
            proposedColor.value= typeColors.proposed;
            opportunityColor.value= typeColors.opportunity;
            futureColor.value= typeColors.future;
            updateCSSVariables();
            applyTheme();
            renderTable();
            saveToLocalStorage();
            alert("Import successful!");
        }catch(err){
            console.error(err);
            alert("Import failed: "+ err.message);
        }
    };
    reader.readAsText(file);
});
function parseCsv(csv){
    let rows= csv.trim().split("\n");
    let header= rows[0].toLowerCase();
    if(!header.includes("bar id")) throw new Error("Invalid CSV (no 'Bar ID' column).");
    let newLines=[];
    let lineMap={};
    let maxLineId=0;
    let maxBarId=0;

    for(let i=1;i<rows.length;i++){
        let row=rows[i].trim();
        if(!row)continue;
        let parsed=[];
        let field="";
        let inQuote=false;
        for(let c of row+","){
            if(c==='"') inQuote=!inQuote;
            else if(c==="," && !inQuote){
                parsed.push(field);
                field="";
            } else field+=c;
        }
        if(parsed.length<7) continue;
        let lineId=parseInt(parsed[0])||0;
        if(!lineMap[lineId]){
            lineMap[lineId]={
                id:lineId,
                name:(parsed[1]||""),
                discipline:(parsed[2]||""),
                experience:(parsed[3]||""),
                officeLocation:(parsed[4]||""),
                geoLocation:(parsed[5]||""),
                type:(parsed[6]||""),
                bars:[],
                selected:false,
                dragging:false
            };
            newLines.push(lineMap[lineId]);
            maxLineId=Math.max(maxLineId,lineId);
        }
        let barIdStr=parsed[7]||"";
        if(!barIdStr) continue;
        let barId=parseInt(barIdStr)||0;
        let barLabel=(parsed[8]||"");
        let barProj=(parsed[9]||"");
        let barClient=(parsed[10]||"");
        let barDisc=(parsed[11]||"");
        let barExp=(parsed[12]||"");
        let barLOE=(parsed[13]||"");
        let barLoc=(parsed[14]||"");
        let barProp=(parsed[15]||"no");
        let barType=(parsed[16]||"proposed");
        let sY= parseInt(parsed[17])||2025;
        let sW= parseInt(parsed[18])||1;
        let eY= parseInt(parsed[19])||2025;
        let eW= parseInt(parsed[20])||1;
        let dur= parseInt(parsed[21])||1;

        let startAbs= toAbsoluteWeek(sY,sW);
        let endAbs= toAbsoluteWeek(eY,eW);
        let length=endAbs- startAbs +1;
        if(length<1) length=dur||1;

        let newBar={
            id:barId,
            label: barLabel,
            projectName: barProj,
            client: barClient,
            discipline: barDisc,
            experience: barExp,
            LOE: barLOE,
            location: barLoc,
            proposed: barProp,
            type: barType,
            startAbsWeek: startAbs,
            length:length,
            selected:false
        };
        lineMap[lineId].bars.push(newBar);
        maxBarId=Math.max(maxBarId, barId);
    }
    return {lines:newLines, lineCounter:maxLineId, barCounter:maxBarId};
}

/*
    ---------------------------------------------------------------------------------------------
    PRINT
    ---------------------------------------------------------------------------------------------
*/
printBtn.addEventListener("click", ()=>{ window.print(); });

/*
    ---------------------------------------------------------------------------------------------
    ZOOM
    ---------------------------------------------------------------------------------------------
*/
zoomSlider.addEventListener("input", e=>{
    cellWidth=parseInt(e.target.value);
    pushState();
    updateCSSVariables();
    renderTable();
    saveToLocalStorage();
});
heightZoomSlider.addEventListener("input", e=>{
    rowHeight=parseInt(e.target.value);
    pushState();
    updateCSSVariables();
    renderTable();
    saveToLocalStorage();
});

/*
    ---------------------------------------------------------------------------------------------
    HISTORY (UNDO/REDO)
    ---------------------------------------------------------------------------------------------
*/
function pushState(){
    let st= JSON.parse(JSON.stringify({
        lines,
        startYear,
        startWeek,
        endYear,
        endWeek,
        lineCounter,
        barCounter,
        cellWidth,
        rowHeight,
        typeColors,
        currentTheme
    }));
    undoStack.push(st);
    redoStack=[];
}
function restoreState(st){
    lines= st.lines;
    startYear= st.startYear;
    startWeek= st.startWeek;
    endYear= st.endYear;
    endWeek= st.endWeek;
    lineCounter= st.lineCounter;
    barCounter= st.barCounter;
    cellWidth= st.cellWidth;
    rowHeight= st.rowHeight;
    typeColors= st.typeColors;
    currentTheme= st.currentTheme;
    updateCSSVariables();
    applyTheme();
    renderTable();
    saveToLocalStorage();
}
function undo(){
    if(!adminMode)return;
    if(undoStack.length<2)return;
    let cur=undoStack.pop();
    redoStack.push(cur);
    let prev=undoStack[undoStack.length-1];
    restoreState(prev);
}
function redo(){
    if(!adminMode)return;
    if(!redoStack.length)return;
    let nxt=redoStack.pop();
    let cur= JSON.parse(JSON.stringify({
        lines,
        startYear,
        startWeek,
        endYear,
        endWeek,
        lineCounter,
        barCounter,
        cellWidth,
        rowHeight,
        typeColors,
        currentTheme
    }));
    undoStack.push(cur);
    restoreState(nxt);
}
document.getElementById("undoBtn").addEventListener("click", ()=>undo());
document.getElementById("redoBtn").addEventListener("click", ()=>redo());

/*
    ---------------------------------------------------------------------------------------------
    HELP
    ---------------------------------------------------------------------------------------------
*/
document.getElementById("helpBtn").addEventListener("click", ()=>{
    alert(`Gantt Planner - Additional Help:

 Enhanced Line Drag & Drop:
  - Grab any line item from the left name cell and drag it up/down. It aligns with visible rows.

 Additional Gridlines:
  - Vertical and horizontal black grid lines ensure easy alignment of weeks, columns, and bars.

 Bar Label, Re-organized Editor:
  - "Bar Label" input field is now first. Then follows the other attributes.

 Sticky Date Headers:
  - The header row with year/week/month stays in view even when scrolling down.

 Additional bar attribute "label" is now fully integrated.

Enjoy your Gantt Planner!
`);
});

/*
    ---------------------------------------------------------------------------------------------
    ADMIN TOGGLE
    ---------------------------------------------------------------------------------------------
*/
adminToggleBtn.addEventListener("click", ()=>{
    if(!adminMode){
        let pwd= prompt("Enter admin password:");
        if(pwd==="Password"){
            adminMode=true;
            alert("Admin mode enabled.");
        } else {
            alert("Incorrect password. Remaining in user mode.");
            return;
        }
    } else {
        adminMode=false;
        alert("Admin mode disabled.");
    }
    csvEditToggleBtn.style.display= adminMode?"inline-block":"none";
    renderTable();
});

/*
    ---------------------------------------------------------------------------------------------
    CSV EDIT
    ---------------------------------------------------------------------------------------------
*/
csvEditToggleBtn.addEventListener("click", ()=>{
    if(!adminMode)return;
    let csvStr= "Line ID,Line Name,Line Discipline,Line Experience,Line OfficeLocation,Line GeoLocation,Line Type,"+
                "Bar ID,Bar Label,Project Name,Client,Discipline,Experience,LOE,Location,Proposed,Type,"+
                "Start Year,Start Week,End Year,End Week,Duration (weeks)\n";
    lines.forEach(line=>{
        if(!line.bars.length){
            csvStr+=`${line.id||""},"${line.name||""}","${line.discipline||""}","${line.experience||""}","${line.officeLocation||""}","${line.geoLocation||""}","${line.type||""}",,,,,,,,,,,,\n`;
        } else {
            line.bars.forEach(bar=>{
                let {year:sy,week:sw}= fromAbsoluteWeek(bar.startAbsWeek);
                let {year:ey,week:ew}= fromAbsoluteWeek(bar.startAbsWeek+bar.length-1);
                csvStr+=`${line.id||""},"${line.name||""}","${line.discipline||""}","${line.experience||""}","${line.officeLocation||""}","${line.geoLocation||""}","${line.type||""}",`;
                csvStr+=`${bar.id||""},"${bar.label||""}","${bar.projectName||""}","${bar.client||""}","${bar.discipline||""}","${bar.experience||""}","${bar.LOE||""}","${bar.location||""}","${bar.proposed||""}","${bar.type||""}",`;
                csvStr+=`${sy},${sw},${ey},${ew},${bar.length}\n`;
            });
        }
    });
    csvTextarea.value=csvStr;
    csvEditModal.style.display="block";
});
csvEditApplyBtn.addEventListener("click", ()=>{
    if(!adminMode)return;
    let csvData= csvTextarea.value;
    try{
        let parsed = parseCsv(csvData);
        lines=parsed.lines;
        lineCounter=parsed.lineCounter;
        barCounter=parsed.barCounter;
        pushState();
        renderTable();
        saveToLocalStorage();
        alert("CSV updated successfully.");
        csvEditModal.style.display="none";
    } catch(err){
        alert("Error parsing CSV: "+err.message);
    }
});
csvEditCancelBtn.addEventListener("click", ()=>{
    csvEditModal.style.display="none";
});
document.addEventListener("mousedown", e=>{
    if(csvEditModal.style.display==="block"){
        let rect= csvEditModal.getBoundingClientRect();
        let inside= (
            e.clientX>=rect.left && e.clientX<=rect.right &&
            e.clientY>=rect.top && e.clientY<=rect.bottom
        );
        if(!inside){
            csvEditModal.style.display="none";
        }
    }
});

/*
    ---------------------------------------------------------------------------------------------
    APPLY TIMESCALE
    ---------------------------------------------------------------------------------------------
*/
applyTimescaleBtn.addEventListener("click", ()=>{
    startYear= parseInt(startYearInput.value)||2025;
    startWeek= parseInt(startWeekInput.value)||1;
    endYear= parseInt(endYearInput.value)||2025;
    endWeek= parseInt(endWeekInput.value)||52;
    pushState();
    renderTable();
    saveToLocalStorage();
});

/*
    ---------------------------------------------------------------------------------------------
    INIT
    ---------------------------------------------------------------------------------------------
*/
function init(){
    loadFromLocalStorage();
    populateDateSelects();
    updateCSSVariables();
    startYearInput.value= startYear;
    startWeekInput.value= startWeek;
    endYearInput.value= endYear;
    endWeekInput.value= endWeek;
    zoomSlider.value= cellWidth;
    heightZoomSlider.value= rowHeight;
    themeSelect.value= currentTheme;
    securedColor.value= typeColors.secured;
    proposedColor.value= typeColors.proposed;
    opportunityColor.value= typeColors.opportunity;
    futureColor.value= typeColors.future;
    applyTheme();
    renderTable();
    pushState();
    csvEditToggleBtn.style.display="none";
    tableWrapper.addEventListener("scroll", ()=> updateBarTextPositions());
    window.addEventListener("resize", ()=> updateBarTextPositions());
}
window.addEventListener("load", init);

function populateDateSelects(){
    let years=[];
    for(let y=2023;y<=2030;y++){
        years.push(y);
    }
    let weeks=[];
    for(let w=1;w<=52;w++){
        weeks.push(w);
    }
    [startYearSelect,endYearSelect].forEach(sel=>{
        sel.innerHTML="";
        years.forEach(Y=>{
            let opt=document.createElement("option");
            opt.value=Y;
            opt.textContent=Y;
            sel.appendChild(opt);
        });
    });
    [startWeekSelect,endWeekSelect].forEach(sel=>{
        sel.innerHTML="";
        weeks.forEach(W=>{
            let opt=document.createElement("option");
            opt.value=W;
            opt.textContent=W;
            sel.appendChild(opt);
        });
    });
}
</script>
</body>
</html>
