<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Character set: Declares UTF-8 encoding to prevent garbled text -->
  <meta charset="UTF-8" />
  <!-- Page Title: Shown in browser tab -->
  <title>Advanced Gantt Chart</title>
  <!-- Bootstrap 5 CSS via CDN: Loads grid, navbar, modals, buttons -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
  />
  <style>
    /* Remove default body margin, set font: Resets margin, sets default font */
    body {
      margin: 0;
      font-family: Arial, sans-serif;
    }

    /* Navbar: Sticky at top, always visible */
    .navbar {
      position: sticky;
      height: 150px;
      top: 0;
      z-index: 1000;
      background-color: #f8f9fa;
      padding: 0.5rem 1rem;
    }

    /* Main container: Full width with padding */
    .gantt-container {
      margin: 0 1rem;
      position: relative;
    }

    /* Cohesive table: Native HTML table for perfect alignment */
    #ganttTable {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed; /* Ensures column widths remain consistent */
    }

    /* Header row: Sticky top */
    #ganttTable thead th {
      position: sticky;
      top: 0px; /* Below navbar */
      background-color: #f8f9fa;
      z-index: 10;
      border-bottom: 1px solid #dee2e6;
      text-align: center;
      font-size: 0.9rem;
      padding: 4px 8px;
      box-sizing: border-box;
    }

    /* Name header: Fixed width, explicit background */
    #nameHeader {
      width: 240px;
      text-align: center;
      height: 100%;
      font-weight: bold;
      background-color: #f8f9fa;
      border-right: 1px solid #dee2e6;
      z-index: 11;
    }

    /* Timescale headers: Dynamic width */
    .timescale-header {
      background-color: #e9ecef;
      border-right: 1px solid #dee2e6;
      min-width: 50px;
    }

    /* Table body: Single clean grid using CSS variables */
    #ganttTable tbody {
      background-image: 
        linear-gradient(to right, rgba(0,0,0,0.1) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(0,0,0,0.1) 1px, transparent 1px);
      background-size: var(--cell-width) var(--row-height);
      background-repeat: repeat;
    }

    /* Row: Dynamic height via CSS variable */
    .gantt-row {
      height: var(--row-height);
    }

    /* Selected row: Highlight background */
    .gantt-row.selected {
      background-color: #fff3cd;
    }

    /* Name cell: Sticky left, white background covering full row height, 
       use flex to center content both vertically and horizontally */
    .name-cell {
      position: sticky;
      left: 0;
      background: white;
      z-index: 9;
      width: 240px;
      border-right: 1px solid #dee2e6;
      display: flex;
      flex-direction: column;
      justify-content: center; /* Vertically center content */
      align-items: center;     /* Horizontally center content */
      padding: 0 8px;
      box-sizing: border-box;
    }

    /* Name cell content wrapper: (we can keep if we want to further structure, or done via parent) */
    .name-cell-content {
      display: flex;
      align-items: center;
      width: 100%;
    }

    /* (REMOVE or comment out the old remove-line-btn since we no longer use the X) */

    /* Line item input: Transparent, editable, centered vertically */
    .line-item-input {
      flex: 1;
      border: none;
      outline: none;
      background-color: transparent;
      font-weight: 500;
      height: 100%;
    }
    .line-item-input:focus {
      outline: 1px solid #ccc;
    }

    /* Bar container cell: Relative for absolute bars */
    .bar-cell {
      position: relative;
      border-right: 1px solid #dee2e6;
      padding: 0;
    }

    /* Full row bar container: Flex centering for perfect vertical alignment */
    .bar-row-container {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center; /* Centers bars and hatches vertically */
    }

    /* Bar: Absolute positioned, centered via flex parent */
    .bar {
      position: absolute;
      height: calc(var(--row-height) - 16px);
      top: auto;
      left: 0;
      border-radius: 4px;
      color: #fff;
      cursor: move;
      user-select: none;
      opacity: 0.7;
      overflow: hidden;
      z-index: 0;
      box-sizing: border-box;
      margin-top: 0;
      margin-bottom: 0;
    }
    .bar.selected {
      outline: 2px solid #ffc107;
    }
    .bar.highlighted {
      outline: 3px solid #0d6efd;
      opacity: 0.9;
    }

    /* Bar text: Centered in visible portion, vertically centered */
    .bar-text {
      position: absolute;
      top: 0;
      height: 100%;
      line-height: calc(var(--row-height) - 16px);
      white-space: nowrap;
      pointer-events: none;
      font-weight: 500;
      padding: 0 8px;
    }

    /* Resize handles: Full height of bar */
    .bar-handle {
      position: absolute;
      top: 0;
      width: 6px;
      height: 100%;
      cursor: col-resize;
      background-color: rgba(255,255,255,0.4);
      z-index: 2;
    }
    .bar-handle.left {
      left: 0;
      border-radius: 4px 0 0 4px;
    }
    .bar-handle.right {
      right: 0;
      border-radius: 0 4px 4px 0;
    }

    /* Overlap hatch: Centered vertically like bars */
    .overlap-hatch {
      position: absolute;
      height: calc(var(--row-height) - 16px);
      top: auto;
      background: repeating-linear-gradient(
        45deg,
        red,
        red 2px,
        transparent 2px,
        transparent 4px
      );
      opacity: 0.5;
      pointer-events: none;
      z-index: 1;
      margin-top: 0;
      margin-bottom: 0;
    }

    /* Scrollable area: Enables horizontal/vertical scroll */
    .table-wrapper {
      overflow: auto;
      max-height: calc(100vh - 96px);
    }

    /* Editor overlay */
    #barEditor {
      position: absolute;
      display: none;
      background: #fff;
      border: 1px solid #ccc;
      padding: 12px;
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      z-index: 999;
      min-width: 280px;
    }
    #barEditor label {
      display: block;
      margin-top: 8px;
      font-weight: 500;
    }
    #barEditor input, #barEditor select {
      margin-top: 4px;
      width: 100%;
    }
    #barEditorActions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 12px;
    }

    /* Line editor overlay (new for line attributes) */
    #lineEditor {
      position: absolute;
      display: none;
      background: #fff;
      border: 1px solid #ccc;
      padding: 12px;
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      z-index: 999;
      min-width: 280px;
    }
    #lineEditor label {
      display: block;
      margin-top: 8px;
      font-weight: 500;
    }
    #lineEditor input {
      margin-top: 4px;
      width: 100%;
    }
    #lineEditorActions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 12px;
    }

    /* Filter modal (new for filtering) */
    #filterModal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      border: 1px solid #ccc;
      padding: 20px;
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      z-index: 999;
      min-width: 300px;
    }
    #filterModal h3 {
      margin-top: 0;
    }
    #filterModal label {
      display: block;
      margin-top: 8px;
    }
    #filterModal input {
      width: 100%;
      margin-top: 4px;
    }
    #filterActions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 12px;
    }

    /* Settings modal (new for theme) */
    #settingsModal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      border: 1px solid #ccc;
      padding: 20px;
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      z-index: 999;
      min-width: 300px;
    }
    #settingsModal h3 {
      margin-top: 0;
    }
    #settingsModal label {
      display: block;
      margin-top: 8px;
    }
    #settingsActions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 12px;
    }
    .color-picker {
      width: 60px;
      height: 30px;
      padding: 0;
      border: none;
      cursor: pointer;
    }

    /* Dark theme styles */
    body.dark-theme {
      background-color: #212529;
      color: #f8f9fa;
    }
    body.dark-theme .navbar {
      background-color: #343a40 !important;
    }
    body.dark-theme #ganttTable thead th,
    body.dark-theme .timescale-header {
      background-color: #495057;
      color: #f8f9fa;
    }
    body.dark-theme .name-cell {
      background: #343a40;
      color: #f8f9fa;
    }
    body.dark-theme .bar-text {
      color: #212529;
    }
    body.dark-theme #barEditor,
    body.dark-theme #lineEditor,
    body.dark-theme #filterModal,
    body.dark-theme #settingsModal {
      background: #343a40;
      color: #f8f9fa;
      border: 1px solid #495057;
    }
    body.dark-theme input,
    body.dark-theme select {
      background: #495057;
      color: #f8f9fa;
      border: 1px solid #6c757d;
    }

    /* Zoom sliders: Enhanced visibility */
    .zoom-slider {
      width: 120px;
      margin: 0 8px;
      height: 8px;
      border-radius: 4px;
      background: #ced4da;
      outline: none;
      -webkit-appearance: none;
      box-shadow: 0 2px 6px rgba(0,0,0,0.25);
    }
    .zoom-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #0d6efd;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    .zoom-slider::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #0d6efd;
      cursor: pointer;
      border: none;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    #heightZoomSlider {
      transform: rotate(-90deg);
      width: 100px;
    }

    /* Legend */
    #statusLegend {
      display: flex;
      gap: 12px;
      align-items: center;
      font-size: 0.85rem;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .legend-swatch {
      width: 16px;
      height: 16px;
      border-radius: 3px;
    }

    /* Toolbar groups */
    .toolbar-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0 0.75rem;
      border-left: 1px solid #dee2e6;
    }
    .toolbar-group:first-child {
      border-left: none;
      padding-left: 0;
    }
    .toolbar-group:last-child {
      padding-right: 0;
    }

    /* Search input in toolbar */
    #searchInput {
      width: 180px;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      #nameHeader, .name-cell {
        width: 180px;
      }
      .zoom-slider {
        width: 100px;
      }
      .toolbar-group {
        padding: 0 0.5rem;
      }
      #searchInput {
        width: 120px;
      }
    }

    /* Hidden import */
    #importFileInput {
      display: none;
    }

    /* Help button */
    #helpBtn {
      cursor: pointer;
      transition: transform 0.2s;
    }
    #helpBtn:hover {
      transform: scale(1.1);
    }

    /* Settings button */
    #settingsBtn {
      cursor: pointer;
      transition: transform 0.2s;
    }
    #settingsBtn:hover {
      transform: scale(1.1);
    }

    /* Stats */
    #statsDisplay {
      font-size: 0.9rem;
      color: #555;
    }

    /* Print styles */
    @media print {
      .navbar, #barEditor, #lineEditor, #filterModal, #settingsModal {
        display: none !important;
      }
      .table-wrapper {
        overflow: visible;
        max-height: none;
      }
      #ganttTable {
        font-size: 10pt;
      }
    }
  </style>
</head>

<body>
  <!-- Sticky navbar with compartmentalized groups -->
  <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
      <!-- Brand -->
      <a class="navbar-brand" href="#">Gantt Planner</a>
      <!-- Toggler -->
      <button class="navbar-toggler" 
              type="button" 
              data-bs-toggle="collapse" 
              data-bs-target="#navbarSupportedContent"
              aria-controls="navbarSupportedContent"
              aria-expanded="false"
              aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <!-- Collapsible content -->
      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <!-- Group 1: Timescale controls -->
        <div class="toolbar-group">
          <label for="startYearInput" class="form-label m-0">Start Y:</label>
          <input id="startYearInput" type="number" class="form-control form-control-sm" value="2025" style="width:72px;" />
          <label for="startWeekInput" class="form-label m-0">Wk:</label>
          <input id="startWeekInput" type="number" class="form-control form-control-sm" value="1" style="width:50px;" />
          <label for="endYearInput" class="form-label m-0">End Y:</label>
          <input id="endYearInput" type="number" class="form-control form-control-sm" value="2025" style="width:72px;" />
          <label for="endWeekInput" class="form-label m-0">Wk:</label>
          <input id="endWeekInput" type="number" class="form-control form-control-sm" value="52" style="width:50px;" />
          <button id="applyTimescaleBtn" type="button" class="btn btn-secondary btn-sm">Apply</button>
        </div>

        <!-- Group 2: Stats and Legend -->
        <div class="toolbar-group">
          <div id="statsDisplay" class="d-flex align-items-center">
            Lines: <span id="lineCount">0</span> | Bars: <span id="barCount">0</span>
          </div>
          <div id="statusLegend" class="d-flex align-items-center">
            <div class="legend-item"><div class="legend-swatch" style="background:#28a745;"></div><span>Secured</span></div>
            <div class="legend-item"><div class="legend-swatch" style="background:#fd7e14;"></div><span>Proposed</span></div>
            <div class="legend-item"><div class="legend-swatch" style="background:#dc3545;"></div><span>Opportunity</span></div>
            <div class="legend-item"><div class="legend-swatch" style="background:#6f42c1;"></div><span>Future</span></div>
          </div>
        </div>

        <!-- Group 3: Zoom controls -->
        <div class="toolbar-group">
          <label for="zoomSlider" class="form-label m-0 me-2">H-Zoom:</label>
          <input type="range" class="zoom-slider" id="zoomSlider" min="50" max="300" value="150" step="10">
          <label for="heightZoomSlider" class="form-label m-0 me-2">V-Zoom:</label>
          <input type="range" class="zoom-slider" id="heightZoomSlider" min="30" max="100" value="40" step="5">
        </div>

        <!-- Group 4: UNDO/REDO buttons + Search and actions -->
        <div class="toolbar-group">
          <!-- Undo/Redo buttons -->
          <button id="undoBtn" type="button" class="btn btn-sm btn-success">Undo</button>
          <button id="redoBtn" type="button" class="btn btn-sm btn-warning">Redo</button>
          <!-- Search input for dynamic filter -->
          <input type="text" id="searchInput" class="form-control form-control-sm" placeholder="Filter lines/bars..." />
        </div>

        <!-- Group 5: Action buttons and help/settings -->
        <div class="toolbar-group ms-auto">
          <button id="addLineItemBtn" class="btn btn-primary btn-sm">Add Line</button>
          <button id="addBarBtn" class="btn btn-secondary btn-sm">Add Bar</button>
          <button id="filterBtn" class="btn btn-outline-primary btn-sm">Filter</button>
          <button id="importJsonBtn" class="btn btn-outline-success btn-sm">Import</button>
          <button id="exportJsonBtn" class="btn btn-outline-info btn-sm">Export JSON</button>
          <button id="downloadCsvBtn" class="btn btn-outline-secondary btn-sm">Export CSV</button>
          <button id="printBtn" class="btn btn-outline-dark btn-sm">Print/PDF</button>
          <svg id="settingsBtn" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 0 0 .12-.61l-1.92-3.32a.488.488 0 0 0-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 0 0-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96a.488.488 0 0 0-.59.22l-1.92 3.32c-.14.24-.08.54.12.61l2.03 1.58c-.05.3-.09.63-.09.94 0 .31.04.64.07.94l-2.03 1.58a.49.49 0 0 0-.12.61l1.92 3.32c.14.24.37.34.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .43-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.45 0 .59-.22l1.92-3.32c.14-.24.08-.54-.12-.61l-2.03-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6 0-1.98 1.62-3.6 3.6-3.6 1.98 0 3.6 1.62 3.6 3.6 0 1.98-1.62 3.6-3.6 3.6z" fill="#0d6efd"/>
          </svg>
          <svg id="helpBtn" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 14.5v.5h-2v-1c0-1.11.45-2.11 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z" fill="#0d6efd"/>
          </svg>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main cohesive table -->
  <div class="gantt-container">
    <div class="table-wrapper">
      <table id="ganttTable">
        <thead>
          <tr id="headerRow">
            <th id="nameHeader">Tasks</th>
            <!-- Timescale headers injected here -->
          </tr>
        </thead>
        <tbody id="tableBody">
          <!-- Rows injected here -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Bar editor -->
  <div id="barEditor">
    <label for="barTextInput">Bar Text:</label>
    <input type="text" id="barTextInput" placeholder="Bar text..." />
    <label for="barStatusSelect">Status:</label>
    <select id="barStatusSelect">
      <option value="secured">Secured</option>
      <option value="proposed">Proposed</option>
      <option value="opportunity">Opportunity</option>
      <option value="future">Future</option>
    </select>
    <label for="startYearSelect">Start Year:</label>
    <select id="startYearSelect"></select>
    <label for="startWeekSelect">Start Week:</label>
    <select id="startWeekSelect"></select>
    <label for="endYearSelect">End Year:</label>
    <select id="endYearSelect"></select>
    <label for="endWeekSelect">End Week:</label>
    <select id="endWeekSelect"></select>
    <div id="barEditorActions">
      <button id="barDeleteBtn" class="btn btn-sm btn-danger">Delete Bar</button>
      <button id="barEditorOkBtn" class="btn btn-sm btn-primary">OK</button>
      <button id="barEditorCancelBtn" class="btn btn-sm btn-secondary">Cancel</button>
    </div>
  </div>

  <!-- Line editor (new popup for line attributes) -->
  <div id="lineEditor">
    <label for="lineNameInput">Name:</label>
    <input type="text" id="lineNameInput" placeholder="Name..." />
    <label for="lineClientInput">Client:</label>
    <input type="text" id="lineClientInput" placeholder="Client..." />
    <label for="lineDisciplineInput">Discipline:</label>
    <input type="text" id="lineDisciplineInput" placeholder="Discipline..." />
    <label for="lineExperienceInput">Experience:</label>
    <input type="text" id="lineExperienceInput" placeholder="Experience..." />
    <label for="lineLocationInput">Location:</label>
    <input type="text" id="lineLocationInput" placeholder="Location..." />
    <label for="lineCustom1Input">Custom1:</label>
    <input type="text" id="lineCustom1Input" placeholder="Custom1..." />
    <label for="lineCustom2Input">Custom2:</label>
    <input type="text" id="lineCustom2Input" placeholder="Custom2..." />
    <label for="lineCustom3Input">Custom3:</label>
    <input type="text" id="lineCustom3Input" placeholder="Custom3..." />
    <div id="lineEditorActions">
      <!-- "Delete Line Item" button to avoid accidental line deletions -->
      <button id="lineDeleteBtn" class="btn btn-sm btn-danger">Delete Line Item</button>
      <button id="lineEditorOkBtn" class="btn btn-sm btn-primary">OK</button>
      <button id="lineEditorCancelBtn" class="btn btn-sm btn-secondary">Cancel</button>
    </div>
  </div>

  <!-- Filter modal (new for filtering) -->
  <div id="filterModal">
    <h3>Filter Lines</h3>
    <label for="filterClient">Client:</label>
    <input type="text" id="filterClient" placeholder="Client..." />
    <label for="filterDiscipline">Discipline:</label>
    <input type="text" id="filterDiscipline" placeholder="Discipline..." />
    <label for="filterExperience">Experience:</label>
    <input type="text" id="filterExperience" placeholder="Experience..." />
    <label for="filterLocation">Location:</label>
    <input type="text" id="filterLocation" placeholder="Location..." />
    <label for="filterCustom1">Custom1:</label>
    <input type="text" id="filterCustom1" placeholder="Custom1..." />
    <label for="filterCustom2">Custom2:</label>
    <input type="text" id="filterCustom2" placeholder="Custom2..." />
    <label for="filterCustom3">Custom3:</label>
    <input type="text" id="filterCustom3" placeholder="Custom3..." />
    <div id="filterActions">
      <button id="filterApplyBtn" class="btn btn-sm btn-primary">Apply</button>
      <button id="filterClearBtn" class="btn btn-sm btn-secondary">Clear</button>
      <button id="filterCancelBtn" class="btn btn-sm btn-secondary">Cancel</button>
    </div>
  </div>

  <!-- Settings modal (new for theme customization) -->
  <div id="settingsModal">
    <h3>Theme Settings</h3>
    <label>Theme:</label>
    <select id="themeSelect">
      <option value="light">Light</option>
      <option value="dark">Dark</option>
    </select>
    <label for="securedColor">Secured Color:</label>
    <input type="color" id="securedColor" class="color-picker" value="#28a745" />
    <label for="proposedColor">Proposed Color:</label>
    <input type="color" id="proposedColor" class="color-picker" value="#fd7e14" />
    <label for="opportunityColor">Opportunity Color:</label>
    <input type="color" id="opportunityColor" class="color-picker" value="#dc3545" />
    <label for="futureColor">Future Color:</label>
    <input type="color" id="futureColor" class="color-picker" value="#6f42c1" />
    <div id="settingsActions">
      <button id="settingsOkBtn" class="btn btn-sm btn-primary">Apply</button>
      <button id="settingsCancelBtn" class="btn btn-sm btn-secondary">Cancel</button>
    </div>
  </div>

  <!-- Hidden import -->
  <input type="file" id="importFileInput" accept=".json,.csv" />

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ---------------------------------------------------------------------------------------------
    // Status colors: Map status to hex (customizable)
    // ---------------------------------------------------------------------------------------------
    let statusColors = {
      secured: "#28a745",
      proposed: "#fd7e14",
      opportunity: "#dc3545",
      future: "#6f42c1"
    };

    // ---------------------------------------------------------------------------------------------
    // Sample data: Initial lines and bars with new attributes
    // ---------------------------------------------------------------------------------------------
    let lines = [
      {
        id: 1,
        name: "Line Item 1",
        client: "",
        discipline: "",
        experience: "",
        location: "",
        custom1: "",
        custom2: "",
        custom3: "",
        bars: [
          {
            id: 101,
            text: "Bar A",
            status: "secured",
            startAbsWeek: toAbsoluteWeek(2025, 2),
            length: 4,
            selected: false,
          },
        ],
        selected: false
      },
      {
        id: 2,
        name: "Line Item 2",
        client: "",
        discipline: "",
        experience: "",
        location: "",
        custom1: "",
        custom2: "",
        custom3: "",
        bars: [
          {
            id: 102,
            text: "Bar B",
            status: "proposed",
            startAbsWeek: toAbsoluteWeek(2025, 10),
            length: 7,
            selected: false,
          },
        ],
        selected: false
      },
    ];

    // ---------------------------------------------------------------------------------------------
    // Timescale defaults
    // ---------------------------------------------------------------------------------------------
    let startYear = 2025;
    let startWeek = 1;
    let endYear = 2025;
    let endWeek = 52;

    // ---------------------------------------------------------------------------------------------
    // Counters for unique IDs
    // ---------------------------------------------------------------------------------------------
    let lineCounter = 2;
    let barCounter = 102;

    // ---------------------------------------------------------------------------------------------
    // Zoom: Horizontal column width in px, vertical row height in px
    // ---------------------------------------------------------------------------------------------
    let cellWidth = 150;
    let rowHeight = 40;

    // ---------------------------------------------------------------------------------------------
    // Clipboard for copy/paste
    // ---------------------------------------------------------------------------------------------
    let clipboard = [];

    // ---------------------------------------------------------------------------------------------
    // Filter criteria (object to store active filters)
    // ---------------------------------------------------------------------------------------------
    let filters = {};

    // ---------------------------------------------------------------------------------------------
    // Search term (new for dynamic filtering lines/bars)
    // ---------------------------------------------------------------------------------------------
    let searchTerm = "";

    // ---------------------------------------------------------------------------------------------
    // Theme setting (new)
    // ---------------------------------------------------------------------------------------------
    let currentTheme = "light";

    // ---------------------------------------------------------------------------------------------
    // Undo/Redo stacks
    // ---------------------------------------------------------------------------------------------
    let undoStack = [];
    let redoStack = [];

    // ---------------------------------------------------------------------------------------------
    // DOM elements
    // ---------------------------------------------------------------------------------------------
    const ganttTable = document.getElementById("ganttTable");
    const headerRow = document.getElementById("headerRow");
    const tableBody = document.getElementById("tableBody");
    const addLineItemBtn = document.getElementById("addLineItemBtn");
    const addBarBtn = document.getElementById("addBarBtn");
    const filterBtn = document.getElementById("filterBtn");
    const importJsonBtn = document.getElementById("importJsonBtn");
    const exportJsonBtn = document.getElementById("exportJsonBtn");
    const downloadCsvBtn = document.getElementById("downloadCsvBtn");
    const printBtn = document.getElementById("printBtn");
    const helpBtn = document.getElementById("helpBtn");
    const settingsBtn = document.getElementById("settingsBtn"); 
    const searchInput = document.getElementById("searchInput"); 
    const importFileInput = document.getElementById("importFileInput");
    const startYearInput = document.getElementById("startYearInput");
    const startWeekInput = document.getElementById("startWeekInput");
    const endYearInput = document.getElementById("endYearInput");
    const endWeekInput = document.getElementById("endWeekInput");
    const applyTimescaleBtn = document.getElementById("applyTimescaleBtn");
    const lineCountSpan = document.getElementById("lineCount");
    const barCountSpan = document.getElementById("barCount");
    const zoomSlider = document.getElementById("zoomSlider");
    const heightZoomSlider = document.getElementById("heightZoomSlider");
    const undoBtn = document.getElementById("undoBtn"); 
    const redoBtn = document.getElementById("redoBtn");

    // Bar editor elements
    const barEditor = document.getElementById("barEditor");
    const barTextInput = document.getElementById("barTextInput");
    const barStatusSelect = document.getElementById("barStatusSelect");
    const startYearSelect = document.getElementById("startYearSelect");
    const startWeekSelect = document.getElementById("startWeekSelect");
    const endYearSelect = document.getElementById("endYearSelect");
    const endWeekSelect = document.getElementById("endWeekSelect");
    const barEditorOkBtn = document.getElementById("barEditorOkBtn");
    const barEditorCancelBtn = document.getElementById("barEditorCancelBtn");
    const barDeleteBtn = document.getElementById("barDeleteBtn");

    // Line editor elements (new)
    const lineEditor = document.getElementById("lineEditor");
    const lineNameInput = document.getElementById("lineNameInput");
    const lineClientInput = document.getElementById("lineClientInput");
    const lineDisciplineInput = document.getElementById("lineDisciplineInput");
    const lineExperienceInput = document.getElementById("lineExperienceInput");
    const lineLocationInput = document.getElementById("lineLocationInput");
    const lineCustom1Input = document.getElementById("lineCustom1Input");
    const lineCustom2Input = document.getElementById("lineCustom2Input");
    const lineCustom3Input = document.getElementById("lineCustom3Input");
    const lineEditorOkBtn = document.getElementById("lineEditorOkBtn");
    const lineEditorCancelBtn = document.getElementById("lineEditorCancelBtn");
    const lineDeleteBtn = document.getElementById("lineDeleteBtn");

    // Filter modal elements (new)
    const filterModal = document.getElementById("filterModal");
    const filterClient = document.getElementById("filterClient");
    const filterDiscipline = document.getElementById("filterDiscipline");
    const filterExperience = document.getElementById("filterExperience");
    const filterLocation = document.getElementById("filterLocation");
    const filterCustom1 = document.getElementById("filterCustom1");
    const filterCustom2 = document.getElementById("filterCustom2");
    const filterCustom3 = document.getElementById("filterCustom3");
    const filterApplyBtn = document.getElementById("filterApplyBtn");
    const filterClearBtn = document.getElementById("filterClearBtn");
    const filterCancelBtn = document.getElementById("filterCancelBtn");

    // Settings modal elements (new)
    const settingsModal = document.getElementById("settingsModal");
    const themeSelect = document.getElementById("themeSelect");
    const securedColor = document.getElementById("securedColor");
    const proposedColor = document.getElementById("proposedColor");
    const opportunityColor = document.getElementById("opportunityColor");
    const futureColor = document.getElementById("futureColor");
    const settingsOkBtn = document.getElementById("settingsOkBtn");
    const settingsCancelBtn = document.getElementById("settingsCancelBtn");

    // Editor state
    let currentEditorBar = null;
    let currentEditorLine = null;

    // Line editor state (new)
    let currentLineEditor = null;

    // Drag state
    let dragging = false;
    let dragType = null;
    let dragStartX = 0;
    let initialStartAbs = 0;
    let initialLength = 0;
    let currentBar = null;
    let currentLine = null;

    // ---------------------------------------------------------------------------------------------
    // Function: toAbsoluteWeek
    // Converts (year, week) to an absolute index (year*52 + (week-1))
    // ---------------------------------------------------------------------------------------------
    function toAbsoluteWeek(year, week) {
      return year * 52 + (week - 1);
    }

    // ---------------------------------------------------------------------------------------------
    // Function: fromAbsoluteWeek
    // Converts an absolute week index back to { year, week }
    // ---------------------------------------------------------------------------------------------
    function fromAbsoluteWeek(absWeek) {
      const y = Math.floor(absWeek / 52);
      const w = (absWeek % 52) + 1;
      return { year: y, week: w };
    }

    // ---------------------------------------------------------------------------------------------
    // Function: getColorFromStatus
    // Returns the color string for a given status, or fallback if unknown
    // ---------------------------------------------------------------------------------------------
    function getColorFromStatus(status) {
      return statusColors[status] || "#fd7e14";
    }

    // ---------------------------------------------------------------------------------------------
    // Function: populateDateSelects
    // Fills the bar editor's year/week dropdowns with a range of values
    // ---------------------------------------------------------------------------------------------
    function populateDateSelects() {
      [startYearSelect, endYearSelect].forEach(sel => {
        sel.innerHTML = "";
        for (let y = 2010; y <= 2030; y++) {
          const opt = document.createElement("option");
          opt.value = y;
          opt.textContent = y;
          sel.appendChild(opt);
        }
      });
      [startWeekSelect, endWeekSelect].forEach(sel => {
        sel.innerHTML = "";
        for (let w = 1; w <= 52; w++) {
          const opt = document.createElement("option");
          opt.value = w;
          opt.textContent = w;
          sel.appendChild(opt);
        }
      });
    }

    // ---------------------------------------------------------------------------------------------
    // Function: updateCSSVariables
    // Updates CSS custom properties to reflect current widths/heights
    // ---------------------------------------------------------------------------------------------
    function updateCSSVariables() {
      document.documentElement.style.setProperty('--cell-width', cellWidth + 'px');
      document.documentElement.style.setProperty('--row-height', rowHeight + 'px');
      ganttTable.style.setProperty('--cell-width', cellWidth + 'px');
      ganttTable.style.setProperty('--row-height', rowHeight + 'px');
    }

    // ---------------------------------------------------------------------------------------------
    // Function: applyTheme
    // Applies light/dark theme by toggling a class on body, then re-renders
    // ---------------------------------------------------------------------------------------------
    function applyTheme() {
      if (currentTheme === "dark") {
        document.body.classList.add("dark-theme");
      } else {
        document.body.classList.remove("dark-theme");
      }
      document.querySelectorAll('.legend-swatch').forEach(swatch => {
        const status = swatch.parentElement.textContent.trim().toLowerCase();
        if (statusColors[status]) {
          swatch.style.backgroundColor = statusColors[status];
        }
      });
      renderTable();
      saveToLocalStorage();
    }

    // ---------------------------------------------------------------------------------------------
    // Function: saveToLocalStorage
    // Persists chart data to localStorage, including theme & statuses
    // ---------------------------------------------------------------------------------------------
    function saveToLocalStorage() {
      const chartData = { 
        lines,
        startYear,
        startWeek,
        endYear,
        endWeek,
        lineCounter,
        barCounter,
        cellWidth,
        rowHeight,
        statusColors,
        currentTheme
      };
      localStorage.setItem("ganttChartData", JSON.stringify(chartData));
    }

    // ---------------------------------------------------------------------------------------------
    // Function: loadFromLocalStorage
    // Loads and parses chart data from localStorage
    // ---------------------------------------------------------------------------------------------
    function loadFromLocalStorage() {
      const stored = localStorage.getItem("ganttChartData");
      if (!stored) return;
      try {
        const parsed = JSON.parse(stored);
        lines = parsed.lines || [];
        lines.forEach(line => {
          line.selected = false;
          line.client = line.client || "";
          line.discipline = line.discipline || "";
          line.experience = line.experience || "";
          line.location = line.location || "";
          line.custom1 = line.custom1 || "";
          line.custom2 = line.custom2 || "";
          line.custom3 = line.custom3 || "";
          line.bars.forEach(bar => { 
            if (!bar.status) bar.status = "proposed"; 
            bar.selected = false;
          });
        });
        startYear = parsed.startYear || 2025;
        startWeek = parsed.startWeek || 1;
        endYear = parsed.endYear || 2025;
        endWeek = parsed.endWeek || 52;
        lineCounter = parsed.lineCounter || 0;
        barCounter = parsed.barCounter || 0;
        cellWidth = parsed.cellWidth || 150;
        rowHeight = parsed.rowHeight || 40;
        statusColors = parsed.statusColors || statusColors;
        currentTheme = parsed.currentTheme || "light";
      } catch (err) {
        console.warn("Invalid localStorage data");
      }
    }

    // ---------------------------------------------------------------------------------------------
    // Function: getSelectedBars
    // Collects all bars that are selected (with parent line references)
    // ---------------------------------------------------------------------------------------------
    function getSelectedBars() {
      const selected = [];
      lines.forEach(line => line.bars.forEach(bar => { 
        if (bar.selected) selected.push({ bar, line }); 
      }));
      return selected;
    }

    // ---------------------------------------------------------------------------------------------
    // Function: deleteBars
    // Removes the specified bars from their respective lines, triggers re-render/save
    // ---------------------------------------------------------------------------------------------
    function deleteBars(barsToDelete) {
      barsToDelete.forEach(({ bar, line }) => {
        line.bars = line.bars.filter(b => b.id !== bar.id);
      });
      pushState(); // Save state for undo
      renderTable();
      saveToLocalStorage();
    }

    // ---------------------------------------------------------------------------------------------
    // Function: getTotalBars
    // Counts total bars across all lines
    // ---------------------------------------------------------------------------------------------
    function getTotalBars() {
      return lines.reduce((count, line) => count + line.bars.length, 0);
    }

    // ---------------------------------------------------------------------------------------------
    // Function: unselectAllBars
    // Sets bar.selected = false for every bar
    // ---------------------------------------------------------------------------------------------
    function unselectAllBars() {
      lines.forEach(line => line.bars.forEach(bar => {
        bar.selected = false;
      }));
    }

    // ---------------------------------------------------------------------------------------------
    // Function: clearHighlights
    // Removes 'highlighted' class from all bar elements
    // ---------------------------------------------------------------------------------------------
    function clearHighlights() {
      document.querySelectorAll('.bar.highlighted').forEach(el => el.classList.remove('highlighted'));
    }

    // ---------------------------------------------------------------------------------------------
    // Function: handleBarClickSelect
    // Handles shift/ctrl-based multi-select or single-select for bars
    // ---------------------------------------------------------------------------------------------
    function handleBarClickSelect(bar, event) {
      const isMulti = event.shiftKey || event.ctrlKey || event.metaKey;
      if (!isMulti) {
        unselectAllBars();
        bar.selected = true;
      } else {
        bar.selected = !bar.selected;
      }
    }

    // ---------------------------------------------------------------------------------------------
    // Function: getDisplayRange
    // Returns the start and end absolute weeks for the current timescale
    // ---------------------------------------------------------------------------------------------
    function getDisplayRange() {
      let ds = toAbsoluteWeek(startYear, startWeek);
      let de = toAbsoluteWeek(endYear, endWeek);
      if (ds > de) [ds, de] = [de, ds];
      return { displayStart: ds, displayEnd: de };
    }

    // ---------------------------------------------------------------------------------------------
    // Function: updateBarTextPositions
    // Adjust bar text within the visible portion as the user scrolls
    // ---------------------------------------------------------------------------------------------
    function updateBarTextPositions() {
      const wrapper = document.querySelector(".table-wrapper");
      const scrollLeft = wrapper.scrollLeft;
      const viewportWidth = wrapper.clientWidth;
      document.querySelectorAll(".bar-text").forEach(textEl => {
        const barEl = textEl.parentElement;
        const barLeft = parseFloat(barEl.style.left);
        const barWidth = parseFloat(barEl.style.width);
        const barRight = barLeft + barWidth;

        const visibleLeft = Math.max(barLeft, scrollLeft);
        const visibleRight = Math.min(barRight, scrollLeft + viewportWidth);
        const visibleWidth = visibleRight - visibleLeft;

        if (visibleWidth <= 0) {
          textEl.style.opacity = "0";
          return;
        }
        textEl.style.opacity = "1";
        const textWidth = textEl.offsetWidth;
        let textLeft = visibleLeft - barLeft + (visibleWidth - textWidth) / 2;
        if (textLeft < 5) textLeft = 5;
        if (textLeft + textWidth > barWidth - 5) textLeft = barWidth - textWidth - 5;
        textEl.style.left = textLeft + "px";
      });
    }

    // ---------------------------------------------------------------------------------------------
    // Function: renderHeader
    // Rebuilds timescale header cells based on current start/end
    // ---------------------------------------------------------------------------------------------
    function renderHeader() {
      while (headerRow.children.length > 1) {
        headerRow.removeChild(headerRow.lastChild);
      }
      const { displayStart, displayEnd } = getDisplayRange();
      const totalWeeks = displayEnd - displayStart + 1;
      if (totalWeeks < 1) return;
      for (let i = 0; i < totalWeeks; i++) {
        const abs = displayStart + i;
        const { year, week } = fromAbsoluteWeek(abs);
        const th = document.createElement("th");
        th.className = "timescale-header";
        th.textContent = `${year}-W${week}`;
        th.style.width = cellWidth + "px";
        headerRow.appendChild(th);
      }
    }

    // ---------------------------------------------------------------------------------------------
    // Function: updateStats
    // Refreshes line and bar counts in the toolbar
    // ---------------------------------------------------------------------------------------------
    function updateStats() {
      lineCountSpan.textContent = lines.length;
      barCountSpan.textContent = getTotalBars();
    }

    // ---------------------------------------------------------------------------------------------
    // Function: renderTable
    // Builds the full table based on lines/bars/filters/search
    // ---------------------------------------------------------------------------------------------
    function renderTable() {
      // Rebuild header
      renderHeader();
      // Clear body
      tableBody.innerHTML = "";
      // Clear highlights from previous
      clearHighlights();

      const { displayStart, displayEnd } = getDisplayRange();
      const totalWeeks = displayEnd - displayStart + 1;
      if (totalWeeks < 1) return;

      // Make searchTerm lowercase for partial checks
      const lowerSearch = searchTerm.toLowerCase();

      // Filter lines by (a) advanced filters plus (b) dynamic text filter
      const filteredLines = lines.filter(line => {
        // First check advanced attribute filters
        const passesAttributeFilters = Object.keys(filters).every(key => {
          if (filters[key]) {
            return line[key] && line[key].toLowerCase().includes(filters[key].toLowerCase());
          }
          return true;
        });
        if (!passesAttributeFilters) return false;

        // Now check dynamic search
        if (!lowerSearch) {
          return true; // no search term => pass
        }

        // Check line-level fields for search
        const lineMatch = (
          (line.name && line.name.toLowerCase().includes(lowerSearch)) ||
          (line.client && line.client.toLowerCase().includes(lowerSearch)) ||
          (line.discipline && line.discipline.toLowerCase().includes(lowerSearch)) ||
          (line.experience && line.experience.toLowerCase().includes(lowerSearch)) ||
          (line.location && line.location.toLowerCase().includes(lowerSearch)) ||
          (line.custom1 && line.custom1.toLowerCase().includes(lowerSearch)) ||
          (line.custom2 && line.custom2.toLowerCase().includes(lowerSearch)) ||
          (line.custom3 && line.custom3.toLowerCase().includes(lowerSearch))
        );
        // Check bar text/status for search
        const barMatch = line.bars.some(b => {
          const textLow = (b.text || "").toLowerCase();
          const statusLow = (b.status || "").toLowerCase();
          return textLow.includes(lowerSearch) || statusLow.includes(lowerSearch);
        });

        // Pass if any line attribute or any bar matched
        return (lineMatch || barMatch);
      });

      // Render each filtered line
      filteredLines.forEach(line => {
        const tr = document.createElement("tr");
        tr.className = "gantt-row";
        if (line.selected) tr.classList.add("selected");

        // Name cell - now centered both vertically & horizontally
        const nameTd = document.createElement("td");
        nameTd.className = "name-cell";

        // The label that is clickable to open line editor
        const nameLabel = document.createElement("span");
        nameLabel.textContent = line.name;
        nameLabel.style.flex = "1";
        nameLabel.style.cursor = "pointer";
        nameLabel.addEventListener("click", e => {
          e.stopPropagation();
          showLineEditor(line, e.clientX, e.clientY);
        });
        nameTd.appendChild(nameLabel);

        // Clicking the cell itself selects the line
        nameTd.addEventListener("click", e => {
          e.stopPropagation();
          unselectAllBars();
          lines.forEach(l => l.selected = false);
          line.selected = true;
          renderTable();
        });
        tr.appendChild(nameTd);

        // Bar container cell
        const barTd = document.createElement("td");
        barTd.colSpan = totalWeeks;
        barTd.className = "bar-cell";
        const barContainer = document.createElement("div");
        barContainer.className = "bar-row-container";

        // Render each bar that overlaps
        line.bars.forEach(bar => {
          const barStart = bar.startAbsWeek;
          const barEnd = barStart + bar.length;
          const overlapStart = Math.max(displayStart, barStart);
          const overlapEnd = Math.min(displayEnd + 1, barEnd);
          const overlapLen = overlapEnd - overlapStart;
          if (overlapLen <= 0) return;

          const barLeft = (overlapStart - displayStart) * cellWidth;
          const barWidth = overlapLen * cellWidth;
          const barDiv = document.createElement("div");
          barDiv.classList.add("bar");
          if (bar.selected) barDiv.classList.add("selected");

          // If bar text partially matches the searchTerm, we highlight
          if (lowerSearch && bar.text.toLowerCase().includes(lowerSearch)) {
            barDiv.classList.add("highlighted");
          }

          barDiv.style.left = barLeft + "px";
          barDiv.style.width = barWidth + "px";
          barDiv.style.backgroundColor = getColorFromStatus(bar.status);

          // Bar text
          const textSpan = document.createElement("span");
          textSpan.className = "bar-text";
          textSpan.textContent = bar.text;
          barDiv.appendChild(textSpan);

          // Resize handles
          const leftHandle = document.createElement("div");
          leftHandle.classList.add("bar-handle", "left");
          barDiv.appendChild(leftHandle);
          const rightHandle = document.createElement("div");
          rightHandle.classList.add("bar-handle", "right");
          barDiv.appendChild(rightHandle);

          // Click => (multi-)select
          barDiv.addEventListener("click", e => {
            e.stopPropagation();
            handleBarClickSelect(bar, e);
            renderTable();
            saveToLocalStorage();
          });

          // Dblclick => open bar editor
          barDiv.addEventListener("dblclick", e => {
            e.stopPropagation();
            showBarEditor(bar, line, e.clientX, e.clientY);
          });

          // Mousedown => start drag
          barDiv.addEventListener("mousedown", e => onBarMouseDown(e, line, bar));

          barContainer.appendChild(barDiv);
        });

        // Overlap hatches
        const sortedBars = [...line.bars].sort((a, b) => a.startAbsWeek - b.startAbsWeek);
        for (let i = 0; i < sortedBars.length; i++) {
          for (let j = i + 1; j < sortedBars.length; j++) {
            const bar1 = sortedBars[i];
            const bar2 = sortedBars[j];
            const start1 = Math.max(displayStart, bar1.startAbsWeek);
            const end1 = Math.min(displayEnd + 1, bar1.startAbsWeek + bar1.length);
            const start2 = Math.max(displayStart, bar2.startAbsWeek);
            const end2 = Math.min(displayEnd + 1, bar2.startAbsWeek + bar2.length);
            const overlapStart = Math.max(start1, start2);
            const overlapEnd = Math.min(end1, end2);
            if (overlapEnd > overlapStart) {
              const left = (overlapStart - displayStart) * cellWidth;
              const width = (overlapEnd - overlapStart) * cellWidth;
              const hatchDiv = document.createElement("div");
              hatchDiv.className = "overlap-hatch";
              hatchDiv.style.left = left + "px";
              hatchDiv.style.width = width + "px";
              barContainer.appendChild(hatchDiv);
            }
          }
        }

        barTd.appendChild(barContainer);
        tr.appendChild(barTd);
        tableBody.appendChild(tr);
      });

      updateStats();
      updateBarTextPositions();
    }

    // ---------------------------------------------------------------------------------------------
    // Function: removeLineItem
    // Removes a line item (by ID) from lines, triggers re-render
    // ---------------------------------------------------------------------------------------------
    function removeLineItem(id) {
      lines = lines.filter(l => l.id !== id);
      pushState();
      renderTable();
      saveToLocalStorage();
    }

    // ---------------------------------------------------------------------------------------------
    // Function: onBarMouseDown
    // Sets drag info and prevents default for movement logic
    // ---------------------------------------------------------------------------------------------
    function onBarMouseDown(e, line, bar) {
      if (e.target.classList.contains("bar-handle")) {
        dragType = e.target.classList.contains("left") ? "resize-left" : "resize-right";
      } else {
        dragType = "move";
      }
      dragging = true;
      currentBar = bar;
      currentLine = line;
      dragStartX = e.clientX;
      initialStartAbs = currentBar.startAbsWeek;
      initialLength = currentBar.length;
      e.preventDefault();
    }

    // ---------------------------------------------------------------------------------------------
    // Document mousemove => drag/resize in progress
    // ---------------------------------------------------------------------------------------------
    document.addEventListener("mousemove", e => {
      if (!dragging || !currentBar) return;
      const dx = e.clientX - dragStartX;
      const dWeeks = Math.round(dx / cellWidth);

      if (dragType === "move") {
        currentBar.startAbsWeek = Math.max(0, initialStartAbs + dWeeks);
      } else if (dragType === "resize-left") {
        let newStart = initialStartAbs + dWeeks;
        let newLength = initialStartAbs + initialLength - newStart;
        if (newLength < 1) {
          newLength = 1;
          newStart = initialStartAbs + initialLength - 1;
        }
        currentBar.startAbsWeek = Math.max(0, newStart);
        currentBar.length = newLength;
      } else if (dragType === "resize-right") {
        let newLength = initialLength + dWeeks;
        if (newLength < 1) newLength = 1;
        currentBar.length = newLength;
      }
      renderTable();
    });

    // ---------------------------------------------------------------------------------------------
    // Document mouseup => finalize drag, save state
    // ---------------------------------------------------------------------------------------------
    document.addEventListener("mouseup", () => {
      if (dragging) {
        dragging = false;
        dragType = null;
        currentBar = null;
        currentLine = null;
        pushState(); 
        saveToLocalStorage();
      }
    });

    // ---------------------------------------------------------------------------------------------
    // Document click => unselect bars/lines if not dragging, clear clipboard
    // ---------------------------------------------------------------------------------------------
    document.addEventListener("click", () => {
      if (!dragging) {
        unselectAllBars();
        lines.forEach(l => l.selected = false);
        clipboard = [];
        renderTable();
        saveToLocalStorage();
      }
    });

    // ---------------------------------------------------------------------------------------------
    // Keyboard shortcuts => delete, copy/paste, arrow moves, reorder lines, undo/redo
    // ---------------------------------------------------------------------------------------------
    document.addEventListener("keydown", e => {
      const selected = getSelectedBars();
      if ((e.key === "Delete" || e.key === "Backspace")) {
        if (selected.length) {
          deleteBars(selected);
          e.preventDefault();
          return;
        }
      }
      if (e.ctrlKey || e.metaKey) {
        // Copy
        if (e.key.toLowerCase() === "c") {
          if (selected.length) {
            clipboard = selected.map(({ bar, line }) => ({ bar: JSON.parse(JSON.stringify(bar)), sourceLine: line }));
            e.preventDefault();
          }
        }
        // Paste
        if (e.key.toLowerCase() === "v") {
          if (!clipboard.length) return;
          let targetLine = selected.length ? selected[selected.length - 1].line : lines[lines.length - 1];
          if (!targetLine) {
            lineCounter++;
            targetLine = { 
              id: lineCounter,
              name: "Line Item " + lineCounter,
              client: "",
              discipline: "",
              experience: "",
              location: "",
              custom1: "",
              custom2: "",
              custom3: "",
              bars: [],
              selected: false 
            };
            lines.push(targetLine);
          }
          clipboard.forEach(item => {
            barCounter++;
            const newBar = JSON.parse(JSON.stringify(item.bar));
            newBar.id = barCounter;
            newBar.selected = true;
            targetLine.bars.push(newBar);
          });
          unselectAllBars();
          pushState();
          renderTable();
          saveToLocalStorage();
          e.preventDefault();
        }
        // Undo (Ctrl+Z)
        if (e.key.toLowerCase() === 'z') {
          undo();
          e.preventDefault();
        }
        // Redo (Ctrl+Y)
        if (e.key.toLowerCase() === 'y') {
          redo();
          e.preventDefault();
        }
      }
      // Arrow keys => shift bars or reorder lines
      if (e.key === "ArrowLeft") {
        if (selected.length) {
          selected.forEach(({ bar }) => {
            bar.startAbsWeek = Math.max(0, bar.startAbsWeek - 1);
          });
          pushState();
          renderTable();
          saveToLocalStorage();
          e.preventDefault();
        }
      } else if (e.key === "ArrowRight") {
        if (selected.length) {
          selected.forEach(({ bar }) => {
            bar.startAbsWeek = Math.max(0, bar.startAbsWeek + 1);
          });
          pushState();
          renderTable();
          saveToLocalStorage();
          e.preventDefault();
        }
      } else if (e.key === "ArrowUp" || e.key === "ArrowDown") {
        if (selected.length) {
          selected.forEach(({ bar, line }) => {
            const idx = lines.indexOf(line);
            if (e.key === "ArrowUp" && idx > 0) {
              line.bars = line.bars.filter(b => b.id !== bar.id);
              lines[idx - 1].bars.push(bar);
            } else if (e.key === "ArrowDown" && idx < lines.length - 1) {
              line.bars = line.bars.filter(b => b.id !== bar.id);
              lines[idx + 1].bars.push(bar);
            }
          });
          pushState();
          renderTable();
          saveToLocalStorage();
          e.preventDefault();
        } else {
          // Move selected line up/down
          const selectedLine = lines.find(l => l.selected);
          if (selectedLine) {
            const idx = lines.indexOf(selectedLine);
            if (e.key === "ArrowUp" && idx > 0) {
              [lines[idx-1], lines[idx]] = [lines[idx], lines[idx-1]];
            } else if (e.key === "ArrowDown" && idx < lines.length - 1) {
              [lines[idx], lines[idx+1]] = [lines[idx+1], lines[idx]];
            }
            pushState();
            renderTable();
            saveToLocalStorage();
            e.preventDefault();
          }
        }
      }
    });

    // ---------------------------------------------------------------------------------------------
    // Function: showBarEditor
    // Opens the bar editing popup at the given coordinate
    // ---------------------------------------------------------------------------------------------
    function showBarEditor(bar, line, x, y) {
      currentEditorBar = bar;
      currentEditorLine = line;
      barTextInput.value = bar.text;
      barStatusSelect.value = bar.status;
      const { year: sy, week: sw } = fromAbsoluteWeek(bar.startAbsWeek);
      const { year: ey, week: ew } = fromAbsoluteWeek(bar.startAbsWeek + bar.length - 1);
      startYearSelect.value = sy;
      startWeekSelect.value = sw;
      endYearSelect.value = ey;
      endWeekSelect.value = ew;
      barEditor.style.display = "block";
      barEditor.style.left = (x + window.scrollX + 10) + "px";
      barEditor.style.top = (y + window.scrollY + 10) + "px";
    }

    // ---------------------------------------------------------------------------------------------
    // Bar editor OK => saves changes, hides editor
    // ---------------------------------------------------------------------------------------------
    barEditorOkBtn.addEventListener("click", () => {
      if (!currentEditorBar) return;
      currentEditorBar.text = barTextInput.value;
      currentEditorBar.status = barStatusSelect.value;
      const sy = parseInt(startYearSelect.value);
      const sw = parseInt(startWeekSelect.value);
      const ey = parseInt(endYearSelect.value);
      const ew = parseInt(endWeekSelect.value);
      currentEditorBar.startAbsWeek = toAbsoluteWeek(sy, sw);
      currentEditorBar.length = toAbsoluteWeek(ey, ew) - currentEditorBar.startAbsWeek + 1;
      if (currentEditorBar.length < 1) currentEditorBar.length = 1;
      barEditor.style.display = "none";
      currentEditorBar = null;
      currentEditorLine = null;
      pushState(); 
      renderTable();
      saveToLocalStorage();
    });

    // ---------------------------------------------------------------------------------------------
    // Bar editor cancel => just close
    // ---------------------------------------------------------------------------------------------
    barEditorCancelBtn.addEventListener("click", () => {
      barEditor.style.display = "none";
      currentEditorBar = null;
      currentEditorLine = null;
    });

    // ---------------------------------------------------------------------------------------------
    // Bar delete => remove bar from line, close editor
    // ---------------------------------------------------------------------------------------------
    barDeleteBtn.addEventListener("click", () => {
      if (!currentEditorBar || !currentEditorLine) return;
      currentEditorLine.bars = currentEditorLine.bars.filter(b => b.id !== currentEditorBar.id);
      barEditor.style.display = "none";
      currentEditorBar = null;
      currentEditorLine = null;
      pushState();
      renderTable();
      saveToLocalStorage();
    });

    // ---------------------------------------------------------------------------------------------
    // Close bar editor if clicked outside
    // ---------------------------------------------------------------------------------------------
    document.addEventListener("mousedown", e => {
      if (barEditor.style.display === "block") {
        const rect = barEditor.getBoundingClientRect();
        const inside = e.clientX >= rect.left && e.clientX <= rect.right && e.clientY >= rect.top && e.clientY <= rect.bottom;
        if (!inside) {
          barEditor.style.display = "none";
          currentEditorBar = null;
          currentEditorLine = null;
        }
      }
    });

    // ---------------------------------------------------------------------------------------------
    // Function: showLineEditor
    // Opens the popup for editing line attributes
    // ---------------------------------------------------------------------------------------------
    function showLineEditor(line, x, y) {
      currentLineEditor = line;
      lineNameInput.value = line.name;
      lineClientInput.value = line.client;
      lineDisciplineInput.value = line.discipline;
      lineExperienceInput.value = line.experience;
      lineLocationInput.value = line.location;
      lineCustom1Input.value = line.custom1;
      lineCustom2Input.value = line.custom2;
      lineCustom3Input.value = line.custom3;
      lineEditor.style.display = "block";
      lineEditor.style.left = (x + window.scrollX + 10) + "px";
      lineEditor.style.top = (y + window.scrollY + 10) + "px";
    }

    // ---------------------------------------------------------------------------------------------
    // Line editor OK => saves attributes
    // ---------------------------------------------------------------------------------------------
    lineEditorOkBtn.addEventListener("click", () => {
      if (!currentLineEditor) return;
      currentLineEditor.name = lineNameInput.value;
      currentLineEditor.client = lineClientInput.value;
      currentLineEditor.discipline = lineDisciplineInput.value;
      currentLineEditor.experience = lineExperienceInput.value;
      currentLineEditor.location = lineLocationInput.value;
      currentLineEditor.custom1 = lineCustom1Input.value;
      currentLineEditor.custom2 = lineCustom2Input.value;
      currentLineEditor.custom3 = lineCustom3Input.value;
      lineEditor.style.display = "none";
      currentLineEditor = null;
      pushState();
      renderTable();
      saveToLocalStorage();
    });

    // ---------------------------------------------------------------------------------------------
    // Line editor cancel => just close
    // ---------------------------------------------------------------------------------------------
    lineEditorCancelBtn.addEventListener("click", () => {
      lineEditor.style.display = "none";
      currentLineEditor = null;
    });

    // ---------------------------------------------------------------------------------------------
    // "Delete Line Item" => remove the line, close editor
    // ---------------------------------------------------------------------------------------------
    lineDeleteBtn.addEventListener("click", () => {
      if (!currentLineEditor) return;
      removeLineItem(currentLineEditor.id);
      lineEditor.style.display = "none";
      currentLineEditor = null;
    });

    // ---------------------------------------------------------------------------------------------
    // Close line editor if clicked outside
    // ---------------------------------------------------------------------------------------------
    document.addEventListener("mousedown", e => {
      if (lineEditor.style.display === "block") {
        const rect = lineEditor.getBoundingClientRect();
        const inside = e.clientX >= rect.left && e.clientX <= rect.right && e.clientY >= rect.top && e.clientY <= rect.bottom;
        if (!inside) {
          lineEditor.style.display = "none";
          currentLineEditor = null;
        }
      }
    });

    // ---------------------------------------------------------------------------------------------
    // Filter button => opens modal
    // ---------------------------------------------------------------------------------------------
    filterBtn.addEventListener("click", () => {
      filterClient.value = filters.client || "";
      filterDiscipline.value = filters.discipline || "";
      filterExperience.value = filters.experience || "";
      filterLocation.value = filters.location || "";
      filterCustom1.value = filters.custom1 || "";
      filterCustom2.value = filters.custom2 || "";
      filterCustom3.value = filters.custom3 || "";
      filterModal.style.display = "block";
    });

    // ---------------------------------------------------------------------------------------------
    // Filter apply => set filters, re-render
    // ---------------------------------------------------------------------------------------------
    filterApplyBtn.addEventListener("click", () => {
      filters = {
        client: filterClient.value.trim(),
        discipline: filterDiscipline.value.trim(),
        experience: filterExperience.value.trim(),
        location: filterLocation.value.trim(),
        custom1: filterCustom1.value.trim(),
        custom2: filterCustom2.value.trim(),
        custom3: filterCustom3.value.trim(),
      };
      Object.keys(filters).forEach(key => {
        if (!filters[key]) delete filters[key];
      });
      filterModal.style.display = "none";
      renderTable();
    });

    // ---------------------------------------------------------------------------------------------
    // Filter clear => reset filters
    // ---------------------------------------------------------------------------------------------
    filterClearBtn.addEventListener("click", () => {
      filters = {};
      filterClient.value = "";
      filterDiscipline.value = "";
      filterExperience.value = "";
      filterLocation.value = "";
      filterCustom1.value = "";
      filterCustom2.value = "";
      filterCustom3.value = "";
      filterModal.style.display = "none";
      renderTable();
    });

    // ---------------------------------------------------------------------------------------------
    // Filter cancel => close
    // ---------------------------------------------------------------------------------------------
    filterCancelBtn.addEventListener("click", () => {
      filterModal.style.display = "none";
    });

    // ---------------------------------------------------------------------------------------------
    // Close filter modal if clicked outside
    // ---------------------------------------------------------------------------------------------
    document.addEventListener("mousedown", e => {
      if (filterModal.style.display === "block") {
        const rect = filterModal.getBoundingClientRect();
        const inside = e.clientX >= rect.left && e.clientX <= rect.right && e.clientY >= rect.top && e.clientY <= rect.bottom;
        if (!inside) {
          filterModal.style.display = "none";
        }
      }
    });

    // ---------------------------------------------------------------------------------------------
    // Settings button => opens settings modal
    // ---------------------------------------------------------------------------------------------
    settingsBtn.addEventListener("click", () => {
      themeSelect.value = currentTheme;
      securedColor.value = statusColors.secured;
      proposedColor.value = statusColors.proposed;
      opportunityColor.value = statusColors.opportunity;
      futureColor.value = statusColors.future;
      settingsModal.style.display = "block";
    });

    // ---------------------------------------------------------------------------------------------
    // Settings OK => apply theme and color changes
    // ---------------------------------------------------------------------------------------------
    settingsOkBtn.addEventListener("click", () => {
      currentTheme = themeSelect.value;
      statusColors.secured = securedColor.value;
      statusColors.proposed = proposedColor.value;
      statusColors.opportunity = opportunityColor.value;
      statusColors.future = futureColor.value;
      settingsModal.style.display = "none";
      applyTheme();
    });

    // ---------------------------------------------------------------------------------------------
    // Settings cancel => just close
    // ---------------------------------------------------------------------------------------------
    settingsCancelBtn.addEventListener("click", () => {
      settingsModal.style.display = "none";
    });

    // ---------------------------------------------------------------------------------------------
    // Close settings modal if clicked outside
    // ---------------------------------------------------------------------------------------------
    document.addEventListener("mousedown", e => {
      if (settingsModal.style.display === "block") {
        const rect = settingsModal.getBoundingClientRect();
        const inside = e.clientX >= rect.left && e.clientX <= rect.right && e.clientY >= rect.top && e.clientY <= rect.bottom;
        if (!inside) {
          settingsModal.style.display = "none";
        }
      }
    });

    // ---------------------------------------------------------------------------------------------
    // Search input => dynamic filter re-render
    // ---------------------------------------------------------------------------------------------
    searchInput.addEventListener("input", () => {
      searchTerm = searchInput.value.trim();
      renderTable();
    });

    // ---------------------------------------------------------------------------------------------
    // Add line button => create new line
    // ---------------------------------------------------------------------------------------------
    addLineItemBtn.addEventListener("click", () => {
      lineCounter++;
      lines.push({ 
        id: lineCounter, 
        name: "Line Item " + lineCounter,
        client: "", 
        discipline: "", 
        experience: "", 
        location: "", 
        custom1: "", 
        custom2: "", 
        custom3: "", 
        bars: [], 
        selected: false 
      });
      pushState();
      renderTable();
      saveToLocalStorage();
    });

    // ---------------------------------------------------------------------------------------------
    // Add bar button => appends bar to last line (or create line if none)
    // ---------------------------------------------------------------------------------------------
    addBarBtn.addEventListener("click", e => {
      e.stopPropagation();
      barCounter++;
      const { displayStart } = getDisplayRange();
      const newBar = {
        id: barCounter,
        text: "New Bar",
        status: "proposed",
        startAbsWeek: displayStart,
        length: 4,
        selected: false,
      };
      if (!lines.length) {
        lineCounter = 1;
        lines.push({
          id: 1,
          name: "Line Item 1",
          client: "",
          discipline: "",
          experience: "",
          location: "",
          custom1: "",
          custom2: "",
          custom3: "",
          bars: [],
          selected: false
        });
      }
      lines[lines.length - 1].bars.push(newBar);
      pushState();
      renderTable();
      saveToLocalStorage();
    });

    // ---------------------------------------------------------------------------------------------
    // Export JSON => uses the new naming format "Gannt_<date/time>.json"
    // ---------------------------------------------------------------------------------------------
    exportJsonBtn.addEventListener("click", () => {
      // Prepare data for export
      const dataStr = JSON.stringify({
        lines,
        startYear,
        startWeek,
        endYear,
        endWeek,
        lineCounter,
        barCounter,
        cellWidth,
        rowHeight,
        statusColors,
        currentTheme
      }, null, 2);

      // Create a Blob
      const blob = new Blob([dataStr], { type: "application/json" });
      const url = URL.createObjectURL(blob);

      // Create a link and set a custom filename with today's date/time
      // Replaces characters that are invalid in filenames (e.g. ":" in time)
      const now = new Date();
      let dateStr = now.toISOString().replace(/[:.]/g, '-');
      const a = document.createElement("a");
      a.download = "Gannt_" + dateStr + ".json"; // Creates the desired name format
      a.href = url;
      a.click();
      URL.revokeObjectURL(url);
    });

    // ---------------------------------------------------------------------------------------------
    // Export CSV => downloads data as CSV
    // ---------------------------------------------------------------------------------------------
    downloadCsvBtn.addEventListener("click", () => {
      let csv = "Line ID,Name,Client,Discipline,Experience,Location,Custom1,Custom2,Custom3,Bar ID,Bar Text,Status,Start Year,Start Week,End Year,End Week,Duration (weeks)\n";
      lines.forEach(line => {
        if (line.bars.length === 0) {
          csv += `${line.id},"${line.name}","${line.client}","${line.discipline}","${line.experience}","${line.location}","${line.custom1}","${line.custom2}","${line.custom3}",,,,,,\n`;
        } else {
          line.bars.forEach(bar => {
            const { year: sy, week: sw } = fromAbsoluteWeek(bar.startAbsWeek);
            const { year: ey, week: ew } = fromAbsoluteWeek(bar.startAbsWeek + bar.length - 1);
            csv += `${line.id},"${line.name}","${line.client}","${line.discipline}","${line.experience}","${line.location}","${line.custom1}","${line.custom2}","${line.custom3}",${bar.id},"${bar.text}","${bar.status}",${sy},${sw},${ey},${ew},${bar.length}\n`;
          });
        }
      });
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.download = "gantt-data.csv";
      a.href = url;
      a.click();
      URL.revokeObjectURL(url);
    });

    // ---------------------------------------------------------------------------------------------
    // Print/PDF button => triggers browser print
    // ---------------------------------------------------------------------------------------------
    printBtn.addEventListener("click", () => {
      window.print();
    });

    // ---------------------------------------------------------------------------------------------
    // Horizontal zoom slider => updates cellWidth
    // ---------------------------------------------------------------------------------------------
    zoomSlider.addEventListener("input", e => {
      cellWidth = parseInt(e.target.value);
      pushState();
      updateCSSVariables();
      renderTable();
      saveToLocalStorage();
    });

    // ---------------------------------------------------------------------------------------------
    // Vertical zoom slider => updates rowHeight
    // ---------------------------------------------------------------------------------------------
    heightZoomSlider.addEventListener("input", e => {
      rowHeight = parseInt(e.target.value);
      pushState();
      updateCSSVariables();
      renderTable();
      saveToLocalStorage();
    });

    // ---------------------------------------------------------------------------------------------
    // Function: parseCsv
    // Converts CSV text into lines/bars
    // ---------------------------------------------------------------------------------------------
    function parseCsv(csv) {
      const rows = csv.trim().split('\n');
      const header = rows[0].toLowerCase();
      if (!header.includes('line id') || !header.includes('bar id')) throw new Error("Invalid CSV header");
      const newLines = [];
      let maxLineId = 0;
      let maxBarId = 0;
      const lineMap = {};

      for (let i = 1; i < rows.length; i++) {
        const row = rows[i].trim();
        if (!row) continue;
        const parsed = [];
        let field = '';
        let inQuote = false;
        for (let c of row + ',') {
          if (c === '"') inQuote = !inQuote;
          else if (c === ',' && !inQuote) { 
            parsed.push(field); 
            field = ''; 
          }
          else field += c;
        }
        if (parsed.length < 9) continue;

        const lineId = parseInt(parsed[0]);
        const lineName = parsed[1] || `Line ${lineId}`;
        const client = parsed[2] || "";
        const discipline = parsed[3] || "";
        const experience = parsed[4] || "";
        const location = parsed[5] || "";
        const custom1 = parsed[6] || "";
        const custom2 = parsed[7] || "";
        const custom3 = parsed[8] || "";
        const barIdStr = parsed[9];

        if (!barIdStr) {
          if (!lineMap[lineId]) {
            lineMap[lineId] = {
              id: lineId,
              name: lineName,
              client,
              discipline,
              experience,
              location,
              custom1,
              custom2,
              custom3,
              bars: [],
              selected: false
            };
            newLines.push(lineMap[lineId]);
            maxLineId = Math.max(maxLineId, lineId);
          }
          continue;
        }
        const barId = parseInt(barIdStr);
        const barText = parsed[10] || '';
        const status = (parsed[11] || "proposed").toLowerCase();
        const sy = parseInt(parsed[12]);
        const sw = parseInt(parsed[13]);
        const ey = parseInt(parsed[14]);
        const ew = parseInt(parsed[15]);
        const duration = parseInt(parsed[16]) || 1;
        if (isNaN(sy) || isNaN(sw) || isNaN(ey) || isNaN(ew)) continue;

        const startAbs = toAbsoluteWeek(sy, sw);
        const endAbs = toAbsoluteWeek(ey, ew);
        let length = endAbs - startAbs + 1;
        if (length < 1) length = duration || 1;

        if (!lineMap[lineId]) {
          lineMap[lineId] = {
            id: lineId,
            name: lineName,
            client,
            discipline,
            experience,
            location,
            custom1,
            custom2,
            custom3,
            bars: [],
            selected: false
          };
          newLines.push(lineMap[lineId]);
          maxLineId = Math.max(maxLineId, lineId);
        }
        const newBar = {
          id: barId,
          text: barText,
          status: status,
          startAbsWeek: startAbs,
          length,
          selected: false
        };
        lineMap[lineId].bars.push(newBar);
        maxBarId = Math.max(maxBarId, barId);
      }
      return { lines: newLines, lineCounter: maxLineId, barCounter: maxBarId };
    }

    // ---------------------------------------------------------------------------------------------
    // Import => triggers hidden file input
    // ---------------------------------------------------------------------------------------------
    importJsonBtn.addEventListener("click", () => {
      importFileInput.value = "";
      importFileInput.click();
    });

    // ---------------------------------------------------------------------------------------------
    // Import file => reads JSON or CSV, merges data
    // ---------------------------------------------------------------------------------------------
    importFileInput.addEventListener("change", e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ev => {
        try {
          let imported;
          if (file.name.endsWith(".json")) {
            imported = JSON.parse(ev.target.result);
            lines = imported.lines || [];
            startYear = imported.startYear || startYear;
            startWeek = imported.startWeek || startWeek;
            endYear = imported.endYear || endYear;
            endWeek = imported.endWeek || endWeek;
            lineCounter = imported.lineCounter || lineCounter;
            barCounter = imported.barCounter || barCounter;
            cellWidth = imported.cellWidth || cellWidth;
            rowHeight = imported.rowHeight || rowHeight;
            statusColors = imported.statusColors || statusColors;
            currentTheme = imported.currentTheme || currentTheme;
            lines.forEach(l => {
              l.selected = false;
              l.bars.forEach(b => b.selected = false);
            });
          } else if (file.name.endsWith(".csv")) {
            const parsed = parseCsv(ev.target.result);
            lines = parsed.lines;
            lineCounter = parsed.lineCounter;
            barCounter = parsed.barCounter;
          } else {
            throw new Error("Unsupported file type");
          }
          startYearInput.value = startYear;
          startWeekInput.value = startWeek;
          endYearInput.value = endYear;
          endWeekInput.value = endWeek;
          zoomSlider.value = cellWidth;
          heightZoomSlider.value = rowHeight;
          themeSelect.value = currentTheme;
          securedColor.value = statusColors.secured;
          proposedColor.value = statusColors.proposed;
          opportunityColor.value = statusColors.opportunity;
          futureColor.value = statusColors.future;
          updateCSSVariables();
          applyTheme();
          renderTable();
          saveToLocalStorage();
          alert("Import successful!");
        } catch (err) {
          console.error(err);
          alert("Import failed: " + err.message);
        }
      };
      reader.readAsText(file);
    });

    // ---------------------------------------------------------------------------------------------
    // Timescale apply => updates start/end from inputs
    // ---------------------------------------------------------------------------------------------
    applyTimescaleBtn.addEventListener("click", () => {
      startYear = parseInt(startYearInput.value) || startYear;
      startWeek = parseInt(startWeekInput.value) || startWeek;
      endYear = parseInt(endYearInput.value) || endYear;
      endWeek = parseInt(endWeekInput.value) || endWeek;
      startYearInput.value = startYear;
      startWeekInput.value = startWeek;
      endYearInput.value = endYear;
      endWeekInput.value = endWeek;
      pushState();
      renderTable();
      saveToLocalStorage();
    });

    // ---------------------------------------------------------------------------------------------
    // Help button => simple alert
    // ---------------------------------------------------------------------------------------------
    helpBtn.addEventListener("click", () => {
      alert(`Gantt Planner Help:
- Click a line name to edit attributes (or delete line item).
- Double-click a bar to edit it.
- Drag bars to move, drag handles to resize.
- Shift/Ctrl+Click for multi-select of bars.
- Delete: Select bars and press Delete/Backspace.
- Copy/Paste bars: Ctrl+C / Ctrl+V.
- Arrow keys: Nudge or move bars/lines up/down.
- Dynamic filter: Type in the filter box to filter by line or bar attributes.
- Additional Filter button for advanced line-attribute filters.
- Undo/Redo: Ctrl+Z / Ctrl+Y or use the toolbar buttons.
- Theme: Settings gear for dark mode and color changes.
- Import/Export: JSON/CSV for data. JSON includes theme.
- Print: Use Print button for PDF/export.
- Zoom: Sliders for horizontal/vertical scaling, saved locally.`);
    });

    // ---------------------------------------------------------------------------------------------
    // Function: pushState
    // Saves a deep copy of the current state onto the undo stack, clears redo stack
    // ---------------------------------------------------------------------------------------------
    function pushState() {
      const stateCopy = JSON.parse(JSON.stringify({
        lines,
        startYear,
        startWeek,
        endYear,
        endWeek,
        lineCounter,
        barCounter,
        cellWidth,
        rowHeight,
        statusColors,
        currentTheme
      }));
      undoStack.push(stateCopy);
      redoStack = [];
    }

    // ---------------------------------------------------------------------------------------------
    // Function: restoreState
    // Replaces current state from a saved state object, re-applies CSS & theme
    // ---------------------------------------------------------------------------------------------
    function restoreState(state) {
      lines = state.lines;
      startYear = state.startYear;
      startWeek = state.startWeek;
      endYear = state.endYear;
      endWeek = state.endWeek;
      lineCounter = state.lineCounter;
      barCounter = state.barCounter;
      cellWidth = state.cellWidth;
      rowHeight = state.rowHeight;
      statusColors = state.statusColors;
      currentTheme = state.currentTheme;
      updateCSSVariables();
      applyTheme();
      renderTable();
      saveToLocalStorage();
    }

    // ---------------------------------------------------------------------------------------------
    // Function: undo => revert to previous state if available
    // ---------------------------------------------------------------------------------------------
    function undo() {
      if (undoStack.length < 2) return; 
      const current = undoStack.pop();
      redoStack.push(current);
      const prev = undoStack[undoStack.length - 1];
      restoreState(prev);
    }

    // ---------------------------------------------------------------------------------------------
    // Function: redo => apply the next state if available
    // ---------------------------------------------------------------------------------------------
    function redo() {
      if (!redoStack.length) return;
      const nextState = redoStack.pop();
      const current = JSON.parse(JSON.stringify({
        lines,
        startYear,
        startWeek,
        endYear,
        endWeek,
        lineCounter,
        barCounter,
        cellWidth,
        rowHeight,
        statusColors,
        currentTheme
      }));
      undoStack.push(current);
      restoreState(nextState);
    }

    // ---------------------------------------------------------------------------------------------
    // Hook up the Undo/Redo toolbar buttons
    // ---------------------------------------------------------------------------------------------
    undoBtn.addEventListener("click", () => {
      undo();
    });
    redoBtn.addEventListener("click", () => {
      redo();
    });

    // ---------------------------------------------------------------------------------------------
    // Function: init => run on page load
    // Loads from localStorage, populates UI, sets defaults, renders, pushes initial state
    // ---------------------------------------------------------------------------------------------
    function init() {
      loadFromLocalStorage();
      populateDateSelects();
      updateCSSVariables();
      startYearInput.value = startYear;
      startWeekInput.value = startWeek;
      endYearInput.value = endYear;
      endWeekInput.value = endWeek;
      zoomSlider.value = cellWidth;
      heightZoomSlider.value = rowHeight;
      themeSelect.value = currentTheme;
      securedColor.value = statusColors.secured;
      proposedColor.value = statusColors.proposed;
      opportunityColor.value = statusColors.opportunity;
      futureColor.value = statusColors.future;
      applyTheme();
      renderTable();
      pushState();
    }

    // ---------------------------------------------------------------------------------------------
    // Run init on window load
    // ---------------------------------------------------------------------------------------------
    window.addEventListener("load", init);
  </script>
</body>
</html>
