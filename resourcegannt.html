<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Character set: Declares UTF-8 encoding to prevent garbled text -->
  <meta charset="UTF-8" />
  <!-- Page Title: Shown in browser tab -->
  <title>Advanced Gantt Chart</title>
  <!-- Bootstrap 5 CSS via CDN: Loads grid, navbar, modals, buttons -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
  />
  <style>
    /* Remove default body margin, set font: Resets margin, sets default font */
    body {
      margin: 0;
      font-family: Arial, sans-serif;
    }

    /* Navbar: Sticky at top, always visible */
    .navbar {
      position: sticky;
      height: 150px;
      top: 0;
      z-index: 1000;
      background-color: #f8f9fa;
      padding: 0.5rem 1rem;
    }

    /* Main container: Full width with padding */
    .gantt-container {
      margin: 0 1rem;
      position: relative;
    }

    /* Cohesive table: Native HTML table for perfect alignment */
    #ganttTable {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed; /* Ensures column widths consistent */
    }

    /* Header row: Sticky top */
    #ganttTable thead th {
      position: sticky;
      top: 0px; /* Below navbar */
      background-color: #f8f9fa;
      z-index: 10;
      border-bottom: 1px solid #dee2e6;
      text-align: center;
      font-size: 0.9rem;
      padding: 4px 8px;
      box-sizing: border-box;
    }

    /* Name header: Fixed width, left-aligned, explicit background */
    #nameHeader {
      width: 240px;
      text-align: center;
      height:100%;
      font-weight: bold;
      background-color: #f8f9fa;
      border-right: 1px solid #dee2e6;
      z-index: 11;
    }

    /* Timescale headers: Dynamic width */
    .timescale-header {
      background-color: #e9ecef;
      border-right: 1px solid #dee2e6;
      min-width: 50px;
    }

    /* Table body: Grid background using CSS variables for dynamic sizing */
    #ganttTable tbody {
      background-image: 
        linear-gradient(to right, rgba(0,0,0,0.1) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(0,0,0,0.1) 1px, transparent 1px);
      background-size: var(--cell-width) var(--row-height);
      background-repeat: repeat;
    }

    /* Row: Dynamic height via CSS variable */
    .gantt-row {
      height: var(--row-height);
      border-bottom: 1px solid #dee2e6;
    }

    /* Name cell: Sticky left, explicit white background to prevent grid bleed */
    .name-cell {
      position: sticky;
      left: 0;
      background: white;
      z-index: 9;
      width: 240px;
      border-right: 1px solid #dee2e6;
      display: flex;
      align-items: center;
    }

    /* Remove line button: Red × */
    .remove-line-btn {
      background: none;
      border: none;
      color: #dc3545;
      font-weight: bold;
      margin: 0 6px 0 0;
      cursor: pointer;
    }

    /* Line item input: Transparent, editable */
    .line-item-input {
      flex: 1;
      border: none;
      outline: none;
      background-color: transparent;
      font-weight: 500;
    }
    .line-item-input:focus {
      outline: 1px solid #ccc;
    }

    /* Bar container cell: Relative for absolute bars */
    .bar-cell {
      position: relative;
      border-right: 1px solid #dee2e6;
    }

    /* Full row bar container: Spans all timescale columns */
    .bar-row-container {
      position: relative;
      width: 100%;
      height: 100%;
    }

    /* Bar: Relative, rounded */
    .bar {
      position: relative; /* Changed to absolute for precise positioning */
      height: calc(var(--row-height) - 10px); /* Dynamic height, leaving 5px top/bottom margin */
      top: 5px;
      border-radius: 4px;
      color: #fff;
      cursor: move;
      user-select: none;
      opacity: 0.7;
      overflow: hidden;
    }
    .bar.selected {
      outline: 2px solid #ffc107;
    }

    /* Bar text: Centered in visible portion */
    .bar-text {
      position: absolute;
      top: 0;
      height: 100%;
      line-height: calc(var(--row-height) - 10px);
      white-space: nowrap;
      pointer-events: none;
      font-weight: 500;
    }

    /* Resize handles: Scale with row height */
    .bar-handle {
      position: absolute;
      top: 0;
      width: 6px;
      height: 100%;
      cursor: col-resize;
      background-color: rgba(255,255,255,0.4);
      z-index: 2;
    }
    .bar-handle.left {
      left: 0;
      border-radius: 4px 0 0 4px;
    }
    .bar-handle.right {
      right: 0;
      border-radius: 0 4px 4px 0;
    }

    /* Today line: Red vertical across table */
    .today-line {
      position: absolute;
      top: 0;
      width: 2px;
      background-color: #dc3545;
      height: 100%;
      z-index: 5;
      pointer-events: none;
    }

    /* Scrollable area: Enables horizontal/vertical scroll */
    .table-wrapper {
      overflow: auto;
      max-height: calc(100vh - 96px);
    }

    /* Editor overlay */
    #barEditor {
      position: absolute;
      display: none;
      background: #fff;
      border: 1px solid #ccc;
      padding: 12px;
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      z-index: 999;
      min-width: 280px;
    }
    #barEditor label {
      display: block;
      margin-top: 8px;
      font-weight: 500;
    }
    #barEditor input, #barEditor select {
      margin-top: 4px;
      width: 100%;
    }
    #barEditorActions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 12px;
    }

    /* Zoom sliders: Enhanced visibility with shadow, thicker track/thumb */
    .zoom-slider {
      width: 120px;
      margin: 0 8px;
      height: 8px;
      border-radius: 4px;
      background: #ced4da;
      outline: none;
      -webkit-appearance: none;
      box-shadow: 0 2px 6px rgba(0,0,0,0.25);
    }
    .zoom-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #0d6efd;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    .zoom-slider::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #0d6efd;
      cursor: pointer;
      border: none;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    /* Vertical zoom slider rotated */
    #heightZoomSlider {
      transform: rotate(-90deg);
      width: 100px;
    }

    /* Print button */
    #printBtn {
      margin-left: 8px;
    }

    /* Legend */
    #statusLegend {
      display: flex;
      gap: 12px;
      align-items: center;
      font-size: 0.85rem;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .legend-swatch {
      width: 16px;
      height: 16px;
      border-radius: 3px;
    }

    /* Toolbar groups: For compartmentalized layout */
    .toolbar-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0 0.75rem;
      border-left: 1px solid #dee2e6;
    }
    .toolbar-group:first-child {
      border-left: none;
      padding-left: 0;
    }
    .toolbar-group:last-child {
      padding-right: 0;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      #nameHeader, .name-cell {
        width: 180px;
      }
      .zoom-slider {
        width: 100px;
      }
      .toolbar-group {
        padding: 0 0.5rem;
      }
    }

    /* Hidden import */
    #importFileInput {
      display: none;
    }

    /* Help button */
    #helpBtn {
      cursor: pointer;
      transition: transform 0.2s;
    }
    #helpBtn:hover {
      transform: scale(1.1);
    }

    /* Stats */
    #statsDisplay {
      font-size: 0.9rem;
      color: #555;
    }

    /* Print styles: Hide navbar, show full */
    @media print {
      .navbar, #barEditor {
        display: none !important;
      }
      .table-wrapper {
        overflow: visible;
        max-height: none;
      }
      #ganttTable {
        font-size: 10pt;
      }
    }
  </style>
</head>

<body>
  <!-- Sticky navbar with compartmentalized groups -->
  <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">Gantt Planner</a>
      <button class="navbar-toggler" 
              type="button" 
              data-bs-toggle="collapse" 
              data-bs-target="#navbarSupportedContent"
              aria-controls="navbarSupportedContent"
              aria-expanded="false"
              aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <!-- Group 1: Timescale controls -->
        <div class="toolbar-group">
          <label for="startYearInput" class="form-label m-0">Start Y:</label>
          <input id="startYearInput" type="number" class="form-control form-control-sm" value="2025" style="width:72px;" />
          <label for="startWeekInput" class="form-label m-0">Wk:</label>
          <input id="startWeekInput" type="number" class="form-control form-control-sm" value="1" style="width:50px;" />
          <label for="endYearInput" class="form-label m-0">End Y:</label>
          <input id="endYearInput" type="number" class="form-control form-control-sm" value="2025" style="width:72px;" />
          <label for="endWeekInput" class="form-label m-0">Wk:</label>
          <input id="endWeekInput" type="number" class="form-control form-control-sm" Leggi value="52" style="width:50px;" />
          <button id="applyTimescaleBtn" type="button" class="btn btn-secondary btn-sm">Apply</button>
        </div>

        <!-- Group 2: Stats and Legend -->
        <div class="toolbar-group">
          <div id="statsDisplay" class="d-flex align-items-center">
            Lines: <span id="lineCount">0</span> | Bars: <span id="barCount">0</span>
          </div>
          <div id="statusLegend" class="d-flex align-items-center">
            <div class="legend-item"><div class="legend-swatch" style="background:#28a745;"></div><span>Secured</span></div>
            <div class="legend-item"><div class="legend-swatch" style="background:#fd7e14;"></div><span>Proposed</span></div>
            <div class="legend-item"><div class="legend-swatch" style="background:#dc3545;"></div><span>Opportunity</span></div>
            <div class="legend-item"><div class="legend-swatch" style="background:#6f42c1;"></div><span>Future</span></div>
          </div>
        </div>

        <!-- Group 3: Zoom controls (horizontal and vertical) -->
        <div class="toolbar-group">
          <label for="zoomSlider" class="form-label m-0 me-2">H-Zoom:</label>
          <input type="range" class="zoom-slider" id="zoomSlider" min="50" max="300" value="150" step="10">
          <label for="heightZoomSlider" class="form-label m-0 me-2">V-Zoom:</label>
          <input type="range" class="zoom-slider" id="heightZoomSlider" min="30" max="100" value="40" step="5">
        </div>

        <!-- Group 4: Action buttons and help -->
        <div class="toolbar-group ms-auto">
          <button id="addLineItemBtn" class="btn btn-primary btn-sm">Add Line</button>
          <button id="addBarBtn" class="btn btn-secondary btn-sm">Add Bar</button>
          <button id="importJsonBtn" class="btn btn-outline-success btn-sm">Import</button>
          <button id="exportJsonBtn" class="btn btn-outline-info btn-sm">Export JSON</button>
          <button id="downloadCsvBtn" class="btn btn-outline-secondary btn-sm">Export CSV</button>
          <button id="printBtn" class="btn btn-outline-dark btn-sm">Print/PDF</button>
          <svg id="helpBtn" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 14.5v.5h-2v-1c0-1.11.45-2.11 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z" fill="#0d6efd"/>
          </svg>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main cohesive table -->
  <div class="gantt-container">
    <div class="table-wrapper">
      <table id="ganttTable">
        <thead>
          <tr id="headerRow">
            <th id="nameHeader">Tasks</th>
            <!-- Timescale headers injected here -->
          </tr>
        </thead>
        <tbody id="tableBody">
          <!-- Rows injected here -->
        </tbody>
      </table>
      <div id="todayLineContainer"></div> <!-- For today line overlay -->
    </div>
  </div>

  <!-- Bar editor -->
  <div id="barEditor">
    <label for="barTextInput">Bar Text:</label>
    <input type="text" id="barTextInput" placeholder="Bar text..." />
    <label for="barStatusSelect">Status:</label>
    <select id="barStatusSelect">
      <option value="secured">Secured</option>
      <option value="proposed">Proposed</option>
      <option value="opportunity">Opportunity</option>
      <option value="future">Future</option>
    </select>
    <label for="startYearSelect">Start Year:</label>
    <select id="startYearSelect"></select>
    <label for="startWeekSelect">Start Week:</label>
    <select id="startWeekSelect"></select>
    <label for="endYearSelect">End Year:</label>
    <select id="endYearSelect"></select>
    <label for="endWeekSelect">End Week:</label>
    <select id="endWeekSelect"></select>
    <div id="barEditorActions">
      <button id="barDeleteBtn" class="btn btn-sm btn-danger">Delete Bar</button>
      <button id="barEditorOkBtn" class="btn btn-sm btn-primary">OK</button>
      <button id="barEditorCancelBtn" class="btn btn-sm btn-secondary">Cancel</button>
    </div>
  </div>

  <!-- Hidden import -->
  <input type="file" id="importFileInput" accept=".json,.csv" />

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Status colors: Map status to hex
    const statusColors = {
      secured: "#28a745",
      proposed: "#fd7e14",
      opportunity: "#dc3545",
      future: "#6f42c1"
    };

    // Sample data: Initial lines and bars
    let lines = [
      {
        id: 1,
        name: "Line Item 1",
        bars: [
          {
            id: 101,
            text: "Bar A",
            status: "secured",
            startAbsWeek: toAbsoluteWeek(2025, 2),
            length: 4,
            selected: false,
          },
        ],
      },
      {
        id: 2,
        name: "Line Item 2",
        bars: [
          {
            id: 102,
            text: "Bar B",
            status: "proposed",
            startAbsWeek: toAbsoluteWeek(2025, 10),
            length: 7,
            selected: false,
          },
        ],
      },
    ];

    // Timescale defaults
    let startYear = 2025;
    let startWeek = 1;
    let endYear = 2025;
    let endWeek = 52;

    // Counters for unique IDs
    let lineCounter = 2;
    let barCounter = 102;

    // Zoom: Horizontal column width in px, vertical row height in px
    let cellWidth = 150;
    let rowHeight = 40;

    // Clipboard for copy/paste
    let clipboard = [];

    // DOM elements
    const ganttTable = document.getElementById("ganttTable");
    const headerRow = document.getElementById("headerRow");
    const tableBody = document.getElementById("tableBody");
    const todayLineContainer = document.getElementById("todayLineContainer");
    const addLineItemBtn = document.getElementById("addLineItemBtn");
    const addBarBtn = document.getElementById("addBarBtn");
    const importJsonBtn = document.getElementById("importJsonBtn");
    const exportJsonBtn = document.getElementById("exportJsonBtn");
    const downloadCsvBtn = document.getElementById("downloadCsvBtn");
    const printBtn = document.getElementById("printBtn");
    const helpBtn = document.getElementById("helpBtn");
    const importFileInput = document.getElementById("importFileInput");
    const startYearInput = document.getElementById("startYearInput");
    const startWeekInput = document.getElementById("startWeekInput");
    const endYearInput = document.getElementById("endYearInput");
    const endWeekInput = document.getElementById("endWeekInput");
    const applyTimescaleBtn = document.getElementById("applyTimescaleBtn");
    const lineCountSpan = document.getElementById("lineCount");
    const barCountSpan = document.getElementById("barCount");
    const zoomSlider = document.getElementById("zoomSlider");
    const heightZoomSlider = document.getElementById("heightZoomSlider");

    // Editor elements
    const barEditor = document.getElementById("barEditor");
    const barTextInput = document.getElementById("barTextInput");
    const barStatusSelect = document.getElementById("barStatusSelect");
    const startYearSelect = document.getElementById("startYearSelect");
    const startWeekSelect = document.getElementById("startWeekSelect");
    const endYearSelect = document.getElementById("endYearSelect");
    const endWeekSelect = document.getElementById("endWeekSelect");
    const barEditorOkBtn = document.getElementById("barEditorOkBtn");
    const barEditorCancelBtn = document.getElementById("barEditorCancelBtn");
    const barDeleteBtn = document.getElementById("barDeleteBtn");

    // Editor state
    let currentEditorBar = null;
    let currentEditorLine = null;

    // Drag state
    let dragging = false;
    let dragType = null;
    let dragStartX = 0;
    let initialStartAbs = 0;
    let initialLength = 0;
    let currentBar = null;
    let currentLine = null;

    // Absolute week conversion: Year*52 + (week-1)
    function toAbsoluteWeek(year, week) {
      return year * 52 + (week - 1);
    }

    // From absolute week to {year, week}
    function fromAbsoluteWeek(absWeek) {
      const y = Math.floor(absWeek / 52);
      const w = (absWeek % 52) + 1;
      return { year: y, week: w };
    }

    // Get color from status
    function getColorFromStatus(status) {
      return statusColors[status] || "#fd7e14";
    }

    // Populate year/week selects in editor
    function populateDateSelects() {
      [startYearSelect, endYearSelect].forEach(sel => {
        sel.innerHTML = "";
        for (let y = 2010; y <= 2030; y++) {
          const opt = document.createElement("option");
          opt.value = y;
          opt.textContent = y;
          sel.appendChild(opt);
        }
      });
      [startWeekSelect, endWeekSelect].forEach(sel => {
        sel.innerHTML = "";
        for (let w = 1; w <= 52; w++) {
          const opt = document.createElement("option");
          opt.value = w;
          opt.textContent = w;
          sel.appendChild(opt);
        }
      });
    }

    // Set CSS variables for dynamic grid and sizing
    function updateCSSVariables() {
      document.documentElement.style.setProperty('--cell-width', cellWidth + 'px');
      document.documentElement.style.setProperty('--row-height', rowHeight + 'px');
      ganttTable.style.setProperty('--cell-width', cellWidth + 'px');
      ganttTable.style.setProperty('--row-height', rowHeight + 'px');
    }

    // Save to localStorage
    function saveToLocalStorage() {
      const chartData = { lines, startYear, startWeek, endYear, endWeek, lineCounter, barCounter, cellWidth, rowHeight };
      localStorage.setItem("ganttChartData", JSON.stringify(chartData));
    }

    // Load from localStorage
    function loadFromLocalStorage() {
      const stored = localStorage.getItem("ganttChartData");
      if (!stored) return;
      try {
        const parsed = JSON.parse(stored);
        lines = parsed.lines || [];
        lines.forEach(line => line.bars.forEach(bar => { if (!bar.status) bar.status = "proposed"; }));
        startYear = parsed.startYear || 2025;
        startWeek = parsed.startWeek || 1;
        endYear = parsed.endYear || 2025;
        endWeek = parsed.endWeek || 52;
        lineCounter = parsed.lineCounter || 0;
        barCounter = parsed.barCounter || 0;
        cellWidth = parsed.cellWidth || 150;
        rowHeight = parsed.rowHeight || 40;
      } catch (err) {
        console.warn("Invalid localStorage data");
      }
    }

    // Get selected bars
    function getSelectedBars() {
      const selected = [];
      lines.forEach(line => line.bars.forEach(bar => { if (bar.selected) selected.push({ bar, line }); }));
      return selected;
    }

    // Delete selected bars
    function deleteBars(barsToDelete) {
      barsToDelete.forEach(({ bar, line }) => {
        line.bars = line.bars.filter(b => b.id !== bar.id);
      });
      renderTable();
      saveToLocalStorage();
    }

    // Count total bars
    function getTotalBars() {
      return lines.reduce((count, line) => count + line.bars.length, 0);
    }

    // Unselect all bars
    function unselectAllBars() {
      lines.forEach(line => line.bars.forEach(bar => bar.selected = false));
    }

    // Handle bar select (click/shift)
    function handleBarClickSelect(bar, event) {
      const isMulti = event.shiftKey || event.ctrlKey || event.metaKey;
      if (!isMulti) {
        unselectAllBars();
        bar.selected = true;
      } else {
        bar.selected = !bar.selected;
      }
    }

    // Get display range (absolute weeks)
    function getDisplayRange() {
      let ds = toAbsoluteWeek(startYear, startWeek);
      let de = toAbsoluteWeek(endYear, endWeek);
      if (ds > de) [ds, de] = [de, ds];
      return { displayStart: ds, displayEnd: de };
    }

    // Today absolute week using current date (November 03, 2025)
    function getTodayAbsWeek() {
      const today = new Date();
      const year = today.getFullYear();
      const jan1 = new Date(year, 0, 1);
      const dayOfYear = Math.floor((today - jan1) / 86400000) + 1;
      const week = Math.ceil(dayOfYear / 7);
      return toAbsoluteWeek(year, week);
    }

    // Update bar text centering in visible area
    function updateBarTextPositions() {
      const wrapper = document.querySelector(".table-wrapper");
      const scrollLeft = wrapper.scrollLeft - 240; // Offset for name column
      const viewportWidth = wrapper.clientWidth;
      document.querySelectorAll(".bar-text").forEach(textEl => {
        const barEl = textEl.parentElement;
        const barLeft = parseFloat(barEl.style.left);
        const barWidth = parseFloat(barEl.style.width);
        const barRight = barLeft + barWidth;

        const visibleLeft = Math.max(barLeft, scrollLeft);
        const visibleRight = Math.min(barRight, scrollLeft + viewportWidth);
        const visibleWidth = visibleRight - visibleLeft;

        if (visibleWidth <= 0) {
          textEl.style.opacity = "0";
          return;
        }

        textEl.style.opacity = "1";
        const textWidth = textEl.offsetWidth;
        let textLeft = visibleLeft - barLeft + (visibleWidth - textWidth) / 2;
        if (textLeft < 5) textLeft = 5;
        if (textLeft + textWidth > barWidth - 5) textLeft = barWidth - textWidth - 5;
        textEl.style.left = textLeft + "px";
      });
    }

    // Render header and timescale
    function renderHeader() {
      // Clear existing timescale headers
      while (headerRow.children.length > 1) {
        headerRow.removeChild(headerRow.lastChild);
      }

      const { displayStart, displayEnd } = getDisplayRange();
      const totalWeeks = displayEnd - displayStart + 1;
      if (totalWeeks < 1) return;

      for (let i = 0; i < totalWeeks; i++) {
        const abs = displayStart + i;
        const { year, week } = fromAbsoluteWeek(abs);
        const th = document.createElement("th");
        th.className = "timescale-header";
        th.textContent = `${year}-W${week}`;
        th.style.width = cellWidth + "px";
        headerRow.appendChild(th);
      }

      // Today line overlay
      todayLineContainer.innerHTML = "";
      const todayAbs = getTodayAbsWeek();
      if (todayAbs >= displayStart && todayAbs <= displayEnd) {
        const offset = (todayAbs - displayStart) * cellWidth + 240; // + name column width
        const todayLine = document.createElement("div");
        todayLine.className = "today-line";
        todayLine.style.left = offset + "px";
        todayLine.style.height = (lines.length * rowHeight + rowHeight) + "px"; // Header + rows
        todayLineContainer.appendChild(todayLine);
      }
    }

    // Update stats display
    function updateStats() {
      lineCountSpan.textContent = lines.length;
      barCountSpan.textContent = getTotalBars();
    }

    // Full table render
    function renderTable() {
      renderHeader();
      tableBody.innerHTML = "";

      const { displayStart, displayEnd } = getDisplayRange();
      const totalWeeks = displayEnd - displayStart + 1;
      if (totalWeeks < 1) return;

      lines.forEach(line => {
        const tr = document.createElement("tr");
        tr.className = "gantt-row";

        // Name cell with remove button and input
        const nameTd = document.createElement("td");
        nameTd.className = "name-cell";
        const removeBtn = document.createElement("button");
        removeBtn.className = "remove-line-btn";
        removeBtn.innerHTML = "×";
        removeBtn.title = "Remove this line";
        removeBtn.addEventListener("click", () => removeLineItem(line.id));
        nameTd.appendChild(removeBtn);
        const nameInput = document.createElement("input");
        nameInput.className = "line-item-input";
        nameInput.value = line.name;
        nameInput.addEventListener("click", e => e.stopPropagation());
        nameInput.addEventListener("change", () => {
          line.name = nameInput.value;
          saveToLocalStorage();
        });
        nameTd.appendChild(nameInput);
        tr.appendChild(nameTd);

        // Bar container cell spanning all weeks
        const barTd = document.createElement("td");
        barTd.colSpan = totalWeeks;
        barTd.className = "bar-cell";
        const barContainer = document.createElement("div");
        barContainer.className = "bar-row-container";

        line.bars.forEach(bar => {
          const barStart = bar.startAbsWeek;
          const barEnd = barStart + bar.length;
          const overlapStart = Math.max(displayStart, barStart);
          const overlapEnd = Math.min(displayEnd + 1, barEnd);
          const overlapLen = overlapEnd - overlapStart;
          if (overlapLen <= 0) return;

          const barLeft = (overlapStart - displayStart) * cellWidth;
          const barWidth = overlapLen * cellWidth;

          const barDiv = document.createElement("div");
          barDiv.classList.add("bar");
          if (bar.selected) barDiv.classList.add("selected");
          barDiv.style.left = barLeft + "px";
          barDiv.style.width = barWidth + "px";
          barDiv.style.backgroundColor = getColorFromStatus(bar.status);

          // Bar text span
          const textSpan = document.createElement("span");
          textSpan.className = "bar-text";
          textSpan.textContent = bar.text;
          barDiv.appendChild(textSpan);

          // Resize handles
          const leftHandle = document.createElement("div");
          leftHandle.classList.add("bar-handle", "left");
          barDiv.appendChild(leftHandle);
          const rightHandle = document.createElement("div");
          rightHandle.classList.add("bar-handle", "right");
          barDiv.appendChild(rightHandle);

          // Bar events: click, dblclick, mousedown
          barDiv.addEventListener("click", e => {
            e.stopPropagation();
            handleBarClickSelect(bar, e);
            renderTable();
            saveToLocalStorage();
          });
          barDiv.addEventListener("dblclick", e => {
            e.stopPropagation();
            showBarEditor(bar, line, e.clientX, e.clientY);
          });
          barDiv.addEventListener("mousedown", e => onBarMouseDown(e, line, bar));

          barContainer.appendChild(barDiv);
        });

        barTd.appendChild(barContainer);
        tr.appendChild(barTd);
        tableBody.appendChild(tr);
      });

      updateStats();
      updateBarTextPositions();
    }

    // Remove line item by ID
    function removeLineItem(id) {
      lines = lines.filter(l => l.id !== id);
      renderTable();
      saveToLocalStorage();
    }

    // Bar mouse down: Start drag or resize
    function onBarMouseDown(e, line, bar) {
      if (e.target.classList.contains("bar-handle")) {
        dragType = e.target.classList.contains("left") ? "resize-left" : "resize-right";
      } else {
        dragType = "move";
      }
      dragging = true;
      currentBar = bar;
      currentLine = line;
      dragStartX = e.clientX;
      initialStartAbs = currentBar.startAbsWeek;
      initialLength = currentBar.length;
      e.preventDefault();
    }

    // Document mousemove: Handle dragging/resizing
    document.addEventListener("mousemove", e => {
      if (!dragging || !currentBar) return;
      const dx = e.clientX - dragStartX;
      const dWeeks = Math.round(dx / cellWidth);

      if (dragType === "move") {
        currentBar.startAbsWeek = Math.max(0, initialStartAbs + dWeeks);
      } else if (dragType === "resize-left") {
        let newStart = initialStartAbs + dWeeks京东;
        let newLength = initialStartAbs + initialLength - newStart;
        if (newLength < 1) { newLength = 1; newStart = initialStartAbs + initialLength - 1; }
        currentBar.startAbsWeek = Math.max(0, newStart);
        currentBar.length = newLength;
      } else if (dragType === "resize-right") {
        let newLength = initialLength + dWeeks;
        if (newLength < 1) newLength = 1;
        currentBar.length = newLength;
      }
      renderTable();
    });

    // Document mouseup: End drag
    document.addEventListener("mouseup", () => {
      if (dragging) {
        dragging = false;
        dragType = null;
        currentBar = null;
        currentLine = null;
        saveToLocalStorage();
      }
    });

    // Click outside: Unselect bars
    document.addEventListener("click", () => {
      if (!dragging) {
        unselectAllBars();
        renderTable();
        saveToLocalStorage();
      }
    });

    // Keyboard shortcuts
    document.addEventListener("keydown", e => {
      const selected = getSelectedBars();
      if (!selected.length) return;

      if ((e.key === "Delete" || e.key === "Backspace")) {
        deleteBars(selected);
        e.preventDefault();
        return;
      }

      if (e.ctrlKey || e.metaKey) {
        if (e.key.toLowerCase() === "c") {
          clipboard = selected.map(({ bar, line }) => ({ bar: JSON.parse(JSON.stringify(bar)), sourceLine: line }));
          e.preventDefault();
        }
        if (e.key.toLowerCase() === "v") {
          if (!clipboard.length) return;
          let targetLine = selected.length ? selected[selected.length - 1].line : lines[lines.length - 1];
          if (!targetLine) {
            lineCounter++;
            targetLine = { id: lineCounter, name: "Line Item " + lineCounter, bars: [] };
            lines.push(targetLine);
          }
          clipboard.forEach(item => {
            barCounter++;
            const newBar = JSON.parse(JSON.stringify(item.bar));
            newBar.id = barCounter;
            newBar.selected = true;
            targetLine.bars.push(newBar);
          });
          unselectAllBars();
          renderTable();
          saveToLocalStorage();
          e.preventDefault();
        }
      }

      if (e.key === "ArrowLeft") {
        selected.forEach(({ bar }) => bar.startAbsWeek = Math.max(0, bar.startAbsWeek - 1));
        renderTable();
        saveToLocalStorage();
        e.preventDefault();
      } else if (e.key === "ArrowRight") {
        selected.forEach(({ bar }) => bar.startAbsWeek = Math.max(0, bar.startAbsWeek + 1));
        renderTable();
        saveToLocalStorage();
        e.preventDefault();
      } else if (e.key === "ArrowUp" || e.key === "ArrowDown") {
        selected.forEach(({ bar, line }) => {
          const idx = lines.indexOf(line);
          if (e.key === "ArrowUp" && idx > 0) {
            line.bars = line.bars.filter(b => b.id !== bar.id);
            lines[idx - 1].bars.push(bar);
          } else if (e.key === "ArrowDown" && idx < lines.length - 1) {
            line.bars = line.bars.filter(b => b.id !== bar.id);
            lines[idx + 1].bars.push(bar);
          }
        });
        renderTable();
        saveToLocalStorage();
        e.preventDefault();
      }
    });

    // Add line button
    addLineItemBtn.addEventListener("click", () => {
      lineCounter++;
      lines.push({ id: lineCounter, name: "Line Item " + lineCounter, bars: [] });
      renderTable();
      saveToLocalStorage();
    });

    // Add bar button
    addBarBtn.addEventListener("click", e => {
      e.stopPropagation();
      barCounter++;
      const { displayStart } = getDisplayRange();
      const newBar = {
        id: barCounter,
        text: "New Bar",
        status: "proposed",
        startAbsWeek: displayStart,
        length: 4,
        selected: false,
      };
      if (!lines.length) {
        lineCounter = 1;
        lines.push({ id: 1, name: "Line Item 1", bars: [] });
      }
      lines[lines.length - 1].bars.push(newBar);
      renderTable();
      saveToLocalStorage();
    });

    // Export JSON
    exportJsonBtn.addEventListener("click", () => {
      const dataStr = JSON.stringify({ lines, startYear, startWeek, endYear, endWeek, lineCounter, barCounter, cellWidth, rowHeight }, null, 2);
      const blob = new Blob([dataStr], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.download = "gantt-data.json";
      a.href = url;
      a.click();
      URL.revokeObjectURL(url);
    });

    // Export CSV
    downloadCsvBtn.addEventListener("click", () => {
      let csv = "Line ID,Line Name,Bar ID,Bar Text,Status,Start Year,Start Week,End Year,End Week,Duration (weeks)\n";
      lines.forEach(line => {
        if (line.bars.length === 0) {
          csv += `${line.id},"${line.name}",,,,,,\n`;
        } else {
          line.bars.forEach(bar => {
            const { year: sy, week: sw } = fromAbsoluteWeek(bar.startAbsWeek);
            const { year: ey, week: ew } = fromAbsoluteWeek(bar.startAbsWeek + bar.length - 1);
            csv += `${line.id},"${line.name}",${bar.id},"${bar.text}","${bar.status}",${sy},${sw},${ey},${ew},${bar.length}\n`;
          });
        }
      });
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.download = "gantt-data.csv";
      a.href = url;
      a.click();
      URL.revokeObjectURL(url);
    });

    // Print/PDF button
    printBtn.addEventListener("click", () => {
      window.print();
    });

    // Horizontal zoom slider
    zoomSlider.addEventListener("input", e => {
      cellWidth = parseInt(e.target.value);
      updateCSSVariables();
      renderTable();
      saveToLocalStorage();
    });

    // Vertical zoom slider
    heightZoomSlider.addEventListener("input", e => {
      rowHeight = parseInt(e.target.value);
      updateCSSVariables();
      renderTable();
      saveToLocalStorage();
    });

    // CSV parser for import
    function parseCsv(csv) {
      const rows = csv.trim().split('\n');
      const header = rows[0].toLowerCase();
      if (!header.includes('line id') || !header.includes('bar id')) throw new Error("Invalid CSV header");
      const newLines = [];
      let maxLineId = 0;
      let maxBarId = 0;
      const lineMap = {};
      for (let i = 1; i < rows.length; i++) {
        const row = rows[i].trim();
        if (!row) continue;
        const parsed = [];
        let field = '';
        let inQuote = false;
        for (let c of row + ',') {
          if (c === '"') inQuote = !inQuote;
          else if (c === ',' && !inQuote) { parsed.push(field); field = ''; }
          else field += c;
        }
        if (parsed.length < 5) continue;
        const lineId = parseInt(parsed[0]);
        const lineName = parsed[1] || `Line ${lineId}`;
        const barIdStr = parsed[2];
        if (!barIdStr) {
          if (!lineMap[lineId]) { lineMap[lineId] = { id: lineId, name: lineName, bars: [] }; newLines.push(lineMap[lineId]); maxLineId = Math.max(maxLineId, lineId); }
          continue;
        }
        const barId = parseInt(barIdStr);
        const barText = parsed[3] || '';
        const status = (parsed[4] || "proposed").toLowerCase();
        const sy = parseInt(parsed[5]);
        const sw = parseInt(parsed[6]);
        const ey = parseInt(parsed[7]);
        const ew = parseInt(parsed[8]);
        const duration = parseInt(parsed[9]) || 1;
        if (isNaN(sy) || isNaN(sw)) continue;
        const startAbs = toAbsoluteWeek(sy, sw);
        let len = duration;
        if (!isNaN(ey) && !isNaN(ew)) len = toAbsoluteWeek(ey, ew) - startAbs + 1;
        if (len < 1) len = 1;
        if (!lineMap[lineId]) { lineMap[lineId] = { id: lineId, name: lineName, bars: [] }; newLines.push(lineMap[lineId]); maxLineId = Math.max(maxLineId, lineId); }
        lineMap[lineId].bars.push({ id: barId, text: barText, status, startAbsWeek: startAbs, length: len, selected: false });
        maxBarId = Math.max(maxBarId, barId);
      }
      newLines.sort((a, b) => a.id - b.id);
      return { lines: newLines, lineCounter: maxLineId, barCounter: maxBarId };
    }

    // Import file handler
    importFileInput.addEventListener("change", e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = evt => {
        try {
          const ext = file.name.split('.').pop().toLowerCase();
          let imported;
          if (ext === 'json') {
            imported = JSON.parse(evt.target.result);
            lines = imported.lines || [];
            startYear = imported.startYear || 2025;
            startWeek = imported.startWeek || 1;
            endYear = imported.endYear || 2025;
            endWeek = imported.endWeek || 52;
            lineCounter = imported.lineCounter || 0;
            barCounter = imported.barCounter || 0;
            cellWidth = imported.cellWidth || 150;
            rowHeight = imported.rowHeight || 40;
          } else if (ext === 'csv') {
            const parsed = parseCsv(evt.target.result);
            lines = parsed.lines;
            lineCounter = parsed.lineCounter;
            barCounter = parsed.barCounter;
          } else throw new Error("Unsupported file");
          lines.forEach(line => line.bars.forEach(bar => { if (!bar.status) bar.status = "proposed"; }));
          updateCSSVariables();
          renderTable();
          saveToLocalStorage();
        } catch (err) {
          alert("Invalid file: " + err.message);
        }
      };
      reader.readAsText(file);
      e.target.value = "";
    });
    importJsonBtn.addEventListener("click", () => importFileInput.click());

    // Apply timescale button
    applyTimescaleBtn.addEventListener("click", () => {
      const sy = parseInt(startYearInput.value, 10);
      const sw = parseInt(startWeekInput.value, 10);
      const ey = parseInt(endYearInput.value, 10);
      const ew = parseInt(endWeekInput.value, 10);
      if (isNaN(sy) || sy < 1 || isNaN(sw) || sw < 1 || sw > 52 || isNaN(ey) || ey < 1 || isNaN(ew) || ew < 1 || ew > 52) {
        alert("Invalid year/week");
        return;
      }
      startYear = sy;
      startWeek = sw;
      endYear = ey;
      endWeek = ew;
      renderTable();
      saveToLocalStorage();
    });

    // Show bar editor modal
    function showBarEditor(bar, line, x, y) {
      currentEditorBar = bar;
      currentEditorLine = line;
      barTextInput.value = bar.text;
      barStatusSelect.value = bar.status;
      const { year: sy, week: sw } = fromAbsoluteWeek(bar.startAbsWeek);
      const { year: ey, week: ew } = fromAbsoluteWeek(bar.startAbsWeek + bar.length - 1);
      startYearSelect.value = sy;
      startWeekSelect.value = sw;
      endYearSelect.value = ey;
      endWeekSelect.value = ew;
      barEditor.style.display = "block";
      barEditor.style.left = (x + window.scrollX + 10) + "px";
      barEditor.style.top = (y + window.scrollY + 10) + "px";
    }

    // Editor OK button
    barEditorOkBtn.addEventListener("click", () => {
      if (!currentEditorBar) return;
      currentEditorBar.text = barTextInput.value;
      currentEditorBar.status = barStatusSelect.value;
      const sy = parseInt(startYearSelect.value);
      const sw = parseInt(startWeekSelect.value);
      const ey = parseInt(endYearSelect.value);
      const ew = parseInt(endWeekSelect.value);
      const startAbs = toAbsoluteWeek(sy, sw);
      const endAbs = toAbsoluteWeek(ey, ew);
      currentEditorBar.startAbsWeek = startAbs;
      currentEditorBar.length = endAbs - startAbs + 1;
      if (currentEditorBar.length < 1) currentEditorBar.length = 1;
      barEditor.style.display = "none";
      currentEditorBar = null;
      renderTable();
      saveToLocalStorage();
    });

    // Editor delete button
    barDeleteBtn.addEventListener("click", () => {
      if (currentEditorBar && currentEditorLine) {
        deleteBars([{ bar: currentEditorBar, line: currentEditorLine }]);
        barEditor.style.display = "none";
        currentEditorBar = null;
        currentEditorLine = null;
      }
    });

    // Editor cancel button
    barEditorCancelBtn.addEventListener("click", () => {
      barEditor.style.display = "none";
      currentEditorBar = null;
    });

    // Editor click outside to close
    document.addEventListener("mousedown", e => {
      if (barEditor.style.display === "block") {
        const rect = barEditor.getBoundingClientRect();
        const inside = e.clientX >= rect.left && e.clientX <= rect.right && e.clientY >= rect.top && e.clientY <= rect.bottom;
        if (!inside) {
          barEditor.style.display = "none";
          currentEditorBar = null;
        }
      }
    });

    // Comprehensive Help/About section
    helpBtn.addEventListener("click", () => {
      const helpWindow = window.open("", "GanttHelp", "width=800,height=800,scrollbars=yes,resizable=yes");
      const helpHTML = `<!DOCTYPE html><html><head><title>Gantt Planner - Comprehensive Help</title><style>body{font-family:Arial;padding:20px;line-height:1.6;background:#f9f9f9;}h1,h2,h3{color:#0d6efd;}ul{margin:12px 0;}code{background:#eef;padding:2px 6px;border-radius:4px;}.tip{background:#e7f3ff;padding:15px;border-left:4px solid #0d6efd;margin:15px 0;border-radius:4px;}pre{background:#eee;padding:10px;border-radius:4px;overflow:auto;}</style></head><body>
        <h1>Gantt Planner - Full Documentation</h1>
        <p>This is an advanced, interactive Gantt chart planner built entirely with HTML, CSS, and JavaScript. It runs locally in your browser with no server required. All data is saved automatically to your browser's localStorage, so it persists across sessions.</p>
        
        <h2>How It Works</h2>
        <p>The chart uses a single cohesive HTML table for perfect alignment. The left column is sticky for task names, the top header is sticky for week labels, and the body scrolls in both directions. A subtle grid background (dynamic with zoom) provides visual structure without interfering with bars.</p>
        <p>Time is modeled in <strong>absolute weeks</strong>: year * 52 + (week - 1). This allows seamless spanning across years.</p>
        <p>Bars are absolutely positioned within row containers, enabling drag, resize, and precise placement. The red vertical "today" line marks the current date (Nov 3, 2025).</p>
        
        <h2>Key Features</h2>
        <ul>
          <li><strong>Dynamic Zoom</strong>: Horizontal zoom slider adjusts week column width (50-300px). New vertical zoom slider adjusts row height (30-100px). Grid, bars, and text automatically scale.</li>
          <li><strong>Task Lines</strong>: Add/remove lines, edit names inline. Each line holds multiple bars.</li>
          <li><strong>Bars</strong>: Create, drag to move, resize with handles, double-click to edit. Status colors: Secured (green), Proposed (orange), Opportunity (red), Future (purple).</li>
          <li><strong>Selection & Keyboard</strong>: Click to select (Shift/Ctrl for multi). Arrows move, Up/Down shift bars between lines, Delete removes. Ctrl+C/V copy/paste bars.</li>
          <li><strong>Timescale</strong>: Set start/end year/week, apply to focus view. Headers show YYYY-WWW.</li>
          <li><strong>Import/Export</strong>: JSON (full state including zoom), CSV (data only). Import overwrites current chart.</li>
          <li><strong>Print/PDF</strong>: Browser print (hides toolbar, expands view).</li>
          <li><strong>Persistent Storage</strong>: Auto-saves to localStorage. Clear browser data to reset.</li>
          <li><strong>Responsive</strong>: Works on desktop/mobile, with adjusted widths for small screens.</li>
          <li><strong>Today Line</strong>: Red vertical line at current week, height matches chart.</li>
          <li><strong>Bar Text Centering</strong>: Text stays centered in visible portion while scrolling.</li>
        </ul>
        
        <h2>Toolbar Guide</h2>
        <p>The sticky top toolbar is grouped logically:</p>
        <ul>
          <li><strong>Timescale</strong>: Set view range and apply.</li>
          <li><strong>Stats & Legend</strong>: Line/bar counts and status color key.</li>
          <li><strong>Zoom</strong>: H-Zoom (width), V-Zoom (height).</li>
          <li><strong>Actions</strong>: Add Line/Bar, Import (JSON/CSV), Export JSON/CSV, Print/PDF, Help (?).</li>
        </ul>
        
        <h2>Tips & Tricks</h2>
        <div class="tip">
          <strong>Precise Editing</strong>: Double-click a bar for exact start/end dates and status.<br>
          <strong>Multi-Select</strong>: Hold Shift/Ctrl while clicking bars.<br>
          <strong>Copy/Paste</strong>: Select bars, Ctrl+C, then Ctrl+V (pastes to last selected line or new).<br>
          <strong>Scrolling</strong>: Use mouse wheel or touch for horizontal/vertical scroll. Headers and names stay fixed.<br>
          <strong>Reset</strong>: Clear localStorage or reload with no data.<br>
          <strong>Performance</strong>: Handles hundreds of bars smoothly due to efficient rendering.
        </div>
        
        <h2>Known Limitations</h2>
        <ul>
          <li>No dependencies (arrows between bars).</li>
          <li>No milestones or other shapes.</li>
          <li>No resource loading or critical path.</li>
          <li>Week-based only (no days/months).</li>
        </ul>
        
        <h2>Technical Details</h2>
        <p>Data structure: <pre>lines = [{id, name, bars: [{id, text, status, startAbsWeek, length, selected}]}]</pre></p>
        <p>Zoom uses CSS variables <code>--cell-width</code> and <code>--row-height</code> for grid and sizing sync.</p>
        <p>All interactions trigger <code>renderTable()</code> for updates, with localStorage save.</p>
        
        <p>Enjoy planning! For issues, inspect console or modify the open-source code.</p>
      </body></html>`;
      helpWindow.document.write(helpHTML);
      helpWindow.document.close();
    });

    // Scroll handler: Update bar text positions and today line if needed
    const tableWrapper = document.querySelector(".table-wrapper");
    tableWrapper.addEventListener("scroll", () => {
      updateBarTextPositions();
    });

    // Initialization
    populateDateSelects();
    loadFromLocalStorage();
    updateCSSVariables();
    zoomSlider.value = cellWidth;
    heightZoomSlider.value = rowHeight;
    startYearInput.value = startYear;
    startWeekInput.value = startWeek;
    endYearInput.value = endYear;
    endWeekInput.value = endWeek;
    renderTable();
  </script>
</body>
</html>
